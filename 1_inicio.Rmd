---
title: Início
output:
  html_document:
    toc: true
    toc_float: true
    css:
      - ./CSS/generic.css
      - ./CSS/logo-above-toc.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
---

<!--start-->
```{r start, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%"}
# restart all variables
rm(list = ls(all = TRUE))

# initialize variables
has.metricas.doi.sucupira <- FALSE
has.metricas.doi.ppg <- FALSE
has.posdocs <- FALSE
```

## **Set up**

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = "asis",
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)
```

## **Load caches**

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
    knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

## **Install packages**

<!--install and/or load all packages-->
```{r install-update-packages, echo = FALSE, include = FALSE}
source("Scripts/all-required-packages.R", local = knitr::knit_global())
```

## **YAML**

```{r yaml, eval = FALSE}
source("Scripts/custom-yaml.R", local = knitr::knit_global())
```

## **Metadata**

```{r metadata, cache = TRUE, cache.path = "cache/metadata/"}
metadata <- c()
metadata$repository_url <- yaml::read_yaml("_site.yml")$repository_url
```

## **Jekyll**

```{r nojekyll}
if(!file.exists(".nojekyll")) {
  file.create('.nojekyll')
}
```

## **Main color**

```{r main-color, cache = TRUE, cache.path = "cache/main-color/"}
# read css color for this page
css <- cssparser::read_css("./CSS/main-color.css")
main.color <- css$`:root`$`--mybackgroundcolor`
```

## **Diretórios**

<!--create (if non existent) all required folders-->
```{r check-create-folders}
paths <- c(
  file.path(getwd(), "PPG"),
  file.path(getwd(), "Sucupira"),
  file.path(getwd(), "Impacto", "Sage Policy Profiles")
)

for (i in 1:length(paths)) {
  if (!dir.exists(paths[i])) {
    dir.create(paths[i], recursive = TRUE, showWarnings = FALSE)
  }
}
```

## **Source scripts de métricas**

<!--read METRIC files-->
```{r source-metrics-scripts}
source(file.path("Scripts", "citescore.R"), local = knitr::knit_global())
source(file.path("Scripts", "sjr.R"), local = knitr::knit_global())
source(file.path("Scripts", "webqualis.R"), local = knitr::knit_global())

source(file.path("Scripts", "doi-cleaner.R"), local = knitr::knit_global())

source(file.path("Scripts", "get-citescore.R"), local = knitr::knit_global())
source(file.path("Scripts", "get-sjr.R"), local = knitr::knit_global())
source(file.path("Scripts", "get-webqualis.R"), local = knitr::knit_global())
source(file.path("Scripts", "get-metrics-from-sources.R"), local = knitr::knit_global())
```

## **Check arquivos Impacto**

<!--check Impacto/Sage folder-->
```{r try-impacto-sage-files}
# list all Sage Profiles
files.to.read <-
  list.files(file.path(getwd(), "Impacto", "Sage Policy Profiles"),
            full.names = TRUE,
            recursive = FALSE,
            pattern = ".csv")
has.sage.files <- length(files.to.read) != 0
```

## **Check arquivos Sucupira**

<!--check Sucupira folder-->
```{r try-sucupira-files}
files.to.read <-
  list.files(file.path(getwd(), "Sucupira"),
            full.names = TRUE,
            recursive = TRUE,
            pattern = "xlsx"
)
has.sucupira.files <- length(files.to.read) != 0
doi_with_altmetric_sucupira <- data.frame()
doi_without_altmetric_sucupira <- data.frame()
```

## **Check diretório PPG**

<!--check PPG folder-->
```{r try-ppg-files}
# list all PPG files
files.to.read <-
  list.files(file.path(getwd(), "PPG"),
            full.names = TRUE,
            recursive = TRUE,
            pattern = "xlsx")
has.ppg.files <- length(files.to.read) != 0
```

## **Check arquivos PPG**

<!--check available files in PPG folder-->
```{r try-agendas-pesquisa}
has.agendas.pesquisa <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Agendas de Pesquisa.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-apresentacao}
has.apresentacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Apresentação.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-area-capes}
has.area.capes <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Área CAPES.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-autoavaliacoes}
has.autoavaliacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Autoavaliação.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-avaliacao}
has.avaliacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Avaliação.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-bibliografia}
has.bibliografia <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Bibliografia.xlsx", sheet = 1),
                silent = TRUE))
```

```{r try-blog-externos}
has.blogs.externos <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Blogs externos.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-blog-ies}
has.blog.ies <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Blog institucional.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-bolsas}
has.bolsas <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Bolsas.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-calendarios}
has.calendarios <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Calendários.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-cep}
has.cep <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Comitê de Ética em Pesquisa.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-convenios}
has.convenios <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Convênios.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-cooperacoes}
has.cooperacoes <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Cooperações.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-coordenacao}
has.coordenacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Coordenação.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-dados-cadastrais}
has.dados.cadastrais <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Dados Cadastrais.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-destaques}
has.destaques <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Destaques.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-discentes}
has.discentes <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Discentes.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-downloads}
has.downloads <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Downloads.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-editais}
has.editais <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Editais.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-financiadores}
has.financiadores <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Financiadores.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-grupos-pesquisa}
has.grupos.pesquisa <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Grupos de Pesquisa.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-historico}
has.historico <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Histórico.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-infraestrutura}
has.infraestrutura <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Infraestrutura.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-internacionalizacao}
has.internacionalizacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Internacionalização.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-laboratorios}
has.laboratorios <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Laboratórios.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-metodologia}
has.metodologia <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Metodologia.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-notas}
has.notas <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Notas.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-periodicos}
has.periodicos <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Periódicos institucionais.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-planejamento}
has.planejamento <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Planejamento estratégico.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-podcasts}
has.podcasts <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Podcasts.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-politicas}
has.politicas <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Políticas.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-premio-capes}
has.premio.capes <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Prêmio CAPES de Tese.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-premios}
has.premios <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Prêmios.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-producao}
has.producao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Produção.xlsx", sheet = 1),
                silent = TRUE)
  )
```

```{r try-repositorios}
has.repositorios.sede <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Repositórios.xlsx", sheet =  "Sede"),
                silent = TRUE)
  )
has.repositorios.cooperacao <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Repositórios.xlsx", sheet = "Cooperação"),
                silent = TRUE)
  )
```

```{r try-videos}
has.videos <-
  !BBmisc::is.error(try(readxl::read_excel("PPG/Videos.xlsx", sheet = 1),
                silent = TRUE)
  )
```

## **Check dados cadastrais PPG**

```{r ppg-data, eval = all(has.dados.cadastrais, has.sucupira.files)}
# projetos - membros
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# most recent Sucupira year
most.recent <-
  as.character(ifelse(!is.null(sucupira.list[[format(Sys.Date(), "%Y")]]), format(Sys.Date(), "%Y"), max(as.numeric(
    names(sucupira.list)
  ))))

# read separate sheets
docentes.raw <- sucupira.list[[most.recent]]

# get initials from the PPG data
nome.PPG <- unique(docentes.raw$'Nome do PPG')

nome.PPG.split <- stringr::str_split_1(as.character(nome.PPG)[[1]], " ")
match.stopwords <- match(stringr::str_split_1(as.character(nome.PPG)[[1]], " "), tm::stopwords("portuguese"))
nome.PPG.no.stopwords <- paste(nome.PPG.split[is.na(match.stopwords)], collapse = " ")
source("Scripts/get-initials.R", local = knitr::knit_global())
sigla.PPG <- initials(nome.PPG.no.stopwords)

try(site.PPG <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
             sheet = "Endereço",
             col_types = c("text"))[7, 2],
  silent = TRUE)

# qualquer planilha para obter os dados da IES
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
nome.IES <- unique(sucupira.raw$`IES Nome`)
nome.IES <- tools::toTitleCase(as.character(nome.IES))

sigla.IES <- unique(sucupira.raw$`IES Sigla`)
```

## **Check DOI produção Sucupira**

```{r metricas-doi-sucupira, cache = TRUE, cache.path = "cache/metricas-doi-sucupira/", eval = has.sucupira.files}
# produção detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
produtos.detalhes <- sucupira.list[as.character(anos)] %>%
  plyr::compact()
produtos.detalhes <- data.frame(do.call(dplyr::bind_rows, produtos.detalhes))
names(produtos.detalhes) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# filter by Valor do Item de Detalhamento
produtos.detalhes <- produtos.detalhes %>%
  dplyr::filter(`Item de Detalhamento` == "Número do DOI" | `Item de Detalhamento` == "URL do DOI" | `Item de Detalhamento` == "URL")

# to lower case
produtos.detalhes$`Valor do Item de Detalhamento` <-
  tolower(produtos.detalhes$`Valor do Item de Detalhamento`)

# remove NA values from Valor do Item de Detalhamento
produtos.detalhes <- produtos.detalhes %>%
  dplyr::filter(!is.na(`Valor do Item de Detalhamento`))

# limpa as entradas de DOI
produtos.detalhes <- cbind(
  produtos.detalhes,
  doi_cleaner(data.frame(DOI = produtos.detalhes$`Valor do Item de Detalhamento`))
  )

# remove NA values from DOI
produtos.detalhes <- produtos.detalhes %>%
  dplyr::filter(!is.na(DOI))

# create unique ID using ID da Produção e DOI
produtos.detalhes$ID <- 
  paste(produtos.detalhes$`ID da Produção`, produtos.detalhes$DOI, sep = "_")

# remove duplicates based on unique ID
produtos.detalhes <- produtos.detalhes %>%
  dplyr::distinct(ID, .keep_all = TRUE)

# loop across IDs
dois <- data.frame(DOI = produtos.detalhes$DOI)
if (!sjmisc::is_empty(dois)) {
  # cria metadados para rastreio pelo Altmetric
  source("Scripts/altmetric-meta-from-dois.R", local = knitr::knit_global())
  
  # get metrics from Altmetric and CrossRef
  source("Scripts/get-metrics-from-dois.R", local = knitr::knit_global())
  
  # store to use downstream
  doi_with_altmetric_sucupira <-
    get_metrics(
      doi_with_altmetric = doi_with_altmetric,
      doi_without_altmetric = NULL,
      citescore,
      scimago,
      qualis
    )
  doi_without_altmetric_sucupira <-
    get_metrics(
      doi_with_altmetric = NULL,
      doi_without_altmetric = doi_without_altmetric,
      citescore,
      scimago,
      qualis
    )
} else {
  doi_with_altmetric_sucupira = data.frame()
  doi_without_altmetric_sucupira = data.frame()
}

has.metricas.doi.sucupira <- 
  !sjmisc::is_empty(doi_with_altmetric_sucupira) | !sjmisc::is_empty(doi_without_altmetric_sucupira)
```

## **Check DOI produção PPG**

```{r metricas-doi-ppg, cache = TRUE, cache.path = "cache/metricas-doi-ppg/"}

```

## **Check HAS**

```{r has, cache = TRUE, cache.path = "cache/has/"}
# directories
has.sage.files <- as.logical(has.sage.files)
has.sucupira.files <- as.logical(has.sucupira.files)
has.ppg.files <- as.logical(has.ppg.files)

# PPG files
has.agendas.pesquisa <- as.logical(has.agendas.pesquisa)
has.apresentacao <- as.logical(has.apresentacao)
has.area.capes <- as.logical(has.area.capes)
has.autoavaliacao <- as.logical(has.autoavaliacao)
has.avaliacao <- as.logical(has.avaliacao)
has.bibliografia <- as.logical(has.bibliografia)
has.blogs.externos <- as.logical(has.blogs.externos)
has.blog.ies <- as.logical(has.blog.ies)
has.bolsas <- as.logical(has.bolsas)
has.calendarios <- as.logical(has.calendarios)
has.cep <- as.logical(has.cep)
has.convenios <- as.logical(has.convenios)
has.cooperacoes <- as.logical(has.cooperacoes)
has.coordenacao <- as.logical(has.coordenacao)
has.dados.cadastrais <- as.logical(has.dados.cadastrais)
has.destaques <- as.logical(has.destaques)
has.discentes <- as.logical(has.discentes)
has.downloads <- as.logical(has.downloads)
has.editais <- as.logical(has.editais)
has.financiadores <- as.logical(has.financiadores)
has.grupos.pesquisa <- as.logical(has.grupos.pesquisa)
has.historico <- as.logical(has.historico)
has.infraestrutura <- as.logical(has.infraestrutura)
has.internacionalizacao <- as.logical(has.internacionalizacao)
has.laboratorios <- as.logical(has.laboratorios)
has.metodologia <- as.logical(has.metodologia)
has.notas <- as.logical(has.notas)
has.periodicos <- as.logical(has.periodicos)
has.planejamento <- as.logical(has.planejamento)
has.podcasts <- as.logical(has.podcasts)
has.politicas <- as.logical(has.politicas)
has.premios <- as.logical(has.premios)
has.premio.capes <- as.logical(has.premio.capes)
has.producao <- as.logical(has.producao)
has.repositorios.cooperacao <- as.logical(has.repositorios.cooperacao)
has.repositorios.sede <- as.logical(has.repositorios.sede)
has.videos <- as.logical(has.videos)

# metrics sucupira
has.metricas.doi.sucupira <- as.logical(has.metricas.doi.sucupira)
has.metricas.doi.ppg <- as.logical(has.metricas.doi.ppg)
```

## **Agregar dados de produção**

```{r bind-all, cache = TRUE, cache.path = "cache/bind-all/", eval = any(has.sucupira.files, has.ppg.files)}
# bind sources
doi_with_altmetric_all <-
  dplyr::bind_rows(
    doi_with_altmetric_sucupira
  ) %>%
  as.data.frame()

# bind sources
doi_without_altmetric_all <-
  dplyr::bind_rows(
    doi_without_altmetric_sucupira
  ) %>%
  as.data.frame()

# bind common data
doi_all <-
  dplyr::bind_rows(doi_with_altmetric_all,
                   doi_without_altmetric_all) %>%
  as.data.frame()
```

## **Salva arquivos .TSV**

```{r save, eval = TRUE}
# Write doi_with_altmetric_all to TSV file
try(
  write.table(
    doi_with_altmetric_all,
    "doi_with_altmetric_all.tsv",
    quote = FALSE,
    sep = "\t",
    row.names = FALSE,
    col.names = TRUE
  ),
  silent = TRUE
)

# Write doi_without_altmetric_all to TSV file
try(
  write.table(
    doi_without_altmetric_all,
    "doi_without_altmetric_all.tsv",
    quote = FALSE,
    sep = "\t",
    row.names = FALSE,
    col.names = TRUE
  ),
  silent = TRUE
)

# Write doi_all to TSV file
try(
  write.table(
    doi_all,
    "doi_all.tsv",
    quote = FALSE,
    sep = "\t",
    row.names = FALSE,
    col.names = TRUE
  ),
  silent = TRUE
)
```

## **Sessio info**

```{r session-info}
sessioninfo::session_info() %>%
  details::details(summary = 'Current session info',
                   open = FALSE)
```
