---
title: Autoavaliação
output:
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: false
    includes:
      in_header: tex/preamble.tex
      before_body: [tex/cover-1.tex, tex/cover-2.tex]
    latex_engine: xelatex
    keep_tex: false
  html_document:
    toc: true
    toc_float: true
    css:
      - ./CSS/generic.css
      - ./CSS/logo-above-toc.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
documentclass: book
classoption: oneside
papersize: a4
geometry: "top=2cm,left=2cm,right=2cm,bottom=2cm"
link-citations: true
always_allow_html: true
tables: true
params:
  quadrienal.vigente: 2025;2026;2027;2028
  render_document: FALSE
---

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = 'asis',
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)

render_document <- params$render_document

# get from params (header)
quadrienal.vigente <- as.numeric(strsplit(params$quadrienal.vigente, ";")[[1]])

if(has.sucupira.files){
  # get years
  source("Scripts/years-sucupira.R", local = knitr::knit_global())
  
  # ajusta para pastas Sucupira
  quadrienal.vigente <- anos[anos %in% quadrienal.vigente]
}
```

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
  knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

<!--script for inserting LOGO ABOVE THE TOC-->
```{js}
$(document).ready(function() {
$('#TOC').parent().prepend('<div id=\"nav_logo\"><img src="PPG/Images/logo-programa.png"></div>');
});
```

<!--script for sharing-->
<p align="right">
```{r share, eval = all(render_document, knitr::is_html_output())}
home <- metadata$repository_url
source("Scripts/social-media-sharing.R", local = knitr::knit_global())
```
</p>

```{r, eval = all(!render_document, knitr::is_html_output())}
cat('<center><div class="d-grid gap-2" style="width: 100%; display: block;">
  <button class="btn btn-lg btn-primary" type="button">
  <a href="autoavaliacao-2025-2028.html">Quadrienal 2025-2028</a>
  </button>
  <br>
  <br>
  <button class="btn btn-lg btn-primary" type="button">
  <a href="autoavaliacao-2021-2024.html">Quadrienal 2021-2024</a>
  </button>
  <br>
  <br>
  <button class="btn btn-lg btn-primary" type="button">
  <a href="autoavaliacao-2017-2020.html">Quadrienal 2017-2020</a>
  </button>
  <br>
  <br>
  <button class="btn btn-lg btn-primary" type="button">
  <a href="autoavaliacao-2013-2016.html">Quadrienal 2013-2016</a>
  </button>
</div></center>
')
```

<br>

```{r quadrienal-vigente, results = "hide", echo = FALSE, include = FALSE, eval = all(render_document, has.sucupira.files)}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

docentes.quadrienio <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(docentes.quadrienio) <-
  names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter docente permanente
docentes.quadrienio <-
  docentes.quadrienio[docentes.quadrienio$Categoria == "PERMANENTE",]

docentes.quadrienio <-
  docentes.quadrienio %>% dplyr::select(
    "Nome Docente"
  )

# remove duplicates
docentes.quadrienio <- docentes.quadrienio[!duplicated(docentes.quadrienio),]

# to title case
docentes.quadrienio <- sort(tools::toTitleCase(tolower(docentes.quadrienio)))
```

```{r cover-one, echo = FALSE, include = FALSE, eval = all(render_document, knitr::is_html_output())}
source("Scripts/cover-1.R", local = knitr::knit_global())
pdf.file.name <-
  paste0("autoavaliacao-", min(quadrienal.vigente), "-", max(quadrienal.vigente), ".pdf")
source("Scripts/cover-2.R", local = knitr::knit_global())
```

```{=latex}
% unnumbered chapters and arabic page numbering
\backmatter

\clearpage
\markboth{}{}

\EnableFootNotes
```

```{r, eval = all(render_document, knitr::is_html_output(), has.avaliacao)}
cat("## **Avaliação CAPES** {#avalicao-capes .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output(), has.avaliacao)}
cat("## **Avaliação CAPES**")
cat('\n\n')
```

```{r, eval = all(render_document, !has.avaliacao)}
cat('<br>')
```

```{r avaliacao-capes, eval = all(render_document, has.avaliacao), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Avaliação CAPES.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  avaliacao.raw <-
    readxl::read_excel("PPG/Avaliação CAPES.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(avaliacao.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(avaliacao.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
        Abrir[i] <-
          paste0('<a href="',avaliacao.raw[i, ncol(avaliacao.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
      }
    } else {
      if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
        Abrir[i] <-
          paste0('\\url{', avaliacao.raw[i, ncol(avaliacao.raw)],'}')
      }
    }
  }
  
  avaliacao <- cbind(avaliacao.raw[, -ncol(avaliacao.raw)], Abrir)
  table <- avaliacao
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
}
```

<br>

```{=latex}
\newpage
```

```{r, eval = all(render_document, knitr::is_html_output(), has.autoavaliacao)}
cat("## **Autoavaliação PPG** {#autoavalicao-ppg .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output(), has.autoavaliacao)}
cat("## **Autoavaliação PPG**")
cat('\n\n')
```

```{r, eval = all(render_document, !has.autoavaliacao)}
cat('<br>')
```

```{r autoavaliacao-ppg, eval = all(render_document, has.autoavaliacao), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Autoavaliação PPG.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  avaliacao.raw <-
    readxl::read_excel("PPG/Autoavaliação PPG.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(avaliacao.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(avaliacao.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
        Abrir[i] <-
          paste0('<a href="',avaliacao.raw[i, ncol(avaliacao.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
      }
    } else {
      if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
        Abrir[i] <-
          paste0('\\url{', avaliacao.raw[i, ncol(avaliacao.raw)],'}')
      }
    }
  }
  
  avaliacao <- cbind(avaliacao.raw[, -ncol(avaliacao.raw)], Abrir)
  table <- avaliacao
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
}
```

<br>

```{=latex}
\newpage
```

```{r, eval = all(render_document, knitr::is_html_output(), has.planejamento)}
cat("## **Planejamento estratégico** {#planejamento-estrategico .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output(), has.planejamento)}
cat("## **Planejamento estratégico**")
cat('\n\n')
```

```{r, eval = all(render_document, !has.planejamento)}
cat('<br>')
```

```{r planejamento, eval = all(render_document, has.planejamento), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Planejamento estratégico.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  planejamento.raw <-
    readxl::read_excel("PPG/Planejamento estratégico.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(planejamento.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(planejamento.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(planejamento.raw[i, ncol(planejamento.raw)])) {
        Abrir[i] <-
          paste0('<a href="',planejamento.raw[i, ncol(planejamento.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
      }
    } else {
      if (!is.na(planejamento.raw[i, ncol(planejamento.raw)])) {
        Abrir[i] <-
          paste0('\\url{', planejamento.raw[i, ncol(planejamento.raw)],'}')
      }
    }
  }
  
  planejamento <- cbind(planejamento.raw[, -ncol(planejamento.raw)], Abrir)
  table <- planejamento
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  } 
}
```

<br>

```{=latex}
\newpage
```

```{r, eval = all(render_document, knitr::is_html_output(), has.sucupira.files)}
cat("## **Preenchimento do Coleta** {#coleta .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output(), has.sucupira.files)}
cat("## **Preenchimento do Coleta**")
cat('\n\n')
```

```{r preenchimento-coleta, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# Get amount of data from Sucupira XLSX files
source("Scripts/get-sucupira-sheets-names.R", local = knitr::knit_global())

summ.df <- data.frame(
  "Ano" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Aba" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Dimensão (Linhas)" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  check.names = FALSE
)

if (has.sucupira.files) {
  for (ROW in 1:length(sucupira.sheets)) {
    sheet <- sucupira.sheets[ROW]
    source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
    # Get yearly data from Sucupira XLSX files
    names(sucupira.list) <- as.character(anos)
    sucupira.quadr <- sucupira.list[as.character(quadrienal.vigente)]
    for (COL in 1:length(quadrienal.vigente)) {
      ano <- quadrienal.vigente[COL]
      summ.df$Ano[COL + length(quadrienal.vigente)*(ROW - 1)] <- ano
      summ.df$Aba[COL + length(quadrienal.vigente)*(ROW - 1)] <- sheet
      summ.df$`Dimensão (Linhas)`[COL + length(quadrienal.vigente)*(ROW - 1)] <-
        nrow(!is.na(sucupira.list[[as.character(ano)]]))
    }
  }
}

# transpose years as columns
summ.df <- tidyr::pivot_wider(
  data = summ.df,
  names_from = Ano,
  values_from = `Dimensão (Linhas)`
)

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(summ.df)) {
  # use kable for HTML output
  knitr::kable(
    summ.df,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Prenchimento do Coleta - Quantidade de dados por aba, por ano"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/(length(quadrienal.vigente)), times = length(quadrienal.vigente)))*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(summ.df)) {
  # use tinytable for LaTeX output
  summ.df <- data.frame(summ.df, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    summ.df,
    width = c(0.60, rep(0.40/(length(quadrienal.vigente)), times = length(quadrienal.vigente)))*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Prenchimento do Coleta - Quantidade de dados por aba, por ano"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(summ.df), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(summ.df), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{=latex}
\newpage
\vspace*{\fill}
\section{\textbf{1. Programa}}
\vspace*{\fill}
\newpage
```

```{r 1-Programa, eval = all(render_document, knitr::is_html_output())}
cat("## **1. Programa** {#programa .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r 1-1-1, eval = all(render_document, knitr::is_html_output())}
cat("### **1.1.1**")
cat('\n\n')
cat("#### **Estrutura Acadêmica do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.1.1 Estrutura Acadêmica do Programa**")
cat('\n\n')
```

```{r cursos-objetivos, eval = all(render_document, has.dados.cadastrais), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Objetivos do curso**")
  cat('\n\n')
}

cursos.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "Cursos",
                     col_types = c("text"))

cursos <- dplyr::select(cursos.raw, c("Nível", "Objetivos"))

# print tables
if (knitr::is_html_output() & !sjmisc::is_empty(cursos)) {
  # use kable for HTML output
  knitr::kable(
    cursos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Objetivos do Curso"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(cursos), width = paste0(c(0.10,0.90)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(summ.df)){
  # use tinytable for LaTeX output
  cursos <- data.frame(cursos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    cursos,
    width = c(0.10,0.90)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Objetivos do Curso"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(cursos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(cursos), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r cursos-egressos, eval = all(render_document, has.dados.cadastrais), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Perfil de egressos**")
  cat('\n\n')
}

cursos.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "Perfil de Egressos",
                     col_types = c("text"))

cursos <- dplyr::select(cursos.raw, c("Nível", "Perfil de Egressos"))

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    cursos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Perfil de Egressos"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(cursos), width = paste0(c(0.10,0.90)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else {
  # use tinytable for LaTeX output
  cursos <- data.frame(cursos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    cursos,
    width = c(0.10,0.90)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Perfil de Egressos"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(cursos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(cursos), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind("Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]), sucupira[[i]])
}
sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter docente responsável
sucupira.df <- sucupira.df[sucupira.df$`Membro Responsável` == "Sim",]

# filter docentes only
sucupira.df <- sucupira.df[sucupira.df$`Categoria do Membro do Projeto` == "Docente",]

# keep docente permanente only
sucupira.df <-
  sucupira.df[sucupira.df$`Nome do Membro do Projeto` %in% toupper(docentes.quadrienio), ]

sucupira.df <-
  sucupira.df %>% dplyr::select(
    "Identificador do Projeto de Pesquisa",
    "Anos",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Categoria do Membro do Projeto",
    "Data de Início",
    "Data da Situação",
    "Situação"
  )
sucupira.df$`Área de Concentração` <- tools::toTitleCase(tolower(sucupira.df$`Área de Concentração`))
sucupira.df$`Linha de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Linha de Pesquisa`))
sucupira.df$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Nome do Projeto de Pesquisa`))
sucupira.df$`Natureza do Projeto de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Natureza do Projeto de Pesquisa`))
sucupira.df$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(sucupira.df$`Nome do Membro do Projeto`))
sucupira.df$`Categoria do Membro do Projeto` <- tools::toTitleCase(tolower(sucupira.df$`Categoria do Membro do Projeto`))
sucupira.df$`Situação` <- tools::toTitleCase(tolower(sucupira.df$`Situação`))

# remove duplicates
sucupira.df <- sucupira.df[!duplicated(sucupira.df),]

# if duplicated, keep Situacão = Concluído
sucupira.df <- sucupira.df[!duplicated(sucupira.df[1:7], fromLast = TRUE),]

# if NA, replace values
sucupira.df$`Área de Concentração`[is.na(sucupira.df$`Área de Concentração`)] <- "Indefinida"
sucupira.df$`Linha de Pesquisa`[is.na(sucupira.df$`Linha de Pesquisa`)] <- "Indefinida"
sucupira.df$`Natureza do Projeto de Pesquisa`[is.na(sucupira.df$`Natureza do Projeto de Pesquisa`)] <- "Indefinida"

# get financiadores from another Sucupira worksheet
sheet <- "Projetos - Financiadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# select variables related to financiadores
sucupira <- sucupira %>%
  lapply(function(x) {
    x <- x %>%
      dplyr::select(
        "Identificador do Projeto de Pesquisa",
        "Nome do Financiador",
        "Natureza do Financiador",
        "Financiador Estrangeiro",
        "Data Início Financiador",
        "Data Fim Financiador"
      )
  })

# remove duplicates
sucupira <- lapply(sucupira, function(x) x[!duplicated(x),])

# match financiadores with projects
sucupira.financiadores <- list()
for (i in 1:length(sucupira)) {
  sucupira.financiadores[[i]] <- dplyr::left_join(sucupira.df, sucupira[[i]], by = "Identificador do Projeto de Pesquisa", keep = FALSE)
  # remove rows with NA values inyroduced after left_join 
  sucupira.financiadores[[i]] <- sucupira.financiadores[[i]][!is.na(sucupira.financiadores[[i]][, which(names(sucupira.financiadores[[i]]) == "Data Início Financiador")]), ]
}

# to dataframe
sucupira.financiadores.df <- data.frame(do.call(dplyr::bind_rows, sucupira.financiadores), check.names = FALSE)

# remove duplicates
sucupira.financiadores.df <- sucupira.financiadores.df[!duplicated(sucupira.financiadores.df),]

sucupira.financiadores.df$`Data Fim Financiador`[is.na(sucupira.financiadores.df$`Data Fim Financiador`)] <- "Atual"
```

```{r 1-1-1-ac, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# áreas de concentração
table.ac <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Área de Concentração`)),
    ncol = length(quadrienal.vigente)
  ), check.names = FALSE)
rownames(table.ac) <- NULL
table.ac <-
  cbind(unique(sucupira.df$`Área de Concentração`), table.ac)
colnames(table.ac) <-
  c("Área de Concentração", as.character(quadrienal.vigente))
for (i in 1:dim(table.ac)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.ac[i, j + 1] <-
      try(data$`Área de Concentração`[match(table.ac$`Área de Concentração`[i],
                                            data$`Área de Concentração`)], silent = TRUE)
  }
}

table.ac.long <-
  tidyr::gather(dplyr::select(table.ac, -1),
                "Ano",
                "Área de Concentração",
                colnames(table.ac)[-1],
                factor_key = TRUE)

# to title case
table.ac.long$`Área de Concentração` <- tools::toTitleCase(tolower(table.ac.long$`Área de Concentração`))

table.ac.long <- rbind(
  table.ac.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.ac)[1]),
    "Área de Concentração" = rep("Áreas", times = dim(table.ac)[1]),
    check.names = FALSE
  )
)

# docentes por área de concentração
table.ac.doc <- table(
  sucupira.df$Anos[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Área de Concentração`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Nome do Membro do Projeto`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]
) %>% as.data.frame(check.names = FALSE)
# drop Freq = 0
table.ac.doc <- table.ac.doc[table.ac.doc$Freq > 0, ]

if(!sjmisc::is_empty(table.ac.doc)){
  # select AC e Docentes
  table.ac.doc <- dplyr::select(as.data.frame(table.ac.doc), "Var1", "Var2", "Var3")
  names(table.ac.doc) <- c("Ano", "Área de Concentração", "Docente")
  # count docentes per year per AC
  table.ac.doc.freq <- table.ac.doc %>%
    dplyr::group_by(Ano, `Área de Concentração`) %>%
    dplyr::summarise(Docente = n())
  
  # long format
  table.ac.doc.long <- data.frame()
  for(i in 1:dim(table.ac.doc.freq)[1]){
    table.ac.doc.long <- rbind(table.ac.doc.long,
                               data.frame("Ano" = rep(table.ac.doc.freq$Ano[i], times = table.ac.doc.freq$Docente[i]),
                                          "Área de Concentração" = rep(table.ac.doc.freq$`Área de Concentração`[i], times = table.ac.doc.freq$Docente[i]),
                                          "Docente" = rep(table.ac.doc.freq$Docente[i], times = table.ac.doc.freq$Docente[i]),
                                          check.names = FALSE))
  }
  # rename and drop columns
  table.ac.doc.long <- dplyr::select(table.ac.doc.long, "Ano", "Área de Concentração")
  names(table.ac.doc.long) <- c("Ano", "Docente Permanente")
  
  table.ac.doc.long <- rbind(
    table.ac.doc.long,
    data.frame(
      "Ano" = rep(paste0(
        min(quadrienal.vigente), "-", max(quadrienal.vigente)
      ), times = length(unique(table.ac.doc$Docente))),
      "Docente Permanente" = rep("Áreas", times = length(unique(table.ac.doc$Docente))),
      check.names = FALSE
    )
  )
}

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Áreas", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.ac.long <- table.ac.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.ac)){
  table.ac.gt <-
    gtsummary::tbl_summary(
      table.ac.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Área de Concentração'),
      type = "level",
      level_value = ("Áreas")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.ac.gt <- list()
}

# print tables
if(!sjmisc::is_empty(table.ac)){
  table.ac.doc.gt <-
    gtsummary::tbl_summary(
      table.ac.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Docente Permanente'),
      type = "level",
      level_value = ("Áreas")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.ac.doc.gt <- list()
}
```

```{r 1-1-1-AC, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **AC** {#descricao-ac}")
  cat('\n\n')
}

# list all tables
table.1.1.1.ac <-
  list(table.ac.gt,
       table.ac.doc.gt
  )

# drop empty elements from list
table.1.1.1.ac <- table.1.1.1.ac[lapply(table.1.1.1.ac, length) > 0]
if(any(lapply(table.1.1.1.ac, length) > 0)){
  table.1.1.1.ac <- gtsummary::tbl_stack(table.1.1.1.ac)
} else {
  table.1.1.1.ac <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.1.1.ac)) {
  table.1.1.1.ac <- table.1.1.1.ac %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.1.1.ac)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.1.1.ac)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.1.ac,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Áreas de Concentração")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-AC-detalhes, eval = all(render_document, has.dados.cadastrais), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# read data
area.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "AC",
                     col_types = c("text"))
area.ativas <- area.raw
area.ativas$Fim[is.na(area.ativas$Fim)] <- "Atual"

# to title case
area.ativas$'Área de Concentração' <- tools::toTitleCase(tolower(area.ativas$'Área de Concentração'))

# print tables
ids <- order(area.ativas$'Área de Concentração', decreasing = FALSE)
area.ativas <- area.ativas[ids,]

# add ID
area.ativas <- cbind(
  seq(1, dim(area.ativas)[1]),
  area.ativas
)
colnames(area.ativas) <-
  c("ID",colnames(area.ativas)[-1])
rownames(area.ativas) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    area.ativas,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Áreas de Concentração"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(area.ativas), width = paste0(c(0.05,0.30,0.45,0.10,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else {
  # use tinytable for LaTeX output
  area.ativas <- data.frame(area.ativas, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    area.ativas,
    width = c(0.05,0.30,0.45,0.10,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Áreas de Concentração"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(area.ativas), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(area.ativas), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-lp, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.lp <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Linha de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.lp) <- NULL
table.lp <- cbind(unique(sucupira.df$`Linha de Pesquisa`), table.lp)
colnames(table.lp) <-
  c("Linha de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.lp)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.lp[i, j + 1] <-
      try(data$`Linha de Pesquisa`[match(table.lp$`Linha de Pesquisa`[i], data$`Linha de Pesquisa`)]
          , silent = TRUE)
  }
}

table.lp.long <-
  tidyr::gather(dplyr::select(table.lp, -1),
                "Ano",
                "Linha de Pesquisa",
                colnames(table.lp)[-1],
                factor_key = TRUE)

# to title case
table.lp.long$`Linha de Pesquisa` <- tools::toTitleCase(tolower(table.lp.long$`Linha de Pesquisa`))

table.lp.long <- rbind(table.lp.long,
                       data.frame(
                         "Ano" = rep(paste0(
                           min(quadrienal.vigente), "-", max(quadrienal.vigente)
                         ), times = dim(table.lp)[1]),
                         "Linha de Pesquisa" = rep("Linhas", times = dim(table.lp)[1]),
                         check.names = FALSE
                       ))

# docentes por linha de pesquisa
table.lp.doc <- table(
  sucupira.df$Anos[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Linha de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Nome do Membro do Projeto`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]
) %>% as.data.frame()
# drop Freq = 0
table.lp.doc <- table.lp.doc[table.lp.doc$Freq > 0, ]

if(!sjmisc::is_empty(table.lp)){
  # select AC e Docentes
  table.lp.doc <- dplyr::select(as.data.frame(table.lp.doc), "Var1", "Var2", "Var3")
  names(table.lp.doc) <- c("Ano", "Linha de Pesquisa", "Docente")
  # count docentes per year per AC
  table.lp.doc.freq <- table.lp.doc %>%
    dplyr::group_by(Ano, `Linha de Pesquisa`) %>%
    dplyr::summarise(Docente = n())
  
  # long format
  table.lp.doc.long <- data.frame()
  for(i in 1:dim(table.lp.doc.freq)[1]){
    table.lp.doc.long <- rbind(table.lp.doc.long,
                               data.frame("Ano" = rep(table.lp.doc.freq$Ano[i], times = table.lp.doc.freq$Docente[i]),
                                          "Linha de Pesquisa" = rep(table.lp.doc.freq$`Linha de Pesquisa`[i], times = table.lp.doc.freq$Docente[i]),
                                          "Docente" = rep(table.lp.doc.freq$Docente[i], times = table.lp.doc.freq$Docente[i]),
                                          check.names = FALSE))
  }
  
  # rename and drop columns
  table.lp.doc.long <- dplyr::select(table.lp.doc.long, "Ano", "Linha de Pesquisa")
  names(table.lp.doc.long) <- c("Ano", "Docente Permanente")
  
  table.lp.doc.long <- rbind(
    table.lp.doc.long,
    data.frame(
      "Ano" = rep(paste0(
        min(quadrienal.vigente), "-", max(quadrienal.vigente)
      ), times = length(unique(table.lp.doc$Docente))),
      "Docente Permanente" = rep("Linhas", times = length(unique(table.lp.doc$Docente))),
      check.names = FALSE
    )
  )
}

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Linhas", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.lp.long <- table.lp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.lp)){
  table.lp.gt <-
    gtsummary::tbl_summary(
      table.lp.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Linha de Pesquisa'),
      type = "level",
      level_value = ("Linhas")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.lp.gt <- list()
}

# print tables
if(!sjmisc::is_empty(table.lp)){
  table.lp.doc.gt <-
    gtsummary::tbl_summary(
      table.lp.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Docente Permanente'),
      type = "level",
      level_value = ("Linhas")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.lp.doc.gt <- list()
}
```

```{r 1-1-1-LP, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **LP** {#descricao-lp}")
  cat('\n\n')
}

# list all tables
table.1.1.1.lp <-
  list(table.lp.gt,
       table.lp.doc.gt
  )

# drop empty elements from list
table.1.1.1.lp <- table.1.1.1.lp[lapply(table.1.1.1.lp, length) > 0]
if(any(lapply(table.1.1.1.lp, length) > 0)){
  table.1.1.1.lp <- gtsummary::tbl_stack(table.1.1.1.lp)
} else {
  table.1.1.1.lp <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.1.1.lp)) {
  
  table.1.1.1.lp <- table.1.1.1.lp %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.1.1.lp)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.1.1.lp)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.1.lp,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Linhas de Pesquisa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-LP-detalhes, eval = all(render_document, has.dados.cadastrais), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# read data
linhas.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "LP",
                     col_types = c("text"))
linhas.atual <- linhas.raw[is.na(linhas.raw$Fim), ]
linhas.atual$Fim[is.na(linhas.atual$Fim)] <- "Atual"

# to title case
linhas.atual$'Linhas de Pesquisa' <- tools::toTitleCase(tolower(linhas.atual$'Linhas de Pesquisa'))

# print tables
ids <- order(linhas.atual$'Linhas de Pesquisa', decreasing = FALSE)
linhas.atual <- linhas.atual[ids,]

# add ID
linhas.atual <- cbind(
  seq(1, dim(linhas.atual)[1]),
  linhas.atual
)
colnames(linhas.atual) <-
  c("ID",colnames(linhas.atual)[-1])
rownames(linhas.atual) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    linhas.atual,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Linhas de Pesquisa"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(linhas.atual), width = paste0(c(0.05,0.30,0.45,0.10,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else {
  # use tinytable for LaTeX output
  linhas.atual <- data.frame(linhas.atual, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    linhas.atual,
    width = c(0.05,0.30,0.45,0.10,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Linhas de Pesquisa"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(linhas.atual), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(linhas.atual), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-pp-lp, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.pp <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp) <- NULL
table.pp <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp)
colnames(table.pp) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp[i, j + 1] <-
      try(data$`Linha de Pesquisa`[match(table.pp$`Nome do Projeto de Pesquisa`[i],
                                         data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.long <-
  tidyr::gather(dplyr::select(table.pp, -1),
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp)[-1],
                factor_key = TRUE)

# to title case
table.pp.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.long$`Nome do Projeto de Pesquisa`))

table.pp.long <- rbind(
  table.pp.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp)[1]),
    "Nome do Projeto de Pesquisa" = rep("Projetos", times = dim(table.pp)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Projetos", na.rm = TRUE), digits = 0)
}

colnames(table.pp.long) <-
  c("Ano", "Projeto por Linha de Pesquisa")

# change all column types to factors
table.pp.long <- table.pp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.pp)){
  table.pp.gt <-
    gtsummary::tbl_summary(
      table.pp.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Projeto por Linha de Pesquisa'),
      type = "level",
      level_value = ("Projetos")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.pp.gt <- list()
}
```

```{r 1-1-1-pp-natureza, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.pp.nt <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.nt) <- NULL
table.pp.nt <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp.nt)
colnames(table.pp.nt) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.nt)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp.nt[i, j + 1] <-
      try(data$`Natureza do Projeto de Pesquisa`[match(table.pp.nt$`Nome do Projeto de Pesquisa`[i],
                                                       data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.nt.long <-
  tidyr::gather(dplyr::select(table.pp.nt, -1),
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp.nt)[-1],
                factor_key = TRUE)

# to title case
table.pp.nt.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.nt.long$`Nome do Projeto de Pesquisa`))

table.pp.nt.long <- rbind(
  table.pp.nt.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.nt)[1]),
    "Nome do Projeto de Pesquisa" = rep("Projetos", times = dim(table.pp.nt)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Projetos", na.rm = TRUE), digits = 0)
}

colnames(table.pp.nt.long) <-
  c("Ano", "Natureza do projeto")

# print tables
if(!sjmisc::is_empty(table.pp.nt)){
  table.pp.nt.gt <-
    gtsummary::tbl_summary(
      table.pp.nt.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Natureza do projeto'),
      type = "level",
      level_value = ("Projetos")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.pp.nt.gt <- list()
}
```

```{r 1-1-1-pp-membro, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.pp.membro <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.membro) <- NULL
table.pp.membro <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp.membro)
colnames(table.pp.membro) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.membro)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp.membro[i, j + 1] <-
      try(data$`Categoria do Membro do Projeto`[match(table.pp.membro$`Nome do Projeto de Pesquisa`[i],
                                                      data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.membro.long <-
  tidyr::gather(dplyr::select(table.pp.membro, -1),
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp.membro)[-1],
                factor_key = TRUE)

# to title case
table.pp.membro.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.membro.long$`Nome do Projeto de Pesquisa`))

table.pp.membro.long <- rbind(
  table.pp.membro.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.membro)[1]),
    "Nome do Projeto de Pesquisa" = rep("Responsável", times = dim(table.pp.membro)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Responsável", na.rm = TRUE), digits = 0)
}

colnames(table.pp.membro.long) <-
  c("Ano", "Categoria do responsável")

# change all column types to factors
table.pp.membro <- table.pp.membro %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.pp.membro)){
  table.pp.membro.gt <-
    gtsummary::tbl_summary(
      table.pp.membro.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Categoria do responsável'),
      type = "level",
      level_value = ("Responsável")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.pp.membro.gt <- list()
}
```

```{r 1-1-1-pp-auxilios, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter by type of financiamento = AUXILIO
sucupira.aux.df <- sucupira.financiadores.df[sucupira.financiadores.df$`Natureza do Financiador` == "OUTRO AUXÍLIO FINANCEIRO", ]

table.pp.financiamento <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.aux.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.financiamento) <- NULL
table.pp.financiamento <-
  cbind(unique(sucupira.aux.df$`Nome do Projeto de Pesquisa`), table.pp.financiamento)
colnames(table.pp.financiamento) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.financiamento)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.aux.df[sucupira.aux.df$Anos == quadrienal.vigente[j],]
    table.pp.financiamento[i, j + 1] <-
      try(data$`Nome do Financiador`[match(table.pp.financiamento$`Nome do Projeto de Pesquisa`[i],
                                           data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.financiamento.long <-
  tidyr::gather(dplyr::select(table.pp.financiamento, -1),
                "Ano",
                "Nome do Financiador",
                colnames(table.pp.financiamento)[-1],
                factor_key = TRUE)

# to title case
table.pp.financiamento.long$`Nome do Financiador` <- tools::toTitleCase(tolower(table.pp.financiamento.long$`Nome do Financiador`))

table.pp.financiamento.long <- rbind(
  table.pp.financiamento.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.financiamento)[1]),
    "Nome do Financiador" = rep("Financiador", times = dim(table.pp.financiamento)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Financiador", na.rm = TRUE), digits = 0)
}

colnames(table.pp.financiamento.long) <-
  c("Ano", "Auxílios")

# change all column types to factors
table.pp.financiamento <- table.pp.financiamento %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.pp.financiamento)){
  table.pp.auxilio.gt <-
    gtsummary::tbl_summary(
      table.pp.financiamento.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Auxílios'),
      type = "level",
      level_value = ("Financiador")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.pp.auxilio.gt <- list()
}
```

```{r 1-1-1-pp-bolsas, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter by type of financiamento = BOLSA
sucupira.bolsas.df <- sucupira.financiadores.df[sucupira.financiadores.df$`Natureza do Financiador` == "BOLSA", ]

table.pp.financiamento <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.bolsas.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.financiamento) <- NULL
table.pp.financiamento <-
  cbind(unique(sucupira.bolsas.df$`Nome do Projeto de Pesquisa`), table.pp.financiamento)
colnames(table.pp.financiamento) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.financiamento)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.bolsas.df[sucupira.bolsas.df$Anos == quadrienal.vigente[j],]
    table.pp.financiamento[i, j + 1] <-
      try(data$`Nome do Financiador`[match(table.pp.financiamento$`Nome do Projeto de Pesquisa`[i],
                                           data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.financiamento.long <-
  tidyr::gather(dplyr::select(table.pp.financiamento, -1),
                "Ano",
                "Nome do Financiador",
                colnames(table.pp.financiamento)[-1],
                factor_key = TRUE)

# to title case
table.pp.financiamento.long$`Nome do Financiador` <- tools::toTitleCase(tolower(table.pp.financiamento.long$`Nome do Financiador`))

table.pp.financiamento.long <- rbind(
  table.pp.financiamento.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.financiamento)[1]),
    "Nome do Financiador" = rep("Financiador", times = dim(table.pp.financiamento)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Financiador", na.rm = TRUE), digits = 0)
}

colnames(table.pp.financiamento.long) <-
  c("Ano", "Bolsas")

# change all column types to factors
table.pp.financiamento <- table.pp.financiamento %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.pp.financiamento)){
  table.pp.bolsa.gt <-
    gtsummary::tbl_summary(
      table.pp.financiamento.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Bolsas'),
      type = "level",
      level_value = ("Financiador")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.pp.bolsa.gt <- list()
}
```

```{r 1-1-1-PP-DP, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **PP** {#descricao-pp}")
  cat('\n\n')
}

# list all tables
table.1.1.1.ppdp <-
  list(table.pp.gt,
       table.pp.nt.gt,
       table.pp.membro.gt,
       table.pp.auxilio.gt,
       table.pp.bolsa.gt
  )

# drop empty elements from list
table.1.1.1.ppdp <- table.1.1.1.ppdp[lapply(table.1.1.1.ppdp, length) > 0]
if(any(lapply(table.1.1.1.ppdp, length) > 0)){
  table.1.1.1.ppdp <- gtsummary::tbl_stack(table.1.1.1.ppdp)
} else {
  table.1.1.1.ppdp <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.1.1.ppdp)) {
  table.1.1.1.ppdp <- table.1.1.1.ppdp %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.1.1.ppdp)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.1.1.ppdp)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.1.ppdp,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Projetos Liderados por Docentes Permanentes")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\blandscape

```{r 1-1-1-PP-DP-landscape, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# select data
table.projetos <- dplyr::select(
  sucupira.financiadores.df,
  "Identificador do Projeto de Pesquisa",
  "Área de Concentração",
  "Linha de Pesquisa",
  "Nome do Projeto de Pesquisa",
  "Natureza do Projeto de Pesquisa",
  "Nome do Membro do Projeto",
  "Situação",
  "Nome do Financiador",
  "Natureza do Financiador"
)

# remove duplicates
table.projetos <- table.projetos[!duplicated(table.projetos),]

# split Natureza do Financiador em Bolsas e Outros Auxílios
table.projetos <- table.projetos %>%
  dplyr::mutate(
    Bolsa = ifelse(`Natureza do Financiador` == "BOLSA", `Nome do Financiador`, NA),
    Auxílio = ifelse(`Natureza do Financiador` == "OUTRO AUXÍLIO FINANCEIRO", `Nome do Financiador`, NA)
  )

# sort by Linha de Pesquisa
table.projetos <- table.projetos[order(table.projetos$`Área de Concentração`, table.projetos$`Linha de Pesquisa`, table.projetos$`Nome do Projeto de Pesquisa`),]

# if duplicated, keep Situacão = Concluído
ids <- unique(table.projetos$`Identificador do Projeto de Pesquisa`)
output <- data.frame(
  "ID" = rep(NA, length(ids)),
  "Área de Concentração" = rep(NA, length(ids)),
  "Linha de Pesquisa" = rep(NA, length(ids)),
  "Projeto" = rep(NA, length(ids)),
  "Natureza" = rep(NA, length(ids)),
  "Responsável" = rep(NA, length(ids)),
  "Bolsa" = rep(NA, length(ids)),
  "Auxílio" = rep(NA, length(ids)),
  "Situação" = rep(NA, length(ids)),
  check.names = FALSE
)

if(!sjmisc::is_empty(ids)){
  for (i in 1:length(ids)) {
    data <- table.projetos[table.projetos$`Identificador do Projeto de Pesquisa` == ids[i], ]
    output$ID[i] <- unique(data$`Identificador do Projeto de Pesquisa`)
    output$`Área de Concentração`[i] <- unique(data$`Área de Concentração`)
    output$`Linha de Pesquisa`[i] <- unique(data$`Linha de Pesquisa`)
    output$Projeto[i] <- unique(data$`Nome do Projeto de Pesquisa`)
    output$Natureza[i] <- unique(data$`Natureza do Projeto de Pesquisa`)
    output$Responsável[i] <- unique(data$`Nome do Membro do Projeto`)
    n.bolsas <- sum(!is.na(data$Bolsa))
    if(n.bolsas > 0){
      output$Bolsa[i] <- paste0("(", 1:n.bolsas, ") ", na.omit(tools::toTitleCase(tolower(unique(data$Bolsa)))), collapse = "; ")
    } else {
      output$Bolsa[i] <- ""
    }
    n.auxilios <- sum(!is.na(data$Auxílio))
    if(n.auxilios > 0){
      output$Auxílio[i] <- paste0("(", 1:n.auxilios, ") ", na.omit(tools::toTitleCase(tolower(unique(data$Auxílio)))), collapse = "; ")
    } else {
      output$Auxílio[i] <- ""
    }
    output$Situação[i] <- unique(data$Situação)
  }
  table.projetos <- output
  
  # add ID to the dataframe
  table.projetos$ID <- seq(1, dim(table.projetos)[1])
  
  # Escape characters in table data & % $ # _ { }
  if(knitr::is_latex_output()) {
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
    try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
  }
  
  table.projetos <- as.data.frame(table.projetos, check.names = FALSE)
  
  colnames(table.projetos) <-
    c(
      "ID",
      "Área de Concentração",
      "Linha de Pesquisa",
      "Projeto",
      "Natureza",
      "Responsável",
      "Bolsa",
      "Auxílio",
      "Situação"
    )
  rownames(table.projetos) <- NULL
  
  # unique paired matrix of area de concentração and linha de pesquisa
  AC.LP <- unique(table.projetos[, c("Área de Concentração", "Linha de Pesquisa")])
  
  # create list of tables
  lista.AC.LP <- list()
  for (item in 1:dim(AC.LP)[1]) {
    lista.AC.LP[[item]] <- table.projetos[table.projetos$`Área de Concentração` == AC.LP[item,1] & table.projetos$`Linha de Pesquisa` == AC.LP[item,2], ]
  }
} else {
  lista.AC.LP <- NULL
  AC.LP <- NULL
}
```

```{r, eval = all(render_document, has.sucupira.files)}
# Create R Markdown chunks dynamically because projetos can be very large tables

out.1 <- NULL

if (!sjmisc::is_empty(lista.AC.LP)) {
  for (i in 1:length(lista.AC.LP)) {
    # Define table caption
    caption.1 <- paste0('Projetos Liderados por Docentes Permanentes - Área de Concentração: ', toupper(AC.LP[i, 1]), ' - ', 'Linha de Pesquisa: ', toupper(AC.LP[i, 2]))
    
    # Drop columns Area de Concentração, Linha de Pesquisa
    lista.AC.LP[[i]] <- dplyr::select(lista.AC.LP[[i]], -c('Área de Concentração', 'Linha de Pesquisa'))
    
    # Generate R Markdown code for this chunk
    knit_expanded.1 <- paste0(
      "\n\n```{r, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}\n\n",
      "cat('\\n\\n<!-- -->\\n\\n')\n\n",
      "# print tables\n\n",
      "if (knitr::is_html_output()) {\n\n",
      "  # use kable for HTML output\n\n",
      "  knitr::kable(\n\n",
      "    lista.AC.LP[[", i, "]],\n\n",
      "    align = 'l',\n\n",
      "    escape = FALSE,\n\n",
      "    format = 'html',\n\n",
      "    booktabs = TRUE,\n\n",
      "    linesep = '',\n\n",
      "    caption = '", caption.1, "',\n\n",
      "    row.names = FALSE) %>% \n\n",
      "    kableExtra::kable_styling(\n\n",
      "      bootstrap_options = c('striped', 'hover', 'condensed', 'responsive'),\n\n",
      "      full_width = TRUE,\n\n",
      "      position = 'center'\n\n",
      "    ) %>% \n\n",
      "    kableExtra::column_spec(column = 1:ncol(lista.AC.LP[[", i, "]]), width = paste0(c(0.02,0.21,0.08,0.16,0.20,0.20,0.13)*(29-3-3), 'cm')) %>% \n\n",
      "    kableExtra::column_spec(column = 1, bold = TRUE) %>% \n\n",
      "    kableExtra::row_spec(row = 0, bold = TRUE) %>% \n\n",
      "    kableExtra::footnote(\n\n",
      "       general_title = '<strong>Fontes</strong>: ',\n\n",
      "       general = c('<a href=\"https://sucupira.capes.gov.br/sucupira/\">Plataforma Sucupira</a>'),\n\n",
      "       escape = FALSE)\n\n",
      "} else {\n\n",
      "  # use tinytable for LaTeX output\n\n",
      "  linhas.atual <- data.frame(lista.AC.LP[[", i, "]], check.names = FALSE)\n\n",
      "  options(tinytable_print_output = 'latex')\n\n",
      "  tinytable::tt(\n\n",
      "    linhas.atual,\n\n",
      "    width = c(0.02,0.21,0.08,0.16,0.20,0.20,0.13)*(29-3-3),\n\n",
      "    style = 'bootstrap',\n\n",
      "    align = 'l',\n\n",
      "    caption = '", caption.1, "',\n\n",
      "    notes = list(\n\n",
      "      '\\\\textbf{Fontes}: \\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}'\n\n",
      "    ),\n\n",
      "    row.names = FALSE\n\n",
      "  ) %>% \n\n",
      "    tinytable::theme_tt('multipage', rowhead = 1, latex_float = 'H') %>% \n\n",
      "    tinytable::style_tt(i = 0, j = 1:ncol(lista.AC.LP[[", i, "]]), bold = TRUE) %>% \n\n",
      "    tinytable::style_tt(i = 1:nrow(lista.AC.LP[[", i, "]]), j = 1, bold = TRUE)\n\n",
      "    cat('\\\\newpage')\n\n",
      "}\n\n",
      "\n\n```"
    )
    
    out.1 <- c(out.1, knit_expanded.1)
  }
}
```

<!--- knit those table chunk statements --> 
`r if(all(exists("out.1"), try(!sjmisc::is_empty(out.1), silent = TRUE), render_document, has.sucupira.files)){paste(knitr::knit(text = out.1), collapse = '\n\n')}`

\newpage

```{r coerencia-abrangencia-ac-lp-pp, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Coerência e Abrangência** {#coerencia-abrangencia}")
  cat('\n\n')
}

# tabela com lista de AC, LP e PP (títulos apenas)
coerencia <- sucupira.df %>% dplyr::select("Área de Concentração", "Linha de Pesquisa", "Nome do Projeto de Pesquisa")

# remove duplicates
coerencia <- coerencia[!duplicated(coerencia),]


# convert to horizontal table
coerencia.tbl <- matrix(NA,
                        nrow = 0,
                        ncol = length(unique(coerencia$`Área de Concentração`)) * length(unique(coerencia$`Linha de Pesquisa`)))
try(colnames(coerencia.tbl) <- paste0("AC: ",
                                      rep(unique(coerencia$`Área de Concentração`), each = length(unique(
                                        coerencia$`Linha de Pesquisa`
                                      ))),
                                      " - ",
                                      "LP: ",
                                      rep(unique(coerencia$`Linha de Pesquisa`), times = length(unique(
                                        coerencia$`Área de Concentração`
                                      )))),
    silent = TRUE)

coerencia.tbl <- coerencia.tbl %>% as.data.frame(check.names = FALSE)

# rbind Nome do Projeto to the respective column
for(i in 1:dim(coerencia)[1]){
  which.col <- which(colnames(coerencia.tbl) == paste0("AC: ", coerencia$`Área de Concentração`[i], " - ", "LP: ", coerencia$`Linha de Pesquisa`[i]))
  coerencia.tbl[i, which.col] <- coerencia$`Nome do Projeto de Pesquisa`[i]
}

# sort each column
coerencia.tbl <- coerencia.tbl %>% dplyr::mutate(across(everything(), ~sort(., na.last = TRUE)))

# keep rows with at least 1 non-NA value
coerencia.tbl <- coerencia.tbl[rowSums(!is.na(coerencia.tbl)) > 0,]

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(coerencia.tbl <- apply(coerencia.tbl, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(coerencia.tbl)) {
  # loop across columns to numerate projects with sprintf
  for(i in 1:ncol(coerencia.tbl)){
    coerencia.tbl[!is.na(coerencia.tbl[,i]),i] <- sprintf("(%d) %s", seq_along(coerencia.tbl[!is.na(coerencia.tbl[,i]),i]), coerencia.tbl[!is.na(coerencia.tbl[,i]),i])
  }
  
  # replace NA with ""
  coerencia.tbl[is.na(coerencia.tbl)] <- ""
  
  # use kable for HTML output
  knitr::kable(
    coerencia.tbl,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Coerência e abrangência (AC > LP > PP)"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(coerencia.tbl), width = paste0(c(rep(1.00/ncol(coerencia.tbl)))*(21-3-3), "cm")) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(coerencia.tbl)){
  # use tinytable for LaTeX output
  coerencia.tbl <- data.frame(coerencia.tbl, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    coerencia.tbl,
    width = c(rep(1.00/ncol(coerencia.tbl)))*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Coerência e abrangência (AC > LP > PP)"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(coerencia.tbl), bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{r 1-1-2, eval = all(render_document, knitr::is_html_output())}
cat("### **1.1.2**")
cat('\n\n')
cat("#### **Proposta Curricular do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.1.2 Proposta Curricular do Programa**")
cat('\n\n')
```

```{r 1-1-2-quanti, eval = all(render_document, has.sucupira.files),, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat('##### *Quantitativa*')
  cat('\n\n')
}

# disciplinas
sheet <- "Disciplinas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

síntese.ano <- c()
for (i in 1:length(quadrienal.vigente)) {
  source("Scripts/síntese-sucupira.R", local = knitr::knit_global())
  síntese.ano <-
    dplyr::bind_rows(síntese.ano,
                     sintese(
                       sucupira.list = sucupira.list,
                       ano = quadrienal.vigente[i]
                     ))
}

síntese.ano <- síntese.ano %>%
  dplyr::select(c(
    "Ano",
    "Níveis de curso",
    "Mestrado",
    "Doutorado",
    "Disciplinas (M)",
    "Disciplinas (D)",
    "Disciplinas obrigatórias (M)",
    "Disciplinas obrigatórias (D)",
    "Disciplinas eletivas (M)",
    "Disciplinas eletivas (D)",
    "Créditos totais (M)",
    "Créditos totais (D)",
    "Carga horária total (M)",
    "Carga horária total (D)"
  ))

table.1.1.2 <-
  gtsummary::tbl_summary(
    síntese.ano,
    by = "Ano",
    type = list(
      "Níveis de curso" ~ "continuous",
      "Mestrado" ~ "continuous",
      "Doutorado" ~ "continuous",
      "Disciplinas (M)" ~ "continuous",
      "Disciplinas (D)" ~ "continuous",
      "Disciplinas obrigatórias (M)" ~ "continuous",
      "Disciplinas obrigatórias (D)" ~ "continuous",
      "Disciplinas eletivas (M)" ~ "continuous",
      "Disciplinas eletivas (D)" ~ "continuous",
      "Créditos totais (M)" ~ "continuous",
      "Créditos totais (D)" ~ "continuous",
      "Carga horária total (M)" ~ "continuous",
      "Carga horária total (D)" ~ "continuous"
    ),
    statistic = list(gtsummary::all_continuous() ~ "{max}"),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(
    label = "**Ano**",
    gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.1.2)) {
  table.1.1.2 <- table.1.1.2 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.1.2)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.1.2)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.2,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Proposta Curricular do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/length(quadrienal.vigente), times = length(quadrienal.vigente)))*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-2-disciplinas, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Load discipline data
sheet <- "Disciplinas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(quadrienal.vigente, names(sucupira.list)))]
disciplinas.raw <-  data.frame(do.call(dplyr::bind_rows, sucupira.list[periodos]), check.names = FALSE)

# select level
course.level <- "Mestrado"
disciplinas.msc <-
  disciplinas.raw[stringr::str_detect(disciplinas.raw$`Nível do Curso`, course.level),]

# remove duplicates
disciplinas.msc <- disciplinas.msc[!duplicated(disciplinas.msc),]

table.msc <-
  data.frame(
    disciplinas.msc$`ID da Disciplina`,
    disciplinas.msc$`Nome da Disciplina`,
    disciplinas.msc$`Indicadora de disciplina obrigatória`,
    disciplinas.msc$`Quantidade de créditos`,
    disciplinas.msc$`Carga Horária`,
    substr(as.Date(disciplinas.msc$`Data de início`, format = "%d/%m/%Y"), 1, 4),
    substr(as.Date(disciplinas.msc$`Data de fim`, format = "%d/%m/%Y"), 1, 4)
  )
colnames(table.msc) <- c("ID", "Disciplina", "Obrigatória", "CR", "CH", "Início", "Fim")

# merge CR (CH)
table.msc <- table.msc %>%
  dplyr::mutate(CR = ifelse(is.na(CR), "", ifelse(is.na(CH), CR, paste0(CR, " (", CH, ")")))) %>%
  dplyr::select(-CH)

# merge Início-Fim in format X - X even if FIm is empty
table.msc <- table.msc %>%
  dplyr::mutate('Início-Fim' = ifelse(is.na(Fim), paste0(Início, " - Atual"), paste0(Início, " - ", Fim))) %>% 
  dplyr::select(-Início, -Fim)

# rename column
colnames(table.msc) <- c("ID", "Disciplina", "Natureza", "CR (CH)", "Início-Fim")

# replace "Sim" and "Não" by "Obrigatória" and "Optativa"
table.msc$Natureza <- ifelse(table.msc$Natureza == "Sim", "Obrigatória", "Optativa")

# select level
course.level <- "Doutorado"
disciplinas.dsc <-
  disciplinas.raw[stringr::str_detect(disciplinas.raw$`Nível do Curso`, course.level),]

# remove duplicates
disciplinas.dsc <- disciplinas.dsc[!duplicated(disciplinas.dsc),]

table.dsc <-
  data.frame(
    disciplinas.dsc$`ID da Disciplina`,
    disciplinas.dsc$`Nome da Disciplina`,
    disciplinas.dsc$`Indicadora de disciplina obrigatória`,
    disciplinas.dsc$`Quantidade de créditos`,
    disciplinas.dsc$`Carga Horária`,
    substr(as.Date(disciplinas.dsc$`Data de início`, format = "%d/%m/%Y"), 1, 4),
    substr(as.Date(disciplinas.dsc$`Data de fim`, format = "%d/%m/%Y"), 1, 4)
  )
colnames(table.dsc) <- c("ID", "Disciplina", "Obrigatória", "CR", "CH", "Início", "Fim")

# merge CR (CH)
table.dsc <- table.dsc %>%
  dplyr::mutate(CR = ifelse(is.na(CR), "", ifelse(is.na(CH), CR, paste0(CR, " (", CH, ")")))) %>%
  dplyr::select(-CH)

# merge Início-Fim in format X - X even if FIm is empty
table.dsc <- table.dsc %>%
  dplyr::mutate('Início-Fim' = ifelse(is.na(Fim), paste0(Início, " - Atual"), paste0(Início, " - ", Fim))) %>% 
  dplyr::select(-Início, -Fim)

# rename column
colnames(table.dsc) <- c("ID", "Disciplina", "Natureza", "CR (CH)", "Início-Fim")

# replace "Sim" and "Não" by "Obrigatória" and "Optativa"
table.dsc$Natureza <- ifelse(table.dsc$Natureza == "Sim", "Obrigatória", "Optativa")

is_valid <- function(x) {
  tryCatch({
    if (exists("x")) {
      if (nrow(x) > 0) {
        return(TRUE)
      } else {
        return(FALSE)
      }
    } else {
      return(FALSE)
    }
  }, error = function(e) {
    return(FALSE)
  })
}

has.table.msc <- is_valid(table.msc)
has.table.dsc <- is_valid(table.dsc)
```

```{r turmas-periodicidade, eval = all(render_document, has.table.msc), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# turmas
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(quadrienal.vigente, names(sucupira.list)))]
turmas.raw <- data.frame(do.call(dplyr::bind_rows, sucupira.list[periodos]), check.names = FALSE)

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "ID pessoa do responsável")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "ID da Disciplina",
    "Período/Ano",
    "Nível do curso",
    "Nome da Disciplina",
    "Categoria do responsável",
    "Nome do responsável",
    "Indicador de responsável principal"
  ))

# keep responsável only
turmas <- turmas[turmas$`Indicador de responsável principal` == "Sim",]

# change to title case
turmas$`Nome do responsável` <- tools::toTitleCase(tolower(turmas$`Nome do responsável`))

# rename
colnames(turmas) <- c(
  "ID",
  "Período/Ano",
  "Disciplinas por curso",
  "Disciplina",
  "Categoria",
  "Docente responsável",
  "Responsável"
)

# select level
course.level <- "Mestrado"
turmas.msc <-
  turmas[stringr::str_detect(turmas$`Disciplinas por curso`, course.level),]


# select level
course.level <- "Doutorado"
turmas.dsc <-
  turmas[stringr::str_detect(turmas$`Disciplinas por curso`, course.level),]
```

\blandscape

```{r 1-1-2-disciplinas-msc, eval = all(render_document, has.table.msc), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Qualitativa (Mestrado)*')
  cat('\n\n')
}

# compute periodicidade: semestral, anual, bienal, trienal, quadrienal
ID <- unique(table.msc$ID)
table.msc$Periodicidade <- "Não oferecida"
for (i in 1:length(ID)) {
  data <- turmas.msc[turmas.msc$ID == ID[i], ]
  # check closest proportion of 1, 1/2, 1/4, 1/8
  n <- nrow(data)
  m <- length(quadrienal.vigente)
  freq <- n / m # oferta anual
  # freq between 1 and 2 periodicidade is semestral
  if (freq >= 1 & freq <= 2) {
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Semestral"
  } else if (freq > 1/2 & freq <= 1) {
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Anual"
  } else if (freq > 1/4 & freq <= 1/2) {
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Bienal"
  } else if (freq > 1/8 & freq <= 1/4) {
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Trienal"
  } else if (freq <= 1/8){
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Quadrienal"
  } else {
    table.msc[table.msc$ID == ID[i], "Periodicidade"] <- "Variável"
  }
}

# drop ID
table.msc <- table.msc %>% dplyr::select(-ID)

# sort by natureza
table.msc <- table.msc[order(table.msc$Natureza), ]

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.msc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Disciplinas de Mestrado"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(table.msc), width = paste0(c(0.40,0.15,0.15,0.15,0.15)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else {
  # use tinytable for LaTeX output
  table.msc <- data.frame(table.msc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.msc,
    width = c(0.40,0.15,0.15,0.15,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas de Mestrado"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.msc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.msc), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-2-disciplinas-dsc, eval = all(render_document, has.table.dsc), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Qualitativa (Doutorado)*')
  cat('\n\n')
}

# compute periodicidade: semestral, anual, bienal, trienal, quadrienal
ID <- unique(table.dsc$ID)
table.dsc$Periodicidade <- "Não oferecida"
for (i in 1:length(ID)) {
  data <- turmas.dsc[turmas.dsc$ID == ID[i], ]
  # check closest proportion of 1, 1/2, 1/4, 1/8
  n <- nrow(data)
  m <- length(quadrienal.vigente)
  freq <- n / m # oferta anual
  # freq between 1 and 2 periodicidade is semestral
  if (freq >= 1 & freq <= 2) {
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Semestral"
  } else if (freq > 1/2 & freq <= 1) {
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Anual"
  } else if (freq > 1/4 & freq <= 1/2) {
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Bienal"
  } else if (freq > 1/8 & freq <= 1/4) {
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Trienal"
  } else if (freq <= 1/8){
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Quadrienal"
  } else {
    table.dsc[table.dsc$ID == ID[i], "Periodicidade"] <- "Variável"
  }
}

# drop ID
table.dsc <- table.dsc %>% dplyr::select(-ID)

# sort by natureza
table.dsc <- table.dsc[order(table.dsc$Natureza), ]

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.dsc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Disciplinas de Doutorado"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(table.dsc), width = paste0(c(0.40,0.15,0.15,0.15,0.15)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else {
  # use tinytable for LaTeX output
  table.dsc <- data.frame(table.dsc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.dsc,
    width = c(0.40,0.15,0.15,0.15,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas de Doutorado"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.dsc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.dsc), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

```{r 1-1-2-bibliografia, eval = all(render_document, has.bibliografia), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Bibliografia*')
  cat('\n\n')
}

# read separate sheets
bibliografia.raw <-
  readxl::read_excel("PPG/Bibliografia.xlsx",
                     sheet = "Bibliografia",
                     col_types = c("text"))

# caps lock
bibliografia.raw$Disciplina <- toupper(bibliografia.raw$Disciplina)

# aggregate Ano by classes
classes <- hist(as.numeric(bibliografia.raw$Ano), plot = FALSE)$breaks
# create class names
bibliografia.raw$Período <- cut(as.numeric(bibliografia.raw$Ano), breaks = classes, include.lowest = TRUE, right = FALSE)
# reverse order of factor Período
bibliografia.raw$Período <- factor(bibliografia.raw$Período, levels = rev(levels(bibliografia.raw$Período)))

# select
bibliografia.raw <- bibliografia.raw %>%
  dplyr::select(c(
    "Disciplina",
    "Tipo",
    "Período"
  ))

# change all column types to factors
bibliografia.raw <- bibliografia.raw %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(bibliografia.raw)){
  table.refs <-
    gtsummary::tbl_summary(
      bibliografia.raw,
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(
      label = "**Bibliografia**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
    gtsummary::modify_header(
      update = stat_0 ~ "**Total**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.refs <- list()
}

# print table
if (knitr::is_html_output() && !sjmisc::is_empty(table.refs)) {
  print(table.refs)
}

if(knitr::is_latex_output() && !sjmisc::is_empty(table.refs)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.refs,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Bibliografia")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(bibliografia.raw), width = paste0(c(0.80,0.20)*(21-3-3), "cm"))
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-1-3, eval = all(render_document, knitr::is_html_output())}
cat("### **1.1.3**")
cat('\n\n')
cat("#### **Infraestrutura** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat('### **1.1.3 Infraestrutura**')
cat('\n\n')
```

```{r 1-1-3-laboratorios-equipamentos, eval = all(render_document, has.laboratorios), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Initialize all sheets
abas <- readxl::excel_sheets("PPG/Laboratórios.xlsx")
abas <- abas[order(abas, decreasing = FALSE)]

# Loop through each sheet
for (j in 1:length(abas)) {
  # Initialize table.infraestrutura for each sheet
  table.infraestrutura <- data.frame()
  
  laboratorios.raw <-
    readxl::read_excel(
      "PPG/Laboratórios.xlsx",
      sheet = abas[j],
      col_types = c("text")
    )
  
  name <- names(laboratorios.raw[1])
  names(laboratorios.raw) <- laboratorios.raw[1,]
  laboratorios.raw <- laboratorios.raw[-1,]
  lab.data <- cbind(rep(name, times = dim(laboratorios.raw)[1]), laboratorios.raw)
  
  # Bind table
  table.infraestrutura <- lab.data
  
  # Repeat each row using the value in last column
  table.infraestrutura <- table.infraestrutura[rep(1:nrow(table.infraestrutura), table.infraestrutura[,ncol(table.infraestrutura)]),]
  
  # Rename columns
  colnames(table.infraestrutura) <- c("Laboratório", "Equipamento", "Quantidade")
  
  # Drop last column
  table.infraestrutura <- table.infraestrutura[, -ncol(table.infraestrutura)]
  
  # Map to wide table using first column as variable and second column as values for each variable
  table.infraestrutura <- table.infraestrutura %>%
    dplyr::group_by(Laboratório) %>%
    dplyr::mutate(row = row_number()) %>%
    tidyr::pivot_wider(names_from = row, values_from = Equipamento) %>%
    dplyr::ungroup()
  
  # Transpose table and use first column as column name
  table.infraestrutura <- t(table.infraestrutura)
  colnames(table.infraestrutura) <- table.infraestrutura[1,]
  table.infraestrutura <- table.infraestrutura[-1,] %>%
    as.data.frame(check.names = FALSE)
  
  # rename 1st column
  colnames(table.infraestrutura)[1] <- name
  
  # Create gtsummary table
  table_name <- paste0("table_", j, "_summary")  # Unique table name
  table_summary <- gtsummary::tbl_summary(
    table.infraestrutura,
    type = list(
      gtsummary::everything() ~ "categorical"
    ),
    statistic = list(gtsummary::all_continuous() ~ "{n}"),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)
  ) %>%
    gtsummary::modify_header(
      label = "**Laboratório/Equipamento**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
    gtsummary::modify_header(
      update = stat_0 ~ "**Total**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
    gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
    gtsummary::bold_labels()
  
  # Print HTML table
  if (knitr::is_html_output() && !sjmisc::is_empty(table_summary)) {
    cat('\n\n')
    print(table_summary)
    cat('\n\n')
  }
  
  # Print LaTeX table
  if (knitr::is_latex_output() && !sjmisc::is_empty(table_summary)) {
    cat('\\FloatBarrier')
    # Convert gtsummary object to kableExtra object
    kable_table <- gtsummary::as_kable_extra(
      x = table_summary,
      escape = FALSE, addtl_fmt = TRUE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", paste("Infraestrutura de Laboratórios e Equipamentos -", name))
    ) %>%
      kableExtra::kable_styling(
        bootstrap_options = c("basic", "hover", "condensed", "responsive"),
        latex_options = c("basic", "repeat_header", "HOLD_position"),
        latex_table_env = "tabularx",
        full_width = TRUE,
        position = "center"
      ) %>%
      kableExtra::column_spec(column = 1:2, width = paste0(c(0.85, 0.15)*(21-3-3), "cm"))
    print(kable_table)
  }
  
  # Add LaTeX commands for new page and float barrier
  if(knitr::is_latex_output()) {
    cat('\\newpage')
  }
}

if (knitr::is_html_output()) {
  # print end of tab rows
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
}
```

<br>

```{r 1-2-1, eval = all(render_document, knitr::is_html_output())}
cat("### **1.2.1**")
cat('\n\n')
cat("#### **Dimensão do corpo Docente Permanente** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.2.1 Dimensão do corpo Docente Permanente**")
cat('\n\n')
```

```{r categoria-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docente permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria == "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$Categoria[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Categoria",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to sentence format
table.doc.long$Categoria <- stringr::str_to_sentence(table.doc.long$Categoria)

table.doc.long <- rbind(table.doc.long,
                        data.frame(
                          "Ano" = rep(paste0(
                            min(quadrienal.vigente), "-", max(quadrienal.vigente)
                          ), times = dim(table.doc)[1]),
                          "Categoria" = rep("Docentes", times = dim(table.doc)[1]),
                          check.names = FALSE
                        ))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.doc)){
  table.1a <-
    gtsummary::tbl_summary(
      table.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%  
    gtsummary::remove_row_type(variables = c('Categoria'), 
                               type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1a <- list()
}
```

```{r vinculacao-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docente permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria == "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$'Tipo vínculo'[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Tipo vínculo",
                colnames(table.doc)[-1],
                factor_key = TRUE)

table.doc.long <- rbind(table.doc.long,
                        data.frame(
                          "Ano" = rep(paste0(
                            min(quadrienal.vigente), "-", max(quadrienal.vigente)
                          ), times = dim(table.doc)[1]),
                          "Tipo vínculo" = rep("Docentes", times = dim(table.doc)[1]),
                          check.names = FALSE
                        ))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.doc)){
  table.1b <-
    gtsummary::tbl_summary(
      table.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%  
    gtsummary::remove_row_type(variables = c('Tipo vínculo'), 
                               type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1b <- list()
}
```

```{r regime-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docente permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria == "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$`Regime de Trabalho`[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Regime de Trabalho",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to sentence format
table.doc.long$'Regime de Trabalho' <- stringr::str_to_sentence(table.doc.long$'Regime de Trabalho')

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.doc)[1]),
    "Regime de Trabalho" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.doc)){
  table.1c <-
    gtsummary::tbl_summary(
      table.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "frequency"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%  
    gtsummary::remove_row_type(variables = c('Regime de Trabalho'), 
                               type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1c <- list()
}
```

```{r carga-horaria-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docente permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria == "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$`Carga Horária PG (Semanal)`[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Carga Horária PG (Semanal)",
                colnames(table.doc)[-1],
                factor_key = TRUE)

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(table.doc)[1]),
    "Carga Horária PG (Semanal)" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.doc)){
  table.1d <-
    gtsummary::tbl_summary(
      table.doc.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      # sort alphanumeric THIS ONLY
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%  
    gtsummary::remove_row_type(variables = c('Carga Horária PG (Semanal)'), 
                               type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1d <- list()
}
```

```{r dimensao-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# list all tables
table.1.1.1.dim <- 
  list(table.1a,
       table.1b,
       table.1c,
       table.1d)

# drop empty elements from list
table.1.1.1.dim <- table.1.1.1.dim[lapply(table.1.1.1.dim, length) > 0]
if(any(lapply(table.1.1.1.dim, length) > 0)){
  table.1.1.1.dim <- gtsummary::tbl_stack(table.1.1.1.dim)
} else {
  table.1.1.1.dim <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.1.1.dim)) {
  table.1.1.1.dim <- table.1.1.1.dim %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.1.1.dim)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.1.1.dim)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.1.dim,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Dimensão do Corpo Docente Permanente")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-2-2, eval = all(render_document, knitr::is_html_output())}
cat("### **1.2.2**")
cat('\n\n')
cat("#### **Coerência acadêmica do Corpo Docente à proposta do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.2.2 Coerência acadêmica do Corpo Docente à proposta do PPG**")
cat('\n\n')
```

```{r coerencia-docente-permanente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

# recode
sucupira$'Data de Admissão' <- substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <- substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <- "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria == "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$`Área de Conhecimento Titulação`[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Área de Conhecimento Titulação",
                colnames(table.doc)[-1],
                factor_key = TRUE
  )

# to title case
table.doc.long$"Área de Conhecimento Titulação" <- tools::toTitleCase(tolower(table.doc.long$"Área de Conhecimento Titulação"))

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(table.doc)[1]),
    "Área de Conhecimento Titulação" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# rename table.doc.long
colnames(table.doc.long)[2] <- "Docentes Permanentes"

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.doc)){
  table.1.2.2.doc <- gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%
    gtsummary::remove_row_type(variables = c('Docentes Permanentes'), type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1.2.2.doc <- list()
}
```

```{r coerencia-docente-colaborador, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria != "PERMANENTE", ]

# recode
sucupira$'Data de Admissão' <- substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <- substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <- "Atual"

docentes <- docentes.quadrienio

table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:length(docentes)) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    # keep docentes permanente only
    sucupira.temp <- sucupira.temp[sucupira.temp$Categoria != "PERMANENTE", ]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$`Área de Conhecimento Titulação`[match(toupper(table.doc$`Nome Docente`[i]), sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}

# remove empty rows
table.doc <- table.doc[complete.cases(table.doc), ]

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Área de Conhecimento Titulação",
                colnames(table.doc)[-1],
                factor_key = TRUE
  )

# to title case
table.doc.long$"Área de Conhecimento Titulação" <- tools::toTitleCase(tolower(table.doc.long$"Área de Conhecimento Titulação"))

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(table.doc)[1]),
    "Área de Conhecimento Titulação" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# rename table.doc.long
colnames(table.doc.long)[2] <- "Docentes Colaboradores e Visitantes"

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.doc)){
  table.1.2.2.outros <- gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%
    gtsummary::remove_row_type(variables = c('Docentes Colaboradores e Visitantes'), type = "level", level_value = ("Docentes")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.1.2.2.outros <- list()
}
```

```{r coerencia, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# List all tables
table.1.2.2 <- list(
  table.1.2.2.doc,
  table.1.2.2.outros
)

# Drop empty elements from the list
table.1.2.2 <- table.1.2.2[lapply(table.1.2.2, length) > 0]
if(any(lapply(table.1.2.2, length) > 0)){
  table.1.2.2 <- gtsummary::tbl_stack(table.1.2.2)
} else {
  table.1.2.2 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.2.2)) {
  table.1.2.2 <- table.1.2.2 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.2.2)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.2.2)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.2,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Coerência Acadêmica do Corpo Docente à Proposta do Programa - Área de Conhecimento (Maior Titulação)")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-2-3, eval = all(render_document, knitr::is_html_output())}
cat("### **1.2.3**")
cat('\n\n')
cat("#### **Estabilidade do corpo docente permanente** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.2.3 Estabilidade do corpo docente permanente**")
cat('\n\n')
```

```{r estabilidade-corpo-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# Filter docentes permanentes using base R
sucupira <- lapply(sucupira, function(x) {
  x <- x[x$Categoria == "PERMANENTE", ]
  return(x)
})

# name list elements by ano
names(sucupira) <- quadrienal.vigente

# add a new column with ano as value to each element in the data.frame
for(i in 1:length(sucupira)) {
  sucupira[[i]]$"Ano" <- quadrienal.vigente[i]
}

# rbind the list elements
table.doc.long <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)

# select Nome Docente e Ano
table.doc.long <- table.doc.long[, c("Ano", "Nome Docente")]

# to title case
table.doc.long$"Nome Docente" <- tools::toTitleCase(tolower(table.doc.long$"Nome Docente"))

# remove row names
rownames(table.doc.long) <- NULL

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print table
if(!sjmisc::is_empty(table.doc.long)){
  table.doc.gt.1 <- table.doc.long |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Ano",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "Estabilidade do corpo docente permanente", stat_0 = "Atuação externa") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.doc.gt.1 <- list()
}

# Função para contar os docentes novos por ano
novos_docentes_por_ano <- function(data) {
  # Lista para armazenar o número de novos docentes por ano
  novos_por_ano <- as.numeric(length(unique(data$Ano)))
  # Ordenar os dados por ano e nome do docente
  data <- data[order(data$Ano, data$"Nome Docente"), ]
  # Lista para armazenar docentes já credenciados
  docentes_credenciados <- character(0)
  # Para cada ano, contar quantos docentes novos foram credenciados
  for (ano in unique(data$Ano)) {
    # Selecionar docentes daquele ano
    docentes_ano <- data[data$Ano == ano, "Nome Docente"]
    # Filtrar os docentes que ainda não foram credenciados em anos anteriores
    novos_docentes <- setdiff(docentes_ano, docentes_credenciados)
    # Armazenar a quantidade de docentes novos
    novos_por_ano[which(unique(data$Ano) == ano)] <- length(novos_docentes)
    # Atualizar a lista de docentes credenciados até aquele ano
    docentes_credenciados <- c(docentes_credenciados, novos_docentes)
    # Para o 1o ano, não considerar nenhum docente como "novo"
    if (ano == data$Ano[1]) {
      novos_por_ano[which(unique(data$Ano) == ano)] <- 0
    }
  }
  # Criar tabela final com os resultados
  names(novos_por_ano) <- unique(data$Ano)
  return(novos_por_ano)
}

# Função para contar os docentes descredenciados por ano
descredenciados_por_ano <- function(data) {
  # Lista para armazenar o número de docentes descredenciados por ano
  descredenciados_por_ano <- as.numeric(length(unique(data$Ano)))
  # Ordenar os dados por ano e nome do docente
  data <- data[order(data$Ano, data$"Nome Docente"), ]
  # Lista para armazenar docentes credenciados
  docentes_credenciados <- character(0)
  # Para cada ano, contar quantos docentes foram descredenciados
  for (ano in unique(data$Ano)) {
    # Selecionar docentes daquele ano
    docentes_ano <- data[data$Ano == ano, "Nome Docente"]
    # Identificar docentes que foram descredenciados (não estão no ano seguinte)
    if (ano != max(as.numeric(data$Ano))) {  # Não há ano seguinte para o último ano
      docentes_ano_seguinte <- data[data$Ano == (as.numeric(ano) + 1), "Nome Docente"]
      descredenciados <- setdiff(docentes_ano, docentes_ano_seguinte)
    } else {
      descredenciados <- docentes_ano  # Para o último ano, todos são descredenciados
    }
    # Armazenar a quantidade de docentes descredenciados
    descredenciados_por_ano[which(unique(data$Ano) == ano)] <- length(descredenciados)
    # Atualizar a lista de docentes credenciados até aquele ano
    docentes_credenciados <- c(docentes_credenciados, docentes_ano)
    # Para o último ano, não considerar nenhum docente como "descredenciado"
    if (ano == data$Ano[length(data$Ano)]) {
      descredenciados_por_ano[which(unique(data$Ano) == ano)] <- 0
    }
  }
  # Criar tabela final com os resultados
  names(descredenciados_por_ano) <- unique(data$Ano)
  return(descredenciados_por_ano)
}

# Calcular os docentes novos por ano
credenciados <- novos_docentes_por_ano(table.doc.long)

# Calcular os docentes descredenciados por ano
descredenciados <- descredenciados_por_ano(table.doc.long)

# Calcular o total de docentes em cada elemento da listas sucupira
total <- sapply(sucupira, function(x) length(unique(x$"Nome Docente")))

df.estabilidade <- data.frame(
  "Ano" = unique(table.doc.long$Ano),
  "Docentes credenciados" = credenciados,
  "Docentes descredenciados" = descredenciados,
  "Total de docentes" = total,
  check.names = FALSE
)

# mat to long format
df.estabilidade.long <- df.estabilidade %>%
  tidyr::pivot_longer(cols = c("Docentes credenciados", "Docentes descredenciados", "Total de docentes"),
                      names_to = "Tipo",
                      values_to = "Quantidade")

# repeat each tipo by Quantidade
df.estabilidade.long <- df.estabilidade.long[rep(row.names(df.estabilidade.long), df.estabilidade.long$Quantidade),]

# drop Quantidade
df.estabilidade.long <- df.estabilidade.long[, -ncol(df.estabilidade.long)]

df.estabilidade.long <- rbind(
  df.estabilidade.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = length(unique(table.doc.long$`Nome Docente`))),
    "Tipo" = rep("Estabilidade", times = length(unique(table.doc.long$`Nome Docente`))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Estabilidade", na.rm = TRUE), digits = 0)
}

# print table
if(!sjmisc::is_empty(df.estabilidade.long)) {
  # print tables
  table.doc.gt.2 <-
    gtsummary::tbl_summary(
      df.estabilidade.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Tipo'),
      type = "level",
      level_value = ("Estabilidade")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(
      quadrienal.vigente
    ) + 1)))} else {
      table.doc.gt.2 <- list()
    }

# producão
# List all tables
table.1.2.3 <- list(
  table.doc.gt.2,
  table.doc.gt.1
)

# Drop empty elements from the list
table.1.2.3 <- table.1.2.3[lapply(table.1.2.3, length) > 0]
if(any(lapply(table.1.2.3, length) > 0)){
  table.1.2.3 <- gtsummary::tbl_stack(table.1.2.3)
} else {
  table.1.2.3 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.1.2.3)) {
  table.1.2.3 <- table.1.2.3 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.2.3)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.1.2.3)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.3,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Estabilidade do corpo docente permanente"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output() && !sjmisc::is_empty(table.1.2.3)) {
  cat('\\newpage')
}
```

<br>

\blandscape

```{r 1-2-4, eval = all(render_document, knitr::is_html_output())}
cat("### **1.2.4**")
cat('\n\n')
cat("#### **Percentual de docentes permanentes com dedicação exclusiva ao PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.2.4 Percentual de docentes permanentes com dedicação exclusiva ao PPG**")
cat('\n\n')
```

```{r 1-2-4-exclusividade, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Docentes com dedicação exclusiva
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# keep docentes permanente only
sucupira <- lapply(sucupira, function(x) {
  x <- x[x$Categoria == "PERMANENTE", ]
  return(x)
})

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.ext <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.ext) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# participações externas ao PPG
sucupira.df.ext <- sucupira.df.ext %>% dplyr::select(
  "Nome Docente",
  "Orientações Externas de Mestrado",
  "Orientações Externas de Mestrado Profissional",
  "Orientações Externas de Doutorado",
  "Orientações Externas de Doutorado Profissional",
  "Coorientações Externas de Mestrado",
  "Coorientações Externas de Mestrado Profissional",
  "Coorientações Externas de Doutorado",
  "Coorientações Externas de Doutorado Profissional"
)

# as numeric
sucupira.df.ext[, 2:ncol(sucupira.df.ext)] <- lapply(sucupira.df.ext[, 2:ncol(sucupira.df.ext)], as.numeric)

# combine Mestrado e Mestrado Profissional
sucupira.df.ext <- sucupira.df.ext %>%
  dplyr::mutate(
    `Orientações Externas de Mestrado` = `Orientações Externas de Mestrado` + `Orientações Externas de Mestrado Profissional`,
    `Coorientações Externas de Mestrado` = `Coorientações Externas de Mestrado` + `Coorientações Externas de Mestrado Profissional`
  ) %>%
  dplyr::select(
    -`Orientações Externas de Mestrado Profissional`,
    -`Coorientações Externas de Mestrado Profissional`
  )

# combine Doutorado e Doutorado Profissional
sucupira.df.ext <- sucupira.df.ext %>%
  dplyr::mutate(
    `Orientações Externas de Doutorado` = `Orientações Externas de Doutorado` + `Orientações Externas de Doutorado Profissional`,
    `Coorientações Externas de Doutorado` = `Coorientações Externas de Doutorado` + `Coorientações Externas de Doutorado Profissional`
  ) %>%
  dplyr::select(
    -`Orientações Externas de Doutorado Profissional`,
    -`Coorientações Externas de Doutorado Profissional`
  )

sucupira.df.ext$`Nome Docente` <- tools::toTitleCase(tolower(sucupira.df.ext$`Nome Docente`))
```

```{r 1-2-4-exclusividade-tabela, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Create table
table.excl <- sucupira.df.ext

# as numeric
table.excl[, 2:ncol(table.excl)] <- lapply(table.excl[, 2:ncol(table.excl)], as.numeric)

# sum columns by Nome docente
table.excl <- table.excl %>% 
  dplyr::mutate(
    `Atuação externa` = rowSums(dplyr::select(., -`Nome Docente`))
  )

# drop Atuação externa
table.excl <- table.excl %>%
  dplyr::select(
    -"Atuação externa"
  )

# to long table, by Nome Docente
table.excl <- table.excl %>%
  tidyr::pivot_longer(
    cols = -c("Nome Docente"),
    names_to = "Atuação externa"
  )

# drop rows with 0 values
table.excl <- table.excl %>%
  dplyr::filter(
    `value` > 0
  )

# repeat each rows by value column
table.excl <- table.excl[rep(row.names(table.excl), table.excl$value), ]

# drop value
table.excl <- table.excl %>%
  dplyr::select(
    "Nome Docente",
    "Atuação externa"
  )

# check for missing docentes.quadrienio
table.excl$"Nome Docente" <- factor(
  table.excl$"Nome Docente",
  levels = sort(unique(c(levels(sucupira.df.ext$`Nome Docente`), docentes.quadrienio)))
)

# change all column types to factors
table.excl.long <- table.excl %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print table
if(!sjmisc::is_empty(table.excl.long)){
  table.excl.gt.1 <- table.excl.long |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Atuação externa",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "Docentes permanentes com atuação externa ao PPG", stat_0 = "Atuação externa") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.excl.gt.1 <- list()
}

# sum rowns of sucupira.df.ext by Nome Docente
table.excl.2 <- sucupira.df.ext %>%
  aggregate(. ~ `Nome Docente`, data = ., sum)

# create atuação externa data.frame
table.excl.2 <- data.frame(
  "Nome Docente" = table.excl.2$"Nome Docente",
  "Atuação exclusiva" = ifelse(rowSums(table.excl.2[, 2:ncol(sucupira.df.ext)]) == 0, "Sim", "Não"),
  check.names = FALSE
)

# print table
if(!sjmisc::is_empty(table.excl.2)){
  table.excl.gt.2 <- table.excl.2 |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Atuação exclusiva",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "Docentes permanentes", stat_0 = "Atuação externa") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.excl.gt.2 <- list()
}

# create list of gtsummary tables
table.excl.list <- list(table.excl.gt.2, table.excl.gt.1)
# remove empty list elements
table.excl.list <- table.excl.list[!sapply(table.excl.list, sjmisc::is_empty)]

spann <- c("**Atuação exclusiva**", "**Atividades externas ao PPG**")
spann <- spann[which(lapply(table.excl.list, length) > 0)]

if(any(lapply(table.excl.list, length) > 0)){
  table.excl.gt <- gtsummary::tbl_merge(
    tbls = table.excl.list,
    tab_spanner = spann
  )
} else {
  table.excl.gt <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.excl.gt)) {
  table.excl.gt <- table.excl.gt %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.excl.gt)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.excl.gt)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.excl.gt,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Docentes permanentes com atuação externa ao PPG"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + (nlevels(factor(table.excl.2$`Atuação exclusiva`))+nlevels(factor(table.excl$`Atuação externa`)))), width = paste0(c(0.40, rep(0.60/((nlevels(factor(table.excl.2$`Atuação exclusiva`))+nlevels(factor(table.excl$`Atuação externa`)))), times = ((nlevels(factor(table.excl.2$`Atuação exclusiva`))+nlevels(factor(table.excl$`Atuação externa`))))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{=latex}
\newpage
```

```{r 1-2-5, eval = all(render_document, knitr::is_html_output())}
cat("### **1.2.5**")
cat('\n\n')
cat("#### **Capacidade de captação de recursos** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.2.5 Capacidade de captação de recursos**")
cat('\n\n')
```

```{r 1-2-5-captacao-auxilios, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter by type of financiamento = OUTRO AUXILIO FINANCEIRO
sucupira.aux.df <- sucupira.financiadores.df[sucupira.financiadores.df$`Natureza do Financiador` == "OUTRO AUXÍLIO FINANCEIRO", ]

table.cap.aux <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.aux.df$`Nome do Membro do Projeto`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.cap.aux) <- NULL
table.cap.aux <-
  cbind(unique(sucupira.aux.df$`Nome do Membro do Projeto`), table.cap.aux)
colnames(table.cap.aux) <-
  c("Nome do Membro do Projeto", as.character(quadrienal.vigente))
for (i in 1:dim(table.cap.aux)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.aux.df[sucupira.aux.df$Anos == quadrienal.vigente[j],]
    table.cap.aux[i, j + 1] <-
      try(data$`Nome do Membro do Projeto`[match(table.cap.aux$`Nome do Membro do Projeto`[i],
                                                 data$`Nome do Membro do Projeto`)], silent = TRUE)
  }
}

table.cap.aux.long <-
  tidyr::gather(dplyr::select(table.cap.aux, -1),
                "Ano",
                "Nome do Membro do Projeto",
                colnames(table.cap.aux)[-1],
                factor_key = TRUE)

# to title case
table.cap.aux.long$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(table.cap.aux.long$`Nome do Membro do Projeto`))

table.cap.aux.long <- rbind(
  table.cap.aux.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.cap.aux)[1]),
    "Nome do Membro do Projeto" = rep("Financiador", times = dim(table.cap.aux)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Financiador", na.rm = TRUE), digits = 0)
}

colnames(table.cap.aux.long) <-
  c("Ano", "Auxílios")

# change all column types to factors
table.cap.aux.long <- table.cap.aux.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
table.cap.aux.long$Auxílios <- factor(
  table.cap.aux.long$Auxílios,
  levels = sort(unique(c(levels(table.cap.aux.long$Auxílios), docentes.quadrienio)))
)

if(!sjmisc::is_empty(table.cap.aux)) {
  # print tables
  table.cap.aux.gt <-
    gtsummary::tbl_summary(
      table.cap.aux.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Auxílios'),
      type = "level",
      level_value = ("Financiador")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(
      quadrienal.vigente
    ) + 1)))
} else {
  table.cap.aux.gt <- list()
}

table.1.2.5 <- table.cap.aux.gt

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.cap.aux)) {
  table.1.2.5 <- table.1.2.5 %>% 
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.2.5)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.cap.aux)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.5,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", " Capacidade de captação de recursos - Auxílios recebidos por docentes"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE
    )
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output() && !sjmisc::is_empty(table.cap.aux)) {
  cat('\\newpage')
}
```

```{r 1-2-5-captacao-bolsas, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter by type of financiamento = BOLSA
sucupira.bolsa.df <- sucupira.financiadores.df[sucupira.financiadores.df$`Natureza do Financiador` == "BOLSA", ]

table.cap.bolsa <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.bolsa.df$`Nome do Membro do Projeto`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.cap.bolsa) <- NULL
table.cap.bolsa <-
  cbind(unique(sucupira.bolsa.df$`Nome do Membro do Projeto`), table.cap.bolsa)
colnames(table.cap.bolsa) <-
  c("Nome do Membro do Projeto", as.character(quadrienal.vigente))
for (i in 1:dim(table.cap.bolsa)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.bolsa.df[sucupira.bolsa.df$Anos == quadrienal.vigente[j],]
    table.cap.bolsa[i, j + 1] <-
      try(data$`Nome do Membro do Projeto`[match(table.cap.bolsa$`Nome do Membro do Projeto`[i],
                                                 data$`Nome do Membro do Projeto`)], silent = TRUE)
  }
}

table.cap.bolsa.long <-
  tidyr::gather(dplyr::select(table.cap.bolsa, -1),
                "Ano",
                "Nome do Membro do Projeto",
                colnames(table.cap.bolsa)[-1],
                factor_key = TRUE)

# to title case
table.cap.bolsa.long$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(table.cap.bolsa.long$`Nome do Membro do Projeto`))

table.cap.bolsa.long <- rbind(
  table.cap.bolsa.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.cap.bolsa)[1]),
    "Nome do Membro do Projeto" = rep("Financiador", times = dim(table.cap.bolsa)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Financiador", na.rm = TRUE), digits = 0)
}

colnames(table.cap.bolsa.long) <-
  c("Ano", "Bolsas")

# change all column types to factors
table.cap.bolsa.long <- table.cap.bolsa.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
table.cap.bolsa.long$Bolsas <- factor(
  table.cap.bolsa.long$Bolsas,
  levels = sort(unique(c(levels(table.cap.bolsa.long$Bolsas), docentes.quadrienio)))
)

if(!sjmisc::is_empty(table.cap.bolsa)) {
  # print tables
  table.cap.bolsa.gt <-
    gtsummary::tbl_summary(
      table.cap.bolsa.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Bolsas'),
      type = "level",
      level_value = ("Financiador")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(
      quadrienal.vigente
    ) + 1)))
} else {
  table.cap.bolsa.gt <- list()
}

table.1.2.5 <- table.cap.bolsa.gt

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.cap.bolsa)) {
  table.1.2.5 <- table.1.2.5 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.2.5)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.cap.bolsa)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.5,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", " Capacidade de captação de recursos - Bolsas"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output() && !sjmisc::is_empty(table.cap.bolsa)) {
  cat('\\newpage')
}
```

```{r 1-2-5-captacao-pq, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# keep docentes permanente only
sucupira <- lapply(sucupira, function(x) {
  x <- x[x$Categoria == "PERMANENTE", ]
  return(x)
})

docentes <- toupper(docentes.quadrienio)

table.cap.pq <-
  data.frame(matrix(
    NA,
    nrow = length(docentes),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.cap.pq) <- NULL
table.cap.pq <- cbind(docentes, table.cap.pq)
colnames(table.cap.pq) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(table.cap.pq)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira[[j]]
    data <- data[data$`Modalidade da Bolsa CNPq` != "NA", ]
    table.cap.pq[i, j + 1] <-
      try(data$`Nome Docente`[match(table.cap.pq$`Nome Docente`[i],
                                    data$`Nome Docente`)], silent = TRUE)
  }
}

table.cap.pq.long <-
  tidyr::gather(dplyr::select(table.cap.pq, -1),
                "Ano",
                "Modalidade da Bolsa CNPq",
                colnames(table.cap.pq)[-1],
                factor_key = TRUE)

# to sentence format
table.cap.pq.long$`Modalidade da Bolsa CNPq` <- stringr::str_to_title(table.cap.pq.long$`Modalidade da Bolsa CNPq`)

# remove empty rows (disregard first column)
table.cap.pq <- table.cap.pq[complete.cases(table.cap.pq[, -1]), ]

table.cap.pq.long <- rbind(table.cap.pq.long,
                           data.frame(
                             "Ano" = rep(paste0(
                               min(quadrienal.vigente), "-", max(quadrienal.vigente)
                             ), times = dim(table.cap.pq)[1]),
                             "Modalidade da Bolsa CNPq" = rep("Modalidade", times = dim(table.cap.pq)[1]),
                             check.names = FALSE
                           ))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Modalidade", na.rm = TRUE), digits = 0)
}

colnames(table.cap.pq.long) <-
  c("Ano", "Bolsa CNPq")

# change all column types to factors
table.cap.pq.long <- table.cap.pq.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
table.cap.pq.long$`Bolsa CNPq` <- factor(
  table.cap.pq.long$`Bolsa CNPq`,
  levels = sort(unique(c(levels(table.cap.pq.long$`Bolsa CNPq`), docentes.quadrienio)))
)

if(!sjmisc::is_empty(table.cap.pq)){
  table.cap.pq.gt <-
    gtsummary::tbl_summary(
      table.cap.pq.long,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(
      list(
        add_stat_1 ~ "**Quadriênio**",
        gtsummary::all_stat_cols() ~ "**{level}**"
      )
    ) %>%  
    gtsummary::remove_row_type(variables = c('Bolsa CNPq'), 
                               type = "level", level_value = ("Modalidade")) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.cap.pq.gt <- list()
}

table.1.2.5 <- table.cap.pq.gt

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.cap.pq)) {
  table.1.2.5 <- table.1.2.5 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.1.2.5)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.cap.pq)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.5,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", " Capacidade de captação de recursos - Bolsas de Produtividade CNPq"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output() && !sjmisc::is_empty(table.cap.pq)) {
  cat('\\newpage')
}
```

\blandscape

```{r 1.2.5-detalhes, eval = all(render_document, has.financiadores)}
financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

financiadores.sub <-
  financiadores.raw %>% dplyr::select("Ano",
                                      "Agência",
                                      "Edital",
                                      "Processo No.",
                                      "Título do projeto",
                                      "Proponente",
                                      "Programa",
                                      "País")
fonte.sub <- financiadores.raw %>% dplyr::select("Fonte")

financiadores <-
  financiadores.sub[complete.cases(financiadores.sub), ]
fonte <- fonte.sub[complete.cases(financiadores.sub), ]

if (dim(financiadores)[1] != 0) {
  Abrir <- matrix(NA, nrow = dim(financiadores)[1])
  colnames(Abrir) <- "Abrir"
  # add hyperlinks
  for (i in 1:dim(fonte)[1])
  {
    if (!is.na(fonte[i, 1]))
    {
      Abrir[i] <-
        paste0('<a href="',
               fonte[i, 1],
               '" target="_blank"',
               '>',
               # fontawesome icon
               fontawesome::fa("up-right-from-square"),
               '</a>')
    }
  }
  financiadores <- cbind(financiadores, Abrir)
  financiadores <-
    financiadores[order(financiadores$Ano, decreasing = TRUE), ]
}

# filter Ano in quadrienal.vitgente
financiadores <- financiadores[financiadores$Ano %in% quadrienal.vigente, ]

# drop Abrir
financiadores <- financiadores %>%
  dplyr::select(-"Abrir")

# sort by Proponente
financiadores <- financiadores[order(financiadores$Proponente), ]

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(financiadores)) {
  # use kable for HTML output
  knitr::kable(
    financiadores,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Capacidade de captação de recursos - Detalhes dos financiadores"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(financiadores), width = paste0(c(0.05,0.05,0.10,0.15,0.20,0.20,0.20,0.05)*(29-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(financiadores)) {
  # use tinytable for LaTeX output
  financiadores <- data.frame(financiadores, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    financiadores,
    width = c(0.05,0.05,0.10,0.15,0.20,0.20,0.20,0.05)*(29-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Capacidade de captação de recursos - Detalhes dos financiadores"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(financiadores), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(financiadores), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{r 1-3-1, eval = all(render_document, knitr::is_html_output())}
cat("### **1.3.1**")
cat('\n\n')
cat("#### **Adequação da proposta ao Plano Institucional da IES** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.3.1 Adequação da proposta ao Plano Institucional da IES**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
```

<br>

```{r 1-3-2, eval = all(render_document, knitr::is_html_output())}
cat("### **1.3.2**")
cat('\n\n')
cat("#### **Adequação do planejamento** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.3.2 Adequação do planejamento**")
cat('\n\n')
```

\blandscape

```{r 1-4-perfil-discente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.perfil.disc <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.perfil.disc) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter columns
sucupira.perfil.disc <- sucupira.perfil.disc %>%
  dplyr::select(
    "Anos",
    "Nível Discente",
    "Gênero",
    "Data de Nascimento",
    "Raça/Cor",
    "Portador de Deficiência"
  )

# compute age for the current period
sucupira.perfil.disc$Idade <- as.numeric(sucupira.perfil.disc$Anos) - as.numeric(substr(
  as.Date(sucupira.perfil.disc$`Data de Nascimento`, format = "%d/%m/%Y"),
  1,
  4
))

# try replacing Bacharelado por Graduação
try(sucupira.perfil.disc$`Nível Discente`[sucupira.perfil.disc$`Nível Discente` == "Bacharelado"] <- "Graduação", silent = TRUE)

# try rename levels Mestrado Profissional by Mestrado
try(sucupira.perfil.disc$`Nível Discente`[sucupira.perfil.disc$`Nível Discente` == "Mestrado Profissional"] <- "Mestrado")

# try rename levels Mestrado Profissional by Mestrado
try(sucupira.perfil.disc$`Nível Discente`[sucupira.perfil.disc$`Nível Discente` == "Doutorado Profissional"] <- "Doutorado")

# reorder levels of Nível Discente: "Bacharelado", "Mestrado" and "Doutorado"
sucupira.perfil.disc$`Nível Discente` <- factor(
  sucupira.perfil.disc$`Nível Discente`,
  levels = c(
    "Graduação",
    "Mestrado",
    "Doutorado"
  )
)

# rename Gênero por Sexo Biológico
sucupira.perfil.disc <- sucupira.perfil.disc %>%
  dplyr::rename("Sexo Biológico" = "Gênero")

# reorder Sexo BIológico as factor
sucupira.perfil.disc$`Sexo Biológico` <- factor(
  sucupira.perfil.disc$`Sexo Biológico`,
  levels = c(
    "Feminino",
    "Masculino",
    "Não Informado"
  )
)

# reorder levels of Raça/Cor: "Nào declarado" and "Não dispõe da informação" should be the last levels
sucupira.perfil.disc$`Raça/Cor` <- factor(
  sucupira.perfil.disc$`Raça/Cor`,
  levels = c(
    "Amarela",
    "Branca",
    "Indígena",
    "Parda",
    "Preta",
    "Não declarado",
    "Não dispõe da informação"
  )
)

# rename Portador de Deficiência por "Pessoa com Deficiência"
sucupira.perfil.disc <- sucupira.perfil.disc %>%
  dplyr::rename("Pessoa com Deficiência" = "Portador de Deficiência")

# reorder levels of Pessoa com Deficiência
sucupira.perfil.disc$`Pessoa com Deficiência` <- factor(
  sucupira.perfil.disc$`Pessoa com Deficiência`,
  levels = c(
    "Sim",
    "Não"
  )
)

# compute Adulto vs Idoso
sucupira.perfil.disc$`Grupo etário` <- ifelse(sucupira.perfil.disc$Idade >= 65, "Pessoa idosa", "Adulto")

# reorder levels of Grupo Etário
sucupira.perfil.disc$`Grupo etário` <- factor(
  sucupira.perfil.disc$`Grupo etário`,
  levels = c(
    "Adulto",
    "Pessoa idosa"
  )
)

# drop Data de Nascimento
sucupira.perfil.disc <- sucupira.perfil.disc %>%
  dplyr::select(
    -"Data de Nascimento"
  )

# check nlevels of Nível Discente
if (nlevels(sucupira.perfil.disc$`Nível Discente`) != 0 && !sjmisc::is_empty(sucupira.perfil.disc)) {
  if (nlevels(sucupira.perfil.disc$`Nível Discente`) == 1) {
    # Mestrado OU Doutorado OU Bacharelado
    # Print tables
    table.matr.gt <- sucupira.perfil.disc |>
      gtsummary::tbl_summary(
        by = Anos,
        type = list(
          "Sexo Biológico" ~ "categorical",
          "Raça/Cor" ~ "categorical",
          "Pessoa com Deficiência" ~ "categorical",
          "Idade" ~ "continuous",
          "Grupo etário" ~ "categorical"
        ),
        statistic = list(
          gtsummary::all_categorical() ~ "{n} ({p}%)",
          gtsummary::all_continuous() ~ "{median} ({p25}-{p75})"
        ),
        missing = "no",
        digits = gtsummary::everything() ~ 0,
        sort = gtsummary::all_categorical() ~ "alphanumeric"
      ) %>%
      gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
      gtsummary::bold_labels()
  } else if (nlevels(sucupira.perfil.disc$`Nível Discente`) >= 2) {
    # Bacharelado, Mestrado, Doutorado
    # Print tables
    table.matr.gt <- sucupira.perfil.disc |>
      #      dplyr::select('Anos', 'Nome do Orientador', 'Nível Discente') |>
      gtsummary::tbl_strata(
        strata = 'Nível Discente',
        .tbl_fun =
          ~ .x |>
          gtsummary::tbl_summary(
            by = Anos,
            type = list(
              "Sexo Biológico" ~ "categorical",
              "Raça/Cor" ~ "categorical",
              "Pessoa com Deficiência" ~ "categorical",
              "Idade" ~ "continuous",
              "Grupo etário" ~ "categorical"
            ),
            statistic = list(
              gtsummary::all_categorical() ~ "{n} ({p}%)",
              gtsummary::all_continuous() ~ "{median} ({p25}-{p75})"
            ),
            missing = "no",
            digits = gtsummary::everything() ~ 0,
            sort = gtsummary::all_categorical() ~ "alphanumeric"
          ) %>%
          gtsummary::modify_header(label = "**Discentes matriculados**") %>%
          gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
          gtsummary::bold_labels(),
        .header = paste0("**{strata}**")
      )
  }
  
  # Print HTML table
  if (knitr::is_html_output() && !sjmisc::is_empty(sucupira.perfil.disc)) {
    table.matr.gt <- table.matr.gt %>%
      gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
    
    print(table.matr.gt)
  }
  
  # Print LaTeX table
  if (knitr::is_latex_output() && !sjmisc::is_empty(sucupira.perfil.disc)) {
    cat('\\FloatBarrier')
    # Convert gtsummary object to kableExtra object
    kable_table <- gtsummary::as_kable_extra(
      x = table.matr.gt,
      escape = FALSE, addtl_fmt = TRUE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", "Perfil sociodemiográfico dos discentes/egressos por ano"),
    ) %>%
      kableExtra::kable_styling(
        bootstrap_options = c("basic", "hover", "condensed", "responsive"),
        latex_options = c("basic", "repeat_header", "HOLD_position", "scale_down"), # scale_down added to fit page width
        latex_table_env = "tabularx",
        full_width = TRUE,
        position = "center"
      ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(sucupira.perfil.disc$Anos))*nlevels(sucupira.perfil.disc$"Nível Discente")), width = paste0(c(0.15, rep(0.85/(length(unique(sucupira.perfil.disc$Anos))*nlevels(sucupira.perfil.disc$"Nível Discente")), times = length(unique(sucupira.perfil.disc$Anos))*nlevels(sucupira.perfil.disc$"Nível Discente")))*(29-3-3), "cm")) %>%
      kableExtra::footnote(
        general_title = "\\\\textbf{Fontes}:",
        general = c(
          "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
        ),
        escape = FALSE)
    print(kable_table)
  }
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

```{r 1-4-1, eval = all(render_document, knitr::is_html_output())}
cat("### **1.4.1**")
cat('\n\n')
cat("#### **Adequação dos processos e procedimentos utilizados para a autoavaliação**")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **1.4.1 Adequação dos processos e procedimentos utilizados para a autoavaliação**")
cat('\n\n')
```

```{r, eval = all(render_document, !has.metodologia)}
cat('<br>')
```

```{r 1-4-1-metodologia, eval = all(render_document, has.metodologia), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Metodologia.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('#### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  metodologia.raw <-
    readxl::read_excel("PPG/Metodologia.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(metodologia.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(metodologia.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(metodologia.raw[i, ncol(metodologia.raw)])) {
        Abrir[i] <-
          paste0('<a href="',metodologia.raw[i, ncol(metodologia.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
      }
    } else {
      if (!is.na(metodologia.raw[i, ncol(metodologia.raw)])) {
        Abrir[i] <-
          paste0('\\url{', metodologia.raw[i, ncol(metodologia.raw)],'}')
      }
    }
  }
  
  metodologia <- cbind(metodologia.raw[, -ncol(metodologia.raw)], Abrir)
  table <- metodologia
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE, longtable = T,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
}
```

```{r 1-4-1-resultados, eval = all(render_document, has.autoavaliacao), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Autoavaliação PPG.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('#### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  autoavaliacao.raw <-
    readxl::read_excel("PPG/Autoavaliação PPG.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(autoavaliacao.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(autoavaliacao.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(autoavaliacao.raw[i, ncol(autoavaliacao.raw)])) {
        Abrir[i] <-
          paste0('<a href="',autoavaliacao.raw[i, ncol(autoavaliacao.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
      }
    } else {
      if (!is.na(autoavaliacao.raw[i, ncol(autoavaliacao.raw)])) {
        Abrir[i] <-
          paste0('\\url{', autoavaliacao.raw[i, ncol(autoavaliacao.raw)],'}')
      }
    }
  }
  
  autoavaliacao <- cbind(autoavaliacao.raw[, -ncol(autoavaliacao.raw)], Abrir)
  table <- autoavaliacao
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE, longtable = T,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
}
```

<br>

```{=latex}
\newpage
\vspace*{\fill}
\section{\textbf{2. Formação}}
\vspace*{\fill}
\newpage
```

```{r 2-Formacao, eval = all(render_document, knitr::is_html_output())}
cat("## **2. Formação** {#formacao .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

\blandscape

```{r 2-1-1, eval = all(render_document, knitr::is_html_output())}
cat("### **2.1.1**")
cat('\n\n')
cat("#### **Coerência do produto final** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.1.1 Coerência do produto final**")
cat('\n\n')
```

```{r 2-1-1-coerencia, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# TCC - Banca
sheet <- "TCC - Banca"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# make unique ID
id.TCC <- sucupira$"Identificador do Trabalho de Conclusão"
id.TCC <- unique(id.TCC)

bancas <- data.frame(
  "Ano" = rep(NA, length(id.TCC)),
  "Linha de Pesquisa" = rep(NA, length(id.TCC)),
  "Tipo de Trabalho de Conclusão" = rep(NA, length(id.TCC)),
  "Título" = rep(NA, length(id.TCC)),
  check.names = FALSE
)

# define new function
create_keyness_pairs <- function(data, col1, col2) {
  # keep rows where n1 + n2 >= 1
  data <- data[rowSums(data[, c(col1, col2)]) >= 1, ]
  
  n1 <- sum(data[[col1]])
  n2 <- sum(data[[col2]])
  
  kw <- transform(
    dplyr::select(data, word = word, col1, col2),
    G2 = corpora::keyness(
      data[[col1]],
      n1,
      data[[col2]],
      n2,
      measure = "G2",
      conf.level = 0.95,
      alpha = 0.05,
      p.adjust = FALSE,
      lambda = 1
    ),
    LogRatio = corpora::keyness(
      data[[col1]],
      n1,
      data[[col2]],
      n2,
      measure = "LogRatio",
      conf.level = 0.95,
      alpha = 0.05,
      p.adjust = FALSE,
      lambda = 1
    ),
    PositiveLRC = corpora::keyness(
      data[[col1]],
      n1,
      data[[col2]],
      n2,
      measure = "PositiveLRC",
      conf.level = 0.95,
      alpha = 0.05,
      p.adjust = FALSE,
      lambda = 1
    )
  )
  
  kw <- kw[order(-kw$LogRatio), ]
  
  # Hide rows with 0 values in measure (significance filter)
  kw <- kw[kw$G2 != 0 & kw$LogRatio != 0 & kw$PositiveLRC != 0, ]
  
  # Format numbers
  kw$G2 <- format(round(kw$G2, digits = 3), nsmall = 3)
  kw$LogRatio <- format(round(kw$LogRatio, digits = 3), nsmall = 3)
  kw$PositiveLRC <- format(round(kw$PositiveLRC, digits = 3), nsmall = 3)
  
  return(kw)
}

all.kw <- list()
lista.kw <- list()
bancas.with.words <- c()
table.bancas.long <- data.frame()

if (!sjmisc::is_empty(id.TCC)) {
  # loop over each ID
  for (i in 1:length(id.TCC)) {
    # select current ID
    banca <- sucupira[sucupira$"Identificador do Trabalho de Conclusão" == id.TCC[i], ]
    
    # get unique values
    bancas$Ano[i] <- substr(as.Date(unique(banca$"Data da Defesa"), format = "%d/%m/%Y"), 1, 4)
    bancas$"Linha de Pesquisa"[i] <- stringr::str_to_sentence(unique(banca$"Linha de Pesquisa"))
    bancas$`Tipo de Trabalho de Conclusão`[i] <- stringr::str_to_sentence(unique(banca$"Tipo de Trabalho de Conclusão"))
    bancas$Título[i] <- stringr::str_to_sentence(unique(banca$"Nome do Trabalho de Conclusão"))
  }
  # sort by Ano and Titulo
  bancas <- dplyr::arrange(bancas, dplyr::desc(Ano), Título)
  
  # rename Tipo de trabalho de conclusão para Tipo
  bancas <- dplyr::rename(bancas, Tipo = `Tipo de Trabalho de Conclusão`)
  
  # retain bancas para o quadrienio
  bancas <- bancas[bancas$Ano %in% as.character(quadrienal.vigente), ]
  
  # compare corpora based on Linha de Pesquisa
  
  # create new list with names from each Linhas de Pesquisa
  words <- list()
  for (i in 1:length(unique(bancas$"Linha de Pesquisa"))) {
    words[[i]] <- unlist(strsplit(bancas$Título[bancas$"Linha de Pesquisa" == unique(bancas$"Linha de Pesquisa")[i]], " "))
    # to lower case
    words[[i]] <- tolower(words[[i]])
    # remove stopwords
    words[[i]] <- words[[i]][!words[[i]] %in% tm::stopwords("portuguese")]
    words[[i]] <- words[[i]][!words[[i]] %in% tm::stopwords("english")]
    # remove punctuation
    words[[i]] <- gsub("[[:punct:]]", "", words[[i]])
    # remove numbers
    words[[i]] <- gsub("[[:digit:]]", "", words[[i]])
    # strip whitespace
    words[[i]] <- gsub("^\\s+|\\s+$", "", words[[i]])
    # remove whitespace
    words[[i]] <- words[[i]][words[[i]] != ""]
    # sort
    words[[i]] <- sort(words[[i]])
  }
  names(words) <- unique(bancas$"Linha de Pesquisa")
  # resize list elements to largest one
  words <- lapply(words, function(x) {length(x) <- max(lengths(words)); x})
  # convert list to data.frame
  words <- as.data.frame(words, check.names = FALSE)
  
  # create dataframe of all words
  all.words <- data.frame(
    word = sort(unique(unlist(words)))
  )
  # add columns for each Linha de Pesquisa
  for (i in 1:length(unique(bancas$"Linha de Pesquisa"))) {
    all.words <- dplyr::mutate(all.words, !!unique(bancas$"Linha de Pesquisa")[i])
  }
  # remove quotes from name
  colnames(all.words) <- gsub("\"", "", colnames(all.words))
  
  # frequency of words in all.words by Linha de Pesquisa
  for (i in 1:dim(all.words)[1]) {
    for (j in 2:dim(all.words)[2]) {
      all.words[i, j] <- sum(all.words$word[i] == words[[j - 1]], na.rm = TRUE)
    }
  }
  
  # to numeric type
  for (i in 2:dim(all.words)[2]){
    all.words[,i] <- all.words[,i] %>% as.numeric()
  }
  # sort by overall frequency
  all.words <- dplyr::arrange(all.words, dplyr::desc(rowSums(all.words[, -1])))
  
  # create all unique pairs of Linhas de Pesquisa
  pairs <- combn(colnames(all.words)[-1], 2, simplify = TRUE)
  
  # loop through all pairs to calculate kw
  for (i in 1:dim(pairs)[2]) {
    all.kw[[i]] <- create_keyness_pairs(all.words, pairs[1, i], pairs[2, i])
  }
  
  # as data.frame with new first column with names from col1 and col2 combined
  all.kw <- lapply(all.kw, function(x) {
    try(x <- cbind(
      "Linha 1" = names(x)[2],
      "Linha 2" = names(x)[3],
      x
    ), silent = TRUE)
    try(x[,1] <- stringr::str_to_title(x[,1]), silent = FALSE)
    try(x[,2] <- stringr::str_to_title(x[,2]), silent = FALSE)
    try(x[,3] <- toupper(x[,3]), silent = FALSE)
    try(names(x)[3] <- "Termo", silent = FALSE)
    try(names(x)[4] <- "Linha 1 (n)", silent = FALSE)
    try(names(x)[5] <- "Linha 2 (n)", silent = FALSE)
    return(x)
  })
  
  # drop lists with 0 elements
  all.kw <- all.kw[lengths(all.kw) == 8]
  lista.kw <- all.kw
  
  # as data.frame
  all.kw <- dplyr::bind_rows(all.kw)
  
  if(length(all.kw) > 0){
    # check which bancas$Título have all.kw$Termo
    for (i in 1:dim(bancas)[1]){
      for(j in 1:dim(all.kw)[1]){
        try(if(grepl(tolower(all.kw$Termo[j]), tolower(bancas$Título[i]))){
          bancas.with.words <- c(bancas.with.words, i)
        }, silent = TRUE)
      }
    }
    bancas.with.words <- unique(bancas.with.words)
    bancas.with.words <- bancas[bancas.with.words, ]
    
    table.bancas.long <- rbind(
      data.frame(bancas.with.words,
                 check.names = FALSE),
      data.frame(
        "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(bancas.with.words)[1]),
        "Linha de Pesquisa" = rep("Data1", times = dim(bancas.with.words)[1]),
        "Tipo" = rep("Data2", times = dim(bancas.with.words)[1]),
        "Título" = rep("TÍTULO", times = dim(bancas.with.words)[1]),
        check.names = FALSE
      )
    )
    
    # to title case
    table.bancas.long$`Linha de Pesquisa` <- stringr::str_to_title(table.bancas.long$`Linha de Pesquisa`)
    
    # change all column types to factors
    table.bancas.long <- table.bancas.long %>%
      dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))
    
    # reorder factor Ano
    table.bancas.long$Ano <- factor(table.bancas.long$Ano, levels = c(quadrienal.vigente, paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    )))
  }
  
  # gt summary table per year of % de bancas with words
  my_N1 <- function(data, ...) {
    gtsummary::style_number(sum(data == "Data1", na.rm = TRUE), digits = 0)
  }
  my_N2 <- function(data, ...) {
    gtsummary::style_number(sum(data == "Data2", na.rm = TRUE), digits = 0)
  }
  
  # bug report
  # https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
  tbl_fix_order <- function(x) {
    nms <- names(x$table_body)
    is_stat_cols <- grepl("^stat_", nms)
    non_stat_cols <- nms[!is_stat_cols]
    stat_cols <- nms[is_stat_cols]
    stat_cols <- stat_cols[
      order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
    ]
    x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
    
    x  
  }
  
  if (!sjmisc::is_empty(table.bancas.long)) {
    # print tables
    table.2.1.1 <- gtsummary::tbl_summary(
      dplyr::select(table.bancas.long, "Ano", "Linha de Pesquisa", "Tipo"),
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0,
      sort = gtsummary::all_categorical() ~ "alphanumeric"
    ) %>%
      gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
      gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
      gtsummary::bold_labels() %>%
      tbl_fix_order() %>%
      gtsummary::add_stat(fns = list("Linha de Pesquisa" ~ my_N1, "Tipo" ~ my_N2)) %>%
      gtsummary::modify_header(
        list(
          add_stat_1 ~ "**Quadriênio**",
          gtsummary::all_stat_cols() ~ "**{level}**"
        )
      ) %>%
      gtsummary::remove_row_type(variables = c('Linha de Pesquisa'), type = "level", level_value = ("Data1")) %>%
      gtsummary::remove_row_type(variables = c('Tipo'), type = "level", level_value = ("Data2")) %>%
      gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
  } else {
    table.2.1.1 <- list()
  }
  
  # Print HTML table
  if (knitr::is_html_output() && !sjmisc::is_empty(table.bancas.long)) {
    table.2.1.1 <- table.2.1.1 %>%
      gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
    
    print(table.2.1.1)
  }
  
  # Print LaTeX table
  if (knitr::is_latex_output() && !sjmisc::is_empty(table.bancas.long)) {
    cat('\\FloatBarrier')
    # Convert gtsummary object to kableExtra object
    kable_table <- gtsummary::as_kable_extra(
      x = table.2.1.1,
      escape = FALSE, addtl_fmt = TRUE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", "Coerência interna do produto final (dissertações e teses) com as Linhas de Pesquisa")
    ) %>% 
      kableExtra::kable_styling(
        bootstrap_options = c("basic", "hover", "condensed", "responsive"),
        latex_options = c("basic", "repeat_header", "HOLD_position"),
        latex_table_env = "tabularx",
        full_width = TRUE,
        position = "center"
      ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
      kableExtra::footnote(
        general_title = "\\\\textbf{Fontes}:",
        general = c(
          "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
        ),
        escape = FALSE)
    print(kable_table)
  }
  
  # Add LaTeX commands for new page and float barrier
  if(knitr::is_latex_output()) {
    cat('\\newpage')
  }
}
```

```{r 2-1-1-detalhe, eval = all(exists("lista.kw"), try(!sjmisc::is_empty(lista.kw), silent = TRUE), render_document, has.sucupira.files)}
if (!sjmisc::is_empty(lista.kw)) {
  # Create R Markdown chunks dynamically because projetos can be very large tables
  
  out.2 <- NULL
  
  for (i in 1:length(lista.kw)) {
    # Define table caption
    caption.2 <- paste0('Palavras-chave mais frequentes por Linha de Pesquisa - Linhas de Pesquisa: ', toupper(unique(lista.kw[[i]]$`Linha 1`)), ' <> ', toupper(unique(lista.kw[[i]]$`Linha 2`)))
    
    # Generate R Markdown code for this chunk
    knit_expanded.2 <- paste0(
      "\n\n```{r, eval = all(exists('lista.kw'), try(!sjmisc::is_empty(lista.kw), silent = TRUE), render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}\n\n",
      "cat('\\n\\n<!-- -->\\n\\n')\n\n",
      "# print tables\n\n",
      "if (knitr::is_html_output()) {\n\n",
      "  # use kable for HTML output\n\n",
      "  knitr::kable(\n\n",
      "    lista.kw[[", i, "]],\n\n",
      "    align = 'l',\n\n",
      "    escape = FALSE,\n\n",
      "    format = 'html',\n\n",
      "    booktabs = TRUE,\n\n",
      "    linesep = '',\n\n",
      "    caption = '", caption.2, "',\n\n",
      "    row.names = FALSE) %>% \n\n",
      "    kableExtra::kable_styling(\n\n",
      "      bootstrap_options = c('striped', 'hover', 'condensed', 'responsive'),\n\n",
      "      full_width = TRUE,\n\n",
      "      position = 'center'\n\n",
      "    ) %>% \n\n",
      "    kableExtra::column_spec(column = 1:ncol(lista.kw[[", i, "]]), width = paste0(c(0.23, 0.23, 0.15, 0.09, 0.09, 0.05, 0.08, 0.08)*(29-3-3), 'cm')) %>% \n\n",
      "    kableExtra::column_spec(column = 1, bold = TRUE) %>% \n\n",
      "    kableExtra::column_spec(column = 2, bold = TRUE) %>% \n\n",
      "    kableExtra::row_spec(row = 0, bold = TRUE) %>% \n\n",
      "    kableExtra::footnote(\n\n",
      "      general_title = '<strong>Fontes</strong>: ',\n\n",
      "      general = c('<a href=\"https://sucupira.capes.gov.br/sucupira/\">Plataforma Sucupira</a>'),\n\n",
      "      escape = FALSE)\n\n",
      "} else {\n\n",
      "  # use tinytable for LaTeX output\n\n",
      "  linhas.atual <- data.frame(lista.kw[[", i, "]], check.names = FALSE)\n\n",
      "  options(tinytable_print_output = 'latex')\n\n",
      "  tinytable::tt(\n\n",
      "    linhas.atual,\n\n",
      "    width = c(0.23, 0.23, 0.15, 0.09, 0.09, 0.05, 0.08, 0.08)*(29-3-3),\n\n",
      "    style = 'bootstrap',\n\n",
      "    align = 'l',\n\n",
      "    caption = '", caption.2, "',\n\n",
      "    notes = list(\n\n",
      "      '\\\\textbf{Fontes}: \\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}'\n\n",
      "    ),\n\n",
      "    row.names = FALSE\n\n",
      "  ) %>% \n\n",
      "    tinytable::theme_tt('multipage', rowhead = 1, latex_float = 'H') %>% \n\n",
      "    tinytable::style_tt(i = 0, j = 1:ncol(lista.kw[[", i, "]]), bold = TRUE) %>% \n\n",
      "    tinytable::style_tt(i = 1:nrow(lista.kw[[", i, "]]), j = 1, bold = TRUE) %>% \n\n",
      "    tinytable::style_tt(i = 1:nrow(lista.kw[[", i, "]]), j = 2, bold = TRUE)\n\n",
      "}\n\n",
      "cat('\\\\newpage')\n\n",
      "\n\n```"
    )
    
    out.2 <- c(out.2, knit_expanded.2)
  }
  
  cat("
**Parâmetros de análise de frequência de palavras-chave entre Linhas de Pesquisa**:

*G2*: Mede a probabilidade de que duas distribuições de palavras sejam diferentes. Sempre retorna valores positivos. 
Se a frequência de uma palavra em um texto for menor do que em outro, o resultado é ajustado para indicar a direção. 
Tende a favorecer palavras que aparecem muitas vezes.

*LogRatio8*: Compara o risco relativo de duas palavras ou grupos de palavras. É uma forma intuitiva de ver diferenças. 
É menos afetado por palavras que aparecem raramente, mas pode dar resultados enganosos para essas palavras.

*PositiveLRC*: Uma versão que indica se há evidência de que uma palavra é mais comum em um texto do que em outro. 
Resultados iguais ou menores que zero significam que não há evidência significativa. É útil para considerar palavras 
que não são claramente significativas, especialmente em textos menores.

Um filtro de significância é aplicado, de modo que apenas palavras com valores diferentes de zero (p<0,05) são exibidas.

Fonte: Evert S (2023). corpora: Statistics and Data Sets for Corpus Frequency Data. R package version 0.6,
  <https://CRAN.R-project.org/package=corpora>.
")
}
```

<!--- knit those table chunk statements --> 
`r if(all(exists("out.2"), try(!sjmisc::is_empty(out.2), silent = TRUE), exists("lista.kw"), try(!sjmisc::is_empty(lista.kw), silent = TRUE), render_document, has.sucupira.files)){paste(knitr::knit(text = out.2), collapse = '\n\n')}`

\elandscape

<br>

```{r 2-1-2, eval = all(render_document, knitr::is_html_output())}
cat("### **2.1.2**")
cat('\n\n')
cat("#### **Qualidade do produto final** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.1.2 Qualidade do produto final**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-2-1, eval = all(render_document, knitr::is_html_output())}
cat("### **2.2.1**")
cat('\n\n')
cat("#### **Produção do corpo discente em eventos científicos** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.2.1 Produção do corpo discente em eventos científicos**")
cat('\n\n')
```

```{r 2-2-1-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Produções - Autores
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.anais <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.anais) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter by Subtipo = Trabalho Em Anais
sucupira.df.anais <- sucupira.df.anais %>% 
  dplyr::filter(`Subtipo de Produção` == "TRABALHO EM ANAIS")

# filter by ID and "Categoria do Autor" == "Discente"
sucupira.df.anais <- sucupira.df.anais %>% 
  dplyr::filter(`Categoria do Autor` == "Discente")

# get unique ID da Produção
ID <- unique(sucupira.df.anais$`ID da Produção`)

# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.anais <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.anais) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# select sucupira.df.anais with matching ID
sucupira.df.anais <- sucupira.df.anais[sucupira.df.anais$`ID da Produção` %in% ID,]

sucupira.df.anais <- sucupira.df.anais %>% 
  dplyr::select(
    "ID da Produção",
    "Anos",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Item de Detalhamento",
    "Valor do Item de Detalhamento",
    "Categoria do Autor Principal"
  )
sucupira.df.anais$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.anais$`Tipo de Produção`))
sucupira.df.anais$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.anais$`Subtipo de Produção`))

sucupira.df.anais$`Tipo de Produção`[is.na(sucupira.df.anais$`Tipo de Produção`)] <- "Indefinido"
sucupira.df.anais$`Subtipo de Produção`[is.na(sucupira.df.anais$`Subtipo de Produção`)] <- "Indefinido"
sucupira.df.anais$`Categoria do Autor Principal`[is.na(sucupira.df.anais$`Categoria do Autor Principal`)] <- "Indefinido"
```

```{r 2-2-1-bibliografica, eval=all(render_document, has.sucupira.files), echo=FALSE, fig.align='center', fig.pos='H', message=FALSE, warning=FALSE, results='asis'}
# filter sucupira.df.anais by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df.anais[sucupira.df.anais$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.bib$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(unique(sucupira.df.bib$`ID da Produção`), table.bib)
colnames(table.bib) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.bib)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.bib[i, 1]
    ano <- quadrienal.vigente[j]
    table.bib[i, j + 1] <- ifelse(
      id %in% sucupira.df.bib$`ID da Produção`[sucupira.df.bib$Anos == ano],
      sucupira.df.bib$`Subtipo de Produção`[match(id, sucupira.df.bib$`ID da Produção`)],
      NA
    )
  }
}

table.bib.long <-
  tidyr::gather(dplyr::select(table.bib, -1),
                "Ano",
                "Nome da Produção",
                colnames(table.bib)[-1],
                factor_key = TRUE
  )

table.bib.long <- rbind(
  table.bib.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.bib[, -1]))),
    "Nome da Produção" = rep("Produção", times = sum(!is.na(table.bib[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica com discente")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.bib)) {
  # Print tables
  table.bib.gt <- gtsummary::tbl_summary(
    table.bib.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção bibliográfica com discente'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.bib.gt <- list()
}
```

```{r 2-2-1-natureza, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "Natureza"
sucupira.df.nat <- sucupira.df.anais %>%
  dplyr::filter(`Item de Detalhamento` == "Natureza")

# to title case
sucupira.df.nat$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.nat$`Valor do Item de Detalhamento`))

table.nat <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.nat$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.nat) <- NULL
table.nat <- cbind(unique(sucupira.df.nat$`ID da Produção`), table.nat)
colnames(table.nat) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.nat)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.nat[i, 1]
    ano <- quadrienal.vigente[j]
    table.nat[i, j + 1] <- ifelse(
      id %in% sucupira.df.nat$`ID da Produção`[sucupira.df.nat$Anos == ano],
      sucupira.df.nat$`Valor do Item de Detalhamento`[match(id, sucupira.df.nat$`ID da Produção`)],
      NA
    )
  }
}

table.nat.long <-
  tidyr::gather(dplyr::select(table.nat, -1),
                "Ano",
                "Natureza",
                colnames(table.nat)[-1],
                factor_key = TRUE
  )

table.nat.long <- rbind(
  table.nat.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.nat[, -1]))),
    "Natureza" = rep("Natureza", times = sum(!is.na(table.nat[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Natureza", na.rm = TRUE), digits = 0)
}

colnames(table.nat.long) <- c("Ano", "Natureza da produção")

# change all column types to factors
table.nat.long <- table.nat.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.nat)) {
  # Print tables
  table.nat.gt <- gtsummary::tbl_summary(
    table.nat.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Natureza da produção'),
      type = "level",
      level_value = ("Natureza")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.nat.gt <- list()
}
```

```{r 2-2-1-local, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "País"
sucupira.df.local <- sucupira.df.anais %>%
  dplyr::filter(`Item de Detalhamento` == "País")

# to title case
sucupira.df.local$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.local$`Valor do Item de Detalhamento`))

table.local <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.local$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.local) <- NULL
table.local <- cbind(unique(sucupira.df.local$`ID da Produção`), table.local)
colnames(table.local) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.local)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.local[i, 1]
    ano <- quadrienal.vigente[j]
    table.local[i, j + 1] <- ifelse(
      id %in% sucupira.df.local$`ID da Produção`[sucupira.df.local$Anos == ano],
      sucupira.df.local$`Valor do Item de Detalhamento`[match(id, sucupira.df.local$`ID da Produção`)],
      NA
    )
  }
}

table.local.long <-
  tidyr::gather(dplyr::select(table.local, -1),
                "Ano",
                "País",
                colnames(table.local)[-1],
                factor_key = TRUE
  )

table.local.long <- rbind(
  table.local.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.local[, -1]))),
    "País" = rep("País", times = sum(!is.na(table.local[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "País", na.rm = TRUE), digits = 0)
}

colnames(table.local.long) <- c("Ano", "País")

# change all column types to factors
table.local.long <- table.local.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.local)) {
  # Print tables
  table.local.gt <- gtsummary::tbl_summary(
    table.local.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('País'),
      type = "level",
      level_value = ("País")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.local.gt <- list()
}
```

```{r 2-2-1-discentes-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.disc <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.disc) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter by Nível != "Graduação"
sucupira.df.disc <- sucupira.df.disc %>% 
  dplyr::filter(`Nível Discente` != "Bacharelado")
```

```{r 2-2-1-discentes-total, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.disc <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.disc$`Identificador do Discente`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.disc) <- NULL
table.disc <- cbind(unique(sucupira.df.disc$`Identificador do Discente`), table.disc)
colnames(table.disc) <- c("ID", as.character(quadrienal.vigente))

# match ID and Ano and fill with Discente
for(i in 1:dim(table.disc)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.disc[i, 1]
    ano <- quadrienal.vigente[j]
    table.disc[i, j + 1] <- ifelse(
      id %in% sucupira.df.disc$`Identificador do Discente`[sucupira.df.disc$Anos == ano],
      "Discente",
      NA
    )
  }
}

table.disc.long <-
  tidyr::gather(dplyr::select(table.disc, -1),
                "Ano",
                "Discentes",
                colnames(table.disc)[-1],
                factor_key = TRUE
  )

table.disc.long <- rbind(
  table.disc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.disc)[1]),
    "Discentes" = rep("Discentes", times = dim(table.disc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Discentes", na.rm = TRUE), digits = 0)
}

colnames(table.disc.long) <- c("Ano", "Discentes")

# change all column types to factors
table.disc.long <- table.disc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.disc)) {
  # Print tables
  table.disc.gt <- gtsummary::tbl_summary(
    table.disc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Discentes'),
      type = "level",
      level_value = ("Discentes")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.disc.gt <- list()
}
```

```{r 2-2-1-discentes-nivel, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.nivel <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.disc$`Identificador do Discente`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.nivel) <- NULL
table.nivel <- cbind(unique(sucupira.df.disc$`Identificador do Discente`), table.nivel)
colnames(table.nivel) <- c("ID", as.character(quadrienal.vigente))

# match ID and Ano and fill with Nivel
for(i in 1:dim(table.nivel)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.nivel[i, 1]
    ano <- quadrienal.vigente[j]
    table.nivel[i, j + 1] <- ifelse(
      id %in% sucupira.df.disc$`Identificador do Discente`[sucupira.df.disc$Anos == ano],
      sucupira.df.disc$`Nível Discente`[match(id, sucupira.df.disc$`Identificador do Discente`)],
      NA
    )
  }
}

table.nivel.long <-
  tidyr::gather(dplyr::select(table.nivel, -1),
                "Ano",
                "Nível",
                colnames(table.nivel)[-1],
                factor_key = TRUE
  )

table.nivel.long <- rbind(
  table.nivel.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.nivel)[1]),
    "Nível" = rep("Nível", times = dim(table.nivel)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Nível", na.rm = TRUE), digits = 0)
}

colnames(table.nivel.long) <- c("Ano", "Nível")

# change all column types to factors
table.nivel.long <- table.nivel.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.nivel)){
  # Print tables
  table.nivel.gt <- gtsummary::tbl_summary(
    table.nivel.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Nível'),
      type = "level",
      level_value = ("Nível")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.nivel.gt <- list()
}
```

```{r 2-2-1-razao, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# proporção entre total de produção e total de discentes por ano 
producao.ano <- table.bib.long %>%
  na.omit() %>%
  dplyr::filter(Ano != "Ano") %>%
  dplyr::count(Ano)
colnames(producao.ano) <- c("Ano", "Número de trabalhos de discentes publicados em Anais (resumo ou resumo expandido)")

alunos.ano <- table.disc.long %>%
  na.omit() %>%
  dplyr::filter(Ano != "Ano") %>%
  dplyr::count(Ano)
colnames(alunos.ano) <- c("Ano", "Número de discentes do Programa")

# bind columns os dataframes with different rows size by Ano
razao.ano <- dplyr::full_join(producao.ano, alunos.ano, by = "Ano")
# replace NA with 0
razao.ano[is.na(razao.ano)] <- 0

# calculate ratio
razao.ano$Razão <- razao.ano$`Número de trabalhos de discentes publicados em Anais (resumo ou resumo expandido)` / razao.ano$`Número de discentes do Programa`

# keep razao only
razao.ano <- razao.ano[, c("Ano", "Razão")]

# get value not in quadrienal
quadrienal.value <- razao.ano$Razão[!razao.ano$Ano %in% quadrienal.vigente]

# keep only Anos in quadrienal.vigente
razao.ano <- razao.ano[razao.ano$Ano %in% quadrienal.vigente, ]

my_N <- function(...) {
  gtsummary::style_number(quadrienal.value, digits = 2)
}

# rename columns
colnames(razao.ano) <- c("Ano", "Razão (trabalhos publicados em Anais por discente)")

# change all column types to factors
table.razao.long <- razao.ano %>%
  dplyr::mutate(dplyr::across(Ano, as.factor))
table.razao.long <- razao.ano %>%
  dplyr::mutate(dplyr::across("Razão (trabalhos publicados em Anais por discente)", as.numeric))

if(!sjmisc::is_empty(producao.ano) && !sjmisc::is_empty(alunos.ano)) {
  # Print tables
  table.razao.gt <- gtsummary::tbl_summary(
    table.razao.long,
    by = "Ano",
    type = list(gtsummary::everything() ~ "continuous"),
    statistic = list(gtsummary::everything() ~ "{max}"),
    missing = "no",
    digits = gtsummary::everything() ~ 2
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::everything() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.razao.gt <- list()
}
```

```{r 2-2-1-list-tables, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# producão
# List all tables
table.2.2.1.a <- list(
  table.bib.gt,
  table.nat.gt,
  table.local.gt
)

# Drop empty elements from the list
table.2.2.1.a <- table.2.2.1.a[lapply(table.2.2.1.a, length) > 0]
if(any(lapply(table.2.2.1.a, length) > 0)){
  table.2.2.1.a <- gtsummary::tbl_stack(table.2.2.1.a)
} else {
  table.2.2.1.a <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.1.a)) {
  table.2.2.1.a <- table.2.2.1.a %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.1.a)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.1.a)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.1.a,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Número de trabalhos de discentes publicados em anais (resumo ou resumo expandido)")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# discentes
# List all tables
table.2.2.1.b <- list(
  table.disc.gt,
  table.nivel.gt
)

# Drop empty elements from the list
table.2.2.1.b <- table.2.2.1.b[lapply(table.2.2.1.b, length) > 0]
if(any(lapply(table.2.2.1.b, length) > 0)){
  table.2.2.1.b <- gtsummary::tbl_stack(table.2.2.1.b)
} else {
  table.2.2.1.b <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.1.b)) {
  table.2.2.1.b <- table.2.2.1.b %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.1.b)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.1.b)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.1.b,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Número de discentes do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# razao producão/discentes
# List all tables
table.2.2.1.c <- list(
  table.razao.gt
)

# Drop empty elements from the list
table.2.2.1.c <- table.2.2.1.c[lapply(table.2.2.1.c, length) > 0]
if(any(lapply(table.2.2.1.c, length) > 0)){
  table.2.2.1.c <- gtsummary::tbl_stack(table.2.2.1.c)
} else {
  table.2.2.1.c <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.1.c)) {
  table.2.2.1.c <- table.2.2.1.c %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.1.c)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.1.c)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.1.c,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Razão (trabalhos publicados em Anais por discente)")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-2-2, eval = all(render_document, knitr::is_html_output())}
cat("### **2.2.2**")
cat('\n\n')
cat("#### **Produção bibliográfica dos discentes/egressos – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.2.2 Produção bibliográfica dos discentes/egressos – Acadêmico**")
cat('\n\n')
```

```{r 2-2-2-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Produções - Autores
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.bibl <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.bibl) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter by Subtipo = Trabalho Em Anais
sucupira.df.bibl <- sucupira.df.bibl %>% 
  dplyr::filter(`Subtipo de Produção` == "ARTIGO EM PERIÓDICO" | `Subtipo de Produção` == "LIVRO")

# filter by ID and "Categoria do Autor" == "Discente" ou "Egresso"
sucupira.df.bibl <- sucupira.df.bibl %>% 
  dplyr::filter(`Categoria do Autor` == "Discente" | `Categoria do Autor` == "Egresso" )

# get unique ID da Produção
ID <- unique(sucupira.df.bibl$`ID da Produção`)

# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.bibl <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.bibl) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# select sucupira.df.bibl with matching ID
sucupira.df.bibl <- sucupira.df.bibl[sucupira.df.bibl$`ID da Produção` %in% ID,]

sucupira.df.bibl <- sucupira.df.bibl %>% 
  dplyr::select(
    "ID da Produção",
    "Anos",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Item de Detalhamento",
    "Valor do Item de Detalhamento",
    "Categoria do Autor Principal"
  )
sucupira.df.bibl$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.bibl$`Tipo de Produção`))
sucupira.df.bibl$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.bibl$`Subtipo de Produção`))

sucupira.df.bibl$`Tipo de Produção`[is.na(sucupira.df.bibl$`Tipo de Produção`)] <- "Indefinido"
sucupira.df.bibl$`Subtipo de Produção`[is.na(sucupira.df.bibl$`Subtipo de Produção`)] <- "Indefinido"
sucupira.df.bibl$`Categoria do Autor Principal`[is.na(sucupira.df.bibl$`Categoria do Autor Principal`)] <- "Indefinido"
```

```{r 2-2-2-bibliografica, eval=all(render_document, has.sucupira.files), echo=FALSE, fig.align='center', fig.pos='H', message=FALSE, warning=FALSE, results='asis'}
# filter sucupira.df.bibl by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df.bibl[sucupira.df.bibl$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.bib$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(unique(sucupira.df.bib$`ID da Produção`), table.bib)
colnames(table.bib) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.bib)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.bib[i, 1]
    ano <- quadrienal.vigente[j]
    table.bib[i, j + 1] <- ifelse(
      id %in% sucupira.df.bib$`ID da Produção`[sucupira.df.bib$Anos == ano],
      sucupira.df.bib$`Subtipo de Produção`[match(id, sucupira.df.bib$`ID da Produção`)],
      NA
    )
  }
}

table.bib.long <-
  tidyr::gather(dplyr::select(table.bib, -1),
                "Ano",
                "Nome da Produção",
                colnames(table.bib)[-1],
                factor_key = TRUE
  )

table.bib.long <- rbind(
  table.bib.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.bib[, -1]))),
    "Nome da Produção" = rep("Produção", times = sum(!is.na(table.bib[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica com discente")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.bib)) {
  # Print tables
  table.bib.gt <- gtsummary::tbl_summary(
    table.bib.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção bibliográfica com discente'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.bib.gt <- list()
}
```

```{r 2-2-2-natureza, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "Natureza" ou "Tipo da Contribuição na Obra"
sucupira.df.nat <- sucupira.df.bibl %>%
  dplyr::filter(`Item de Detalhamento` == "Natureza" | `Item de Detalhamento` == "Tipo da Contribuição na Obra"
  )

# to title case
sucupira.df.nat$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.nat$`Valor do Item de Detalhamento`))

# replace completo por artigo completo
sucupira.df.nat$`Valor do Item de Detalhamento` <- ifelse(
  sucupira.df.nat$`Valor do Item de Detalhamento` == "Completo",
  "Artigo (Completo)",
  sucupira.df.nat$`Valor do Item de Detalhamento`
)

# replace resumo por artigo resumo
sucupira.df.nat$`Valor do Item de Detalhamento` <- ifelse(
  sucupira.df.nat$`Valor do Item de Detalhamento` == "Resumo",
  "Artigo (Resumo)",
  sucupira.df.nat$`Valor do Item de Detalhamento`
)

table.nat <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.nat$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.nat) <- NULL
table.nat <- cbind(unique(sucupira.df.nat$`ID da Produção`), table.nat)
colnames(table.nat) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.nat)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.nat[i, 1]
    ano <- quadrienal.vigente[j]
    table.nat[i, j + 1] <- ifelse(
      id %in% sucupira.df.nat$`ID da Produção`[sucupira.df.nat$Anos == ano],
      sucupira.df.nat$`Valor do Item de Detalhamento`[match(id, sucupira.df.nat$`ID da Produção`)],
      NA
    )
  }
}

table.nat.long <-
  tidyr::gather(dplyr::select(table.nat, -1),
                "Ano",
                "Natureza",
                colnames(table.nat)[-1],
                factor_key = TRUE
  )

table.nat.long <- rbind(
  table.nat.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.nat[, -1]))),
    "Natureza" = rep("Natureza", times = sum(!is.na(table.nat[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Natureza", na.rm = TRUE), digits = 0)
}

colnames(table.nat.long) <- c("Ano", "Natureza da produção")

# change all column types to factors
table.nat.long <- table.nat.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.nat)) {
  # Print tables
  table.nat.gt <- gtsummary::tbl_summary(
    table.nat.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Natureza da produção'),
      type = "level",
      level_value = ("Natureza")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.nat.gt <- list()
}
```

```{r 2-2-2-local, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "Idioma"
sucupira.df.local <- sucupira.df.bibl %>%
  dplyr::filter(`Item de Detalhamento` == "Idioma")

# to title case
sucupira.df.local$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.local$`Valor do Item de Detalhamento`))

table.local <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.local$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.local) <- NULL
table.local <- cbind(unique(sucupira.df.local$`ID da Produção`), table.local)
colnames(table.local) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.local)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.local[i, 1]
    ano <- quadrienal.vigente[j]
    table.local[i, j + 1] <- ifelse(
      id %in% sucupira.df.local$`ID da Produção`[sucupira.df.local$Anos == ano],
      sucupira.df.local$`Valor do Item de Detalhamento`[match(id, sucupira.df.local$`ID da Produção`)],
      NA
    )
  }
}

table.local.long <-
  tidyr::gather(dplyr::select(table.local, -1),
                "Ano",
                "País",
                colnames(table.local)[-1],
                factor_key = TRUE
  )

table.local.long <- rbind(
  table.local.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.local[, -1]))),
    "País" = rep("País", times = sum(!is.na(table.local[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "País", na.rm = TRUE), digits = 0)
}

colnames(table.local.long) <- c("Ano", "País")

# change all column types to factors
table.local.long <- table.local.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.local)) {
  # Print tables
  table.local.gt <- gtsummary::tbl_summary(
    table.local.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('País'),
      type = "level",
      level_value = ("País")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.local.gt <- list()
}
```

```{r 2-2-2-egressos-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Discentes
sheet <- "Egressos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[[as.character(max(as.numeric(quadrienal.vigente)))]] %>%
  plyr::compact()

sucupira.df.disc <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.disc) <- names(sucupira)

# rename column sucupira.df.disc$"Ano Titulação" to "Anos"
colnames(sucupira.df.disc)[colnames(sucupira.df.disc) == "Ano Titulação"] <- "Anos"

# filter Anos within quadrienio.vigente
sucupira.df.disc <- sucupira.df.disc[sucupira.df.disc$Anos %in% quadrienal.vigente, ]
```

```{r 2-2-2-discentes-total, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.disc <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.disc$`Identificador do Egresso`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.disc) <- NULL
table.disc <- cbind(unique(sucupira.df.disc$`Identificador do Egresso`), table.disc)
colnames(table.disc) <- c("ID", as.character(quadrienal.vigente))

# match ID and Ano and fill with Egresso
for(i in 1:dim(table.disc)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.disc[i, 1]
    ano <- quadrienal.vigente[j]
    table.disc[i, j + 1] <- ifelse(
      id %in% sucupira.df.disc$`Identificador do Egresso`[sucupira.df.disc$Anos == ano],
      "Titulação",
      NA
    )
  }
}

table.disc.long <-
  tidyr::gather(dplyr::select(table.disc, -1),
                "Ano",
                "Titulações",
                colnames(table.disc)[-1],
                factor_key = TRUE
  )

table.disc.long <- rbind(
  table.disc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.disc)[1]),
    "Titulações" = rep("Titulações", times = dim(table.disc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Titulações", na.rm = TRUE), digits = 0)
}

colnames(table.disc.long) <- c("Ano", "Titulações")

# change all column types to factors
table.disc.long <- table.disc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.disc)) {
  # Print tables
  table.disc.gt <- gtsummary::tbl_summary(
    table.disc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Titulações'),
      type = "level",
      level_value = ("Titulações")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.disc.gt <- list()
}
```

```{r 2-2-2-discentes-nivel, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.nivel <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.disc$`Identificador do Egresso`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.nivel) <- NULL
table.nivel <- cbind(unique(sucupira.df.disc$`Identificador do Egresso`), table.nivel)
colnames(table.nivel) <- c("ID", as.character(quadrienal.vigente))

# match ID and Ano and fill with Nivel
for(i in 1:dim(table.nivel)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.nivel[i, 1]
    ano <- quadrienal.vigente[j]
    table.nivel[i, j + 1] <- ifelse(
      id %in% sucupira.df.disc$`Identificador do Egresso`[sucupira.df.disc$Anos == ano],
      sucupira.df.disc$`Nível Titulação`[match(id, sucupira.df.disc$`Identificador do Egresso`)],
      NA
    )
  }
}

table.nivel.long <-
  tidyr::gather(dplyr::select(table.nivel, -1),
                "Ano",
                "Nível",
                colnames(table.nivel)[-1],
                factor_key = TRUE
  )

table.nivel.long <- rbind(
  table.nivel.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.nivel)[1]),
    "Nível" = rep("Nível", times = dim(table.nivel)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Nível", na.rm = TRUE), digits = 0)
}

colnames(table.nivel.long) <- c("Ano", "Nível")

# change all column types to factors
table.nivel.long <- table.nivel.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.nivel)){
  # Print tables
  table.nivel.gt <- gtsummary::tbl_summary(
    table.nivel.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Nível'),
      type = "level",
      level_value = ("Nível")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.nivel.gt <- list()
}
```

```{r 2-2-2-razao, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# proporção entre total de produção e total de titulações por ano 
producao.ano <- table.bib.long %>%
  na.omit() %>%
  dplyr::filter(Ano != "Ano") %>%
  dplyr::count(Ano)
colnames(producao.ano) <- c("Ano", "Número de artigos/livros/capítulos publicados por discentes/egressos")

egressos.ano <- table.disc.long %>%
  na.omit() %>%
  dplyr::filter(Ano != "Ano") %>%
  dplyr::count(Ano)
colnames(egressos.ano) <- c("Ano", "Número de titulações do Programa")

# bind columns os dataframes with different rows size by Ano
razao.ano <- dplyr::full_join(producao.ano, egressos.ano, by = "Ano")
# replace NA with 0
razao.ano[is.na(razao.ano)] <- 0

# calculate ratio
razao.ano$Razão <- razao.ano$`Número de artigos/livros/capítulos publicados por discentes/egressos` / razao.ano$`Número de titulações do Programa`

# keep razao only
razao.ano <- razao.ano[, c("Ano", "Razão")]

# get value not in quadrienal
quadrienal.value <- razao.ano$Razão[!razao.ano$Ano %in% quadrienal.vigente]

# keep only Anos in quadrienal.vigente
razao.ano <- razao.ano[razao.ano$Ano %in% quadrienal.vigente, ]

my_N <- function(...) {
  gtsummary::style_number(quadrienal.value, digits = 2)
}

# rename columns
colnames(razao.ano) <- c("Ano", "Razão (artigos/livros/capítulos publicados por discentes/egressos por titulação)")

# change all column types to factors
table.razao.long <- razao.ano %>%
  dplyr::mutate(dplyr::across(Ano, as.factor))
table.razao.long <- razao.ano %>%
  dplyr::mutate(dplyr::across("Razão (artigos/livros/capítulos publicados por discentes/egressos por titulação)", as.numeric))

if(!sjmisc::is_empty(producao.ano) && !sjmisc::is_empty(alunos.ano)) {
  # Print tables
  table.razao.gt <- gtsummary::tbl_summary(
    table.razao.long,
    by = "Ano",
    type = list(gtsummary::everything() ~ "continuous"),
    statistic = list(gtsummary::everything() ~ "{max}"),
    missing = "no",
    digits = gtsummary::everything() ~ 2
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::everything() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.razao.gt <- list()
}
```

```{r 2-2-2-list-tables, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# producão
# List all tables
table.2.2.2.a <- list(
  table.bib.gt,
  table.nat.gt,
  table.local.gt
)

# Drop empty elements from the list
table.2.2.2.a <- table.2.2.2.a[lapply(table.2.2.2.a, length) > 0]
if(any(lapply(table.2.2.2.a, length) > 0)){
  table.2.2.2.a <- gtsummary::tbl_stack(table.2.2.2.a)
} else {
  table.2.2.2.a <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.2.a)) {
  table.2.2.2.a <- table.2.2.2.a %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.2.a)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.2.a)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.2.a,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Número de trabalhos de discentes/egressos publicados (artigos/livros/capítulos)")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# discentes
# List all tables
table.2.2.2.b <- list(
  table.disc.gt,
  table.nivel.gt
)

# Drop empty elements from the list
table.2.2.2.b <- table.2.2.2.b[lapply(table.2.2.2.b, length) > 0]
if(any(lapply(table.2.2.2.b, length) > 0)){
  table.2.2.2.b <- gtsummary::tbl_stack(table.2.2.2.b)
} else {
  table.2.2.2.b <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.2.b)) {
  table.2.2.2.b <- table.2.2.2.b %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.2.b)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.2.b)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.2.b,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Número de titulações do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# razao producão/titulações
# List all tables
table.2.2.2.c <- list(
  table.razao.gt
)

# Drop empty elements from the list
table.2.2.2.c <- table.2.2.2.c[lapply(table.2.2.2.c, length) > 0]
if(any(lapply(table.2.2.2.c, length) > 0)){
  table.2.2.2.c <- gtsummary::tbl_stack(table.2.2.2.c)
} else {
  table.2.2.2.c <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.2.2.c)) {
  table.2.2.2.c <- table.2.2.2.c %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.2.2.c)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.2.2.c)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.2.2.c,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Razão (trabalhos de discentes/egressos publicados [artigos/livros/capítulos] por titulação)")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-3-1, eval = all(render_document, knitr::is_html_output())}
cat("### **2.3.1**")
cat('\n\n')
cat("#### **Atuação dos Egressos** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.3.1 Atuação dos Egressos**")
cat('\n\n')
```

```{r 2-3-1-formacao-continuada, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
discentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Discente`,
  `Nível Discente`,
  `Situação Discente`,
  `Data Matrícula`,
  `Data Situação`
)
colnames(discentes)[2] <- "Nome"
colnames(discentes)[3] <- "Nível"
colnames(discentes)[4] <- "Situação"

# Egressos
sheet <- "Egressos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
egressos <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa do Egresso`,
  `Nome do Egresso`,
  `Nível Titulação`,
  `Ano Titulação`
)
colnames(egressos)[1] <- "Identificador da Pessoa"
colnames(egressos)[2] <- "Nome"
colnames(egressos)[3] <- "Nível"
try(egressos$Situação <- "EGRESSO", silent = TRUE)

# Pós-Doc
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
posdoc <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Pós-Doc Nome`,
  `Vínculo Início`,
  `Vínculo Fim`
)
colnames(posdoc)[2] <- "Nome"
try(posdoc$Situação <- "PÓS-DOC", silent = TRUE)

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
docentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Docente`,
  `Data de Admissão`,
  `Data de Desligamento`
)
colnames(docentes)[2] <- "Nome"
try(docentes$Situação <- "DOCENTE", silent = TRUE)

# bind all data by "Identificador da Pessoa"
formacao.continuada <- dplyr::bind_rows(
  discentes,
  egressos,
  posdoc,
  docentes
)

# remove duplicates
formacao.continuada <- formacao.continuada %>%
  dplyr::distinct()

# sort by "Identificador da Pessoa"
formacao.continuada <- formacao.continuada %>%
  dplyr::arrange(`Identificador da Pessoa`)

# create table to fill with start-end year for each situation
table <- data.frame(
  "Nome" = NA,
  "Bacharelado" = NA,
  "Mestrado" = NA,
  "Doutorado" = NA,
  "Pós-Doc" = NA,
  "Docente" = NA,
  check.names = FALSE
)

ID <- unique(formacao.continuada$`Identificador da Pessoa`)
for (i in 1:length(ID)) {
  # select data by ID
  data <- formacao.continuada %>%
    dplyr::filter(`Identificador da Pessoa` == ID[i])
  # get name
  table[i, "Nome"] <- data$Nome[1]
  # get year of start and end for discentes equal to bacharelado
  table[i, "Bacharelado"] <- min(data$`Data Matrícula`[data$Nível == "Bacharelado"], na.rm = TRUE)
  table[i, "Bacharelado"] <- format(as.Date(table[i, "Bacharelado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to mestrado
  table[i, "Mestrado"] <- min(data$`Data Matrícula`[data$Nível == "Mestrado"], na.rm = TRUE)
  table[i, "Mestrado"] <- format(as.Date(table[i, "Mestrado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to doutorado
  table[i, "Doutorado"] <- min(data$`Data Matrícula`[data$Nível == "Doutorado"], na.rm = TRUE)
  table[i, "Doutorado"] <- format(as.Date(table[i, "Doutorado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for pós-doc
  table[i, "Pós-Doc"] <- min(data$`Vínculo Início`, na.rm = TRUE)
  table[i, "Pós-Doc"] <- format(as.Date(table[i, "Pós-Doc"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for docentes
  table[i, "Docente"] <- min(data$`Data de Admissão`, na.rm = TRUE)
  table[i, "Docente"] <- format(as.Date(table[i, "Docente"], format = "%d/%m/%Y"), "%Y")
}

# add last colum with total number of years
table$Atuações <- apply(table, 1, function(x) {
  sum(!is.na(x)) - 1
})

# add last column with the lowest and higher levels of education. Paste levels
table$Formação <- apply(table, 1, function(x) {
  # drop first and last columns
  x <- x[-c(1, length(x))]
  # get lower column with data
  lower <- which(!is.na(x))[1]
  # get higher column with data
  higher <- which(!is.na(x))[length(which(!is.na(x)))]
  if(length(which(!is.na(x))) == 1) {
    return(names(x)[lower])
  } else {
    return(paste(names(x)[lower], names(x)[higher], sep = " - "))
  }
})

# sort by iniciacao científica, mestrado, doutorado, pós-doc, docente e nome
table.continuada <- table %>%
  dplyr::arrange(
    `Bacharelado`,
    `Mestrado`,
    `Doutorado`,
    `Pós-Doc`,
    `Docente`,
    Nome
  )

# to long format
table.continuada <- table.continuada %>%
  tidyr::pivot_longer(
    cols = c(`Bacharelado`, `Mestrado`, `Doutorado`, `Pós-Doc`, `Docente`),
    names_to = "Nível",
    values_to = "Ano"
  )

# drop NA values
table.continuada <- table.continuada %>%
  dplyr::filter(!is.na(Ano))

# select data with Quadrienal in range of quadrienal.vigente
table.continuada <- table.continuada %>%
  dplyr::filter(Ano >= quadrienal.vigente[1] & Ano <= quadrienal.vigente[length(quadrienal.vigente)])

# select columns to print
table.continuada.part <- table.continuada %>%
  dplyr::select(Atuações, Nível, Formação, Ano)

# sort by Ano
table.continuada.part <- table.continuada.part %>%
  dplyr::arrange(Ano, Atuações, Nível, Formação)

# Select rows where Formação contains " - " using base R
try(table.continuada.part <- table.continuada.part[grepl(" - ", table.continuada.part$Formação), ], silent = TRUE)

# reload previous table if current is empty
if(nrow(table.continuada.part) == 0) {
  table.continuada.part <- table.continuada %>%
    dplyr::select(Atuações, Nível, Formação, Ano)
}

# get available levels
niveis <- unique(table.continuada.part$Formação)
niveis.todos <- c(
  "Bacharelado",
  "Mestrado",
  "Doutorado",
  "Pós-Doc",
  "Docente",
  "Bacharelado - Mestrado",
  "Bacharelado - Doutorado",
  "Bacharelado - Pós-Doc",
  "Bacharelado - Docente",
  "Mestrado - Doutorado",
  "Mestrado - Pós-Doc",
  "Mestrado - Docente",
  "Doutorado - Pós-Doc",
  "Doutorado - Docente",
  "Pós-Doc - Docente"
)

niveis.usados <- niveis.todos[niveis.todos %in% niveis]

# order levels of Formação
table.continuada.part$Formação <- factor(
  table.continuada.part$Formação,
  levels = niveis.usados
)

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# print tables
if(!sjmisc::is_empty(table.continuada)){
  table.2.3.1 <-
    gtsummary::tbl_summary(
      table.continuada.part,
      by = "Ano",
      statistic = list(gtsummary::all_categorical() ~ "{n}"),
      missing = "no",
      digits = gtsummary::everything() ~ 0
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::bold_labels() %>%
    tbl_fix_order() %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA)
} else {
  table.2.3.1 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.3.1)) {
  table.2.3.1 <- table.2.3.1 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.3.1)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.3.1)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.3.1,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Formação continuada no Programa")
  ) %>% 
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(table.continuada.part$Ano))+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(unique(table.continuada.part$Ano))), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# retrieve data to print details with atuações > 1
table.continuada.2 <- table.continuada %>%
  dplyr::filter(Atuações > 1)

# paste rows with Ano based on same Nome
table.continuada.2 <- table.continuada.2 %>%
  dplyr::group_by(Nome) %>%
  dplyr::summarise(
    Atuações = sum(Atuações),
    Nível = paste(Nível, collapse = " - "),
    Formação = paste(Formação, collapse = " - "),
    Ano = paste(Ano, collapse = " - ")
  )

# drop formação
table.continuada.2 <- table.continuada.2 %>%
  dplyr::select(-Atuações, -Formação)

# Nome to title case
table.continuada.2$Nome <- tools::toTitleCase(tolower(table.continuada.2$Nome))

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(table.continuada.2)) {
  # use kable for HTML output
  knitr::kable(
    table.continuada.2,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Formação continuada no Programa - Detalhes"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(table.continuada.2)[2], width = paste0(c(0.60,0.25,0.15)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(table.continuada.2)) {
  # use tinytable for LaTeX output
  summ.df <- data.frame(table.continuada.2, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.continuada.2,
    width = c(0.60,0.25,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Formação continuada no Programa - Detalhes"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.continuada.2), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.continuada.2), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-3-2, eval = all(render_document, knitr::is_html_output())}
cat("### **2.3.2**")
cat('\n\n')
cat("#### **Egressos de destaque na sociedade** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.3.2 Egressos de destaque na sociedade**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-4-1, eval = all(render_document, knitr::is_html_output())}
cat("### **2.4.1**")
cat('\n\n')
cat("#### **Produção bibliográfica total do Programa – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.4.1 Produção bibliográfica total do Programa – Acadêmico**")
cat('\n\n')
```

```{r 2-4-1-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Produções - Autores
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.bibl <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.bibl) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter by Subtipo = Trabalho Em Anais
sucupira.df.bibl <- sucupira.df.bibl %>% 
  dplyr::filter(`Subtipo de Produção` == "ARTIGO EM PERIÓDICO" | `Subtipo de Produção` == "LIVRO")

# get unique ID da Produção
ID <- unique(sucupira.df.bibl$`ID da Produção`)

# filter ID that has "Categoria do Autor" == "Docente" ou Discente" ou "Egresso"

valid_ids <- vector()
for (id in unique(sucupira.df.bibl$`ID da Produção`)) {
  subset_data <- sucupira.df.bibl[sucupira.df.bibl$`ID da Produção` == id, ]
  if ("Docente" %in% subset_data$`Categoria do Autor` && 
      (any(subset_data$`Categoria do Autor` == "Discente") || 
       any(subset_data$`Categoria do Autor` == "Egresso"))) {
    valid_ids <- c(valid_ids, id)
  }
}
ID <- ID[ID %in% valid_ids]

# select sucupira.df.bibl with matching ID
sucupira.df.bibl <- sucupira.df.bibl[sucupira.df.bibl$`ID da Produção` %in% ID,]

sucupira.df.bibl <- sucupira.df.bibl %>% 
  dplyr::select(
    "ID da Produção",
    "Anos",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Nome do Autor",
    "Número de Ordem do Autor",
    "Categoria do Autor"
  )

# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.details <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.details) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# select sucupira.df.details with matching ID
sucupira.df.details <- sucupira.df.details[sucupira.df.details$`ID da Produção` %in% ID,]

sucupira.df.details <- sucupira.df.details %>% 
  dplyr::select(
    "ID da Produção",
    "Anos",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Item de Detalhamento",
    "Valor do Item de Detalhamento",
    "Categoria do Autor Principal"
  )
sucupira.df.bibl$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.bibl$`Tipo de Produção`))
sucupira.df.bibl$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df.bibl$`Subtipo de Produção`))
sucupira.df.bibl$`Nome do Autor` <- tools::toTitleCase(tolower(sucupira.df.bibl$`Nome do Autor`))

sucupira.df.bibl$`Tipo de Produção`[is.na(sucupira.df.bibl$`Tipo de Produção`)] <- "Indefinido"
sucupira.df.bibl$`Subtipo de Produção`[is.na(sucupira.df.bibl$`Subtipo de Produção`)] <- "Indefinido"

sucupira.df.details$`Categoria do Autor Principal`[is.na(sucupira.df.bibl$`Categoria do Autor Principal`)] <- "Indefinido"
```

```{r 2-4-1-bibliografica, eval=all(render_document, has.sucupira.files), echo=FALSE, fig.align='center', fig.pos='H', message=FALSE, warning=FALSE, results='asis'}
# filter sucupira.df.bibl by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df.bibl[sucupira.df.bibl$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.bib$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(unique(sucupira.df.bib$`ID da Produção`), table.bib)
colnames(table.bib) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.bib)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.bib[i, 1]
    ano <- quadrienal.vigente[j]
    table.bib[i, j + 1] <- ifelse(
      id %in% sucupira.df.bib$`ID da Produção`[sucupira.df.bib$Anos == ano],
      sucupira.df.bib$`Subtipo de Produção`[match(id, sucupira.df.bib$`ID da Produção`)],
      NA
    )
  }
}

table.bib.long <-
  tidyr::gather(dplyr::select(table.bib, -1),
                "Ano",
                "Nome da Produção",
                colnames(table.bib)[-1],
                factor_key = TRUE
  )

table.bib.long <- rbind(
  table.bib.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.bib[, -1]))),
    "Nome da Produção" = rep("Produção", times = sum(!is.na(table.bib[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica com discente")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.bib)) {
  # Print tables
  table.bib.gt <- gtsummary::tbl_summary(
    table.bib.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção bibliográfica com discente'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.bib.gt <- list()
}
```

```{r 2-4-1-natureza, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "Natureza"
sucupira.df.nat <- sucupira.df.details %>%
  dplyr::filter(`Item de Detalhamento` == "Natureza" | `Item de Detalhamento` == "Tipo da Contribuição na Obra"
  )

# to title case
sucupira.df.nat$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.nat$`Valor do Item de Detalhamento`))

# replace completo por artigo completo
sucupira.df.nat$`Valor do Item de Detalhamento` <- ifelse(
  sucupira.df.nat$`Valor do Item de Detalhamento` == "Completo",
  "Artigo (Completo)",
  sucupira.df.nat$`Valor do Item de Detalhamento`
)

# replace resumo por artigo resumo
sucupira.df.nat$`Valor do Item de Detalhamento` <- ifelse(
  sucupira.df.nat$`Valor do Item de Detalhamento` == "Resumo",
  "Artigo (Resumo)",
  sucupira.df.nat$`Valor do Item de Detalhamento`
)

table.nat <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.nat$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.nat) <- NULL
table.nat <- cbind(unique(sucupira.df.nat$`ID da Produção`), table.nat)
colnames(table.nat) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.nat)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.nat[i, 1]
    ano <- quadrienal.vigente[j]
    table.nat[i, j + 1] <- ifelse(
      id %in% sucupira.df.nat$`ID da Produção`[sucupira.df.nat$Anos == ano],
      sucupira.df.nat$`Valor do Item de Detalhamento`[match(id, sucupira.df.nat$`ID da Produção`)],
      NA
    )
  }
}

table.nat.long <-
  tidyr::gather(dplyr::select(table.nat, -1),
                "Ano",
                "Natureza",
                colnames(table.nat)[-1],
                factor_key = TRUE
  )

table.nat.long <- rbind(
  table.nat.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.nat[, -1]))),
    "Natureza" = rep("Natureza", times = sum(!is.na(table.nat[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Natureza", na.rm = TRUE), digits = 0)
}

colnames(table.nat.long) <- c("Ano", "Natureza da produção")

# change all column types to factors
table.nat.long <- table.nat.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
if(!sjmisc::is_empty(table.nat)) {
  # Print tables
  table.nat.gt <- gtsummary::tbl_summary(
    table.nat.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Natureza da produção'),
      type = "level",
      level_value = ("Natureza")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.nat.gt <- list()
}
```

```{r 2-4-1-local, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter `Item de Detalhamento` = "Idioma"
sucupira.df.local <- sucupira.df.details %>%
  dplyr::filter(`Item de Detalhamento` == "Idioma")

# to title case
sucupira.df.local$`Valor do Item de Detalhamento` <- tools::toTitleCase(tolower(sucupira.df.local$`Valor do Item de Detalhamento`))

table.local <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.local$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.local) <- NULL
table.local <- cbind(unique(sucupira.df.local$`ID da Produção`), table.local)
colnames(table.local) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.local)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.local[i, 1]
    ano <- quadrienal.vigente[j]
    table.local[i, j + 1] <- ifelse(
      id %in% sucupira.df.local$`ID da Produção`[sucupira.df.local$Anos == ano],
      sucupira.df.local$`Valor do Item de Detalhamento`[match(id, sucupira.df.local$`ID da Produção`)],
      NA
    )
  }
}

table.local.long <-
  tidyr::gather(dplyr::select(table.local, -1),
                "Ano",
                "País",
                colnames(table.local)[-1],
                factor_key = TRUE
  )

table.local.long <- rbind(
  table.local.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.local[, -1]))),
    "País" = rep("País", times = sum(!is.na(table.local[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "País", na.rm = TRUE), digits = 0)
}

colnames(table.local.long) <- c("Ano", "País")

# change all column types to factors
table.local.long <- table.local.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.local)) {
  # Print tables
  table.local.gt <- gtsummary::tbl_summary(
    table.local.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('País'),
      type = "level",
      level_value = ("País")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.local.gt <- list()
}
```

```{r 2-4-1-docente, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
sucupira.df.autor <- sucupira.df.bibl

table.docente <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.autor$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.docente) <- NULL
table.docente <- cbind(unique(sucupira.df.autor$`ID da Produção`), table.docente)
colnames(table.docente) <- c("ID da Produção", as.character(quadrienal.vigente))

# check protagonismo docente in sucupira.df.bibl$"Número de Ordem do Autor": 1st, 2nd, 2nd last, last
# loop across ID
for(i in 1:length(ID)){
  subset <- sucupira.df.autor[sucupira.df.autor$`ID da Produção` == ID[i], ]
  coluna <- which(unique(subset$Anos) == quadrienal.vigente)
  # separate checks for 2 authors, 3 authors, 4 authors, and 5 or more authors
  # if authors == 2
  if(dim(subset)[1] == 2){
    protagonista <- which(subset$`Nome do Autor` %in% docentes.quadrienio == TRUE)
    if(!sjmisc::is_empty(protagonista)){
      table.docente[i, coluna + 1] <- subset$`Nome do Autor`[protagonista]
    }
  }
  # if authors == 3
  else if(dim(subset)[1] == 3){
    protagonista <- which(subset$`Nome do Autor` %in% docentes.quadrienio == TRUE)
    if(!sjmisc::is_empty(protagonista)){
      # if protagonista has 1
      if(1 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[1]}
      else if(2 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[2]}
      else if(3 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[3]}
    }
  }
  # if authors == 4
  else if(dim(subset)[1] == 4){
    protagonista <- which(subset$`Nome do Autor` %in% docentes.quadrienio == TRUE)
    if(!sjmisc::is_empty(protagonista)){
      # if protagonista has 1
      if(4 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[4]}
      else if(3 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[3]}
      else if(2 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[2]}
      else if(1 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[1]}
    }
  }
  # if authors == 5 or more
  else if(dim(subset)[1] >= 5){
    protagonista <- which(subset$`Nome do Autor` %in% docentes.quadrienio == TRUE)
    if(!sjmisc::is_empty(protagonista)){
      # if protagonista is last
      if(dim(subset)[1] %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[dim(subset)[1]]}
      # if protagonista is second last
      else if((dim(subset)[1] - 1) %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[(dim(subset)[1] - 1)]}
      # if protagonista is second
      else if(2 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[2]}
      # if protagonista is first
      else if(1 %in% protagonista){table.docente[i, coluna + 1] <- subset$`Nome do Autor`[1]}
      # if protagonista is in between
      else{
        for(j in 1:dim(subset)[1]){
          if(j %in% protagonista){
            table.docente[i, coluna + 1] <- subset$`Nome do Autor`[j]
          }
        }
      }
    }
  }
}

table.docente.long <-
  tidyr::gather(dplyr::select(table.docente, -1),
                "Ano",
                "Docente",
                colnames(table.docente)[-1],
                factor_key = TRUE
  )

table.docente.long <- rbind(
  table.docente.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.docente[, -1]))),
    "Docente" = rep("Docente", times = sum(!is.na(table.docente[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docente", na.rm = TRUE), digits = 0)
}

colnames(table.docente.long) <- c("Ano", "Docente (protagonista)")

# change all column types to factors
table.docente.long <- table.docente.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

if(!sjmisc::is_empty(table.docente)) {
  # Print tables
  table.docente.gt <- gtsummary::tbl_summary(
    table.docente.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "alphanumeric"
  ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Docente (protagonista)'),
      type = "level",
      level_value = ("Docente")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.docente.gt <- list()
}
```

```{r 2-4-1-list-tables, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# producão
# List all tables
table.2.4.1.a <- list(
  table.bib.gt,
  table.nat.gt,
  table.local.gt,
  table.docente.gt
)

# Drop empty elements from the list
table.2.4.1.a <- table.2.4.1.a[lapply(table.2.4.1.a, length) > 0]
if(any(lapply(table.2.4.1.a, length) > 0)){
  table.2.4.1.a <- gtsummary::tbl_stack(table.2.4.1.a)
} else {
  table.2.4.1.a <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.4.1.a)) {
  table.2.4.1.a <- table.2.4.1.a %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>") %>%
    gtsummary::modify_source_note("O protagonismo do docente permanente foi definido pela ordem de autoria: 1º autor, 2º autor, penúltmo ou último")
  
  print(table.2.4.1.a)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.4.1.a)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.4.1.a,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Produção bibliográfica (artigos/livros/capítulos) dos Docentes Permanentes produzidos em coautoria com os discentes/egressos")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
        "Protagonismo definido pela ordem de autoria: 1º autor, 2º autor, penúltimo ou último"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{=latex}
\newpage
\FloatBarrier
```

<br>

\blandscape

```{r 2-5-1, eval = all(render_document, knitr::is_html_output())}
cat("### **2.5.1**")
cat('\n\n')
cat("#### **Atividades de ensino nas disciplinas do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.5.1 Atividades de ensino nas disciplinas do PPG**")
cat('\n\n')
```

```{r turmas, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(quadrienal.vigente, names(sucupira.list)))]
turmas.raw <- data.frame(do.call(dplyr::bind_rows, sucupira.list[periodos]), check.names = FALSE)

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "Nível do curso",
                                                  "ID pessoa do responsável")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "Período/Ano",
    "Nível do curso",
    "Nome da Disciplina",
    "Categoria do responsável",
    "Nome do responsável",
    "Indicador de responsável principal"
  ))

# change to title case
turmas$`Nome da Disciplina` <- tools::toTitleCase(tolower(turmas$`Nome da Disciplina`))
turmas$`Nome do responsável` <- tools::toTitleCase(tolower(turmas$`Nome do responsável`))

# rename
colnames(turmas) <- c(
  "Período/Ano",
  "Disciplinas",
  "Disciplina",
  "Categoria",
  "Docente responsável",
  "Responsável"
)

# unique disciplinas por periodo/ano
turmas.curso <- turmas %>%
  dplyr::distinct(`Período/Ano`, `Disciplinas`, `Disciplina`, .keep_all = TRUE)

# generate table (total by year)
if(!sjmisc::is_empty(turmas.curso)){
  table.part1 <-
    gtsummary::tbl_summary(
      turmas.curso %>% dplyr::select(
        "Período/Ano",
        "Disciplinas",
        "Categoria"
      ),
      by = "Período/Ano",
      type = list(
        "Disciplinas" ~ "categorical",
        "Categoria" ~ "categorical"
      ),
      statistic = list(
        "Disciplinas" ~ "{n}",
        "Categoria" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.part1 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.part1)) {
  table.part1 <- table.part1 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.part1)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.part1)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part1,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Turmas oferecidas por curso e categoria por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(turmas$"Período/Ano"))), width = paste0(c(0.15, rep(0.85/(length(unique(turmas$"Período/Ano"))), times = length(unique(turmas$"Período/Ano"))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# generate table (total by year)
if(!sjmisc::is_empty(turmas.curso)){
  table.part2 <-
    gtsummary::tbl_summary(
      turmas.curso %>% dplyr::select(
        "Período/Ano",
        "Disciplina"
      ),
      by = "Período/Ano",
      type = list(
        "Disciplina" ~ "categorical"
      ),
      statistic = list(
        "Disciplina" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.part2 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.part2)) {
  table.part2 <- table.part2 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.part2)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.part2)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part2,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas oferecidas por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(turmas$"Período/Ano"))), width = paste0(c(0.60, rep(0.40/(length(unique(turmas$"Período/Ano"))), times = length(unique(turmas$"Período/Ano"))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# get turmas by responsável and categoria Docente
turmas.doc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Docente", ]

# as factor
turmas.doc$`Docente responsável` <- factor(turmas.doc$`Docente responsável`)

# check for missing docentes.quadrienio
turmas.doc$`Docente responsável` <- factor(
  turmas.doc$`Docente responsável`,
  levels = sort(unique(c(levels(turmas.doc$`Docente responsável`), docentes.quadrienio)))
)

# generate table
if(!sjmisc::is_empty(turmas.doc)){
  table.part3 <- 
    gtsummary::tbl_summary(
      turmas.doc %>% dplyr::select(
        "Período/Ano",
        "Docente responsável"
      ),
      by = "Período/Ano",
      type = list(
        "Docente responsável" ~ "categorical"
      ),
      statistic = list(
        "Docente responsável" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.part3 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.part3)) {
  table.part3 <- table.part3 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.part3)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.part3)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part3, addtl_fmt = TRUE,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Docentes responsáveis pelas disciplinas oferecidas por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(turmas.doc$"Período/Ano"))), width = paste0(c(0.60, rep(0.40/(length(unique(turmas.doc$"Período/Ano"))), times = length(unique(turmas.doc$"Período/Ano"))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}


# get turmas by responsável and categoria Pós-Doc
turmas.posdoc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Pós-Doc", ]

if(!sjmisc::is_empty(turmas.posdoc)){
  table.part4 <- 
    gtsummary::tbl_summary(
      turmas.posdoc %>% dplyr::select(
        "Período/Ano",
        "Docente responsável"
      ),
      by = "Período/Ano",
      type = list(
        "Docente responsável" ~ "categorical"
      ),
      statistic = list(
        "Docente responsável" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.part4 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(turmas.posdoc)) {
  table.part4 <- table.part4 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.part4)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(turmas.posdoc)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part4, addtl_fmt = TRUE,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Pós-docs responsáveis pelas disciplinas oferecidas por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(turmas.posdoc$"Período/Ano"))), width = paste0(c(0.60, rep(0.40/(length(unique(turmas.posdoc$"Período/Ano"))), times = length(unique(turmas.posdoc$"Período/Ano"))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output() && !sjmisc::is_empty(turmas.posdoc)) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{r 2-5-2, eval = all(render_document, knitr::is_html_output())}
cat("### **2.5.2**")
cat('\n\n')
cat("#### **Responsabilidade por PP/PTT** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.5.2 Responsabilidade por PP/PTT**")
cat('\n\n')
```

```{r 2-5-2-doc, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"])),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]), table.doc)
colnames(table.doc) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.doc)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.doc[i, j + 1] <-
      try(data$`Nome do Membro do Projeto`[match(table.doc$`Nome do Projeto de Pesquisa`[i],
                                                 data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(dplyr::select(table.doc, -1),
                "Ano",
                "Nome do Membro do Projeto",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to title case
table.doc.long$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(table.doc.long$`Nome do Membro do Projeto`))

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.doc)[1]),
    "Nome do Membro do Projeto" = rep("Membros", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Membros", na.rm = TRUE), digits = 0)
}

colnames(table.doc.long) <-
  c("Ano", "Projetos de pesquisa por Docente")

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
table.doc.long$`Projetos de pesquisa por Docente` <- factor(
  table.doc.long$`Projetos de pesquisa por Docente`,
  levels = sort(unique(c("Membros", levels(table.doc.long$`Projetos de pesquisa por Docente`), docentes.quadrienio)))
)

# print tables
table.doc.gt <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Projetos de pesquisa por Docente'),
    type = "level",
    level_value = ("Membros")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 2-5-2-docentes, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Docentes** {#docentes-linhas-pesquisa}")
  cat('\n\n')
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.doc.gt)) {
  table.doc.gt <- table.doc.gt %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.doc.gt)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.doc.gt)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.doc.gt,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Docentes Permanentes Responsáveis por Projetos")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# select data
table.projetos.doc <-
  sucupira.df %>% dplyr::select(
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Categoria do Membro do Projeto",
    "Situação"
  )

# if duplicated, keep Situacão = Concluído
table.projetos.doc <- table.projetos.doc[!duplicated(table.projetos.doc[1:5], fromLast = TRUE),]

# select data DOCENTES
table.doc <-
  table(table.projetos.doc$`Nome do Membro do Projeto`[table.projetos.doc$`Categoria do Membro do Projeto` == "Docente"],
        table.projetos.doc$`Linha de Pesquisa`[table.projetos.doc$`Categoria do Membro do Projeto` == "Docente"])

# add row totals
table.doc <- cbind(table.doc, rowSums(table.doc))
colnames(table.doc) <- stringr::str_to_title(c(head(colnames(table.doc), -1), "Quadriênio"))

# add column totals
table.doc <- rbind(table.doc, colSums(table.doc))
rownames(table.doc) <- stringr::str_to_title(c(head(rownames(table.doc), -1), "Quadriênio"))

# add name column
table.doc <- cbind(
  "Nome do Membro do Projeto" = rownames(table.doc),
  table.doc
)

table.doc <- cbind(
  c(seq(1, dim(table.doc)[1] - 1), ""),
  table.doc
)

colnames(table.doc) <-
  c("ID", colnames(table.doc)[-1])
rownames(table.doc) <- NULL

# drop ID column
table.doc <- table.doc[, -1]

# change page layout to landscape using LaTeX command
if(knitr::is_latex_output()) {
  cat('\\blandscape')
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(table.projetos.doc)) {
  # use kable for HTML output
  knitr::kable(
    table.doc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Docentes Permanentes Responsáveis por Projetos, por Linha de Pesquisa"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:(length(unique(table.projetos.doc$`Linha de Pesquisa`))+1), width = paste0(c(0.25, rep(0.65/length(unique(table.projetos.doc$`Linha de Pesquisa`)), times = length(unique(table.projetos.doc$`Linha de Pesquisa`))), 0.10)*(29-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(table.projetos.doc)){
  # use tinytable for LaTeX output
  table.doc <- data.frame(table.doc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.doc,
    width = c(0.25, rep(0.65/length(unique(table.projetos.doc$`Linha de Pesquisa`)), times = length(unique(table.projetos.doc$`Linha de Pesquisa`))), 0.10),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Docentes Permanentes Responsáveis por Projetos, por Linha de Pesquisa"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.doc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.doc), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# change page layout to landscape using LaTeX command
if(knitr::is_latex_output()) {
  cat('\\elandscape')
}
```

<br>

\blandscape

```{r 2-5-3, eval = all(render_document, knitr::is_html_output())}
cat("### **2.5.3**")
cat('\n\n')
cat("#### **Orientação no PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.5.3 Orientação no PPG**")
cat('\n\n')
```

```{r 2-5-3-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Discentes - Orientadores
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.orient <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.orient) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter by Nível Discente (remove B)
sucupira.df.orient <- sucupira.df.orient %>% 
  dplyr::filter(`Nível Discente` != "Bacharelado")

sucupira.df.orient <- sucupira.df.orient %>% 
  dplyr::select(
    "Anos",
    "Identificador do Discente",
    "Nome Discente",
    "Situação Discente",
    "Identificador do Orientador",
    "Nome do Orientador",
    "Tipo de Orientador",
    "Orientador Principal?",
    "Nível Discente"
  )

# replace missing values with Indefinido
sucupira.df.orient$`Nome do Orientador`[is.na(sucupira.df.orient$`Nome do Orientador`)] <- "Indefinido"
sucupira.df.orient$`Orientador Principal?`[is.na(sucupira.df.orient$`Orientador Principal?`)] <- "Indefinido"

sucupira.df.orient$`Nome do Orientador` <- tools::toTitleCase(tolower(sucupira.df.orient$`Nome do Orientador`))
sucupira.df.orient$`Nível Discente` <- tools::toTitleCase(tolower(sucupira.df.orient$`Nível Discente`))
```

```{r 2-5-3-orient-matr, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter sucupira.df.orient by "Orientador Principal?" == "Sim"
sucupira.df.matr <- sucupira.df.orient[sucupira.df.orient$`Orientador Principal?` == "Sim", ]

# filter sucupira.df.matr by "Situação Discente" == "Matriculado"
sucupira.df.matr <- sucupira.df.matr[sucupira.df.matr$`Situação Discente` == "MATRICULADO", ]

# change all column types to factors
sucupira.df.matr <- sucupira.df.matr %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
sucupira.df.matr$`Nome do Orientador` <- factor(
  sucupira.df.matr$`Nome do Orientador`,
  levels = sort(unique(c(levels(factor(sucupira.df.matr$`Nome do Orientador`)), docentes.quadrienio)))
)

# check nlevels of Nível Discente
if (nlevels(sucupira.df.matr$`Nível Discente`) != 0) {
  if (nlevels(sucupira.df.matr$`Nível Discente`) == 1) {
    # Mestrado OU Doutorado
    # Print tables
    table.matr.gt <- sucupira.df.matr |>
      dplyr::select('Anos', 'Nome do Orientador') |>
      gtsummary::tbl_summary(
        by = Anos,
        statistic = list(gtsummary::all_categorical() ~ "{n}"),
        missing = "no",
        digits = gtsummary::everything() ~ 0,
        sort = gtsummary::all_categorical() ~ "alphanumeric"
      ) %>%
      gtsummary::modify_header(label = "**Nome do Orientador (Principal)**") %>%
      gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
      gtsummary::bold_labels()
  } else if (nlevels(sucupira.df.matr$`Nível Discente`) == 2) {
    # Mestrado & Doutorado
    # Print tables
    table.matr.gt <- sucupira.df.matr |>
      dplyr::select('Anos', 'Nome do Orientador', 'Nível Discente') |>
      gtsummary::tbl_strata(
        strata = 'Nível Discente',
        .tbl_fun =
          ~ .x |>
          gtsummary::tbl_summary(
            by = Anos,
            statistic = list(gtsummary::all_categorical() ~ "{n}"),
            missing = "no",
            digits = gtsummary::everything() ~ 0,
            sort = gtsummary::all_categorical() ~ "alphanumeric"
          ) %>%
          gtsummary::modify_header(label = "**Discentes matriculados**") %>%
          gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
          gtsummary::bold_labels(),
        .header = paste0("**{strata}**")
      )
  }
  
  # Print HTML table
  if (knitr::is_html_output() && !sjmisc::is_empty(sucupira.df.matr)) {
    table.matr.gt <- table.matr.gt %>%
      gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
    
    
    print(table.matr.gt)
  }
  
  # Print LaTeX table
  if (knitr::is_latex_output() && !sjmisc::is_empty(sucupira.df.matr)) {
    cat('\\FloatBarrier')
    # Convert gtsummary object to kableExtra object
    kable_table <- gtsummary::as_kable_extra(
      x = table.matr.gt,
      escape = FALSE, addtl_fmt = TRUE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", "Relação de orientadores com alunos matriculados por ano"),
    ) %>%
      kableExtra::kable_styling(
        bootstrap_options = c("basic", "hover", "condensed", "responsive"),
        latex_options = c("basic", "repeat_header", "HOLD_position"),
        latex_table_env = "tabularx",
        full_width = TRUE,
        position = "center"
      ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(sucupira.df.matr$Anos))*nlevels(sucupira.df.matr$"Nível Discente")), width = paste0(c(0.55, rep(0.45/(length(unique(sucupira.df.matr$Anos))*nlevels(sucupira.df.matr$"Nível Discente")), times = length(unique(sucupira.df.matr$Anos))*nlevels(sucupira.df.matr$"Nível Discente")))*(29-3-3), "cm")) %>%
      kableExtra::footnote(
        general_title = "\\\\textbf{Fontes}:",
        general = c(
          "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
        ),
        escape = FALSE)
    print(kable_table)
  }
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-5-4, eval = all(render_document, knitr::is_html_output())}
cat("### **2.5.4**")
cat('\n\n')
cat("#### **Titulação no PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.5.4 Titulação no PPG**")
cat('\n\n')
```

```{r 2-5-4-orient-tit, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter sucupira.df.orient by "Orientador Principal?" == "Sim"
sucupira.df.tit <- sucupira.df.orient[sucupira.df.orient$`Orientador Principal?` == "Sim", ]

# filter sucupira.df.tit by "Situação Discente" == "Titulado"
sucupira.df.tit <- sucupira.df.tit[sucupira.df.tit$`Situação Discente` == "TITULADO", ]

# change all column types to factors
sucupira.df.tit <- sucupira.df.tit %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
sucupira.df.tit$`Nome do Orientador` <- factor(
  sucupira.df.tit$`Nome do Orientador`,
  levels = sort(unique(c(levels(factor(sucupira.df.tit$`Nome do Orientador`)), docentes.quadrienio)))
)

# check nlevels of Nível Discente
if (nlevels(sucupira.df.tit$`Nível Discente`) != 0) {
  if (nlevels(sucupira.df.tit$`Nível Discente`) == 1) {
    # Mestrado OU Doutorado
    # Print tables
    table.tit.gt <- sucupira.df.tit |>
      dplyr::select('Anos', 'Nome do Orientador') |>
      gtsummary::tbl_summary(
        by = Anos,
        statistic = list(gtsummary::all_categorical() ~ "{n}"),
        missing = "no",
        digits = gtsummary::everything() ~ 0,
        sort = gtsummary::all_categorical() ~ "alphanumeric"
      ) %>%
      gtsummary::modify_header(label = "**Nome do Orientador (Principal)**") %>%
      gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
      gtsummary::bold_labels()
  } else if (nlevels(sucupira.df.tit$`Nível Discente`) == 2) {
    # Mestrado & Doutorado
    # Print tables
    table.tit.gt <- sucupira.df.tit |>
      dplyr::select('Anos', 'Nome do Orientador', 'Nível Discente') |>
      gtsummary::tbl_strata(
        strata = 'Nível Discente',
        .tbl_fun =
          ~ .x |>
          gtsummary::tbl_summary(
            by = Anos,
            statistic = list(gtsummary::all_categorical() ~ "{n}"),
            missing = "no",
            digits = gtsummary::everything() ~ 0,
            sort = gtsummary::all_categorical() ~ "alphanumeric"
          ) %>%
          gtsummary::modify_header(label = "**Discentes titulados**") %>%
          gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
          gtsummary::bold_labels(),
        .header = paste0("**{strata}**")
      )
  }
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(sucupira.df.tit)) {
  table.tit.gt <- table.tit.gt %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.tit.gt)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(sucupira.df.tit)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.tit.gt,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Relação de orientadores com alunos titulados por ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(sucupira.df.tit$Anos))*nlevels(sucupira.df.tit$"Nível Discente")), width = paste0(c(0.55, rep(0.45/(length(unique(sucupira.df.tit$Anos))*nlevels(sucupira.df.tit$"Nível Discente")), times = length(unique(sucupira.df.tit$Anos))*nlevels(sucupira.df.tit$"Nível Discente")))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

\blandscape

```{r 2-5-5, eval = all(render_document, knitr::is_html_output())}
cat("### **2.5.5**")
cat('\n\n')
cat("#### **Orientação na graduação** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **2.5.5 Orientação na graduação**")
cat('\n\n')
```

```{r 2-5-5-grad, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# keep docentes permanente only
sucupira <- lapply(sucupira, function(x) {
  x <- x[x$Categoria == "PERMANENTE", ]
  return(x)
})

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df.grad <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df.grad) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# inserção na graduação
sucupira.df.grad <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Orientações de Monografia",
    "Orientações de Iniciação Científica",
    "Orientações de Tutoria",
    "Número de Disciplinas da Graduação",
    "Carga Horária na Graduação (Anual)"
  )

sucupira.df.grad$`Nome Docente` <- tools::toTitleCase(tolower(sucupira.df.grad$`Nome Docente`))
```

```{r 2-5-5-orient-grad, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Create table
table.mono <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Orientações de Monografia"
  )

# drop rows with 0 values
table.mono <- table.mono %>%
  dplyr::filter(`Orientações de Monografia` > 0)

# repeat each rows by value column
table.mono <- table.mono[rep(row.names(table.mono), table.mono$`Orientações de Monografia`), ]

# check for missing docentes.quadrienio
table.mono$"Nome Docente" <- factor(
  table.mono$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.mono$"Nome Docente"), docentes.quadrienio)))
)

# check for missing anos in table.mono
table.mono$"Anos" <- factor(
  table.mono$"Anos",
  levels = sort(quadrienal.vigente)
)

# change all column types to factors
table.mono <- table.mono %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables tbl_cross with thee levels
if(!sjmisc::is_empty(table.mono)){
  table.mono.gt <- table.mono |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Anos",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Orientações na Graduação**", stat_0 = "Total") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.mono.gt <- list()
}

# Create table
table.ic <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Orientações de Iniciação Científica"
  )

# drop rows with 0 values
table.ic <- table.ic %>%
  dplyr::filter(`Orientações de Iniciação Científica` > 0)

# repeat each rows by value column
table.ic <- table.ic[rep(row.names(table.ic), table.ic$`Orientações de Iniciação Científica`), ]

# check for missing docentes.quadrienio
table.ic$"Nome Docente" <- factor(
  table.ic$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.ic$"Nome Docente"), docentes.quadrienio)))
)

# check for missing anos in table.ic
table.ic$"Anos" <- factor(
  table.ic$"Anos",
  levels = sort(quadrienal.vigente)
)

# change all column types to factors
table.ic <- table.ic %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables tbl_cross with thee levels
if(!sjmisc::is_empty(table.ic)){
  table.ic.gt <- table.ic |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Anos",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Orientações na Graduação**", stat_0 = "Total") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.ic.gt <- list()
}

# Create table
table.tut <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Orientações de Tutoria"
  )

# drop rows with 0 values
table.tut <- table.tut %>%
  dplyr::filter(`Orientações de Tutoria` > 0)

# repeat each rows by value column
table.tut <- table.tut[rep(row.names(table.tut), table.tut$`Orientações de Tutoria`), ]

# check for missing docentes.quadrienio
table.tut$"Nome Docente" <- factor(
  table.tut$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.tut$"Nome Docente"), docentes.quadrienio)))
)

# check for missing anos in table.tut
table.tut$"Anos" <- factor(
  table.tut$"Anos",
  levels = sort(quadrienal.vigente)
)

# change all column types to factors
table.tut <- table.tut %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables tbl_cross with thee levels
if(!sjmisc::is_empty(table.tut)){
  table.tut.gt <- table.tut |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Anos",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Orientações na Graduação**", stat_0 = "Total") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
} else {
  table.tut.gt <- list()
}

# List all tables
table.2.5.5a <- list(
  table.mono.gt,
  table.ic.gt,
  table.tut.gt
)

# Drop empty elements from the list
table.2.5.5a <- table.2.5.5a[lapply(table.2.5.5a, length) > 0]

spann <- c("**Orientações de Monografia**", "**Orientações de Iniciação Científica**", "**Orientações de Tutoria**")
spann <- spann[which(lapply(table.2.5.5a, length) > 0)]

if(any(lapply(table.2.5.5a, length) > 0)){
  table.2.5.5a <- gtsummary::tbl_merge(
    tbls = table.2.5.5a,
    tab_spanner = spann
  )
} else {
  table.2.5.5a <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.5.5a)) {
  table.2.5.5a <- table.2.5.5a %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.5.5a)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.5.5a)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.5.5a,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Inserção na Graduação - Orientação"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + (length(unique(sucupira.df.grad$Anos)))*length(spann)), width = paste0(c(0.40, rep(0.60/((length(unique(sucupira.df.grad$Anos)))*length(spann)*length(spann)), times = (length(unique(sucupira.df.grad$Anos))+1)*length(spann)))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 2-5-5-aulas-grad, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Create table
table.aulas <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Número de Disciplinas da Graduação"
  )

# drop rows with 0 values
table.aulas <- table.aulas %>%
  dplyr::filter(`Número de Disciplinas da Graduação` > 0)

# repeat each rows by value column
table.aulas <- table.aulas[rep(row.names(table.aulas), table.aulas$`Número de Disciplinas da Graduação`), ]

# check for missing docentes.quadrienio
table.aulas$"Nome Docente" <- factor(
  table.aulas$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.aulas$"Nome Docente"), docentes.quadrienio)))
)

# check for missing anos in table.aulas
table.aulas$"Anos" <- factor(
  table.aulas$"Anos",
  levels = sort(quadrienal.vigente)
)

# change all column types to factors
table.aulas <- table.aulas %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables tbl_cross with thee levels
if(!sjmisc::is_empty(table.aulas)){
  table.aulas.gt <- table.aulas |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Anos",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Disciplinas na Graduação**", stat_0 = "Total") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.aulas.gt <- list()
}

# Create table
table.ch <- sucupira.df.grad %>% 
  dplyr::select(
    "Anos",
    "Nome Docente",
    "Carga Horária na Graduação (Anual)"
  )

# drop rows with 0 values
table.ch <- table.ch %>%
  dplyr::filter(`Carga Horária na Graduação (Anual)` > 0)

# repeat each rows by value column
table.ch <- table.ch[rep(row.names(table.ch), table.ch$`Carga Horária na Graduação (Anual)`), ]

# check for missing docentes.quadrienio
table.ch$"Nome Docente" <- factor(
  table.ch$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.ch$"Nome Docente"), docentes.quadrienio)))
)

# check for missing anos in table.ch
table.ch$"Anos" <- factor(
  table.ch$"Anos",
  levels = sort(quadrienal.vigente)
)

# change all column types to factors
table.ch <- table.ch %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables tbl_cross with thee levels
if(!sjmisc::is_empty(table.ch)){
  table.ch.gt <- table.ch |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Anos",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Disciplinas na Graduação - Carga Horária (Anual)**", stat_0 = "Total") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.ch.gt <- list()
}

# List all tables
table.2.5.5b <- list(
  table.aulas.gt,
  table.ch.gt
)

# Drop empty elements from the list
table.2.5.5b <- table.2.5.5b[lapply(table.2.5.5b, length) > 0]

spann <- c("**Disciplinas na Graduação**", "**Carga Horária (Anual)**")
spann <- spann[which(lapply(table.2.5.5b, length) > 0)]

if(any(lapply(table.2.5.5b, length) > 0)){
  table.2.5.5b <- gtsummary::tbl_merge(
    tbls = table.2.5.5b,
    tab_spanner = spann
  )
} else {
  table.2.5.5b <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.2.5.5b)) {
  table.2.5.5b <- table.2.5.5b %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.2.5.5b)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.2.5.5b)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.5.5b,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Inserção na Graduação - Disciplinas"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + (length(unique(sucupira.df.grad$Anos)))*length(spann)), width = paste0(c(0.40, rep(0.60/((length(unique(sucupira.df.grad$Anos)))*length(spann)*length(spann)), times = (length(unique(sucupira.df.grad$Anos))+1)*length(spann)))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 2-5-5-insercao-grad, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Create table
# drop Ano
table.insercao <- sucupira.df.grad %>%
  dplyr::select(
    -"Anos"
  )

# as numeric
table.insercao[, 2:ncol(table.insercao)] <- lapply(table.insercao[, 2:ncol(table.insercao)], as.numeric)

# sum columns by Nome docente
table.insercao <- table.insercao %>% 
  dplyr::mutate(
    `Atuação graduação` = rowSums(dplyr::select(., -`Nome Docente`))
  )

# drop Atuação externa
table.insercao <- table.insercao %>%
  dplyr::select(
    -"Atuação graduação"
  )

# to long table, by Nome Docente
table.insercao <- table.insercao %>%
  tidyr::pivot_longer(
    cols = -c("Nome Docente"),
    names_to = "Atuação graduação"
  )

# drop rows with 0 values
table.insercao <- table.insercao %>%
  dplyr::filter(
    `value` > 0
  )

# repeat each rows by value column
table.insercao <- table.insercao[rep(row.names(table.insercao), table.insercao$value), ]

# drop value
table.insercao <- table.insercao %>%
  dplyr::select(
    "Nome Docente",
    "Atuação graduação"
  )

# check for missing docentes.quadrienio
table.insercao$"Nome Docente" <- factor(
  table.insercao$"Nome Docente",
  levels = sort(unique(c(levels(sucupira.df.grad$`Nome Docente`), docentes.quadrienio)))
)

# change all column types to factors
table.insercao.long <- table.insercao %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print table
if(!sjmisc::is_empty(table.insercao.long)){
  table.insercao.gt.1 <- table.insercao.long |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Atuação graduação",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "Docentes permanentes", stat_0 = "Atuação graduação") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.insercao.gt.1 <- list()
}

# Create table
# drop Ano
table.insercao.2 <- sucupira.df.grad %>%
  dplyr::select(
    -"Anos"
  )

# as numeric
table.insercao.2[, 2:ncol(table.insercao.2)] <- lapply(table.insercao.2[, 2:ncol(table.insercao.2)], as.numeric)

# sum rowns of sucupira.df.grad by Nome Docente
table.insercao.2 <- table.insercao.2 %>%
  aggregate(. ~ `Nome Docente`, data = ., sum)

# create atuação externa data.frame
table.insercao.2 <- data.frame(
  "Nome Docente" = table.insercao.2$"Nome Docente",
  "Atuação graduação" = ifelse(rowSums(table.insercao.2[, 2:ncol(table.insercao.2)]) != 0, "Sim", "Não"),
  check.names = FALSE
)

# print table
if(!sjmisc::is_empty(table.insercao.2)){
  table.insercao.2.gt.2 <- table.insercao.2 |>
    gtsummary::tbl_cross(
      row = 'Nome Docente',
      col = "Atuação graduação",
      statistic = "{n}",
      missing = "no",
      digits = 0,
      margin = NULL
    ) %>%
    gtsummary::modify_header(label = "**Docentes permanentes com atuação na graduação**", stat_0 = "Atuação graduaçào") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() 
} else {
  table.insercao.2.gt.2 <- list()
}

# create list of gtsummary tables
table.insercao.list <- list(table.insercao.2.gt.2, table.insercao.gt.1)
# remove empty list elements
table.insercao.list <- table.insercao.list[!sapply(table.insercao.list, sjmisc::is_empty)]

spann <- c("**Atuação graduação**", "**Atividades de inserção na Graduação**")
spann <- spann[which(lapply(table.insercao.list, length) > 0)]

if(any(lapply(table.insercao.list, length) > 0)){
  table.insercao.gt <- gtsummary::tbl_merge(
    tbls = table.insercao.list,
    tab_spanner = spann
  )
} else {
  table.insercao.gt <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.insercao.gt)) {
  table.insercao.gt <- table.insercao.gt %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.insercao.gt)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.insercao.gt)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.insercao.gt,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "**Docentes permanentes com atuação na graduação**"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + (nlevels(factor(table.insercao.2$`Atuação graduação`))+nlevels(factor(table.insercao$`Atuação graduação`)))), width = paste0(c(0.40, rep(0.60/((nlevels(factor(table.insercao.2$`Atuação graduação`))+nlevels(factor(table.insercao$`Atuação graduação`)))), times = ((nlevels(factor(table.insercao.2$`Atuação graduação`))+nlevels(factor(table.insercao$`Atuação graduação`))))))*(29-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{=latex}
\newpage
\vspace*{\fill}
\section{\textbf{3. Impacto}}
\vspace*{\fill}
\newpage
```

```{r 3-Impacto, eval = all(render_document, knitr::is_html_output())}
cat("## **3. Impacto** {#impacto .tabset}")
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
```

```{r 3-1-1, eval = all(render_document, knitr::is_html_output())}
cat("### **3.1.1**")
cat('\n\n')
cat("#### **Produção bibliográfica indicada dos DP – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.1.1 Produção bibliográfica indicada dos DP – Acadêmico**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-1-2, eval = all(render_document, knitr::is_html_output())}
cat("### **3.1.2**")
cat('\n\n')
cat("#### **Produção do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.1.2 Produção do Programa**")
cat('\n\n')
```

```{r 3-1-2-data, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

sucupira.df <- sucupira.df %>% 
  dplyr::select(
    "ID da Produção",
    "Anos",
    "Nome da Produção",
    "Produção vinculada a TCC concluído",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Projeto",
    "Categoria do Autor Principal"
  )
sucupira.df$`Área de Concentração` <- tools::toTitleCase(tolower(sucupira.df$`Área de Concentração`))
sucupira.df$`Linha de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Linha de Pesquisa`))
sucupira.df$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Tipo de Produção`))
sucupira.df$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Subtipo de Produção`))

# replace NA values with "Indefinido"
sucupira.df$`Área de Concentração`[is.na(sucupira.df$`Área de Concentração`)] <- "Indefinido"
sucupira.df$`Linha de Pesquisa`[is.na(sucupira.df$`Linha de Pesquisa`)] <- "Indefinido"
sucupira.df$`Tipo de Produção`[is.na(sucupira.df$`Tipo de Produção`)] <- "Indefinido"
sucupira.df$`Subtipo de Produção`[is.na(sucupira.df$`Subtipo de Produção`)] <- "Indefinido"
sucupira.df$`Categoria do Autor Principal`[is.na(sucupira.df$`Categoria do Autor Principal`)] <- "Indefinido"
```

```{r 3-1-2-total, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.total <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.total) <- NULL
table.total <- cbind(unique(sucupira.df$`ID da Produção`), table.total)
colnames(table.total) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.total)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.total[i, 1]
    ano <- quadrienal.vigente[j]
    table.total[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      "Produção total",
      NA
    )
  }
}

table.total.long <-
  tidyr::gather(dplyr::select(table.total, -1),
                "Ano",
                "Tipo de Produção",
                colnames(table.total)[-1],
                factor_key = TRUE
  )

table.total.long <- rbind(
  table.total.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.total[, -1]))),
    "Tipo de Produção" = rep("Produção", times = sum(!is.na(table.total[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.total.long) <- c("Ano", "Produção total")

# change all column types to factors
table.total.long <- table.total.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.total)){
  table.tot.gt <- gtsummary::tbl_summary(
    table.total.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção total'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.tot.gt <- list()
}
```

```{r 3-1-2-producao, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.prd <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.prd) <- NULL
table.prd <- cbind(unique(sucupira.df$`ID da Produção`), table.prd)
colnames(table.prd) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.prd)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.prd[i, 1]
    ano <- quadrienal.vigente[j]
    table.prd[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      sucupira.df$`Tipo de Produção`[match(id, sucupira.df$`ID da Produção`)],
      NA
    )
  }
}

table.prd.long <-
  tidyr::gather(dplyr::select(table.prd, -1),
                "Ano",
                "Tipo de Produção",
                colnames(table.prd)[-1],
                factor_key = TRUE
  )

table.prd.long <- rbind(
  table.prd.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.prd[, -1]))),
    "Tipo de Produção" = rep("Produção", times = sum(!is.na(table.prd[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.prd.long) <- c("Ano", "Tipo de Produção")

# change all column types to factors
table.prd.long <- table.prd.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.prd)){
  table.prd.gt <- gtsummary::tbl_summary(
    table.prd.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Tipo de Produção'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.prd.gt <- list()
}
```

```{r 3-1-2-bibliografica, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter sucupira.df by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.bib$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(unique(sucupira.df.bib$`ID da Produção`), table.bib)
colnames(table.bib) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.bib)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.bib[i, 1]
    ano <- quadrienal.vigente[j]
    table.bib[i, j + 1] <- ifelse(
      id %in% sucupira.df.bib$`ID da Produção`[sucupira.df.bib$Anos == ano],
      sucupira.df.bib$`Subtipo de Produção`[match(id, sucupira.df.bib$`ID da Produção`)],
      NA
    )
  }
}

table.bib.long <-
  tidyr::gather(dplyr::select(table.bib, -1),
                "Ano",
                "Nome da Produção",
                colnames(table.bib)[-1],
                factor_key = TRUE
  )

table.bib.long <- rbind(
  table.bib.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.bib[, -1]))),
    "Nome da Produção" = rep("Produção", times = sum(!is.na(table.bib[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.bib)){
  table.bib.gt <- gtsummary::tbl_summary(
    table.bib.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção bibliográfica'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.bib.gt <- list()
}
```

```{r 3-1-2-tecnica, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# filter sucupira.df by "Tipo de Produção" == "Técnica"
sucupira.df.tec <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Técnica", ])

table.tec <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df.tec$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.tec) <- NULL
table.tec <- cbind(unique(sucupira.df.tec$`ID da Produção`), table.tec)
colnames(table.tec) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.tec)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.tec[i, 1]
    ano <- quadrienal.vigente[j]
    table.tec[i, j + 1] <- ifelse(
      id %in% sucupira.df.tec$`ID da Produção`[sucupira.df.tec$Anos == ano],
      sucupira.df.tec$`Subtipo de Produção`[match(id, sucupira.df.tec$`ID da Produção`)],
      NA
    )
  }
}

table.tec.long <-
  tidyr::gather(dplyr::select(table.tec, -1),
                "Ano",
                "Subtipo de Produção",
                colnames(table.tec)[-1],
                factor_key = TRUE
  )

table.tec.long <- rbind(
  table.tec.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.tec[, -1]))),
    "Subtipo de Produção" = rep("Produção", times = sum(!is.na(table.tec[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tec.long) <- c("Ano", "Produção técnica")

# change all column types to factors
table.tec.long <- table.tec.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.tec)){
  table.tec.gt <- gtsummary::tbl_summary(
    table.tec.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção técnica'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.tec.gt <- list()
}
```

```{r 3-1-2-tcc, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.tcc <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.tcc) <- NULL
table.tcc <- cbind(unique(sucupira.df$`ID da Produção`), table.tcc)
colnames(table.tcc) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.tcc)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.tcc[i, 1]
    ano <- quadrienal.vigente[j]
    table.tcc[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      sucupira.df$`Produção vinculada a TCC concluído`[match(id, sucupira.df$`ID da Produção`)],
      NA
    )
  }
}

table.tcc.long <-
  tidyr::gather(dplyr::select(table.tcc, -1),
                "Ano",
                "Subtipo de Produção",
                colnames(table.tec)[-1],
                factor_key = TRUE
  )

table.tcc.long <-
  tidyr::gather(dplyr::select(table.tcc, -1),
                "Ano",
                "Produção vinculada a TCC concluído",
                colnames(table.tcc)[-1],
                factor_key = TRUE
  )

table.tcc.long <- rbind(
  table.tcc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.tcc[, -1]))),
    "Produção vinculada a TCC concluído" = rep("Produção", times = sum(!is.na(table.tcc[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tcc.long) <- c("Ano", "Produção vinculada a TCC concluído")

# change all column types to factors
table.tcc.long <- table.tcc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.tcc)){
  table.tcc.gt <- gtsummary::tbl_summary(
    table.tcc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção vinculada a TCC concluído'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.tcc.gt <- list()
}
```

```{r 3-1-2-ac, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.ac <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.ac) <- NULL
table.ac <- cbind(unique(sucupira.df$`ID da Produção`), table.ac)
colnames(table.ac) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.ac)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.ac[i, 1]
    ano <- quadrienal.vigente[j]
    table.ac[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      sucupira.df$`Área de Concentração`[match(id, sucupira.df$`ID da Produção`)],
      NA
    )
  }
}

table.ac.long <-
  tidyr::gather(dplyr::select(table.ac, -1),
                "Ano",
                "Área de Concentração",
                colnames(table.ac)[-1],
                factor_key = TRUE
  )

table.ac.long <- rbind(
  table.ac.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.ac[, -1]))),
    "Área de Concentração" = rep("Produção", times = sum(!is.na(table.ac[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.ac.long) <- c("Ano", "Produção vinculada a Área de Concentração")

# change all column types to factors
table.ac.long <- table.ac.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.ac)){
  table.ac.gt <- gtsummary::tbl_summary(
    table.ac.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção vinculada a Área de Concentração'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.ac.gt <- list()
}
```

```{r 3-1-2-lp, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.lp <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.lp) <- NULL
table.lp <- cbind(unique(sucupira.df$`ID da Produção`), table.lp)
colnames(table.lp) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.lp)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.lp[i, 1]
    ano <- quadrienal.vigente[j]
    table.lp[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      sucupira.df$`Linha de Pesquisa`[match(id, sucupira.df$`ID da Produção`)],
      NA
    )
  }
}

table.lp.long <-
  tidyr::gather(dplyr::select(table.lp, -1),
                "Ano",
                "Linha de Pesquisa",
                colnames(table.lp)[-1],
                factor_key = TRUE
  )

table.lp.long <- rbind(
  table.lp.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.lp[, -1]))),
    "Linha de Pesquisa" = rep("Produção", times = sum(!is.na(table.lp[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.lp.long) <- c("Ano", "Produção vinculada a Linha de Pesquisa")

# change all column types to factors
table.lp.long <- table.lp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.lp)){
  table.lp.gt <- gtsummary::tbl_summary(
    table.lp.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Produção vinculada a Linha de Pesquisa'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.lp.gt <- list()
}
```

```{r 3-1-2-autor-principal, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
table.aut <- data.frame(matrix(
  NA,
  nrow = length(unique(sucupira.df$`ID da Produção`)),
  ncol = length(quadrienal.vigente)
))

rownames(table.aut) <- NULL
table.aut <- cbind(unique(sucupira.df$`ID da Produção`), table.aut)
colnames(table.aut) <- c("ID da Produção", as.character(quadrienal.vigente))

# match ID da Produção and Ano and fill with Produção
for(i in 1:dim(table.aut)[1]) {
  for(j in 1:length(quadrienal.vigente)) {
    id <- table.aut[i, 1]
    ano <- quadrienal.vigente[j]
    table.aut[i, j + 1] <- ifelse(
      id %in% sucupira.df$`ID da Produção`[sucupira.df$Anos == ano],
      sucupira.df$`Categoria do Autor Principal`[match(id, sucupira.df$`ID da Produção`)],
      NA
    )
  }
}

table.aut.long <-
  tidyr::gather(dplyr::select(table.aut, -1),
                "Ano",
                "Categoria do Autor Principal",
                colnames(table.aut)[-1],
                factor_key = TRUE
  )

table.aut.long <- rbind(
  table.aut.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.aut[, -1]))),
    "Categoria do Autor Principal" = rep("Produção", times = sum(!is.na(table.aut[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.aut.long) <- c("Ano", "Categoria do Autor Principal")

# change all column types to factors
table.aut.long <- table.aut.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
if(!sjmisc::is_empty(table.aut)){
  table.aut.gt <- gtsummary::tbl_summary(
    table.aut.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Subtotal**",
      statistic = gtsummary::everything() ~ "{n}"
    ) %>%
    gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels() %>%
    gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
    gtsummary::modify_header(list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )) %>%
    gtsummary::remove_row_type(
      variables = c('Categoria do Autor Principal'),
      type = "level",
      level_value = ("Produção")
    ) %>%
    gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
} else {
  table.aut.gt <- list()
}
```

```{r 3-1-2-list-tables, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
# List all tables
table.3.1.2 <- list(
  table.tot.gt,
  table.ac.gt,
  table.lp.gt,
  table.tcc.gt,
  table.aut.gt,
  table.prd.gt,
  table.bib.gt,
  table.tec.gt
)

# Drop empty elements from the list
table.3.1.2 <- table.3.1.2[lapply(table.3.1.2, length) > 0]
if(any(lapply(table.3.1.2, length) > 0)){
  table.3.1.2 <- gtsummary::tbl_stack(table.3.1.2)
} else {
  table.3.1.2 <- list()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(table.3.1.2)) {
  table.3.1.2 <- table.3.1.2 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>")
  
  print(table.3.1.2)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(table.3.1.2)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.3.1.2,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Produção do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1 + 1), width = paste0(c(0.50, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15, 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
      ),
      escape = FALSE)
  print(kable_table)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 3-2-1, eval = all(render_document, knitr::is_html_output())}
cat("### **3.2.1**")
cat('\n\n')
cat("#### **Avaliação quantitativa dos impactos do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.2.1 Avaliação quantitativa dos impactos do PPG**")
cat('\n\n')
```

```{r 3-2-1-data, eval = all(render_document, any(has.metricas.doi.ppg, has.metricas.doi.sucupira)), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
metricas_all_ID <- metricas_all[!duplicated(metricas_all$"ID da Produção"),]

metricas_all_ID$Qualis[is.na(metricas_all_ID$Qualis)] <- "Não classificado"

# get only artigos
metricas_all_ID <- metricas_all_ID[metricas_all_ID$"Subtipo de Produção" == "ARTIGO EM PERIÓDICO",]

# loop to get Qualis values from matched ISSN values
for(i in 1:dim(metricas_all_ID)[1]) {
  # check if ISSN exists in the list
  if(!sjmisc::is_empty(which(metricas_all_ID$ISSN[i] == qualis$ISSN))){
    metricas_all_ID$Qualis[i] <- as.character(unique(qualis[which(metricas_all_ID$ISSN[i] == qualis$ISSN), "Estrato"]))
  }
}

síntese.ano <- dplyr::bind_cols(
  Ano = as.numeric(metricas_all_ID$"Ano da Produção"),
  Qualis = as.factor(metricas_all_ID$Qualis),
  CiteScore = as.numeric(metricas_all_ID$CiteScore),
  SJR = as.numeric(metricas_all_ID$SJR),
  Citações = as.numeric(metricas_all_ID$citations),
  Altmetric = as.numeric(metricas_all_ID$altmetric_score),
  Facebook = as.numeric(metricas_all_ID$cited_by_fbwalls_count),
  Blogs = as.numeric(metricas_all_ID$cited_by_feeds_count),
  'Google+' = as.numeric(metricas_all_ID$cited_by_gplus_count),
  Notícias = as.numeric(metricas_all_ID$cited_by_msm_count),
  Reddit = as.numeric(metricas_all_ID$cited_by_rdts_count),
  'Stack Exchange' = as.numeric(metricas_all_ID$cited_by_qna_count),
  X = as.numeric(metricas_all_ID$cited_by_tweeters_count),
  BlueSky = as.numeric(metricas_all_ID$cited_by_bluesky_count),
  Wikipedia = as.numeric(metricas_all_ID$cited_by_wikipedia_count),
  Policies = as.numeric(metricas_all_ID$cited_by_policies_count),
  Patentes = as.numeric(metricas_all_ID$cited_by_patents_count),
  'YouTube/Vimeo' = as.numeric(metricas_all_ID$cited_by_videos_count),
  Posts = as.numeric(metricas_all_ID$cited_by_posts_count),
  Mendeley = as.numeric(metricas_all_ID$mendeley),
  'Acesso aberto' = factor(as.logical(metricas_all_ID$is_oa), levels = c(TRUE, FALSE), labels = c("Sim", "Não"))
)

# Data selection
síntese.ano <- síntese.ano %>%
  dplyr::select(c(
    "Ano",
    "Qualis",
    "CiteScore",
    "SJR",
    "Citações",
    "Altmetric",
    "Facebook",
    "Blogs",
    "Google+",
    "Notícias",
    "Reddit",
    "Stack Exchange",
    "X",
    "BlueSky",
    "Wikipedia",
    "Policies",
    "Patentes",
    "YouTube/Vimeo",
    "Posts",
    "Mendeley",
    "Acesso aberto"
  ))

# filter data in quadrineal.vigente
síntese.ano <- síntese.ano %>%
  dplyr::filter(
    Ano >= min(quadrienal.vigente) &
      Ano <= max(quadrienal.vigente)
  )

# generate table (total by year)
if(!sjmisc::is_empty(síntese.ano)){
  table.3.2.1 <-
    gtsummary::tbl_summary(
      síntese.ano,
      by = "Ano",
      type = list(
        "CiteScore" ~ "continuous",
        "Qualis" ~ "categorical",
        "SJR" ~ "continuous",
        "Citações" ~ "continuous",
        "Altmetric" ~ "continuous",
        "Facebook" ~ "continuous",
        "Blogs" ~ "continuous",
        "Google+" ~ "continuous",
        "Notícias" ~ "continuous",
        "Reddit" ~ "continuous",
        "Stack Exchange" ~ "continuous",
        "X" ~ "continuous",
        "BlueSky" ~ "continuous",
        "Wikipedia" ~ "continuous",
        "Policies" ~ "continuous",
        "Patentes" ~ "continuous",
        "YouTube/Vimeo" ~ "continuous",
        "Posts" ~ "continuous",
        "Mendeley" ~ "continuous",
        "Acesso aberto" ~ "categorical"
      ),
      statistic = list(
        gtsummary::all_continuous() ~ "{median} ({min}-{max})",
        gtsummary::all_categorical() ~ "{n}"
      ),
      missing = "no",
      digits = list(
        "Qualis" ~ 0,
        "CiteScore" ~ 2,
        "SJR" ~ 2,
        "Citações" ~ 0,
        "Altmetric" ~ 0,
        "Facebook" ~ 0,
        "Blogs" ~ 0,
        "Google+" ~ 0,
        "Notícias" ~ 0,
        "Reddit" ~ 0,
        "Stack Exchange" ~ 0,
        "X" ~ 0,
        "BlueSky" ~ 0,
        "Wikipedia" ~ 0,
        "Policies" ~ 0,
        "Patentes" ~ 0,
        "YouTube/Vimeo" ~ 0,
        "Posts" ~ 0,
        "Mendeley" ~ 0,
        "Acesso aberto" ~ 0
      ),
    ) %>%
    gtsummary::modify_header(
      label = "**Ano**",
      gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::add_overall(
      last = TRUE,
      col_label = "**Quadriênio**",
      statistic = list(
        gtsummary::all_continuous() ~ "{median} ({min}-{max})",
        gtsummary::all_categorical() ~ "{n}"
      )
    ) %>%
    gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
    gtsummary::bold_labels()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(síntese.ano)) {
  table.3.2.1 <- table.3.2.1 %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>") %>%
    gtsummary::modify_source_note("<a href='https://www.altmetric.com/'>Altmetric</a>") %>%
    gtsummary::modify_source_note("<a href='https://www.dimensions.ai/'>Dimensions</a>") %>%
    gtsummary::modify_source_note("<a href='https://www.scimagojr.com/'>SJR</a>") %>%
    gtsummary::modify_source_note("<a href='https://www.scopus.com/sources'>CiteScore</a>") %>%
    gtsummary::modify_source_note("<a href='https://plu.mx'>PlumX</a>") %>%
    gtsummary::modify_source_note("<a href='https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/veiculoPublicacaoQualis/listaConsultaGeralPeriodicos.jsf'>Qualis</a>") %>%
    gtsummary::modify_source_note("<a href='https://www.crossref.org'>CrossRef</a>") %>%
    gtsummary::modify_source_note("<a href='https://doaj.org'>DOAJ</a>")
  
  print(table.3.2.1)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(síntese.ano)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.3.2.1,
    escape = FALSE, addtl_fmt = TRUE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Avaliação quantitativa dos impactos do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.25, rep(0.60/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm")) %>%
    kableExtra::footnote(
      general_title = "\\\\textbf{Fontes}:",
      general = c(
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
        "\\\\textbf{\\\\href{https://www.altmetric.com/}{Altmetric}}",
        "\\\\textbf{\\\\href{https://www.dimensions.ai/}{Dimensions}}",
        "\\\\textbf{\\\\href{https://www.scimagojr.com/}{SJR}}",
        "\\\\textbf{\\\\href{https://www.scopus.com/sources}{CiteScore}}",
        "\\\\textbf{\\\\href{https://plu.mx}{PlumX}}",
        "\\\\textbf{\\\\href{https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/veiculoPublicacaoQualis/listaConsultaGeralPeriodicos.jsf}{Qualis}}",
        "\\\\textbf{\\\\href{https://www.crossref.org}{CrossRef}}",
        "\\\\textbf{\\\\href{https://doaj.org}{DOAJ}}",
        "As métricas são referentes apenas às produções com *digital object identifier* (DOI)",
        "A classificação dos periódicos pelo Qualis refere-se à Avaliação Quadrienal 2017-2020"
      ),
      escape = FALSE)
  print(kable_table)
}
```

```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-2-2, eval = all(render_document, knitr::is_html_output())}
cat("### **3.2.2**")
cat('\n\n')
cat("#### **Avaliação qualitativa dos impactos do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.2.2 Avaliação qualitativa dos impactos do PPG**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-3-1, eval = all(render_document, knitr::is_html_output())}
cat("### **3.3.1**")
cat('\n\n')
cat("#### **Visibilidade** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.3.1 Visibilidade**")
cat('\n\n')
```

```{r site-ppg, eval = all(render_document, file.exists("site.png")), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H', out.width = "100%"}
if(knitr::is_html_output()) {
  cat("##### **Site institucional**")
  cat('\n\n')
}

# get URL
yml <- yaml::read_yaml("_site.yml")
URL.site <- yml$navbar$right[[1]]$menu[[2]]$href

if(knitr::is_html_output()) {
  img <- magick::image_read('site.png')
  # zero margins
  par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
  plot(img)
} else {
  cat("\\includegraphics[width=\\textwidth]{site.png}")
}
# add caption
cat('\n\n')
cat(paste0('**Fonte**: ', URL.site))
cat('\n\n')

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r observatorio-ppg, eval = all(render_document, file.exists("observatorio.png")), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H', out.width = "100%"}
if(knitr::is_html_output()) {
  cat("##### **Observatório**")
  cat('\n\n')
}

# get URL
yml <- yaml::read_yaml("_site.yml")
URL.obs <- yml$href

if(knitr::is_html_output()) {
  img <- magick::image_read('observatorio.png')
  # zero margins
  par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
  plot(img)
} else {
  cat("\\includegraphics[width=\\textwidth]{observatorio.png}")
}
# add caption
cat('\n\n')
cat(paste0('**Fonte**: ', URL.obs))
cat('\n\n')

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

\blandscape

```{r 3-3-2, eval = all(render_document, knitr::is_html_output())}
cat("### **3.3.2**")
cat('\n\n')
cat("#### **Internacionalização e Inserção** {.tabset}")
cat('\n\n')
```

```{r, eval = all(render_document, !knitr::is_html_output())}
cat("### **3.3.2 Internacionalização e Inserção**")
cat('\n\n')
```

```{r 3-3-2-parcerias-para-desenvolvimento-de-produtos-publicacoes-conjuntas, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Parcerias*')
  cat('\n\n')
}

# Produções - Autores
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}
sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira.df) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter Categoria do Autor = Participante Externo
sucupira.df <- sucupira.df %>%
  dplyr::filter(`Categoria do Autor` == "Participante Externo")

IDs.part.externos <- unique(sucupira.df$`ID Pessoa do Autor`)

# participantes externos
sheet <- "Participante Externo"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
externos <- sucupira.raw

# get participantes by IDs.part.externos
externos <- externos[externos$`Identificador da Pessoa do Participante` %in% IDs.part.externos, ]

# drop columns
externos <- externos %>% dplyr::select("Nome do Participante", "Tipos de Participação", "Instituição de Origem", "País")
externos <- externos[!duplicated(externos), ]
externos <- externos[!is.na(externos$`Instituição de Origem`), ]

# format names
externos$`Nome do Participante` <- tools::toTitleCase(tolower(externos$`Nome do Participante`))
externos$`Tipos de Participação` <- tools::toTitleCase(tolower(externos$`Tipos de Participação`))
colnames(externos)[which(names(externos) == "Tipos de Participação")] <- "Participação"
externos$`Instituição de Origem` <- toupper(externos$`Instituição de Origem`)
rownames(externos) <- NULL

if (dim(externos)[1] != 0) {
  externos <- externos[order(externos$'Nome do Participante', decreasing = FALSE),]
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(externos)) {
  # use kable for HTML output
  knitr::kable(
    externos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Parcerias para desenvolvimento de produtos/publicações conjuntas"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(externos)[2], width = paste0(c(0.30,0.20,0.40,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(externos)) {
  # use tinytable for LaTeX output
  externos <- data.frame(externos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    externos,
    width = c(0.30,0.20,0.40,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Parcerias para desenvolvimento de produtos/publicações conjuntas"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(externos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(externos), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 3-3-2-atracao-pos-docs, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Atração Pós-Docs*')
  cat('\n\n')
}

# pós-docs
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# periodo
periodo <- quadrienal.vigente

# get posdocs for the current period
sucupira <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira), check.names = FALSE)
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# recode
sucupira$'Vínculo Início' <-
  substr(as.Date(sucupira$'Vínculo Início', format = "%d/%m/%Y"), 1, 4)
sucupira$'Vínculo Fim' <-
  substr(as.Date(sucupira$'Vínculo Fim', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Vínculo Fim'[is.na(sucupira$'Vínculo Fim')] <-
  "Atual"

# filter duplicated posdocs (changes in details will we exhibited)
posdocs <-
  sucupira[
    !duplicated(
      sucupira[, 
               match("Pós-Doc Nome", colnames(sucupira)):match("Vínculo Fim", colnames(sucupira))]
    ), ]
posdocs <- posdocs[order(posdocs$"Pós-Doc Nome"),]

table.posdoc.hist <- data.frame(matrix(NA, nrow = 0, ncol = 5))
if (dim(posdocs)[1] != 0) {
  posdocs <- posdocs[order(posdocs$'Pós-Doc Nome'),]
  
  for (i in 1:dim(posdocs)[1]) {
    table <- cbind(
      posdocs$'Pós-Doc Nome'[i],
      posdocs$'Origem IES Nome'[i],
      paste(
        posdocs$'Vínculo Início'[i],
        "-",
        posdocs$'Vínculo Fim'[i],
        sep = ""
      ),
      posdocs$ORCID[i],
      posdocs$País[i]
    )
    table.posdoc.hist <- rbind(table.posdoc.hist, table)
  }
}
colnames(table.posdoc.hist) <-
  c("Nome", "Instituição de origem", "Vigência", "ORCID", "País")
rownames(table.posdoc.hist) <- NULL

table.posdoc.hist <- table.posdoc.hist[order(table.posdoc.hist$'Nome', decreasing = FALSE), ]

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(table.posdoc.hist)) {
  # use kable for HTML output
  knitr::kable(
    table.posdoc.hist,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Atração de pós-doutorandos"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(table.posdoc.hist)[2], width = paste0(c(0.25,0.35,0.15,0.15,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(table.posdoc.hist)) {
  # use tinytable for LaTeX output
  table.posdoc.hist <- data.frame(table.posdoc.hist, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.posdoc.hist,
    width = c(0.25,0.35,0.15,0.15,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Atração de pós-doutorandos"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.posdoc.hist), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.posdoc.hist), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 3-3-2-recepcao-de-discentes-para-estagio-visita-ao-laboratório, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

```{r 3-3-2-convidados-por-outras-IES-ou-eventos, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

```{r 3-3-2-assessorias-de-ONGs-empresas-agencias-de-fomento-revistas-científicas-ou-orgaos-de-governo, eval = all(render_document, has.sucupira.files, curl::has_internet()), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Assessoria*')
  cat('\n\n')
}

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Keep active professors and remove duplicated data
sucupira <- sucupira.raw[is.na(sucupira.raw$`Data de Desligamento`), ]
sucupira.unique <- sucupira[!duplicated(sucupira$`Nome Docente`) & !is.na(sucupira$ORCID),]

orcids <- gsub("(.{14})(.*)$", "\\1-\\2",
               gsub("(.{9})(.*)$", "\\1-\\2",
                    gsub("(.{4})(.*)$", "\\1-\\2", sucupira.unique$ORCID)
               )
)

if (file.exists(file.path("cache", "impactos", "invited-positions.Rds"))) {
  editor.name.all <- readRDS(file.path("cache", "impactos", "invited-positions.Rds"))
} else {
  dir.create(file.path("cache", "impactos"), showWarnings = FALSE, recursive = TRUE)
  editor.name.all <- c()
  for (id in 1:length(orcids)) {
    my_orcid <- orcids[id]
    docente.name <- sucupira.unique$`Nome Docente`[id]
    source("Scripts/orcid-invited-positions.R", local = knitr::knit_global())
    editor.name.all <- rbind(editor.name.all, invited.pos)
  }
  rownames(editor.name.all) <- NULL
  
  saveRDS(editor.name.all, file.path("cache", "impactos", "invited-positions.Rds"))
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(editor.name.all)) {
  # use kable for HTML output
  knitr::kable(
    editor.name.all,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Assessoria de ONGs, empresas, agências de fomento, revistas científicas ou órgãos de governo"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(editor.name.all)[2], width = paste0(c(0.10,0.10,0.25,0.30,0.15,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>",
        "<a href='https://orcid.org'>ORCID</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(editor.name.all)) {
  # use tinytable for LaTeX output
  editor.name.all <- data.frame(editor.name.all, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    editor.name.all,
    width = c(0.10,0.10,0.25,0.30,0.15,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Assessoria de ONGs, empresas, agências de fomento, revistas científicas ou órgãos de governo"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
      "\\textbf{\\href{https://orcid.org}{ORCID}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(editor.name.all), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(editor.name.all), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

if (knitr::is_html_output()) {
  cat('##### *Revisor*')
  cat('\n\n')
}

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Keep active professors and remove duplicated data
sucupira <- sucupira.raw[is.na(sucupira.raw$`Data de Desligamento`), ]
sucupira.unique <- sucupira[!duplicated(sucupira$`Nome Docente`) & !is.na(sucupira$ORCID),]

orcids <- gsub("(.{14})(.*)$", "\\1-\\2",
               gsub("(.{9})(.*)$", "\\1-\\2",
                    gsub("(.{4})(.*)$", "\\1-\\2", sucupira.unique$ORCID)
               )
)

if (file.exists(file.path("cache", "impactos", "reviewer-board.Rds"))) {
  peer.review.all <- readRDS(file.path("cache", "impactos", "reviewer-board.Rds"))
} else {
  dir.create(file.path("cache", "impactos"), showWarnings = FALSE, recursive = TRUE)
  peer.review.all <- c()
  for (id in 1:length(orcids)) {
    my_orcid <- orcids[id]
    docente.name <- sucupira.unique$`Nome Docente`[id]
    source("Scripts/orcid-reviewer-board.R", local = knitr::knit_global())
    peer.review.all <- rbind(peer.review.all, peer.review)
  }
  rownames(peer.review.all) <- NULL
  
  saveRDS(peer.review.all, file.path("cache", "impactos", "reviewer-board.Rds"))
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(peer.review.all)) {
  # use kable for HTML output
  knitr::kable(
    peer.review.all,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Revisor de periódicos nacionais e internacionais"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(peer.review.all)[2], width = paste0(c(0.05,0.05,0.25,0.25,0.10,0.10,0.10,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>",
        "<a href='https://orcid.org'>ORCID</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(peer.review.all)) {
  # use tinytable for LaTeX output
  peer.review.all <- data.frame(peer.review.all, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    peer.review.all,
    width = c(0.05,0.05,0.25,0.25,0.10,0.10,0.10,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Revisor de periódicos nacionais e internacionais"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
      "\\textbf{\\href{https://orcid.org}{ORCID}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(peer.review.all), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(peer.review.all), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 3-3-2-cargos-de-gestao-universitaria-externa-ao-PPG, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

```{r 3-3-2-lideranca-de-sociedades-e-ou-de-orgãos-científicos-culturais-profissionais-sociais-governamentais, eval = all(render_document, has.sucupira.files, curl::has_internet()), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Liderança*')
  cat('\n\n')
}

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Keep active professors and remove duplicated data
sucupira <- sucupira.raw[is.na(sucupira.raw$`Data de Desligamento`), ]
sucupira.unique <- sucupira[!duplicated(sucupira$`Nome Docente`) & !is.na(sucupira$ORCID),]

orcids <- gsub("(.{14})(.*)$", "\\1-\\2",
               gsub("(.{9})(.*)$", "\\1-\\2",
                    gsub("(.{4})(.*)$", "\\1-\\2", sucupira.unique$ORCID)
               )
)

if (file.exists(file.path("cache", "impactos", "membership.Rds")) | file.exists(file.path("cache", "impactos", "services.Rds"))) {
  member.all <- readRDS(file.path("cache", "impactos", "membership.Rds"))
  services.all <- readRDS(file.path("cache", "impactos", "services.Rds"))
} else {
  dir.create(file.path("cache", "impactos"), showWarnings = FALSE, recursive = TRUE)
  member.all <- c()
  services.all <- c()
  for (id in 1:length(orcids)) {
    my_orcid <- orcids[id]
    docente.name <- sucupira.unique$`Nome Docente`[id]
    source("Scripts/orcid-memberships-services.R", local = knitr::knit_global())
    member.all <- rbind(member.all, member)
    services.all <- rbind(services.all, services)
  }
  rownames(member.all) <- NULL
  rownames(services.all) <- NULL
  
  saveRDS(peer.review.all, file.path("cache", "impactos", "membership.Rds"))
  saveRDS(services.all, file.path("cache", "impactos", "services.Rds"))
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(member.all)) {
  # use kable for HTML output
  knitr::kable(
    member.all,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Liderança de sociedades e/ou de órgãos científicos, culturais, profissionais, sociais, governamentais"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(member.all)[2], width = paste0(c(0.08,0.08,0.24,0.30,0.07,0.08,0.08,0.07)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>",
        "<a href='https://orcid.org'>ORCID</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(member.all)) {
  # use tinytable for LaTeX output
  member.all <- data.frame(member.all, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    member.all,
    width = c(0.08,0.08,0.24,0.30,0.07,0.08,0.08,0.07)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Liderança de sociedades e/ou de órgãos científicos, culturais, profissionais, sociais, governamentais"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
      "\\textbf{\\href{https://orcid.org}{ORCID}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(member.all), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(member.all), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(services.all)) {
  # use kable for HTML output
  knitr::kable(
    services.all,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Assessorias de ONGs, empresas, agências de fomento, revistas científicas ou órgãos de governo"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(services.all)[2], width = paste0(c(0.10,0.10,0.25,0.30,0.15,0.10)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE) %>%
    kableExtra::footnote(
      general_title = "<strong>Fontes</strong>: ",
      general = c(
        "<a href='https://sucupira.capes.gov.br/sucupira/'>Plataforma Sucupira</a>",
        "<a href='https://orcid.org'>ORCID</a>"
      ),
      escape = FALSE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(services.all)) {
  # use tinytable for LaTeX output
  services.all <- data.frame(services.all, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    services.all,
    width = c(0.10,0.10,0.25,0.30,0.15,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Assessorias de ONGs, empresas, agências de fomento, revistas científicas ou órgãos de governo"),
    notes = list(
      "\\textbf{Fontes}: \\textbf{\\href{https://sucupira.capes.gov.br/sucupira/}{Plataforma Sucupira}}",
      "\\textbf{\\href{https://orcid.org}{ORCID}}"
    )
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(services.all), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(services.all), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 3-3-2-internacionalizacao-pesquisa, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

```{r 3-3-2-internacionalizacao-producao-intelectual, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

```{r 3-3-2-internacionalizacao-mobilidade-atuacao-academica, eval = all(render_document, has.internacionalizacao), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Mobilidade e Atuação*')
  cat('\n\n')
}

# read separate sheets
internacional.raw <-
  readxl::read_excel("PPG/Internacionalização.xlsx",
                     sheet = "Internacionalização",
                     col_types = c("text"))

# replace the link by a tag
Abrir <- matrix(NA, nrow = dim(internacional.raw)[1])
colnames(Abrir) <- "Abrir"

# add hyperlinks
for (i in 1:dim(internacional.raw)[1]) {
  if (knitr::is_html_output()) {
    if (!is.na(internacional.raw[i, ncol(internacional.raw)])) {
      Abrir[i] <-
        paste0('<a href="',internacional.raw[i, ncol(internacional.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
    }
  } else {
    if (!is.na(internacional.raw[i, ncol(internacional.raw)])) {
      Abrir[i] <-
        paste0('\\url{', internacional.raw[i, ncol(internacional.raw)],'}')
    }
  }
}

internacional <- cbind(internacional.raw[, -ncol(internacional.raw)], Abrir)

# convert 1st column to date
internacional$`Publicação` <- as.Date(internacional$`Publicação`, format = "%d/%m/%Y")
# get year only
internacional$`Publicação` <- format(internacional$`Publicação`, "%Y")
# get quadrienal.vigente only
internacional <- internacional[internacional$`Publicação` %in% quadrienal.vigente,]
# sort by increasing year
internacional <- internacional[order(internacional$`Publicação`, decreasing = FALSE),]

# print tables
if (knitr::is_html_output() && !sjmisc::is_empty(internacional)) {
  # use kable for HTML output
  knitr::kable(
    internacional,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE, longtable = T,
    linesep = "",
    caption = "Mobilidade e atuação acadêmica internacional"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )  %>% kableExtra::column_spec(column = 1:dim(internacional)[2], width = paste0(c(0.10,0.50,0.10,0.30)*(21-3-3), "cm")) %>%
    kableExtra::column_spec(column = 1, bold = TRUE) %>%
    kableExtra::row_spec(row = 0, bold = TRUE)
} else if (knitr::is_latex_output() && !sjmisc::is_empty(internacional)) {
  # use tinytable for LaTeX output
  internacional <- data.frame(internacional, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    internacional,
    width = c(0.10,0.50,0.10,0.30)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Mobilidade e atuação acadêmica internacional")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1) %>%
    tinytable::style_tt(i = 0, j = 1:ncol(internacional), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(internacional), j = 1, bold = TRUE)
}

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 3-3-2-internacionalizacao-condicoes-institucionais, eval = all(render_document, has.sucupira.files), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', fig.pos='H'}

```

\elandscape

```{=latex}
\newpage
\FloatBarrier
```

<br>

```{=latex}
\DisableFootNotes
```
