---
title: Autoavaliação
output:
  html_document:
    toc: true
    toc_float: true
    css:
      - ./CSS/generic.css
      - ./CSS/logo-above-toc.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
  pdf_document:
    toc: true
    toc_depth: 4
    number_sections: false
    includes:
      in_header: tex/preamble.tex
      before_body: [tex/cover-1.tex, tex/cover-2.tex]
    latex_engine: xelatex
    keep_tex: false
documentclass: book
classoption: oneside
papersize: a4
geometry: "top=2cm,left=2cm,right=2cm,bottom=2cm"
link-citations: true
always_allow_html: true
tables: true
---

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = "asis",
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)
```

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
    knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

<!--script for inserting LOGO ABOVE THE TOC-->
```{js}
$(document).ready(function() {
  $('#TOC').parent().prepend('<div id=\"nav_logo\"><img src="PPG/Images/logo-programa.png"></div>');
  });
```

<!--script for sharing-->
<p align="right">
```{r share, eval = knitr::is_html_output()}
home <- metadata$repository_url
source("Scripts/social-media-sharing.R", local = knitr::knit_global())
```
</p>

<br>

```{r quadrienal-vigente, results = "hide", echo = FALSE, include = FALSE, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
quadrienal.vigente <-
  2021:min(
    as.numeric(format(Sys.Date(), "%Y")),
    max(anos),
    2024)

# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

docentes.quadrienio <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(docentes.quadrienio) <-
  names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter docente permanente
docentes.quadrienio <-
  docentes.quadrienio[docentes.quadrienio$Categoria == "PERMANENTE",]

docentes.quadrienio <-
  docentes.quadrienio %>% dplyr::select(
    "Nome Docente"
  )

# remove duplicates
docentes.quadrienio <- docentes.quadrienio[!duplicated(docentes.quadrienio),]

# to title case
docentes.quadrienio <- sort(tools::toTitleCase(tolower(docentes.quadrienio)))
```

```{r cover-one, echo = FALSE, include = FALSE, eval = knitr::is_html_output()}
source("Scripts/cover-1.R", local = knitr::knit_global())
source("Scripts/cover-2.R", local = knitr::knit_global())
```

```{=latex}
% unnumbered chapters and arabic page numbering
\backmatter

\clearpage
\markboth{}{}

\EnableFootNotes
```

```{r, eval = knitr::is_html_output()}
cat("## **Avaliação CAPES** {#avalicao-capes .tabset}")
```

```{r, eval = !knitr::is_html_output()}
cat("## **Avaliação CAPES**")
cat('\n\n')
```

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.avaliacao}
cat('<br>')
```

```{r avaliacao, eval = has.avaliacao, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Avaliação.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  avaliacao.raw <-
    readxl::read_excel("PPG/Avaliação.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(avaliacao.raw)[1])
  colnames(Abrir) <- "Abrir"

  # add hyperlinks
  for (i in 1:dim(avaliacao.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
        Abrir[i] <-
          paste0('<a href="',avaliacao.raw[i, ncol(avaliacao.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
        }
      } else {
        if (!is.na(avaliacao.raw[i, ncol(avaliacao.raw)])) {
          Abrir[i] <-
            paste0('\\url{', avaliacao.raw[i, ncol(avaliacao.raw)],'}')
        }
      }
    }
  
  avaliacao <- cbind(avaliacao.raw[, -ncol(avaliacao.raw)], Abrir)
  table <- avaliacao
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
    
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
  if (knitr::is_latex_output()) {
    cat("\\newpage")
  }
}
```

<br>

```{r, eval = all(knitr::is_html_output(), has.sucupira.files)}
cat("## **Dados do Coleta", paste0(quadrienal.vigente[1], "-", quadrienal.vigente[length(quadrienal.vigente)], "** {#coleta .tabset}"))
```

```{r, eval = all(!knitr::is_html_output(), has.sucupira.files)}
cat("## **Dados do Coleta", paste0(quadrienal.vigente[1], "-", quadrienal.vigente[length(quadrienal.vigente)], "** {#coleta .tabset}"))
cat('\n\n')
```

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r descritivo-dados, eval = has.sucupira.files, cache = TRUE, cache.path = "cache/missing/"}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# Get amount of data from Sucupira XLSX files
source("Scripts/get-sucupira-sheets-names.R", local = knitr::knit_global())

summ.df <- data.frame(
  "Ano" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Aba" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Quantidade de dados" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Dados perdidos" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  "Dados duplicados" = rep(NA, length(quadrienal.vigente) * length(sucupira.sheets)),
  check.names = FALSE
)

if (has.sucupira.files) {
  for (ROW in 1:length(sucupira.sheets)) {
    sheet <- sucupira.sheets[ROW]
    source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
    # Get yearly data from Sucupira XLSX files
    names(sucupira.list) <- as.character(anos)
    sucupira.quadr <- sucupira.list[as.character(quadrienal.vigente)]
    for (COL in 1:length(quadrienal.vigente)) {
      ano <- quadrienal.vigente[COL]
      summ.df$Ano[COL + length(quadrienal.vigente)*(ROW - 1)] <- ano
      summ.df$Aba[COL + length(quadrienal.vigente)*(ROW - 1)] <- sheet
      summ.df$`Quantidade de dados`[COL + length(quadrienal.vigente)*(ROW - 1)] <- sum(!is.na(unlist(sucupira.list[[as.character(ano)]])))
      summ.df$`Dados perdidos`[COL + length(quadrienal.vigente)*(ROW - 1)] <- sum(is.na(unlist(sucupira.list[[as.character(ano)]])))
      summ.df$`Dados duplicados`[COL + length(quadrienal.vigente)*(ROW - 1)] <- sum(duplicated(sucupira.list[[as.character(ano)]]))
    }
  }
}

summ.data.wider <- tidyr::pivot_wider(
  summ.df,
  id_cols = Ano,
  names_from = Aba,
  values_from = `Quantidade de dados`
)

summ.missing.wider <- tidyr::pivot_wider(
  summ.df,
  id_cols = Ano,
  names_from = Aba,
  values_from = `Dados perdidos`
)

summ.duplicates.wider <- tidyr::pivot_wider(
  summ.df,
  id_cols = Ano,
  names_from = Aba,
  values_from = `Dados duplicados`
)

# percent of missing data
summ.missing.wider <- summ.missing.wider / (summ.data.wider + summ.data.wider) * 100
summ.missing.wider$Ano <- quadrienal.vigente
```

```{r, eval = all(knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados completos**")
```

```{r, eval = all(!knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados completos**")
cat('\n\n')
```

```{r descritivo-dados-completos, eval = has.sucupira.files, cache = TRUE, cache.path = "cache/missing/", echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# print tables
table.dados.gt <-
  gtsummary::tbl_summary(
    summ.data.wider,
    type = list(gtsummary::everything() ~ "continuous"),
    by = "Ano",
    statistic = list(gtsummary::everything() ~ "{sum}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.dados.gt)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.dados.gt,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Dados completos por ano e aba da planilha")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/length(quadrienal.vigente), times = length(quadrienal.vigente)))*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r, eval = all(knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados omissos**")
```

```{r, eval = all(!knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados omissos**")
cat('\n\n')
```

```{r descritivo-dados-omissos, eval = has.sucupira.files, cache = TRUE, cache.path = "cache/missing/", echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# print tables
table.missing.gt <-
  gtsummary::tbl_summary(
    summ.missing.wider,
    type = list(gtsummary::everything() ~ "continuous"),
    by = "Ano",
    statistic = list(gtsummary::everything() ~ "{sum}%"),
    missing = "no",
    digits = gtsummary::everything() ~ 1
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.missing.gt)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.missing.gt,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Dados omissos por ano e aba da planilha")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/length(quadrienal.vigente), times = length(quadrienal.vigente)))*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r, eval = all(knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados duplicados**")
```

```{r, eval = all(!knitr::is_html_output(), has.sucupira.files)}
cat("### **Dados duplicados**")
cat('\n\n')
```

```{r descritivo-dados-duplicados, eval = has.sucupira.files, cache = TRUE, cache.path = "cache/missing/", echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# print tables
table.duplicates.gt <-
  gtsummary::tbl_summary(
    summ.duplicates.wider,
    type = list(gtsummary::everything() ~ "continuous"),
    by = "Ano",
    statistic = list(gtsummary::everything() ~ "{sum}%"),
    missing = "no",
    digits = gtsummary::everything() ~ 1
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.duplicates.gt)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.duplicates.gt,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Dados duplicados por ano e aba da planilha")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/length(quadrienal.vigente), times = length(quadrienal.vigente)))*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{=latex}
\newpage
```

```{r, eval = knitr::is_html_output()}
cat("## **Ficha de Avaliação** {#ficha-avaliacao}")
```

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

## **1. Programa** {#programa .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r 1-1-1, eval = knitr::is_html_output()}
cat("### **1.1.1**")
cat('\n\n')
cat("#### **Estrutura Acadêmica do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.1.1 Estrutura Acadêmica do Programa**")
cat('\n\n')
```

```{r cursos-objetivos, eval = has.dados.cadastrais, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Objetivos do curso**")
  cat('\n\n')
}

cursos.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "Cursos",
                     col_types = c("text"))

cursos <- dplyr::select(cursos.raw, c("Nível", "Objetivos"))

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    cursos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Objetivos do Curso"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(cursos), width = paste0(c(0.10,0.90)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  cursos <- data.frame(cursos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    cursos,
    width = c(0.10,0.90)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Objetivos do Curso")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(cursos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(cursos), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r cursos-egressos, eval = has.dados.cadastrais, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Perfil do egresso**")
  cat('\n\n')
}

cursos.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "Egressos",
                     col_types = c("text"))

cursos <- dplyr::select(cursos.raw, c("Nível", "Objetivos"))

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    cursos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Perfil do Egresso"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(cursos), width = paste0(c(0.10,0.90)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  cursos <- data.frame(cursos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    cursos,
    width = c(0.10,0.90)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Perfil do Egresso")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(cursos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(cursos), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-data, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind("Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
                         sucupira[[i]])
}
sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira.df) <-
  names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

# filter docente responsável
sucupira.df <-
  sucupira.df[sucupira.df$`Membro Responsável` == "Sim",]

# keep docente permanente only
sucupira.df <-
  sucupira.df[sucupira.df$`Nome do Membro do Projeto` %in% toupper(docentes.quadrienio), ]

sucupira.df <-
  sucupira.df %>% dplyr::select(
    "Anos",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Categoria do Membro do Projeto",
    "Data de Início",
    "Data da Situação",
    "Situação"
  )
sucupira.df$`Área de Concentração` <- tools::toTitleCase(tolower(sucupira.df$`Área de Concentração`))
sucupira.df$`Linha de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Linha de Pesquisa`))
sucupira.df$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Nome do Projeto de Pesquisa`))
sucupira.df$`Natureza do Projeto de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Natureza do Projeto de Pesquisa`))
sucupira.df$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(sucupira.df$`Nome do Membro do Projeto`))
sucupira.df$`Categoria do Membro do Projeto` <- tools::toTitleCase(tolower(sucupira.df$`Categoria do Membro do Projeto`))
sucupira.df$`Situação` <- tools::toTitleCase(tolower(sucupira.df$`Situação`))

# remove duplicates
sucupira.df <- sucupira.df[!duplicated(sucupira.df),]

# if duplicated, keep Situacão = Concluído
sucupira.df <- sucupira.df[!duplicated(sucupira.df[, 1:7], fromLast = TRUE),]
```

```{r 1-1-1-ac, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# áreas de concentração
table.ac <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Área de Concentração`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.ac) <- NULL
table.ac <-
  cbind(unique(sucupira.df$`Área de Concentração`), table.ac)
colnames(table.ac) <-
  c("Área de Concentração", as.character(quadrienal.vigente))
for (i in 1:dim(table.ac)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.ac[i, j + 1] <-
      try(data$`Área de Concentração`[match(table.ac$`Área de Concentração`[i],
                                            data$`Área de Concentração`)], silent = TRUE)
  }
}

table.ac.long <-
  tidyr::gather(table.ac[, -1],
                "Ano",
                "Área de Concentração",
                colnames(table.ac)[-1],
                factor_key = TRUE)

# to title case
table.ac.long$`Área de Concentração` <- tools::toTitleCase(tolower(table.ac.long$`Área de Concentração`))

table.ac.long <- rbind(
  table.ac.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.ac)[1]),
    "Área de Concentração" = rep("Áreas", times = dim(table.ac)[1]),
    check.names = FALSE
  )
)

# docentes por área de concentração
table.ac.doc <- table(
  sucupira.df$Anos[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Área de Concentração`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Nome do Membro do Projeto`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]
) %>% as.data.frame()
# drop Freq = 0
table.ac.doc <- table.ac.doc[table.ac.doc$Freq > 0, ]
# select AC e Docentes
table.ac.doc <- dplyr::select(as.data.frame(table.ac.doc), "Var1", "Var2", "Var3")
names(table.ac.doc) <- c("Ano", "Área de Concentração", "Docente")
# count docentes per year per AC
table.ac.doc.freq <- table.ac.doc %>%
  dplyr::group_by(Ano, `Área de Concentração`) %>%
  dplyr::summarise(Docente = n())

# long format
table.ac.doc.long <- data.frame()
for(i in 1:dim(table.ac.doc.freq)[1]){
  table.ac.doc.long <- rbind(table.ac.doc.long,
                             data.frame("Ano" = rep(table.ac.doc.freq$Ano[i], times = table.ac.doc.freq$Docente[i]),
                                        "Área de Concentração" = rep(table.ac.doc.freq$`Área de Concentração`[i], times = table.ac.doc.freq$Docente[i]),
                                        "Docente" = rep(table.ac.doc.freq$Docente[i], times = table.ac.doc.freq$Docente[i]),
                                        check.names = FALSE))
}
# rename and drop columns
table.ac.doc.long <- dplyr::select(table.ac.doc.long, "Ano", "Área de Concentração")
names(table.ac.doc.long) <- c("Ano", "Docente Permanente")

table.ac.doc.long <- rbind(
  table.ac.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = length(unique(table.ac.doc$Docente))),
    "Docente Permanente" = rep("Áreas", times = length(unique(table.ac.doc$Docente))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Áreas", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.ac.long <- table.ac.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.ac.gt <-
  gtsummary::tbl_summary(
    table.ac.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Área de Concentração'),
    type = "level",
    level_value = ("Áreas")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))

# print tables
table.ac.doc.gt <-
  gtsummary::tbl_summary(
    table.ac.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Docente Permanente'),
    type = "level",
    level_value = ("Áreas")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 1-1-1-AC, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **AC** {#descricao-ac}")
  cat('\n\n')
}

# list all tables
table.all <-
  list(table.ac.gt,
       table.ac.doc.gt
       )

# drop empty elements from list
table.all <- table.all[lapply(table.all, length) > 0]

table.all <- gtsummary::tbl_stack(table.all)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.all)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.all,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Áreas de Concentração")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-AC-detalhes, eval = has.dados.cadastrais, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# read data
area.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "AC",
                     col_types = c("text"))
area.ativas <- area.raw
area.ativas$Fim[is.na(area.ativas$Fim)] <- ""

# to title case
area.ativas$'Área de Concentração' <- tools::toTitleCase(tolower(area.ativas$'Área de Concentração'))

# print tables
ids <- order(area.ativas$'Área de Concentração', decreasing = FALSE)
area.ativas <- area.ativas[ids,]

# add ID
area.ativas <- cbind(
  seq(1, dim(area.ativas)[1]),
  area.ativas
  )
colnames(area.ativas) <-
  c("ID",colnames(area.ativas)[-1])
rownames(area.ativas) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    area.ativas,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Áreas de Concentração"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(area.ativas), width = paste0(c(0.05,0.30,0.45,0.10,0.10)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  area.ativas <- data.frame(area.ativas, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    area.ativas,
    width = c(0.05,0.30,0.45,0.10,0.10)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Áreas de Concentração")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(area.ativas), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(area.ativas), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-lp, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.lp <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Linha de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.lp) <- NULL
table.lp <- cbind(unique(sucupira.df$`Linha de Pesquisa`), table.lp)
colnames(table.lp) <-
  c("Linha de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.lp)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.lp[i, j + 1] <-
      try(data$`Linha de Pesquisa`[match(table.lp$`Linha de Pesquisa`[i], data$`Linha de Pesquisa`)]
          , silent = TRUE)
  }
}

table.lp.long <-
  tidyr::gather(table.lp[, -1],
                "Ano",
                "Linha de Pesquisa",
                colnames(table.lp)[-1],
                factor_key = TRUE)

# to title case
table.lp.long$`Linha de Pesquisa` <- tools::toTitleCase(tolower(table.lp.long$`Linha de Pesquisa`))

table.lp.long <- rbind(table.lp.long,
                       data.frame(
                         "Ano" = rep(paste0(
                           min(quadrienal.vigente), "-", max(quadrienal.vigente)
                         ), times = dim(table.lp)[1]),
                         "Linha de Pesquisa" = rep("Linhas", times = dim(table.lp)[1]),
                         check.names = FALSE
                       ))

# docentes por linha de pesquisa
table.lp.doc <- table(
  sucupira.df$Anos[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Linha de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"],
  sucupira.df$`Nome do Membro do Projeto`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]
) %>% as.data.frame()
# drop Freq = 0
table.lp.doc <- table.lp.doc[table.lp.doc$Freq > 0, ]
# select AC e Docentes
table.lp.doc <- dplyr::select(as.data.frame(table.lp.doc), "Var1", "Var2", "Var3")
names(table.lp.doc) <- c("Ano", "Linha de Pesquisa", "Docente")
# count docentes per year per AC
table.lp.doc.freq <- table.lp.doc %>%
  dplyr::group_by(Ano, `Linha de Pesquisa`) %>%
  dplyr::summarise(Docente = n())

# long format
table.lp.doc.long <- data.frame()
for(i in 1:dim(table.lp.doc.freq)[1]){
  table.lp.doc.long <- rbind(table.lp.doc.long,
                             data.frame("Ano" = rep(table.lp.doc.freq$Ano[i], times = table.lp.doc.freq$Docente[i]),
                                        "Linha de Pesquisa" = rep(table.lp.doc.freq$`Linha de Pesquisa`[i], times = table.lp.doc.freq$Docente[i]),
                                        "Docente" = rep(table.lp.doc.freq$Docente[i], times = table.lp.doc.freq$Docente[i]),
                                        check.names = FALSE))
}

# rename and drop columns
table.lp.doc.long <- dplyr::select(table.lp.doc.long, "Ano", "Linha de Pesquisa")
names(table.lp.doc.long) <- c("Ano", "Docente Permanente")

table.lp.doc.long <- rbind(
  table.lp.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = length(unique(table.lp.doc$Docente))),
    "Docente Permanente" = rep("Linhas", times = length(unique(table.lp.doc$Docente))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Linhas", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.lp.long <- table.lp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.lp.gt <-
  gtsummary::tbl_summary(
    table.lp.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Linha de Pesquisa'),
    type = "level",
    level_value = ("Linhas")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))

# print tables
table.lp.doc.gt <-
  gtsummary::tbl_summary(
    table.lp.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Docente Permanente'),
    type = "level",
    level_value = ("Linhas")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 1-1-1-LP, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **LP** {#descricao-lp}")
  cat('\n\n')
}

# list all tables
table.all <-
  list(table.lp.gt,
       table.lp.doc.gt
       )

# drop empty elements from list
table.all <- table.all[lapply(table.all, length) > 0]

table.all <- gtsummary::tbl_stack(table.all)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.all)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.all,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Linhas de Pesquisa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-LP-detalhes, eval = has.dados.cadastrais, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# read data
linhas.raw <-
  readxl::read_excel("PPG/Dados Cadastrais.xlsx",
                     sheet = "LP",
                     col_types = c("text"))
linhas.atual <- linhas.raw[is.na(linhas.raw$Fim), ]
linhas.atual$Fim[is.na(linhas.atual$Fim)] <- ""

# to title case
linhas.atual$'Linhas de Pesquisa' <- tools::toTitleCase(tolower(linhas.atual$'Linhas de Pesquisa'))

# print tables
ids <- order(linhas.atual$'Linhas de Pesquisa', decreasing = FALSE)
linhas.atual <- linhas.atual[ids,]

# add ID
linhas.atual <- cbind(
  seq(1, dim(linhas.atual)[1]),
  linhas.atual
  )
colnames(linhas.atual) <-
  c("ID",colnames(linhas.atual)[-1])
rownames(linhas.atual) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    linhas.atual,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Linhas de Pesquisa"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(linhas.atual), width = paste0(c(0.05,0.30,0.45,0.10,0.10)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  linhas.atual <- data.frame(linhas.atual, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    linhas.atual,
    width = c(0.05,0.30,0.45,0.10,0.10),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Linhas de Pesquisa")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(linhas.atual), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(linhas.atual), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-1-pp-lp, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.pp <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp) <- NULL
table.pp <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp)
colnames(table.pp) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp[i, j + 1] <-
      try(data$`Linha de Pesquisa`[match(table.pp$`Nome do Projeto de Pesquisa`[i],
                                         data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.long <-
  tidyr::gather(table.pp[, -1],
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp)[-1],
                factor_key = TRUE)

# to title case
table.pp.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.long$`Nome do Projeto de Pesquisa`))

table.pp.long <- rbind(
  table.pp.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp)[1]),
    "Nome do Projeto de Pesquisa" = rep("Projetos", times = dim(table.pp)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Projetos", na.rm = TRUE), digits = 0)
}

colnames(table.pp.long) <-
  c("Ano", "Projeto por Linha de Pesquisa")

# change all column types to factors
table.pp.long <- table.pp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.pp.gt <-
  gtsummary::tbl_summary(
    table.pp.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Projeto por Linha de Pesquisa'),
    type = "level",
    level_value = ("Projetos")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 1-1-1-pp-natureza, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.pp.nt <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.nt) <- NULL
table.pp.nt <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp.nt)
colnames(table.pp.nt) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.nt)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp.nt[i, j + 1] <-
      try(data$`Natureza do Projeto de Pesquisa`[match(table.pp.nt$`Nome do Projeto de Pesquisa`[i],
                                         data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.nt.long <-
  tidyr::gather(table.pp.nt[, -1],
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp.nt)[-1],
                factor_key = TRUE)

# to title case
table.pp.nt.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.nt.long$`Nome do Projeto de Pesquisa`))

table.pp.nt.long <- rbind(
  table.pp.nt.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.nt)[1]),
    "Nome do Projeto de Pesquisa" = rep("Projetos", times = dim(table.pp.nt)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Projetos", na.rm = TRUE), digits = 0)
}

colnames(table.pp.nt.long) <-
  c("Ano", "Natureza do projeto")

# print tables
table.pp.nt.gt <-
  gtsummary::tbl_summary(
    table.pp.nt.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Natureza do projeto'),
    type = "level",
    level_value = ("Projetos")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 1-1-1-pp-membro, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.pp.membro <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`)),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.pp.membro) <- NULL
table.pp.membro <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`), table.pp.membro)
colnames(table.pp.membro) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.pp.membro)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.pp.membro[i, j + 1] <-
      try(data$`Categoria do Membro do Projeto`[match(table.pp.membro$`Nome do Projeto de Pesquisa`[i],
                                         data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.pp.membro.long <-
  tidyr::gather(table.pp.membro[, -1],
                "Ano",
                "Nome do Projeto de Pesquisa",
                colnames(table.pp.membro)[-1],
                factor_key = TRUE)

# to title case
table.pp.membro.long$`Nome do Projeto de Pesquisa` <- tools::toTitleCase(tolower(table.pp.membro.long$`Nome do Projeto de Pesquisa`))

table.pp.membro.long <- rbind(
  table.pp.membro.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.pp.membro)[1]),
    "Nome do Projeto de Pesquisa" = rep("Responsável", times = dim(table.pp.membro)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Responsável", na.rm = TRUE), digits = 0)
}

colnames(table.pp.membro.long) <-
  c("Ano", "Categoria do responsável")

# change all column types to factors
table.pp.membro <- table.pp.membro %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.pp.membro.gt <-
  gtsummary::tbl_summary(
    table.pp.membro.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Categoria do responsável'),
    type = "level",
    level_value = ("Responsável")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 1-1-1-PP-DP, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **PP** {#descricao-pp}")
  cat('\n\n')
}

# list all tables
table.all <-
  list(table.pp.gt,
       table.pp.nt.gt,
       table.pp.membro.gt
       )

# drop empty elements from list
table.all <- table.all[lapply(table.all, length) > 0]

table.all <- gtsummary::tbl_stack(table.all)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.all)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.all,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Projetos Liderados por Docentes Permanentes")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\blandscape

```{r 1-1-1-PP-DP-landscape, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# select data
table.projetos <-
  sucupira.df %>% dplyr::select(
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Situação"
  )

# if duplicated, keep Situacão = Concluído
table.projetos <- table.projetos[!duplicated(table.projetos[1:5], fromLast = TRUE),]

table.projetos <- cbind(
  seq(1, dim(table.projetos)[1]),
  table.projetos
  )

colnames(table.projetos) <-
  c(
    "ID",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Projeto",
    "Natureza",
    "Responsável",
    "Situação"
  )
rownames(table.projetos) <- NULL

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(table.projetos <- apply(table.projetos, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.projetos,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Projetos"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(table.projetos), width = paste0(c(0.01,0.19,0.15,0.25,0.10,0.15,0.15)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  table.projetos <- data.frame(table.projetos, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.projetos,
    width = c(0.01,0.19,0.15,0.25,0.10,0.15,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Projetos Liderados por Docentes Permanentes")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.projetos), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.projetos), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

\elandscape

<br>

```{r 1-1-2, eval = knitr::is_html_output()}
cat("### **1.1.2**")
cat('\n\n')
cat("#### **Proposta Curricular do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.1.2 Proposta Curricular do Programa**")
cat('\n\n')
```

```{r 1-1-2-quanti, eval = has.sucupira.files,, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat('##### *Quantitativa*')
  cat('\n\n')
}

# disciplinas
sheet <- "Disciplinas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

síntese.ano <- c()
for (i in 1:length(quadrienal.vigente)) {
  source("Scripts/síntese-sucupira.R", local = knitr::knit_global())
  síntese.ano <-
    dplyr::bind_rows(síntese.ano,
          sintese(
            sucupira.list = sucupira.list,
            ano = quadrienal.vigente[i]
          ))
}

síntese.ano <- síntese.ano %>%
  dplyr::select(c(
    "Ano",
    "Níveis de curso",
    "Mestrado",
    "Doutorado",
    "Disciplinas (M)",
    "Disciplinas (D)",
    "Disciplinas obrigatórias (M)",
    "Disciplinas obrigatórias (D)",
    "Disciplinas eletivas (M)",
    "Disciplinas eletivas (D)",
    "Créditos totais (M)",
    "Créditos totais (D)",
    "Carga horária total (M)",
    "Carga horária total (D)"
    ))

table.1.1.2 <-
  gtsummary::tbl_summary(
    síntese.ano,
    by = "Ano",
    type = list(
      "Níveis de curso" ~ "continuous",
      "Mestrado" ~ "continuous",
      "Doutorado" ~ "continuous",
      "Disciplinas (M)" ~ "continuous",
      "Disciplinas (D)" ~ "continuous",
      "Disciplinas obrigatórias (M)" ~ "continuous",
      "Disciplinas obrigatórias (D)" ~ "continuous",
      "Disciplinas eletivas (M)" ~ "continuous",
      "Disciplinas eletivas (D)" ~ "continuous",
      "Créditos totais (M)" ~ "continuous",
      "Créditos totais (D)" ~ "continuous",
      "Carga horária total (M)" ~ "continuous",
      "Carga horária total (D)" ~ "continuous"
      ),
    statistic = list(gtsummary::all_continuous() ~ "{max}"),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(
    label = "**Ano**",
    gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.1.1.2)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.1.2,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Proposta Curricular do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)), width = paste0(c(0.60, rep(0.40/length(quadrienal.vigente), times = length(quadrienal.vigente)))*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-2-disciplinas, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Load discipline data
sheet <- "Disciplinas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(quadrienal.vigente, names(sucupira.list)))]
disciplinas.raw <- do.call(rbind.data.frame, sucupira.list[periodos])

# select level
course.level <- "Mestrado"
disciplinas.msc <-
  disciplinas.raw[stringr::str_detect(disciplinas.raw$`Nível do Curso`, course.level),]

# remove duplicates
disciplinas.msc <- disciplinas.msc[!duplicated(disciplinas.msc),]

table.msc <-
  data.frame(
    disciplinas.msc$`Nome da Disciplina`,
    disciplinas.msc$`Indicadora de disciplina obrigatória`,
    disciplinas.msc$`Quantidade de créditos`,
    disciplinas.msc$`Carga Horária`,
    substr(as.Date(disciplinas.msc$`Data de início`, format = "%d/%m/%Y"), 1, 4),
    substr(as.Date(disciplinas.msc$`Data de fim`, format = "%d/%m/%Y"), 1, 4)
  )
colnames(table.msc) <- c("Disciplina", "Obrigatória", "CR", "CH", "Início", "Fim")

# to title case
table.msc$Disciplina <- tools::toTitleCase(tolower(table.msc$Disciplina))

# merge CR (CH)
table.msc <- table.msc %>%
  dplyr::mutate(CR = ifelse(is.na(CR), "", ifelse(is.na(CH), CR, paste0(CR, " (", CH, ")")))) %>%
  dplyr::select(-CH)

# merge Início-Fim in format X - X even if FIm is empty
table.msc <- table.msc %>%
  dplyr::mutate('Início-Fim' = ifelse(is.na(Fim), paste0(Início, " - Atual"), paste0(Início, " - ", Fim))) %>% 
  dplyr::select(-Início, -Fim)

# rename column
colnames(table.msc) <- c("Disciplina", "Obrigatória", "CR (CH)", "Início-Fim")

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(table.msc <- apply(table.msc, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

# select level
course.level <- "Doutorado"
disciplinas.dsc <-
  disciplinas.raw[stringr::str_detect(disciplinas.raw$`Nível do Curso`, course.level),]

# remove duplicates
disciplinas.dsc <- disciplinas.dsc[!duplicated(disciplinas.dsc),]

table.dsc <-
  data.frame(
    disciplinas.dsc$`Nome da Disciplina`,
    disciplinas.dsc$`Indicadora de disciplina obrigatória`,
    disciplinas.dsc$`Quantidade de créditos`,
    disciplinas.dsc$`Carga Horária`,
    substr(as.Date(disciplinas.dsc$`Data de início`, format = "%d/%m/%Y"), 1, 4),
    substr(as.Date(disciplinas.dsc$`Data de fim`, format = "%d/%m/%Y"), 1, 4)
  )
colnames(table.dsc) <- c("Disciplina", "Obrigatória", "CR", "CH", "Início", "Fim")

# to title case
table.dsc$Disciplina <- tools::toTitleCase(tolower(table.dsc$Disciplina))

# merge CR (CH)
table.dsc <- table.dsc %>%
  dplyr::mutate(CR = ifelse(is.na(CR), "", ifelse(is.na(CH), CR, paste0(CR, " (", CH, ")")))) %>%
  dplyr::select(-CH)

# merge Início-Fim in format X - X even if FIm is empty
table.dsc <- table.dsc %>%
  dplyr::mutate('Início-Fim' = ifelse(is.na(Fim), paste0(Início, " - Atual"), paste0(Início, " - ", Fim))) %>% 
  dplyr::select(-Início, -Fim)

# rename column
colnames(table.dsc) <- c("Disciplina", "Obrigatória", "CR (CH)", "Início-Fim")

# Escape characters in table data & % $ # _ { }
if(knitr::is_latex_output()) {
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\&", "\\\\&", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\%", "\\\\%", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\$", "\\\\$", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\#", "\\\\#", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\_", "\\\\_", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\{", "\\\\{", x)), silent = TRUE)
  try(table.dsc <- apply(table.dsc, 2, function(x) gsub("\\}", "\\\\}", x)), silent = TRUE)
}

is_valid <- function(x) {
  tryCatch({
    if (exists("x")) {
      if (nrow(x) > 0) {
        return(TRUE)
      } else {
        return(FALSE)
      }
    } else {
      return(FALSE)
    }
  }, error = function(e) {
    return(FALSE)
  })
}

has.table.msc <- is_valid(table.msc)
has.table.dsc <- is_valid(table.dsc)
```

```{r 1-1-2-disciplinas-msc, eval = has.table.msc, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Qualitativa (Mestrado)*')
  cat('\n\n')
}

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.msc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Disciplinas de Mestrado"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(table.msc), width = paste0(c(0.55,0.15,0.15,0.15)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  table.msc <- data.frame(table.msc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.msc,
    width = c(0.55,0.15,0.15,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas de Mestrado")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.msc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.msc), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 1-1-2-disciplinas-dsc, eval = has.table.dsc, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if (knitr::is_html_output()) {
  cat('##### *Qualitativa (Doutorado)*')
  cat('\n\n')
}

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.dsc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Disciplinas de Doutorado"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  ) %>% kableExtra::column_spec(column = 1:ncol(table.dsc), width = paste0(c(0.55,0.15,0.15,0.15)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
} else {
  # use tinytable for LaTeX output
  table.dsc <- data.frame(table.dsc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.dsc,
    width = c(0.55,0.15,0.15,0.15)*(21-3-3),
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas de Doutorado")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.dsc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.dsc), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-1-3, eval = knitr::is_html_output()}
cat("### **1.1.3**")
cat('\n\n')
cat("#### **Infraestrutura** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat('### **1.1.3 Infraestrutura**')
cat('\n\n')
```

```{r 1-1-3-laboratorios-equipamentos, eval = has.laboratorios, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Initialize all sheets
abas <- readxl::excel_sheets("PPG/Laboratórios.xlsx")
abas <- abas[order(abas, decreasing = FALSE)]

# Loop through each sheet
for (j in 1:length(abas)) {
  # Initialize table.infraestrutura for each sheet
  table.infraestrutura <- data.frame()
  
  laboratorios.raw <-
    readxl::read_excel(
      "PPG/Laboratórios.xlsx",
      sheet = abas[j],
      col_types = c("text")
    )
  
  name <- names(laboratorios.raw[1])
  names(laboratorios.raw) <- laboratorios.raw[1,]
  laboratorios.raw <- laboratorios.raw[-1,]
  lab.data <- cbind(rep(name, times = dim(laboratorios.raw)[1]), laboratorios.raw)
  
  # Bind table
  table.infraestrutura <- lab.data
  
  # Repeat each row using the value in last column
  table.infraestrutura <- table.infraestrutura[rep(1:nrow(table.infraestrutura), table.infraestrutura[,ncol(table.infraestrutura)]),]
  
  # Rename columns
  colnames(table.infraestrutura) <- c("Laboratório", "Equipamento", "Quantidade")
  
  # Drop last column
  table.infraestrutura <- table.infraestrutura[, -ncol(table.infraestrutura)]
  
  # Map to wide table using first column as variable and second column as values for each variable
  table.infraestrutura <- table.infraestrutura %>%
    dplyr::group_by(Laboratório) %>%
    dplyr::mutate(row = row_number()) %>%
    tidyr::pivot_wider(names_from = row, values_from = Equipamento) %>%
    dplyr::ungroup()
  
  # Transpose table and use first column as column name
  table.infraestrutura <- t(table.infraestrutura)
  colnames(table.infraestrutura) <- table.infraestrutura[1,]
  table.infraestrutura <- table.infraestrutura[-1,] %>%
    as.data.frame(check.names = FALSE)
  
  # rename 1st column
  colnames(table.infraestrutura)[1] <- name

  # Create gtsummary table
  table_name <- paste0("table_", j, "_summary")  # Unique table name
  table_summary <- gtsummary::tbl_summary(
    table.infraestrutura,
    type = list(
      gtsummary::everything() ~ "categorical"
    ),
    statistic = list(gtsummary::all_continuous() ~ "{n}"),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)
  ) %>%
    gtsummary::modify_header(
      label = "**Laboratório/Equipamento**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
    gtsummary::modify_header(
      update = stat_0 ~ "**Total**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    ) %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
    gtsummary::bold_labels()
  
  # Print HTML table
  if (knitr::is_html_output()) {
    cat('\n\n')
    print(table_summary)
    cat('\n\n')
  }
  
  # Print LaTeX table
  if (knitr::is_latex_output()) {
    cat('\\FloatBarrier')
    # Convert gtsummary object to kableExtra object
    kable_table <- gtsummary::as_kable_extra(
      x = table_summary,
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", paste("Infraestrutura de Laboratórios e Equipamentos -", name))
    ) %>%
      kableExtra::kable_styling(
        bootstrap_options = c("basic", "hover", "condensed", "responsive"),
        latex_options = c("basic", "repeat_header", "HOLD_position"),
        latex_table_env = "tabularx",
        full_width = TRUE,
        position = "center"
      ) %>% kableExtra::column_spec(column = 1:2, width = paste0(c(0.85, 0.15)*(21-3-3), "cm"))
  print(kable_table)
  }
  
  source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
  
  # Add LaTeX commands for new page and float barrier
  if(knitr::is_latex_output()) {
    cat('\\newpage')
  }
}

if (knitr::is_html_output()) {
  # print end of tab rows
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
  )
}
```

<br>

```{r 1-2-1, eval = knitr::is_html_output()}
cat("### **1.2.1**")
cat('\n\n')
cat("#### **Dimensão do corpo Docente Permanente** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.2.1 Dimensão do corpo Docente Permanente**")
cat('\n\n')
```

```{r categoria-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <-
  sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Categoria", colnames(sucupira))]),]
docentes <- docentes[order(docentes$"Nome Docente"), ]

table.doc <-
  data.frame(matrix(
    NA,
    nrow = dim(docentes)[1],
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes$`Nome Docente`, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(docentes)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$'Categoria'[match(table.doc$`Nome Docente`[i], sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}
table.doc.1 <- table.doc

table.doc.long <-
  tidyr::gather(table.doc[, -1],
                "Ano",
                "Categoria",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to sentence format
table.doc.long$Categoria <- stringr::str_to_sentence(table.doc.long$Categoria)

table.doc.long <- rbind(table.doc.long,
                        data.frame(
                          "Ano" = rep(paste0(
                            min(quadrienal.vigente), "-", max(quadrienal.vigente)
                          ), times = dim(table.doc)[1]),
                          "Categoria" = rep("Docentes", times = dim(table.doc)[1]),
                          check.names = FALSE
                        ))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

table.1a <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%  
  gtsummary::remove_row_type(variables = c('Categoria'), 
                  type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r vinculacao-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <-
  sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Carga Horária PG (Semanal)", colnames(sucupira))]),]
docentes <- docentes[order(docentes$"Nome Docente"), ]

table.doc <-
  data.frame(matrix(
    NA,
    nrow = dim(docentes)[1],
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes$`Nome Docente`, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(docentes)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$'Tipo vínculo'[match(table.doc$`Nome Docente`[i], sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}
table.doc.2 <- table.doc

table.doc.long <-
  tidyr::gather(table.doc[, -1],
                "Ano",
                "Tipo vínculo",
                colnames(table.doc)[-1],
                factor_key = TRUE)

table.doc.long <- rbind(table.doc.long,
                        data.frame(
                          "Ano" = rep(paste0(
                            min(quadrienal.vigente), "-", max(quadrienal.vigente)
                          ), times = dim(table.doc)[1]),
                          "Tipo vínculo" = rep("Docentes", times = dim(table.doc)[1]),
                          check.names = FALSE
                        ))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

table.1b <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%  
  gtsummary::remove_row_type(variables = c('Tipo vínculo'), 
                  type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r regime-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <-
  sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Carga Horária PG (Semanal)", colnames(sucupira))]),]
docentes <- docentes[order(docentes$"Nome Docente"), ]

table.doc <-
  data.frame(matrix(
    NA,
    nrow = dim(docentes)[1],
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes$`Nome Docente`, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(docentes)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$'Regime de Trabalho'[match(table.doc$`Nome Docente`[i], sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}
table.doc.3 <- table.doc

table.doc.long <-
  tidyr::gather(table.doc[, -1],
                "Ano",
                "Regime de Trabalho",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to sentence format
table.doc.long$'Regime de Trabalho' <- stringr::str_to_sentence(table.doc.long$'Regime de Trabalho')

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.doc)[1]),
    "Regime de Trabalho" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

table.1c <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%  
  gtsummary::remove_row_type(variables = c('Regime de Trabalho'), 
                  type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r carga-horaria-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

docentes <-
  sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Carga Horária PG (Semanal)", colnames(sucupira))]),]
docentes <- docentes[order(docentes$"Nome Docente"), ]

table.doc <-
  data.frame(matrix(
    NA,
    nrow = dim(docentes)[1],
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes$`Nome Docente`, table.doc)
colnames(table.doc) <-
  c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(docentes)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <-
      sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    
    table.doc[i, j + 1] <-
      try(sucupira.temp$"Carga Horária PG (Semanal)"[match(table.doc$`Nome Docente`[i], sucupira.temp$`Nome Docente`)]
          , silent = TRUE)
  }
}
table.doc.4 <- table.doc

table.doc.long <- tidyr::gather(table.doc[, -1], "Ano", "Carga Horária PG (Semanal)", colnames(table.doc)[-1], factor_key=TRUE)

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(table.doc)[1]),
    "Carga Horária PG (Semanal)" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

table.1d <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%  
  gtsummary::remove_row_type(variables = c('Carga Horária PG (Semanal)'), 
                  type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r dimensao-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# list all tables
table.all <- 
  list(table.1a,
       table.1b,
       table.1c,
       table.1d)

# drop empty elements from list
table.all <- table.all[lapply(table.all, length) > 0]

table.1.2.1 <- gtsummary::tbl_stack(table.all)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.1.2.1)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.1,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Dimensão do Corpo Docente Permanente")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-2-2, eval = knitr::is_html_output()}
cat("### **1.2.2**")
cat('\n\n')
cat("#### **Coerência acadêmica do Corpo Docente à proposta do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.2.2 Coerência acadêmica do Corpo Docente à proposta do PPG**")
cat('\n\n')
```

```{r coerencia-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get docentes for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# keep docentes permanente only
sucupira <- sucupira[sucupira$Categoria == "PERMANENTE", ]

# recode
sucupira$'Data de Admissão' <- substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <- substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <- "Atual"

# filter duplicated docentes (changes in details will be exhibited)
docentes <- sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Área de Conhecimento Titulação", colnames(sucupira))]), ]
docentes <- docentes[order(docentes$"Nome Docente"),]

# generate tables
table.doc <- data.frame(matrix(NA, nrow = dim(docentes)[1], ncol = length(quadrienal.vigente)))
rownames(table.doc) <- NULL
table.doc <- cbind(docentes$`Nome Docente`, table.doc)
colnames(table.doc) <- c("Nome Docente", as.character(quadrienal.vigente))
for (i in 1:dim(docentes)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    sucupira.temp <- sucupira.list[as.character(quadrienal.vigente[j])][[1]]
    table.doc[i, j + 1] <- try(sucupira.temp$'Área de Conhecimento Titulação'[match(table.doc$`Nome Docente`[i], sucupira.temp$`Nome Docente`)], silent = TRUE)
  }
}
table.doc.5 <- table.doc

table.doc.long <-
  tidyr::gather(
    table.doc[, -1],
    "Ano",
    "Área de Conhecimento Titulação",
    colnames(table.doc)[-1],
    factor_key = TRUE
  )

# to title case
table.doc.long$"Área de Conhecimento Titulação" <- tools::toTitleCase(tolower(table.doc.long$"Área de Conhecimento Titulação"))

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = dim(table.doc)[1]),
    "Área de Conhecimento Titulação" = rep("Docentes", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.1.2.2 <- gtsummary::tbl_summary(
  table.doc.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%
  gtsummary::remove_row_type(variables = c('Área de Conhecimento Titulação'), type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))

# Print HTML table
if (knitr::is_html_output()) {
  print(table.1.2.2)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.2,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Coerência Acadêmica do Corpo Docente Permanente à Proposta do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-2-3, eval = knitr::is_html_output()}
cat("### **1.2.3**")
cat('\n\n')
cat("#### **Estabilidade do corpo docente permanente** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.2.3 Estabilidade do corpo docente permanente**")
cat('\n\n')
```

```{r estabilidade-corpo-docente, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the quadrienio.vigente
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

# filter docentes permanentes
sucupira <- lapply(sucupira, function(x) {
  x <- x %>%
    dplyr::filter(`Categoria` == "PERMANENTE")
  return(x)
})

# loop for across the list to get docente, data de admissão e data de desligamento 
table.doc <- lapply(sucupira, function(x) {
  x <- x %>%
    dplyr::select("Nome Docente", "Data de Admissão", "Data de Desligamento")
  return(x)
})

# convert date dd/mm/yyy to yyyy
for(i in 1:length(table.doc)) {
  table.doc[[i]]$"Data de Admissão" <- as.numeric(format(as.Date(table.doc[[i]]$"Data de Admissão", format = "%d/%m/%Y"), "%Y"))
  table.doc[[i]]$"Data de Desligamento" <- as.numeric(format(as.Date(table.doc[[i]]$"Data de Desligamento", format = "%d/%m/%Y"), "%Y"))
}

# name list elements by ano
names(table.doc) <- quadrienal.vigente

# add a new column with ano as value to each element in the data.frame
for(i in 1:length(table.doc)) {
  table.doc[[i]]$"Ano" <- quadrienal.vigente[i]
}
table.doc.6 <- table.doc

# rbind the list elements
table.doc.long <- do.call(rbind, table.doc)

# get docentes with Data Admissão within the quadrienio.vigente
credenciados <- table.doc.long %>%
  dplyr::filter(`Data de Admissão` %in% quadrienal.vigente) %>%
  dplyr::distinct(`Nome Docente`, .keep_all = TRUE)

descredenciados <- table.doc.long %>%
  dplyr::filter(`Data de Desligamento` %in% quadrienal.vigente) %>%
  dplyr::distinct(`Nome Docente`, .keep_all = TRUE)

# to title case
table.doc.long$"Nome Docente" <- tools::toTitleCase(tolower(table.doc.long$"Nome Docente"))
table.doc.long$Estabilidade <- NA

# calculate number of docentes per year
table.doc.7 <- table.doc.long %>%
  dplyr::group_by(Ano) %>%
  dplyr::summarise(n = dplyr::n_distinct(`Nome Docente`))

table.doc.long <- dplyr::select(table.doc.long, "Ano", "Nome Docente", "Estabilidade")

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0("Z", min(quadrienal.vigente), "-", max(quadrienal.vigente)), times = length(unique(table.doc.long$"Nome Docente"))),
    "Nome Docente" = rep("Docentes", times = length(unique(table.doc.long$"Nome Docente"))),
    "Estabilidade" = rep(NA, times = length(unique(table.doc.long$"Nome Docente"))),
    check.names = FALSE
  )
)

# create a new row total for each year
for(i in 1:dim(table.doc.7)[1]){
  table.doc.long <- rbind(
    table.doc.long,
    data.frame(
      "Ano" = rep(table.doc.7$Ano[i], times = table.doc.7$n[i]),
      "Nome Docente" = rep(NA, times = table.doc.7$n[i]),
      "Estabilidade" = rep("Total", times = table.doc.7$n[i]),
      check.names = FALSE
    )
  )
}

# create a new row total for credenciados for each year
table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(credenciados$Ano),
    "Nome Docente" = rep(NA, times = nrow(credenciados)),
    "Estabilidade" = rep("Credenciados", times = nrow(credenciados)),
    check.names = FALSE
  )
)

# create a new row total for descredenciados for each year
table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(descredenciados$Ano),
    "Nome Docente" = rep(NA, times = nrow(descredenciados)),
    "Estabilidade" = rep("Descredenciados", times = nrow(descredenciados)),
    check.names = FALSE
  )
)

# reorder columns
table.doc.long <- table.doc.long %>%
  dplyr::select("Ano", "Estabilidade", "Nome Docente")

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Docentes", na.rm = TRUE), digits = 0)
}

# check for missing docentes.quadrienio
table.doc.long$"Nome Docente" <- factor(
  table.doc.long$"Nome Docente",
  levels = sort(unique(c("Docentes", levels(table.doc.long$"Nome Docente"), docentes.quadrienio)))
)

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# print tables
table.1.2.3 <- gtsummary::tbl_summary(
  table.doc.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "alphanumeric"
  ) %>%
  tbl_fix_order() %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(
    list(
      add_stat_1 ~ "**Quadriênio**",
      gtsummary::all_stat_cols() ~ "**{level}**"
    )
  ) %>%
  gtsummary::remove_row_type(variables = c('Nome Docente'), type = "level", level_value = ("Docentes")) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))

# Print HTML table
if (knitr::is_html_output()) {
  print(table.1.2.3)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.3,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Estabilidade do Corpo Docente Permanente")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 1-2-4, eval = knitr::is_html_output()}
cat("### **1.2.4**")
cat('\n\n')
cat("#### **Percentual de docentes permanentes com dedicação exclusiva ao PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.2.4 Percentual de docentes permanentes com dedicação exclusiva ao PPG**")
cat('\n\n')
```

<!-- EM CONSTRUÇÃO -->

<br>

```{=latex}
\newpage
```

```{r 1-2-5, eval = knitr::is_html_output()}
cat("### **1.2.5**")
cat('\n\n')
cat("#### **Capacidade de captação de recursos** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.2.5 Capacidade de captação de recursos**")
cat('\n\n')
```

```{r auto-financiadores-docente-ano, eval = has.financiadores, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Read the financiadores raw data
financiadores.raw <- readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

# Select variables to display, by AGENCIA & ANO
financiadores <- financiadores.raw %>% 
  dplyr::select("Proponente", "Ano", "Total")

# Drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores),]

# Order financiadores by Proponente
financiadores <- financiadores[order(financiadores$Proponente, decreasing = TRUE),]

# Filter data for the current quadrennial period
financiadores <- financiadores[financiadores$Ano %in% quadrienal.vigente, ]

# count number of unique "Docentes" in the data
my_N <- function(data, ...) {
  dplyr::n_distinct(data$Proponente)
}

# change all column types to factors
financiadores <- financiadores %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
financiadores$Proponente <- factor(
  financiadores$Proponente,
  levels = sort(unique(c(levels(financiadores$Proponente), docentes.quadrienio)))
)

# print tables
table.1.2.5 <-
  gtsummary::tbl_summary(
    financiadores,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0, "Total" ~ 2)
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_fmt_fun(update = add_stat_1 ~ function(x) gtsummary::style_number(x, digits = 0))  %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(variables = c("Total"), type = "all")

# Print HTML table
if (knitr::is_html_output()) {
  print(table.1.2.5)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.1.2.5,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Capacidade de Captação de Recursos")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(unique(financiadores$Ano))+ 1), width = paste0(c(0.65, rep(0.20/(length(unique(financiadores$Ano))), times = length(unique(financiadores$Ano))), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

if (knitr::is_html_output()) {
  # print end of tab rows
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
  )
}
```

<br>

```{r 1-3-1, eval = knitr::is_html_output()}
cat("### **1.3.1**")
cat('\n\n')
cat("#### **Adequação da proposta ao Plano Institucional da IES** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.3.1 Adequação da proposta ao Plano Institucional da IES**")
cat('\n\n')
```

```{r planejamento, eval = all(has.planejamento, knitr::is_html_output()), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Initialize all sheets
abas <- readxl::excel_sheets("PPG/Planejamento estratégico.xlsx")

# Display each sheet in a tab
for (i in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('##### **', abas[i], '**'))
  cat('\n\n<!-- -->\n\n')
  
  # Read data from Excel sheet
  planejamento <- readxl::read_excel("PPG/Planejamento estratégico.xlsx",
                                     sheet = abas[i],
                                     col_types = c("text"))
  
  # Display sheet content in an iframe
  cat(
    paste0(
      '<iframe src="',
      planejamento[1],
      '/preview" style=\"width:100%; height:600px; border:2px solid black;\"></iframe>'
    )
  )
  
  # Print end of tab rows
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
}
```

```{=latex}
\newpage
```

<br>

```{r 1-3-2, eval = knitr::is_html_output()}
cat("### **1.3.2**")
cat('\n\n')
cat("#### **Adequação do planejamento** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.3.2 Adequação do planejamento**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->

<br>

```{=latex}
\newpage
```

```{r 1-4-1, eval = knitr::is_html_output()}
cat("### **1.4.1**")
cat('\n\n')
cat("#### **Adequação dos processos e procedimentos utilizados para a autoavaliação** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **1.4.1 Adequação dos processos e procedimentos utilizados para a autoavaliação**")
cat('\n\n')
```

```{r 1-4-1-metodologia, eval = has.metodologia, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Metodologia.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('##### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  metodologia.raw <-
    readxl::read_excel("PPG/Metodologia.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(metodologia.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(metodologia.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(metodologia.raw[i, ncol(metodologia.raw)])) {
        Abrir[i] <-
          paste0('<a href="',metodologia.raw[i, ncol(metodologia.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
        }
      } else {
        if (!is.na(metodologia.raw[i, ncol(metodologia.raw)])) {
          Abrir[i] <-
            paste0('\\url{', metodologia.raw[i, ncol(metodologia.raw)],'}')
        }
      }
    }
  
  metodologia <- cbind(metodologia.raw[, -ncol(metodologia.raw)], Abrir)
  table <- metodologia
  
  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))

  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
  if (knitr::is_latex_output()) {
    cat("\\newpage")
  }
}
```

```{r 1-4-1-resultados, eval = has.autoavaliacao, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Autoavaliação.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('##### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  autoavaliacao.raw <-
    readxl::read_excel("PPG/Autoavaliação.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(autoavaliacao.raw)[1])
  colnames(Abrir) <- "Abrir"
  
  # add hyperlinks
  for (i in 1:dim(autoavaliacao.raw)[1]) {
    if (knitr::is_html_output()) {
      if (!is.na(autoavaliacao.raw[i, ncol(autoavaliacao.raw)])) {
        Abrir[i] <-
          paste0('<a href="',autoavaliacao.raw[i, ncol(autoavaliacao.raw)],'" target="_blank"', '>', fontawesome::fa("up-right-from-square"), '</a>')
        }
      } else {
        if (!is.na(autoavaliacao.raw[i, ncol(autoavaliacao.raw)])) {
          Abrir[i] <-
            paste0('\\url{', autoavaliacao.raw[i, ncol(autoavaliacao.raw)],'}')
        }
      }
    }
  
  autoavaliacao <- cbind(autoavaliacao.raw[, -ncol(autoavaliacao.raw)], Abrir)
  table <- autoavaliacao

  cat(knitr::knit_print(
    knitr::kable(
      x = table,
      align = "l",
      escape = FALSE,
      format = ifelse(knitr::is_html_output(), "html", "latex"),
      booktabs = TRUE,
      linesep = "",
      caption = ifelse(knitr::is_html_output(), "", abas[j])
    ) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      latex_options = c("striped", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:ncol(table), width = paste0(c(0.10,0.45,0.45)*(21-3-3), "cm")) %>%
      kableExtra::column_spec(column = 1, bold = TRUE) %>%
      kableExtra::row_spec(row = 0, bold = TRUE)
  ))
  
  if (knitr::is_html_output()) {
    # print end of tab rows
    cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>'
    )
  }
  if (knitr::is_latex_output()) {
    cat("\\newpage")
  }
}
```

<br>

## **2. Formação** {#formacao .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r 2-1-1, eval = knitr::is_html_output()}
cat("### **2.1.1**")
cat('\n\n')
cat("#### **Coerência do produto final** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.1.1 Coerência do produto final**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-1-2, eval = knitr::is_html_output()}
cat("### **2.1.2**")
cat('\n\n')
cat("#### **Qualidade do produto final** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.1.2 Qualidade do produto final**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-2-1, eval = knitr::is_html_output()}
cat("### **2.2.1**")
cat('\n\n')
cat("#### **Produção do corpo discente em eventos científicos** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.2.1 Produção do corpo discente em eventos científicos**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-2-2, eval = knitr::is_html_output()}
cat("### **2.2.2**")
cat('\n\n')
cat("#### **Produção bibliográfica dos discentes/egressos – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.2.2 Produção bibliográfica dos discentes/egressos – Acadêmico**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-3-1, eval = knitr::is_html_output()}
cat("### **2.3.1**")
cat('\n\n')
cat("#### **Atuação dos Egressos** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.3.1 Atuação dos Egressos**")
cat('\n\n')
```

```{r 2-3-1-formacao-continuada, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
discentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Discente`,
  `Nível Discente`,
  `Situação Discente`,
  `Data Matrícula`,
  `Data Situação`
)
colnames(discentes)[2] <- "Nome"
colnames(discentes)[3] <- "Nível"
colnames(discentes)[4] <- "Situação"

# Egressos
sheet <- "Egressos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
egressos <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa do Egresso`,
  `Nome do Egresso`,
  `Nível Titulação`,
  `Ano Titulação`
)
colnames(egressos)[1] <- "Identificador da Pessoa"
colnames(egressos)[2] <- "Nome"
colnames(egressos)[3] <- "Nível"
try(egressos$Situação <- "EGRESSO", silent = TRUE)

# Pós-Doc
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
posdoc <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Pós-Doc Nome`,
  `Vínculo Início`,
  `Vínculo Fim`
)
colnames(posdoc)[2] <- "Nome"
try(posdoc$Situação <- "PÓS-DOC", silent = TRUE)

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
docentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Docente`,
  `Data de Admissão`,
  `Data de Desligamento`
)
colnames(docentes)[2] <- "Nome"
try(docentes$Situação <- "DOCENTE", silent = TRUE)

# bind all data by "Identificador da Pessoa"
formacao.continuada <- dplyr::bind_rows(
  discentes,
  egressos,
  posdoc,
  docentes
)

# remove duplicates
formacao.continuada <- formacao.continuada %>%
  dplyr::distinct()

# sort by "Identificador da Pessoa"
formacao.continuada <- formacao.continuada %>%
  dplyr::arrange(`Identificador da Pessoa`)

# create table to fill with start-end year for each situation
table <- data.frame(
  "Nome" = NA,
  "Bacharelado" = NA,
  "Mestrado" = NA,
  "Doutorado" = NA,
  "Pós-Doc" = NA,
  "Docente" = NA,
  check.names = FALSE
)

ID <- unique(formacao.continuada$`Identificador da Pessoa`)
for (i in 1:length(ID)) {
  # select data by ID
  data <- formacao.continuada %>%
    dplyr::filter(`Identificador da Pessoa` == ID[i])
  # get name
  table[i, "Nome"] <- data$Nome[1]
  # get year of start and end for discentes equal to bacharelado
  table[i, "Bacharelado"] <- min(data$`Data Matrícula`[data$Nível == "Bacharelado"], na.rm = TRUE)
  table[i, "Bacharelado"] <- format(as.Date(table[i, "Bacharelado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to mestrado
  table[i, "Mestrado"] <- min(data$`Data Matrícula`[data$Nível == "Mestrado"], na.rm = TRUE)
  table[i, "Mestrado"] <- format(as.Date(table[i, "Mestrado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to doutorado
  table[i, "Doutorado"] <- min(data$`Data Matrícula`[data$Nível == "Doutorado"], na.rm = TRUE)
  table[i, "Doutorado"] <- format(as.Date(table[i, "Doutorado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for pós-doc
  table[i, "Pós-Doc"] <- min(data$`Vínculo Início`, na.rm = TRUE)
  table[i, "Pós-Doc"] <- format(as.Date(table[i, "Pós-Doc"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for docentes
  table[i, "Docente"] <- min(data$`Data de Admissão`, na.rm = TRUE)
  table[i, "Docente"] <- format(as.Date(table[i, "Docente"], format = "%d/%m/%Y"), "%Y")
}

# add last colum with total number of years
table$Atuações <- apply(table, 1, function(x) {
  sum(!is.na(x)) - 1
})

# add last column with the lowest and higher levels of education. Paste levels
table$Formação <- apply(table, 1, function(x) {
  # drop first and last columns
  x <- x[-c(1, length(x))]
  # get lower column with data
  lower <- which(!is.na(x))[1]
  # get higher column with data
  higher <- which(!is.na(x))[length(which(!is.na(x)))]
  if(length(which(!is.na(x))) == 1) {
    return(names(x)[lower])
  } else {
    return(paste(names(x)[lower], names(x)[higher], sep = " - "))
  }
})

# sort by iniciacao científica, mestrado, doutorado, pós-doc, docente e nome
table.continuada <- table %>%
  dplyr::arrange(
    `Bacharelado`,
    `Mestrado`,
    `Doutorado`,
    `Pós-Doc`,
    `Docente`,
    Nome
  )

# add column with first first atuação date available
table.continuada$Ano <- apply(table.continuada, 1, function(x) {
  as.numeric(min(x[2:6], na.rm = TRUE))
})

# select data to print with Ano in quadrienal.vigente
table.continuada <- table.continuada %>%
  dplyr::filter(
    table.continuada$`Bacharelado` == quadrienal.vigente |
      table.continuada$`Mestrado` == quadrienal.vigente |
      table.continuada$`Doutorado` == quadrienal.vigente |
      table.continuada$`Pós-Doc` == quadrienal.vigente |
      table.continuada$`Docente` == quadrienal.vigente
  )

# select columns to print
table.continuada.part <- table.continuada %>%
  dplyr::select(Atuações, Formação, Ano)

# sort by Ano
table.continuada.part <- table.continuada.part %>%
  dplyr::arrange(Ano, Atuações, Formação)

# select Formação with " - " in Formação
try(table.continuada.part <- dplyr::filter(table.continuada.part, grepl(" - ", Formação)), silent = TRUE)

# reload previous table if current is empty
if(nrow(table.continuada.part) == 0) {
  table.continuada.part <- table.continuada %>%
    dplyr::select(Atuações, Formação, Ano)
}

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# print tables
table.2.3.1 <-
 gtsummary::tbl_summary(
    table.continuada.part,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  tbl_fix_order() %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::bold_labels() %>%
  tbl_fix_order() %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
 ) %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.2.3.1)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.2.3.1,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Formação continuada no Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-3-2, eval = knitr::is_html_output()}
cat("### **2.3.2**")
cat('\n\n')
cat("#### **Egressos de destaque na sociedade** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.3.2 Egressos de destaque na sociedade**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-4-1, eval = knitr::is_html_output()}
cat("### **2.4.1**")
cat('\n\n')
cat("#### **Produção bibliográfica total do Programa – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.4.1 Produção bibliográfica total do Programa – Acadêmico**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-5-1, eval = knitr::is_html_output()}
cat("### **2.5.1**")
cat('\n\n')
cat("#### **Atividades de ensino nas disciplinas do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.5.1 Atividades de ensino nas disciplinas do PPG**")
cat('\n\n')
```

```{r turmas, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# turmas
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(quadrienal.vigente, names(sucupira.list)))]
turmas.raw <- do.call(rbind.data.frame, sucupira.list[periodos])

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "Nome da Disciplina",
                                                  "Nível do curso")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "Período/Ano",
    "Nível do curso",
    "Nome da Disciplina",
    "Categoria do responsável",
    "Nome do responsável",
    "Indicador de responsável principal"
  ))

# change to title case
turmas$`Nome da Disciplina` <- tools::toTitleCase(tolower(turmas$`Nome da Disciplina`))
turmas$`Nome do responsável` <- tools::toTitleCase(tolower(turmas$`Nome do responsável`))

# rename
colnames(turmas) <- c(
  "Período/Ano",
  "Disciplinas por curso",
  "Disciplina",
  "Categoria",
  "Docente responsável",
  "Responsável"
)

# generate table (total by year)
table.part1 <-
  gtsummary::tbl_summary(
    turmas %>% dplyr::select(
      "Período/Ano",
      "Disciplinas por curso",
      "Categoria"
    ),
    by = "Período/Ano",
    type = list(
      "Disciplinas por curso" ~ "categorical",
      "Categoria" ~ "categorical"
    ),
    statistic = list(
      "Disciplinas por curso" ~ "{n}",
      "Categoria" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.part1)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part1,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Turmas oferecidas por curso e categoria por período/ano."),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# generate table (total by year)
table.part1 <-
  gtsummary::tbl_summary(
    turmas %>% dplyr::select(
      "Período/Ano",
      "Disciplina"
    ),
    by = "Período/Ano",
    type = list(
      "Disciplina" ~ "categorical"
    ),
    statistic = list(
      "Disciplina" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part1,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Disciplinas oferecidas por curso e categoria por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# get turmas by responsável and categoria Docente
turmas.doc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Docente", ]

# as factor
turmas.doc$`Docente responsável` <- factor(turmas.doc$`Docente responsável`)

# check for missing docentes.quadrienio
turmas.doc$`Docente responsável` <- factor(
  turmas.doc$`Docente responsável`,
  levels = sort(unique(c(levels(turmas.doc$`Docente responsável`), docentes.quadrienio)))
)

table.part2 <- 
gtsummary::tbl_summary(
    turmas.doc %>% dplyr::select(
      "Período/Ano",
      "Docente responsável"
    ),
    by = "Período/Ano",
    type = list(
      "Docente responsável" ~ "categorical"
    ),
    statistic = list(
      "Docente responsável" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.part2)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part2,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Docentes responsáveis pelas disciplinas oferecidas por curso e categoria por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# get turmas by responsável and categoria Pós-Doc
turmas.posdoc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Pós-Doc", ]

if(!sjmisc::is_empty(turmas.posdoc)){
  table.part3 <- 
    gtsummary::tbl_summary(
      turmas.posdoc %>% dplyr::select(
        "Período/Ano",
        "Docente responsável"
      ),
      by = "Período/Ano",
      type = list(
        "Docente responsável" ~ "categorical"
      ),
      statistic = list(
        "Docente responsável" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(turmas.posdoc)) {
  print(table.part3)
}

# Print LaTeX table
if (knitr::is_latex_output() && !sjmisc::is_empty(turmas.posdoc)) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.part3,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Pós-docs responsáveis pelas disciplinas oferecidas por curso e categoria por período/ano"),
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-5-2, eval = knitr::is_html_output()}
cat("### **2.5.2**")
cat('\n\n')
cat("#### **Responsabilidade por PP/PTT** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.5.2 Responsabilidade por PP/PTT**")
cat('\n\n')
```

```{r 2-5-2-doc, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.doc <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"])),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.doc) <- NULL
table.doc <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Docente"]), table.doc)
colnames(table.doc) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.doc)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.doc[i, j + 1] <-
      try(data$`Nome do Membro do Projeto`[match(table.doc$`Nome do Projeto de Pesquisa`[i],
                                                 data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.doc.long <-
  tidyr::gather(table.doc[, -1],
                "Ano",
                "Nome do Membro do Projeto",
                colnames(table.doc)[-1],
                factor_key = TRUE)

# to title case
table.doc.long$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(table.doc.long$`Nome do Membro do Projeto`))

table.doc.long <- rbind(
  table.doc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.doc)[1]),
    "Nome do Membro do Projeto" = rep("Membros", times = dim(table.doc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Membros", na.rm = TRUE), digits = 0)
}

colnames(table.doc.long) <-
  c("Ano", "Projetos de pesquisa por Docente")

# change all column types to factors
table.doc.long <- table.doc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# check for missing docentes.quadrienio
table.doc.long$`Projetos de pesquisa por Docente` <- factor(
  table.doc.long$`Projetos de pesquisa por Docente`,
  levels = sort(unique(c("Membros", levels(table.doc.long$`Projetos de pesquisa por Docente`), docentes.quadrienio)))
)

# print tables
table.doc.gt <-
  gtsummary::tbl_summary(
    table.doc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Projetos de pesquisa por Docente'),
    type = "level",
    level_value = ("Membros")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 2-5-2-docentes, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Docentes** {#docentes-linhas-pesquisa}")
  cat('\n\n')
}

# Print HTML table
if (knitr::is_html_output()) {
  print(table.doc.gt)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.doc.gt,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Docentes Permanentes Responsáveis por Projetos")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# select data
table.projetos.doc <-
  sucupira.df %>% dplyr::select(
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Categoria do Membro do Projeto",
    "Situação"
  )

# if duplicated, keep Situacão = Concluído
table.projetos.doc <- table.projetos.doc[!duplicated(table.projetos.doc[1:5], fromLast = TRUE),]

# select data DOCENTES
table.doc <-
  table(table.projetos.doc$`Nome do Membro do Projeto`[table.projetos.doc$`Categoria do Membro do Projeto` == "Docente"],
        table.projetos.doc$`Linha de Pesquisa`[table.projetos.doc$`Categoria do Membro do Projeto` == "Docente"])

# add row totals
table.doc <- cbind(table.doc, rowSums(table.doc))
colnames(table.doc) <- stringr::str_to_title(c(head(colnames(table.doc), -1), "Quadriênio"))

# add column totals
table.doc <- rbind(table.doc, colSums(table.doc))
rownames(table.doc) <- stringr::str_to_title(c(head(rownames(table.doc), -1), "Quadriênio"))

# add name column
table.doc <- cbind(
  "Nome do Membro do Projeto" = rownames(table.doc),
  table.doc
)

table.doc <- cbind(
  c(seq(1, dim(table.doc)[1] - 1), ""),
  table.doc
  )

colnames(table.doc) <-
  c("ID", colnames(table.doc)[-1])
rownames(table.doc) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.doc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Docentes Permanentes Responsáveis por Projetos"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )
} else {
  # use tinytable for LaTeX output
  table.doc <- data.frame(table.doc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.doc,
    width = 1,
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Docentes Permanenters Responsáveis por Projetos")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.doc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.doc), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

```{r 2-5-2-posdoc, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.posdoc <-
  data.frame(matrix(
    NA,
    nrow = length(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Pós-Doc"])),
    ncol = length(quadrienal.vigente)
  ))
rownames(table.posdoc) <- NULL
table.posdoc <-
  cbind(unique(sucupira.df$`Nome do Projeto de Pesquisa`[sucupira.df$`Categoria do Membro do Projeto` == "Pós-Doc"]),
        table.posdoc)
colnames(table.posdoc) <-
  c("Nome do Projeto de Pesquisa", as.character(quadrienal.vigente))
for (i in 1:dim(table.posdoc)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j],]
    table.posdoc[i, j + 1] <-
      try(data$`Nome do Membro do Projeto`[match(table.posdoc$`Nome do Projeto de Pesquisa`[i],
                                                 data$`Nome do Projeto de Pesquisa`)], silent = TRUE)
  }
}

table.posdoc.long <-
  tidyr::gather(
    table.posdoc[, -1],
    "Ano",
    "Nome do Membro do Projeto",
    colnames(table.posdoc)[-1],
    factor_key = TRUE
  )

# to title case
table.posdoc.long$`Nome do Membro do Projeto` <- tools::toTitleCase(tolower(table.posdoc.long$`Nome do Membro do Projeto`))


table.posdoc.long <- rbind(
  table.posdoc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = dim(table.posdoc)[1]),
    "Nome do Membro do Projeto" = rep("Membros", times = dim(table.posdoc)[1]),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Membros", na.rm = TRUE), digits = 0)
}

colnames(table.posdoc.long) <-
  c("Ano", "Projetos de pesquisa por Pós-Doc")

# change all column types to factors
table.posdoc.long <- table.posdoc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# print tables
table.posdoc.gt <-
  gtsummary::tbl_summary(
    table.posdoc.long,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Projetos de pesquisa por Pós-Doc'),
    type = "level",
    level_value = ("Membros")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 2-5-2-posdoutorandos, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
if(knitr::is_html_output()) {
  cat("##### **Pós-Docs** {#posdocs-linhas-pesquisa}")
  cat('\n\n')
}

# Print HTML table
if (knitr::is_html_output()) {
  print(table.posdoc.gt)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.posdoc.gt,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Pós-docs Responsáveis por Projetos")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.65, rep(0.20/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}

# select data
table.projetos.posdoc <-
  sucupira.df %>% dplyr::select(
    "Área de Concentração",
    "Linha de Pesquisa",
    "Nome do Projeto de Pesquisa",
    "Natureza do Projeto de Pesquisa",
    "Nome do Membro do Projeto",
    "Categoria do Membro do Projeto",
    "Situação"
  )

# if duplicated, keep Situacão = Concluído
table.projetos.posdoc <- table.projetos.posdoc[!duplicated(table.projetos.posdoc[1:5], fromLast = TRUE),]

# select data DOCENTES
table.posdoc <-
  table(table.projetos.posdoc$`Nome do Membro do Projeto`[table.projetos.posdoc$`Categoria do Membro do Projeto` == "Pós-Doc"],
        table.projetos.posdoc$`Linha de Pesquisa`[table.projetos.posdoc$`Categoria do Membro do Projeto` == "Pós-Doc"])

# add row totals
table.posdoc <- cbind(table.posdoc, rowSums(table.posdoc))
colnames(table.posdoc) <- stringr::str_to_title(c(head(colnames(table.posdoc), -1), "Quadriênio"))

# add column totals
table.posdoc <- rbind(table.posdoc, colSums(table.posdoc))
rownames(table.posdoc) <- stringr::str_to_title(c(head(rownames(table.posdoc), -1), "Quadriênio"))

# add name column
table.posdoc <- cbind(
  "Nome do Membro do Projeto" = rownames(table.posdoc),
  table.posdoc
)

table.posdoc <- cbind(
  c(seq(1, dim(table.posdoc)[1] - 1), ""),
  table.posdoc
  )

colnames(table.posdoc) <-
  c("ID", colnames(table.posdoc)[-1])
rownames(table.posdoc) <- NULL

# print tables
if (knitr::is_html_output()) {
  # use kable for HTML output
  knitr::kable(
    table.posdoc,
    align = "l",
    escape = FALSE,
    format = "html",
    booktabs = TRUE,
    linesep = "",
    caption = "Pós-Docs Responsáveis por Projetos"
  ) %>% kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = TRUE,
    position = "center"
  )
} else {
  # use tinytable for LaTeX output
  table.posdoc <- data.frame(table.posdoc, check.names = FALSE)
  options(tinytable_print_output = "latex")
  tinytable::tt(
    table.posdoc,
    width = 1,
    style = "bootstrap",
    align = "l",
    caption = ifelse(knitr::is_html_output(), "", "Pós-Docs Responsáveis por Projetos")
  ) %>%
    tinytable::theme_tt("multipage", rowhead = 1, latex_float = "H") %>%
    tinytable::style_tt(i = 0, j = 1:ncol(table.posdoc), bold = TRUE) %>%
    tinytable::style_tt(i = 1:nrow(table.posdoc), j = 1, bold = TRUE)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 2-5-3, eval = knitr::is_html_output()}
cat("### **2.5.3**")
cat('\n\n')
cat("#### **Orientação no PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.5.3 Orientação no PPG**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-5-4, eval = knitr::is_html_output()}
cat("### **2.5.4**")
cat('\n\n')
cat("#### **Titulação no PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.5.4 Titulação no PPG**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 2-5-5, eval = knitr::is_html_output()}
cat("### **2.5.5**")
cat('\n\n')
cat("#### **Orientação na graduação** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **2.5.5 Orientação na graduação**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

## **3. Impacto na sociedade** {#impacto .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r 3-1-1, eval = knitr::is_html_output()}
cat("### **3.1.1**")
cat('\n\n')
cat("#### **Produção bibliográfica indicada dos DP – Acadêmico** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.1.1 Produção bibliográfica indicada dos DP – Acadêmico**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-1-2, eval = knitr::is_html_output()}
cat("### **3.1.2**")
cat('\n\n')
cat("#### **Produção do Programa** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.1.2 Produção do Programa**")
cat('\n\n')
```

```{r 3-1-2-data, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Get data for the current period
sucupira <- sucupira.list[as.character(quadrienal.vigente)] %>%
  plyr::compact()

for (i in 1:length(sucupira)) {
  sucupira[[i]] <- cbind(
    "Anos" = rep(quadrienal.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}

sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira.df) <- names(sucupira[[as.character(max(as.numeric(quadrienal.vigente)))]])

sucupira.df <- sucupira.df %>% 
  dplyr::select(
    "Anos",
    "Nome da Produção",
    "Produção vinculada a TCC concluído",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Projeto",
    "Categoria do Autor Principal"
  )
sucupira.df$`Área de Concentração` <- tools::toTitleCase(tolower(sucupira.df$`Área de Concentração`))
sucupira.df$`Linha de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Linha de Pesquisa`))
sucupira.df$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Tipo de Produção`))
sucupira.df$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Subtipo de Produção`))
```

```{r 3-1-2-ac, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.ac <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.ac) <- NULL
table.ac <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.ac)
colnames(table.ac) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.ac)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j], ]
    table.ac[i, j + 1] <- try(
      data$`Área de Concentração`[match(table.ac$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.ac <- table.ac[rowSums(is.na(table.ac)) < ncol(table.ac), ]

table.ac.long <- tidyr::gather(
  table.ac[, -1],
  "Ano",
  "Área de Concentração",
  colnames(table.ac)[-1],
  factor_key = TRUE
)

table.ac.long <- rbind(
  table.ac.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.ac[, -1]))),
    "Área de Concentração" = rep("Produção", times = sum(!is.na(table.ac[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.ac.long) <- c("Ano", "Área de Concentração")

# change all column types to factors
table.ac.long <- table.ac.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.ac.gt <- gtsummary::tbl_summary(
  table.ac.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Área de Concentração'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-lp, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.lp <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.lp) <- NULL
table.lp <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.lp)
colnames(table.lp) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.lp)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j], ]
    table.lp[i, j + 1] <- try(
      data$`Linha de Pesquisa`[match(table.lp$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.lp <- table.lp[rowSums(is.na(table.lp)) < ncol(table.lp), ]

table.lp.long <- tidyr::gather(
  table.lp[, -1],
  "Ano",
  "Linha de Pesquisa",
  colnames(table.lp)[-1],
  factor_key = TRUE
)

table.lp.long <- rbind(
  table.lp.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.lp[, -1]))),
    "Linha de Pesquisa" = rep("Produção", times = sum(!is.na(table.lp[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.lp.long) <- c("Ano", "Linha de Pesquisa")

# change all column types to factors
table.lp.long <- table.lp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.lp.gt <- gtsummary::tbl_summary(
  table.lp.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Linha de Pesquisa'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-producao, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.prd <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.prd) <- NULL
table.prd <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.prd)
colnames(table.prd) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.prd)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j], ]
    table.prd[i, j + 1] <- try(
      data$`Tipo de Produção`[match(table.prd$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.prd <- table.prd[rowSums(is.na(table.prd)) < ncol(table.prd), ]

table.prd.long <- tidyr::gather(
  table.prd[, -1],
  "Ano",
  "Tipo de Produção",
  colnames(table.prd)[-1],
  factor_key = TRUE
)

table.prd.long <- rbind(
  table.prd.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.prd[, -1]))),
    "Tipo de Produção" = rep("Produção", times = sum(!is.na(table.prd[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.prd.long) <- c("Ano", "Tipo de Produção")

# change all column types to factors
table.prd.long <- table.prd.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.prd.gt <- gtsummary::tbl_summary(
  table.prd.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Tipo de Produção'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-autor, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.aut <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.aut) <- NULL
table.aut <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.aut)
colnames(table.aut) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.aut)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j], ]
    table.aut[i, j + 1] <- try(
      data$`Categoria do Autor Principal`[match(table.aut$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.aut <- table.aut[rowSums(is.na(table.aut)) < ncol(table.aut), ]

table.aut.long <- tidyr::gather(
  table.aut[, -1],
  "Ano",
  "Categoria do Autor Principal",
  colnames(table.aut)[-1],
  factor_key = TRUE
)

table.aut.long <- rbind(
  table.aut.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.aut[, -1]))),
    "Categoria do Autor Principal" = rep("Produção", times = sum(!is.na(table.aut[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.aut.long) <- c("Ano", "Categoria do Autor Principal")

# change all column types to factors
table.aut.long <- table.aut.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.aut.gt <- gtsummary::tbl_summary(
  table.aut.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Categoria do Autor Principal'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-tcc, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
table.tcc <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.tcc) <- NULL
table.tcc <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.tcc)
colnames(table.tcc) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.tcc)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == quadrienal.vigente[j], ]
    table.tcc[i, j + 1] <- try(
      data$`Produção vinculada a TCC concluído`[match(table.tcc$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.tcc <- table.tcc[rowSums(is.na(table.tcc)) < ncol(table.tcc), ]

table.tcc.long <- tidyr::gather(
  table.tcc[, -1],
  "Ano",
  "Produção vinculada a TCC concluído",
  colnames(table.tcc)[-1],
  factor_key = TRUE
)

table.tcc.long <- rbind(
  table.tcc.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.tcc[, -1]))),
    "Produção vinculada a TCC concluído" = rep("Produção", times = sum(!is.na(table.tcc[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tcc.long) <- c("Ano", "Produção vinculada a TCC concluído")

# change all column types to factors
table.tcc.long <- table.tcc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.tcc.gt <- gtsummary::tbl_summary(
  table.tcc.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Produção vinculada a TCC concluído'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-bibliografica, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# filter sucupira.df by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df.bib$`Nome da Produção`[!duplicated(sucupira.df.bib)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(sucupira.df.bib$`Nome da Produção`[!duplicated(sucupira.df.bib)], table.bib)
colnames(table.bib) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.bib)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df.bib[sucupira.df.bib$Anos == quadrienal.vigente[j], ]
    table.bib[i, j + 1] <- try(
      data$`Subtipo de Produção`[match(table.bib$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.bib <- table.bib[rowSums(is.na(table.bib)) < ncol(table.bib), ]

table.bib.long <- tidyr::gather(
  table.bib[, -1],
  "Ano",
  "Nome da Produção",
  colnames(table.bib)[-1],
  factor_key = TRUE
)

# to title case
table.bib$`Nome da Produção` <- tools::toTitleCase(tolower(table.bib$`Nome da Produção`))

table.bib.long <- rbind(
  table.bib.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.bib[, -1]))),
    "Nome da Produção" = rep("Produção", times = sum(!is.na(table.bib[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.bib.gt <- gtsummary::tbl_summary(
  table.bib.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Produção bibliográfica'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-tecnica, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# filter sucupira.df by "Tipo de Produção" == "Técnica"
sucupira.df.tec <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Técnica", ])

table.tec <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df.tec$`Nome da Produção`[!duplicated(sucupira.df.tec)]),
  ncol = length(quadrienal.vigente)
))

rownames(table.tec) <- NULL
table.tec <- cbind(sucupira.df.tec$`Nome da Produção`[!duplicated(sucupira.df.tec)], table.tec)
colnames(table.tec) <- c("Nome da Produção", as.character(quadrienal.vigente))

for (i in 1:dim(table.tec)[1]) {
  for (j in 1:length(quadrienal.vigente)) {
    data <- sucupira.df.tec[sucupira.df.tec$Anos == quadrienal.vigente[j], ]
    table.tec[i, j + 1] <- try(
      data$`Subtipo de Produção`[match(table.tec$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.tec <- table.tec[rowSums(is.na(table.tec)) < ncol(table.tec), ]

table.tec.long <- tidyr::gather(
  table.tec[, -1],
  "Ano",
  "Subtipo de Produção",
  colnames(table.tec)[-1],
  factor_key = TRUE
)

# to title case
table.tec.long$`Subtipo de Produção` <- tools::toTitleCase(tolower(table.tec.long$`Subtipo de Produção`))

table.tec.long <- rbind(
  table.tec.long,
  data.frame(
    "Ano" = rep(paste0(
      min(quadrienal.vigente), "-", max(quadrienal.vigente)
    ), times = sum(!is.na(table.tec[, -1]))),
    "Subtipo de Produção" = rep("Produção", times = sum(!is.na(table.tec[, -1]))),
    check.names = FALSE
  )
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tec.long) <- c("Ano", "Produção técnica")

# change all column types to factors
table.tec.long <- table.tec.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.tec.gt <- gtsummary::tbl_summary(
  table.tec.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
  gtsummary::add_stat(fns = gtsummary::all_categorical() ~ my_N) %>%
  gtsummary::modify_header(list(
    add_stat_1 ~ "**Quadriênio**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  )) %>%
  gtsummary::remove_row_type(
    variables = c('Produção técnica'),
    type = "level",
    level_value = ("Produção")
  ) %>%
  gtsummary::modify_column_hide(columns = paste0("stat_", as.character(length(quadrienal.vigente) + 1)))
```

```{r 3-1-2-list-tables, eval = has.sucupira.files, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
# List all tables
table.all <- list(
  table.ac.gt,
  table.lp.gt,
  table.prd.gt,
  table.aut.gt,
  table.tcc.gt,
  table.bib.gt,
  table.tec.gt
)

# Drop empty elements from the list
table.all <- table.all[lapply(table.all, length) > 0]

table.3.1.2 <- gtsummary::tbl_stack(table.all)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.3.1.2)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.3.1.2,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Produção do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    )
  print(kable_table)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 3-2-1, eval = knitr::is_html_output()}
cat("### **3.2.1**")
cat('\n\n')
cat("#### **Avaliação quantitativa dos impactos do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.2.1 Avaliação quantitativa dos impactos do PPG**")
cat('\n\n')
```

```{r 3-2-1-data, eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
metricas_all_ID <- metricas_all[!duplicated(metricas_all$"ID da Produção"),]

metricas_all_ID$Qualis[is.na(metricas_all_ID$Qualis)] <- "Não classificado"

# get only artigos
metricas_all_ID <- metricas_all_ID[metricas_all_ID$"Subtipo de Produção" == "ARTIGO EM PERIÓDICO",]

# loop to get Qualis values from matched ISSN values
for(i in 1:dim(metricas_all_ID)[1]) {
  # check if ISSN exists in the list
  if(!sjmisc::is_empty(which(metricas_all_ID$ISSN[i] == qualis$ISSN))){
      metricas_all_ID$Qualis[i] <- as.character(unique(qualis[which(metricas_all_ID$ISSN[i] == qualis$ISSN), "Estrato"]))
  }
}

síntese.ano <- dplyr::bind_cols(
      Ano = as.numeric(metricas_all_ID$"Ano da Produção"),
      Qualis = as.factor(metricas_all_ID$Qualis),
      CiteScore = as.numeric(metricas_all_ID$CiteScore),
      SJR = as.numeric(metricas_all_ID$SJR),
      Citações = as.numeric(metricas_all_ID$citations),
      Altmetric = as.numeric(metricas_all_ID$altmetric_score),
      Facebook = as.numeric(metricas_all_ID$cited_by_fbwalls_count),
      Blogs = as.numeric(metricas_all_ID$cited_by_feeds_count),
      'Google+' = as.numeric(metricas_all_ID$cited_by_gplus_count),
      Notícias = as.numeric(metricas_all_ID$cited_by_msm_count),
      Posts = as.numeric(metricas_all_ID$cited_by_posts_count),
      Reddit = as.numeric(metricas_all_ID$cited_by_rdts_count),
      X = as.numeric(metricas_all_ID$cited_by_tweeters_count),
      'YouTube/Vimeo' = as.numeric(metricas_all_ID$cited_by_videos_count),
      Patentes = as.numeric(metricas_all_ID$cited_by_patents_count),
      Mendeley = as.numeric(metricas_all_ID$mendeley),
      'Acesso aberto' = factor(as.logical(metricas_all_ID$is_oa), levels = c(TRUE, FALSE), labels = c("Sim", "Não"))
          )

# Data selection
síntese.ano <- síntese.ano %>%
  dplyr::select(c(
    "Ano",
    "Qualis",
    "CiteScore",
    "SJR",
    "Citações",
    "Altmetric",
    "Facebook",
    "Blogs",
    "Google+",
    "Notícias",
    "Posts",
    "Reddit",
    "X",
    "YouTube/Vimeo",
    "Patentes",
    "Mendeley",
    "Acesso aberto"
    ))

# filter data in quadrineal.vigente
síntese.ano <- síntese.ano %>%
  dplyr::filter(
    Ano >= min(quadrienal.vigente) &
    Ano <= max(quadrienal.vigente)
    )

# generate table (total by year)
table.3.2.1 <-
  gtsummary::tbl_summary(
    síntese.ano,
    by = "Ano",
    type = list(
      "CiteScore" ~ "continuous",
      "Qualis" ~ "categorical",
      "SJR" ~ "continuous",
      "Citações" ~ "continuous",
      "Altmetric" ~ "continuous",
      "Facebook" ~ "continuous",
      "Blogs" ~ "continuous",
      "Google+" ~ "continuous",
      "Notícias" ~ "continuous",
      "Posts" ~ "continuous",
      "Reddit" ~ "continuous",
      "X" ~ "continuous",
      "YouTube/Vimeo" ~ "continuous",
      "Patentes" ~ "continuous",
      "Mendeley" ~ "continuous",
      "Acesso aberto" ~ "categorical"
      ),
    statistic = list(
      gtsummary::all_continuous() ~ "{median} ({min}-{max})",
      gtsummary::all_categorical() ~ "{n} ({p}%)"
      ),
    missing = "no",
    digits = list(
      "Qualis" ~ 0,
      "CiteScore" ~ 2,
      "SJR" ~ 2,
      "Citações" ~ 0,
      "Altmetric" ~ 0,
      "Facebook" ~ 0,
      "Blogs" ~ 0,
      "Google+" ~ 0,
      "Notícias" ~ 0,
      "Posts" ~ 0,
      "Reddit" ~ 0,
      "X" ~ 0,
      "YouTube/Vimeo" ~ 0,
      "Patentes" ~ 0,
      "Mendeley" ~ 0
      ),
    ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = list(
      gtsummary::all_continuous() ~ "{median} ({min}-{max})",
      gtsummary::all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  gtsummary::modify_header(
    update = stat_0 ~ "**Total**",
    gtsummary::all_stat_cols() ~ "**{level}**"
  ) %>%
  gtsummary::modify_header(
    label = "**Ano**",
    gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()


# Print HTML table
if (knitr::is_html_output()) {
  print(table.3.2.1)
}

# Print LaTeX table
if (knitr::is_latex_output()) {
  cat('\\FloatBarrier')
  # Convert gtsummary object to kableExtra object
  kable_table <- gtsummary::as_kable_extra(
    x = table.3.2.1,
    escape = FALSE,
    format = ifelse(knitr::is_html_output(), "html", "latex"),
    booktabs = TRUE,
    linesep = "",
    caption = ifelse(knitr::is_html_output(), "", "Avaliação quantitativa dos impactos do Programa")
  ) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("basic", "hover", "condensed", "responsive"),
      latex_options = c("basic", "repeat_header", "HOLD_position"),
      latex_table_env = "tabularx",
      full_width = TRUE,
      position = "center"
    ) %>% kableExtra::column_spec(column = 1:(1 + length(quadrienal.vigente)+ 1), width = paste0(c(0.25, rep(0.60/(length(quadrienal.vigente)), times = length(quadrienal.vigente)), 0.15)*(21-3-3), "cm"))
  print(kable_table)
}

source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('\n\n')
cat('**Nota**: A classificação dos periódicos pelo Qualis refere-se à Avaliação Quadrienal 2017-2020 conforme arquivo disponibilizado na [Plataforma Sucupira](https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/veiculoPublicacaoQualis/listaConsultaGeralPeriodicos.xhtml) e não substitui a classificação da CAPES da Avaliação Quadrienal ', min(quadrienal.vigente), '-', max(quadrienal.vigente), '.', sep = "")
cat('\n\n')

# Add LaTeX commands for new page and float barrier
if(knitr::is_latex_output()) {
  cat('\\newpage')
}
```

<br>

```{r 3-2-2, eval = knitr::is_html_output()}
cat("### **3.2.2**")
cat('\n\n')
cat("#### **Avaliação qualitativa dos impactos do PPG** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.2.2 Avaliação qualitativa dos impactos do PPG**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-3-1, eval = knitr::is_html_output()}
cat("### **3.3.1**")
cat('\n\n')
cat("#### **Visibilidade** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.3.1 Visibilidade**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{r 3-3-2, eval = knitr::is_html_output()}
cat("### **3.3.2**")
cat('\n\n')
cat("#### **Internacionalização e Inserção** {.tabset}")
cat('\n\n')
```

```{r, eval = !knitr::is_html_output()}
cat("### **3.3.2 Internacionalização e Inserção**")
cat('\n\n')
```


<!-- EM CONSTRUÇÃO -->


```{=latex}
\newpage
\FloatBarrier
```

<br>

```{=latex}
\DisableFootNotes
```

```{r relatorio-quadrienal, eval = knitr::is_html_output(), echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", fig.pos='H'}
cat("## **Relatório quadrienal** {#relatorio-quadrienal}")
cat('\n\n')
cat('<!--script for generating HORIZONTAL LINE-->')
cat('\n\n')
cat('<hr style="height:2px;border-width:0;color:black;background-color:black">')
cat('\n\n')
cat(
  paste0(
    '<iframe src=\"',
    'autoavaliacao.pdf',
    '\" style=\"width:100%; height:600px; border:2px solid black;\"></iframe>'
  )
)
cat('\n\n')
```
