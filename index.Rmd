---
title: OBSERVATÓRIO
output:
  html_document:
    toc: false
    toc_float: true
    css:
      - ./CSS/index.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
---

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = 'asis',
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)
```

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
    knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

---
title: "OBSERVATÓRIO `r ifelse(magrittr::and(has.dados.cadastrais, has.sucupira.files), sigla.PPG, "")`"
---

<br>

<br>

<center>

```{r logo-ppg}
if(file.exists("PPG/Images/logo-programa.png")) {
  cat('<img src=\"PPG/Images/logo-programa.png\" height="100px" align=\"center\"/>')
  has.logo.ppg <- TRUE
} else {
  has.logo.ppg <- FALSE
}
```

<br>

<p style="font-size:1.5em">
```{r intro, results = 'asis'}
if (has.dados.cadastrais && has.sucupira.files) {
  cat(
    'O **Observatório ', toupper(as.character(sigla.PPG)),
    '** é uma iniciativa do **Programa de Pós-graduação em ', as.character(nome.PPG), '** - [', tools::toTitleCase(as.character(nome.IES)), '](', as.character(site.PPG),') ',
    'que envolve o registro, o acompanhamento e a análise agregada e estruturada de dados para divulgação transparente de suas atividades, planejamentos, ações e impactos, tornando-os acessíveis à sociedade',
    sep = ""
  )
} else {
  cat(
    'O **Observatório** é uma iniciativa que envolve o registro, o acompanhamento e a análise agregada e estruturada de dados para divulgação transparente de suas atividades, planejamentos, ações e impactos, tornando-os acessíveis à sociedade',
    sep = ""
  )
}
```
</p>

</center>

```{r meta-observatorio, eval = !any(has.logo.ppg, has.sucupira.files, has.financiadores, has.metricas.doi.ppg, has.metricas.doi.sucupira, has.discentes)}
# se não ná nada para exibir, mostre os observatórios existentes
cat('<br>')
cat('<br>')

shiny::HTML("<h1>UNISUAM | PPGCR</h1>")
shiny::HTML('<iframe src="https://ppgcr-unisuam.github.io/observatoriocr/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>UFC | PPGFisio</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgfisioufc.github.io/PPGFisio_UFC/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>UFTM-UFU | PPGFisio</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgfisiouftmufu.github.io/ObservatorioUFTM_UFU/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>UFRN | PPGCR</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgfisioterapia.github.io/observatorioUFRN/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>USP | PPGReab</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgreab.github.io/Observatorio-PPGPosReab-USP/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>UNISUAM | PPGDL</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgdl-unisuam.github.io/observatoriodl/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>IFRJ | PPGCTIS</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgctis.github.io/ObservatorioCTIS/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')

shiny::HTML("<h1>UPE | PPGRDF</h1>")
shiny::HTML('<iframe id="scaled-frame" src="https://ppgrdf-upe.github.io/Observatorio_PPGRDF/" style="width:100%; height:600px; border:2px solid white;"></iframe>')

cat('<br>')
cat('<br>')
```

```{r sintese-coerencia, include = FALSE, eval = has.sucupira.files}
# projetos
sheet <- "Linhas de Pesquisa - Projetos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# convert sucupira.list into dataframe adding a new colum with the respective ano
sucupira <- dplyr::bind_rows(sucupira.list, .id = "Ano")

# crosstable of projects by year EM ANDAMENTO by Área de Concentração and Linha de Pesquisa
projetos.em.andamento <- sucupira[sucupira$Situação == "EM ANDAMENTO", ]
projetos.em.andamento <- projetos.em.andamento %>%
  dplyr::group_by(Ano, `Área de Concentração`, `Linha de Pesquisa`) %>%
  dplyr::summarise(n = n())

# crosstable of projects by year CONCLUÍDO by Linha de Pesquisa
projetos.concluido <- sucupira[sucupira$Situação == "CONCLUÍDO", ]
projetos.concluido <- projetos.concluido %>%
  dplyr::group_by(Ano, `Área de Concentração`, `Linha de Pesquisa`) %>%
  dplyr::summarise(n = n())

# get current AC and LP
current.AC <- unique(projetos.em.andamento$`Área de Concentração`)
current.LP <- unique(projetos.em.andamento$`Linha de Pesquisa`)

# remove NA values
current.AC <- current.AC[!is.na(current.AC)]
current.LP <- current.LP[!is.na(current.LP)]

# remove projeto isolado da LP
current.LP <- current.LP[current.LP != "PROJETO ISOLADO"]

# summary data for plot table
summ.AC.LP <-
  as.data.frame(
    table(
      projetos.em.andamento$`Área de Concentração`,
      projetos.em.andamento$`Linha de Pesquisa`
    )
  )

# drop freq = 0 values
summ.AC.LP <- summ.AC.LP[summ.AC.LP$Freq != 0, ]

colnames(summ.AC.LP) <- c("AC", "LP", "Freq")

# summ.AC.LP$AC <- as.factor(abbreviate(summ.AC.LP$AC))
# summ.AC.LP$LP <- as.factor(abbreviate(summ.AC.LP$LP))
data <- summ.AC.LP

# Criar uma tabela de nós com identificadores únicos
nodes <- data %>%
  dplyr::select(AC, LP) %>%
  tidyr::pivot_longer(cols = c(AC, LP), names_to = "type", values_to = "label") %>%
  dplyr::distinct() %>%
  dplyr::mutate(id = as.character(row_number())) %>%
  dplyr::select(id, label, type)

# Calcular a frequência total para cada nó
node_freq <- data %>%
  tidyr::pivot_longer(cols = c(AC, LP), names_to = "type", values_to = "label") %>%
  dplyr::group_by(label) %>%
  dplyr::summarise(Freq = sum(as.numeric(Freq))) %>%
  dplyr::ungroup()

# Adicionar a frequência dos nós ao dataframe 'nodes'
nodes <- nodes %>%
  dplyr::left_join(node_freq, by = c("label" = "label")) %>%
  dplyr::mutate(size = Freq)

# Criar uma tabela de arestas
edges <- data %>%
  dplyr::left_join(nodes %>% dplyr::select(label, id), by = c("AC" = "label")) %>%
  dplyr::rename(from = id) %>%
  dplyr::left_join(nodes %>% dplyr::select(label, id), by = c("LP" = "label")) %>%
  dplyr::rename(to = id) %>%
  dplyr::mutate(label = paste("Freq:", Freq)) %>%
  dplyr::select(from, to, label)

# Criar o grafo tree layout
g <- igraph::graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)

# plot 1
par(
  oma = c(0, 0, 0, 0),
  mar = c(1, 1, 2, 1),
  bg = main.color,
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# Visualizar o grafo
plot(
  g,
  vertex.size = igraph::V(g)$size,  # Tamanho dos vértices baseado na frequência
  vertex.label = NA,  # Rótulos dos vértices
  vertex.label.cex = 0.8,
  vertex.label.color = ifelse(igraph::V(g)$type == "AC", main.color, "white"),
  vertex.label.dist = ifelse(igraph::V(g)$type == "AC", 0, 2),
  vertex.frame.color = ifelse(igraph::V(g)$type == "AC", main.color, main.color),
  vertex.color = ifelse(igraph::V(g)$type == "AC", RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], RColorBrewer::brewer.pal(n = 9, name = "Set3")[2]),
  edge.label = NA,
  edge.label.cex = 0.8,
  edge.label.color = "white",
  layout = igraph::layout.fruchterman.reingold,
  main = "Áreas de Concentração e Linhas de Pesquisa"
)

# add legend
legend("bottomleft", legend = c("Área de Concentração", "Linha de Pesquisa"), fill = RColorBrewer::brewer.pal(n = 9, name = "Set3"), bty = "n")

# plot 2

# plot area setup
# layout.m <- matrix(c(1, 2, 3, 4), ncol = 2, byrow = FALSE)
layout.m <- matrix(c(1, 2), ncol = 1, byrow = FALSE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.coerencia.1 <- c(length(current.AC),
                      length(current.LP))
names(summ.coerencia.1) <-
  c("Áreas de Concentração",
    "Linhas de Pesquisa")

summ.data <- c(summ.coerencia.1)
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-coerencia-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-coerencia-1
knitr::include_graphics("index_files/figure-html/sintese-coerencia-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-coerencia-2
knitr::include_graphics("index_files/figure-html/sintese-coerencia-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-projetos-cloud, include = FALSE, eval = has.sucupira.files}
# projetos
sheet <- "Projetos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# delete duplicates based on ID
sucupira.raw <- sucupira.raw[!duplicated(sucupira.raw$`Identificador do Projeto de Pesquisa`),]
data.to.cloud <- sucupira.raw$`Nome do Projeto de Pesquisa`
cloud.title <- "Projetos"
clean.text <- TRUE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
plot(wordcloud)

# dissertações e teses
sheet <- "TCC"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# delete duplicates based on ID da Produção
sucupira.raw <- sucupira.raw[!duplicated(sucupira.raw$`Identificador do Trabalho de Conclusão`),]
data.to.cloud <- sucupira.raw$`Nome do Trabalho de Conclusão`
cloud.title <- "Dissertações e Teses"
clean.text <- TRUE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
plot(wordcloud)
```

```{r sintese-projetos-cloud-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-projetos-cloud-1
knitr::include_graphics("index_files/figure-html/sintese-projetos-cloud-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-projetos-cloud-2
knitr::include_graphics("index_files/figure-html/sintese-projetos-cloud-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-projetos, include = FALSE, eval = has.sucupira.files}
# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# convert sucupira.list into dataframe adding a new colum with the respective ano
sucupira <- dplyr::bind_rows(sucupira.list, .id = "Ano")
# distinct entries
sucupira <- dplyr::distinct(sucupira)

# plot 1 (total de projetos por área de concentração, por ano)

# crosstable of projects by Área de Concentração
projetos.ac <- sucupira %>%
  dplyr::distinct(Ano, `Identificador do Projeto de Pesquisa`, .keep_all = TRUE) %>%
  dplyr::group_by(Ano, `Área de Concentração`) %>%
  dplyr::summarise(n = n())

# replace NA values by Indefinida
projetos.ac$`Área de Concentração`[is.na(projetos.ac$`Área de Concentração`)] <- "Indefinida"

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(projetos.ac$`Área de Concentração`)), name = "Set3")

plot.1 <- plotly::plot_ly(
  data = projetos.ac,
  x = ~Ano,
  y = ~n,
  color = ~`Área de Concentração`,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Projetos por Área de Concentração",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# plot 2 (total de projetos por linha, por ano)

# crosstable of projects by Linha de Pesquisa
projetos.lp <- sucupira %>%
  dplyr::distinct(Ano, `Identificador do Projeto de Pesquisa`, .keep_all = TRUE) %>%
  dplyr::group_by(Ano, `Linha de Pesquisa`) %>%
  dplyr::summarise(n = n())

# replace NA values by Indefinida
projetos.lp$`Linha de Pesquisa`[is.na(projetos.lp$`Linha de Pesquisa`)] <- "Indefinida"

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(projetos.lp$`Linha de Pesquisa`)), name = "Set3")

plot.2 <- plotly::plot_ly(
  data = projetos.lp,
  x = ~Ano,
  y = ~n,
  color = ~`Linha de Pesquisa`,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Projetos por Linha de Pesquisa",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# plot 3 (total de projetos por situação, por ano)

# crosstable of projects by Situação
projetos.situacao <- sucupira %>%
  dplyr::distinct(Ano, `Identificador do Projeto de Pesquisa`, .keep_all = TRUE) %>%
  dplyr::group_by(Ano, Situação) %>%
  dplyr::summarise(n = n())

# replace NA values by Indefinida
projetos.situacao$Situação[is.na(projetos.situacao$Situação)] <- "Indefinida"

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(projetos.situacao$Situação)), name = "Set3")

plot.3 <- plotly::plot_ly(
  data = projetos.situacao,
  x = ~Ano,
  y = ~n,
  color = ~Situação,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Projetos por Situação",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# plot 4 (total de projetos por Natureza do Projeto de Pesquisa, por ano)

# crosstable of projects by Natureza
projetos.natureza <- sucupira %>%
  dplyr::distinct(Ano, `Identificador do Projeto de Pesquisa`, .keep_all = TRUE) %>%
  dplyr::group_by(Ano, `Natureza do Projeto de Pesquisa`) %>%
  dplyr::summarise(n = n())

# replace NA values by Indefinida
projetos.natureza$`Natureza do Projeto de Pesquisa`[is.na(projetos.natureza$`Natureza do Projeto de Pesquisa`)] <- "Indefinida"

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(projetos.natureza$`Natureza do Projeto de Pesquisa`)), name = "Set3")

plot.4 <- plotly::plot_ly(
  data = projetos.natureza,
  x = ~Ano,
  y = ~n,
  color = ~`Natureza do Projeto de Pesquisa`,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.4 <- plot.4 %>% plotly::layout(
  title = list(
    text = "Projetos por Natureza",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# plot 5 (total de projetos por categoria de membro, por ano)

# crosstable of projects by Categoria do Membro
projetos.categoria <- sucupira %>%
  dplyr::distinct(Ano, `Identificador da Pessoa do Membro`, .keep_all = TRUE) %>%
  dplyr::group_by(Ano, `Categoria do Membro do Projeto`) %>%
  dplyr::summarise(n = n())

# replace NA values by Indefinida
projetos.categoria$`Categoria do Membro do Projeto`[is.na(projetos.categoria$`Categoria do Membro do Projeto`)] <- "Indefinida"

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(projetos.categoria$`Categoria do Membro do Projeto`)), name = "Set3")

plot.5 <- plotly::plot_ly(
  data = projetos.categoria,
  x = ~Ano,
  y = ~n,
  color = ~`Categoria do Membro do Projeto`,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.5 <- plot.5 %>% plotly::layout(
  title = list(
    text = "Categoria dos Membros dos Projetos",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# plot 6 (summary table in plot)
summ.table.projetos <- data.frame()

# total per situação em andamento using filter current year
summ.table.projetos.1 <- sucupira %>%
  dplyr::filter(Ano == Ano[length(Ano)]) %>%
  dplyr::distinct(`Identificador do Projeto de Pesquisa`, Situação, .keep_all = TRUE) %>%
  dplyr::group_by(Situação) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::filter(Situação == "EM ANDAMENTO")

# total per situação concluído using all years
summ.table.projetos.1 <- rbind(
  summ.table.projetos.1,
  sucupira %>%
    dplyr::distinct(`Identificador do Projeto de Pesquisa`, Situação, .keep_all = TRUE) %>%
    dplyr::group_by(Situação) %>%
    dplyr::summarise(n = n()) %>%
    dplyr::filter(Situação == "CONCLUÍDO")
)

# total per categoria
summ.table.projetos.2 <- sucupira %>% 
  dplyr::distinct(`Identificador da Pessoa do Membro`, `Categoria do Membro do Projeto`, .keep_all = TRUE) %>%
  dplyr::group_by(`Categoria do Membro do Projeto`) %>%
  dplyr::summarise(n = n())

# total de membros
summ.table.projetos.3 <- sucupira %>%
  dplyr::distinct(`Identificador da Pessoa do Membro`, .keep_all = TRUE) %>%
  dplyr::summarise(n = n())

# merge datasets as two column 
summ.table.projetos <- c(summ.table.projetos.1$n, summ.table.projetos.2$n, summ.table.projetos.3$n)
names(summ.table.projetos) <- c(summ.table.projetos.1$Situação, summ.table.projetos.2$`Categoria do Membro do Projeto`, "Membros")

# to title case
names(summ.table.projetos) <- tools::toTitleCase(tolower(names(summ.table.projetos)))

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 2, 2, 3, 4, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# change to matrix format with names
summ.data <- summ.table.projetos
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-projetos-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.4
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.5
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-projetos-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-projetos-1
knitr::include_graphics("index_files/figure-html/sintese-projetos-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-financiadores, include = FALSE, eval = has.financiadores}
financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

# dplyr::select variables to display
financiadores <-
  financiadores.raw %>% dplyr::select("Ano", "Agência", "Programa", "Total", "Proponente")

# drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores), ]

# generate cross-table
agencia.ano <-
  table(financiadores$'Agência', financiadores$'Ano')
agencia.ano <-
  agencia.ano[, order(colnames(agencia.ano), decreasing = FALSE)]

# get all 'agencias'
agencias <- na.exclude(rownames(agencia.ano))

# plot 1 (financiadores per agency by year (absolute frequency)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(agencias), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(agencia.ano, id.vars = "Agência", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Agência", "Ano", "Frequência")

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Agência,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Editais por Agências Financiadoras",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = unique(data_long$Ano)
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# generate cross-table
valor.ano <-
  with(financiadores, tapply(
    financiadores$Total,
    list(financiadores$'Agência', financiadores$'Ano'),
    FUN = sum
  ))

# add zero to not available values
valor.ano[is.na(valor.ano)] <- 0

valor.ano <-
  valor.ano[, order(colnames(valor.ano), decreasing = FALSE)]

# get all 'agencias'
agencias <- na.exclude(rownames(valor.ano))


# plot 2 (financiadores per agency by year (absolute frequency))

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(agencias), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(valor.ano, id.vars = "Agência", variable.name = "Ano", value.name = "Valor")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Agência", "Ano", "Valor")

plot.2 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Valor,
  color = ~Agência,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Valores por Agências Financiadoras",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = unique(data_long$Ano)
  ),
  yaxis = list(
    title = "R$",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# generate cross-table
professores.ano <-
  rowSums(table(financiadores$Ano, financiadores$Proponente) != 0)

# plot 3 (financiadores per docente by year (absolute frequency))

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(agencias), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(professores.ano, value.name = "Frequência")
data_long$Ano <- names(professores.ano)
# add column with years
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Frequência", "Ano")

plot.3 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = colors[1],
  type = 'bar',
  colors = colors[1],
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Docentes com Financiamentos",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = unique(data_long$Ano)
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)

editais <- financiadores$Programa
top <- min(length(editais[which(!is.na(editais))]), 10)
data.editais <-
  na.omit(data.frame(name = names(sort(
    table(editais), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(editais), decreasing = TRUE
  )[1:top])))
# break vector names in 2 lines
text.2.break <- data.editais$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.editais$name <- broken_text

# plot 4 (top-10 editais)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(agencias), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(data.editais, value.name = "Frequência")
data_long <- data_long[, -2]
colnames(data_long) <- c("Edital", "Frequência")
# set factor level for sorting
data_long$Edital <- factor(data_long$Edital, levels = data.editais$name)

plot.4 <- plotly::plot_ly(
  data = data_long,
  x = ~Frequência,
  y = ~Edital,
  color = colors[1],
  type = 'bar',
  colors = colors[1],
  height = 720
)

plot.4 <- plot.4 %>% plotly::layout(
  title = list(
    text = paste0("Top-", top, " Editais Financiados"),
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = seq(0, max(data.editais$value), by = 1)
  ),
  yaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    # reverse axis
    autorange = 'reversed'
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)

agencias <- financiadores$Agência
top <- min(length(agencias[which(!is.na(agencias))]), 10)
data.agencias <-
  na.omit(data.frame(name = names(sort(
    table(agencias), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(agencias), decreasing = TRUE
  )[1:top])))
# break vector names in 2 lines
text.2.break <- data.agencias$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.agencias$name <- broken_text

# plot 5 (top-10 agencias)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(agencias), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(data.agencias, value.name = "Frequência")
data_long <- data_long[, -2]
colnames(data_long) <- c("Agência", "Frequência")
# set factor level for sorting
data_long$Agência <- factor(data_long$Agência, levels = data.agencias$name)

plot.5 <- plotly::plot_ly(
  data = data_long,
  x = ~Frequência,
  y = ~Agência,
  color = colors[1],
  type = 'bar',
  colors = colors[1],
  height = 720
)

plot.5 <- plot.5 %>% plotly::layout(
  title = list(
    text = paste0("Top-", top, " Agências Financiadoras"),
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = seq(0, max(data.agencias$value), by = 1)
  ),
  yaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    # reverse axis
    autorange = 'reversed'
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)

# calculate summary statistics for financiamentos
summ.table.financiadores <- matrix(0, nrow = 1, ncol = 5)
summ.table.financiadores <-
  cbind(
    paste0(
      formatC(
        length(na.omit(financiadores$Total)),
        format = "d",
        digits = 0,
        big.mark = ".",
        decimal.mark = ","
      )
    ),
    paste0(
      "R$ ",
      formatC(
        sum(financiadores$Total, na.rm = TRUE),
        format = "f",
        digits = 2,
        big.mark = ".",
        decimal.mark = ","
      )
    ),
    paste0("R$ ", formatC(
      median(financiadores$Total, na.rm = TRUE),
      format = "f",
      digits = 0,
      big.mark = "."
    )),
    paste0("R$ ", formatC(
      min(financiadores$Total, na.rm = TRUE),
      format = "f",
      digits = 0,
      big.mark = "."
    )),
    paste0("R$ ",
           formatC(
             max(financiadores$Total, na.rm = TRUE),
             format = "f",
             digits = 0,
             big.mark = "."
           ))
  )
names(summ.table.financiadores) <-
  c("Editais financiados",
    "Total de financiamentos",
    "Mediana anual",
    "Menor",
    "Maior")

# plot 6 (summary table in plot)

# plot area setup
layout.m <-
  matrix(c(1, 1, 2, 2, 3, 3, 4, 5), ncol = 2, byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.financiadores
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-financiadores-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.financiadores, out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.4
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())


cat('<div align="center">')
plot.5
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-financiadores-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.financiadores, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-financiadores-1
knitr::include_graphics("index_files/figure-html/sintese-financiadores-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-producoes-cloud, include = FALSE, eval = has.sucupira.files}
# produções
sheet <- "Produções"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# delete duplicates based on ID da Produção
sucupira.raw <- sucupira.raw[!duplicated(sucupira.raw$`ID da Produção`),]

data.to.cloud <- sucupira.raw$`Nome da Produção`
cloud.title <- "Produção"
clean.text <- TRUE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
plot(wordcloud)
  
# filter produção bibliográfica
sucupira <- sucupira.raw[sucupira.raw$`Tipo de Produção` == "BIBLIOGRÁFICA",]
data.to.cloud <- sucupira$`Subtipo de Produção`
sheet <- "Produção bibliográfica"
cloud.title <- "Produção bibliográfica"
clean.text <- FALSE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
plot(wordcloud)

# filter produção bibliográfica
sucupira <- sucupira.raw[sucupira.raw$`Tipo de Produção` == "TÉCNICA",]
data.to.cloud <- sucupira$`Subtipo de Produção`
sheet <- "Produção técnica"
cloud.title <- "Produção técnica"
clean.text <- FALSE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
plot(wordcloud)
```

```{r sintese-producoes-cloud-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-producoes-cloud-1
knitr::include_graphics("index_files/figure-html/sintese-producoes-cloud-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-producoes-cloud-2
knitr::include_graphics("index_files/figure-html/sintese-producoes-cloud-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-producoes-cloud-3
knitr::include_graphics("index_files/figure-html/sintese-producoes-cloud-3.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-producao, include = FALSE, eval = has.sucupira.files}
# produção
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
produtos <- sucupira.list[as.character(anos)] %>%
  plyr::compact()
produtos <- data.frame(do.call(dplyr::bind_rows, produtos))
names(produtos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# remove duplicated ID rows
produtos <- produtos[!duplicated(produtos$`ID da Produção`), ]

# get years
produtos$'Ano' <- substr(as.Date(produtos$`Ano da Produção`, format = "%Y"), 1, 4)

# generate cross tables of artigos per year
table.1 <- table(produtos$`Tipo de Produção`, produtos$"Ano")
subtipos.1 <- unique(produtos$`Tipo de Produção`)

# plot 2 (total de produção bibliografica, por ano, por subtipo)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(subtipos.1), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.1, id.vars = "Subtipo", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Tipo", "Ano", "Frequência")

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Tipo,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Produção Total",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# select products
produtos.bib <- produtos[produtos$`Tipo de Produção` == "BIBLIOGRÁFICA", ]

# get years
produtos.bib$'Ano' <- substr(as.Date(produtos.bib$`Ano da Produção`, format = "%Y"), 1, 4)

# generate cross tables of artigos per year
table.2 <- table(produtos.bib$`Subtipo de Produção`, produtos.bib$"Ano")
subtipos.2 <- unique(produtos.bib$`Subtipo de Produção`)

# plot 2 (total de produção bilbiográfica, por ano, por subtipo)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(subtipos.2), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.2, id.vars = "Subtipo", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Subtipo", "Ano", "Frequência")

plot.2 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Subtipo,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Produção Bibliográfica",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# select products
produtos.tec <- produtos[produtos$`Tipo de Produção` == "TÉCNICA", ]

# get years
produtos.tec$'Ano' <- substr(as.Date(produtos.tec$`Ano da Produção`, format = "%Y"), 1, 4)

# generate cross tables of artigos per year
table.3 <- table(produtos.tec$`Subtipo de Produção`, produtos.tec$"Ano")
subtipos.3 <- unique(produtos.tec$`Subtipo de Produção`)

# plot 3 (total de produção técnica, por ano, por subtipo)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(subtipos.3), name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.3, id.vars = "Subtipo", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Subtipo", "Ano", "Frequência")

plot.3 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Subtipo,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Produção Técnica",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)
```

```{r sintese-producao-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-artigos, include = FALSE, eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira)}
# select products
metricas_artigos <- metricas_all[metricas_all$`Subtipo de Produção` == "ARTIGO EM PERIÓDICO", ]

# keep journal titles
metricas_artigos <- metricas_artigos[metricas_artigos$`Item de Detalhamento` == "ISSN / Título do periódico", ]

# remove duplicated ID rows
metricas_artigos <- metricas_artigos[!duplicated(metricas_artigos$`ID da Produção`), ]

# convert NA values in "Indefinida"
metricas_artigos$Qualis[is.na(metricas_artigos$Qualis)] <- "Indefinida"

# Qualis
estratos.capes <- c("A1", "A2", "A3", "A4", "B1", "B2", "B3", "B4", "B5", "C")
estratos <- sort(unique(na.omit(metricas_artigos$Qualis)))
qualis.PPG <- vector("numeric", length(estratos.capes))
for (i in 1:length(estratos.capes)) {
  qualis.PPG[i] <-
    sum(metricas_artigos$Qualis == estratos.capes[i], na.rm = TRUE) / length(metricas_artigos$Qualis) * 100
}
names(qualis.PPG) <- match(estratos.capes, estratos)
qualis.PPG <- table(metricas_artigos$Qualis)

# generate cross tables of artigos per year
table.1 <- table(metricas_artigos$"Ano da Produção")

table.2 <-
  matrix(0, ncol = length(unique(metricas_artigos$"Ano da Produção")), nrow = length(estratos))
colnames(table.2) <- sort(unique(metricas_artigos$"Ano da Produção"))
rownames(table.2) <- estratos

for (i in 1:length(metricas_artigos$Qualis)) {
    table.2[match(metricas_artigos$Qualis[i], rownames(table.2)), match(metricas_artigos$"Ano da Produção"[i], colnames(table.2))] <-
      table.2[match(metricas_artigos$Qualis[i], rownames(table.2)), match(metricas_artigos$"Ano da Produção"[i], colnames(table.2))] + 1
}
nb.cols <- length(rownames(table.2))

table.3 <- data.frame(metricas_artigos$"Ano da Produção", metricas_artigos$SJR)

table.4 <- data.frame(metricas_artigos$"Ano da Produção", metricas_artigos$CiteScore)

table.5 <- data.frame(metricas_artigos$`Valor do Item de Detalhamento`, metricas_artigos$SJR)

# plot 1 (total de produção bibliográfica, por estrato, por ano)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(estratos), name = "Blues")

# Reshape data for Plotly
data_long <- reshape2::melt(table.2, id.vars = "Estrato", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Estrato", "Ano", "Frequência")

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Estrato,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Métricas da Produção (Qualis)",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# plot 2 (violin plot of SJR por ano)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = 9, name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.3, id.vars = "metricas_artigos..Ano.da.Produção.", value.name = "SJR")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
data_long <- data_long[, -2]
colnames(data_long) <- c("Ano", "SJR")

plot.2 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~SJR,
  color = colors[1],
  type = 'box',
  colors = colors[1],
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Métricas da Produção (SJR)",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "SciMAGO Journal Rank (SJR)",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)


# plot 3 (violin plot of CiteScore por ano)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(estratos), name = "Blues")

# Reshape data for Plotly
data_long <- reshape2::melt(table.4, id.vars = "metricas_artigos..Ano.da.Produção.", value.name = "CiteScore")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
data_long <- data_long[, -2]
colnames(data_long) <- c("Ano", "CiteScore")

plot.3 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~CiteScore,
  color = colors[1],
  type = 'box',
  colors = colors[1],
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Métricas da Produção (CiteScore)",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "CiteScore",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)


journals.SJR <- unique(table.5)
# rename columns
colnames(journals.SJR) <- c("metricas_artigos.journal", "metricas_artigos.SJR")
top <- min((as.numeric(journals.SJR$SJR)), 10)
data.journals <-
  data.frame(
    name = journals.SJR$metricas_artigos.journal[order(as.numeric(journals.SJR$metricas_artigos.SJR), decreasing = TRUE)][1:top],
    value = as.numeric(sort(as.numeric(journals.SJR$metricas_artigos.SJR), decreasing = TRUE
             )[1:top])
    )
# break vector names in 2 lines
text.2.break <- data.journals$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.journals$name <- broken_text

# plot 4 (top-10 journals)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = top, name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(data.journals, value.name = "SJR")
data_long <- data_long[, -2]
colnames(data_long) <- c("Periódico", "SJR")
# set factor level for sorting
data_long$Periódico <- factor(data_long$Periódico, levels = data.journals$name)

plot.4 <- plotly::plot_ly(
  data = data_long,
  x = ~SJR,
  y = ~Periódico,
  color = colors[1],
  type = 'bar',
  colors = colors[1],
  height = 720
)

plot.4 <- plot.4 %>% plotly::layout(
  title = list(
    text = paste0("Top-", top, " Periódicos (SJR)"),
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = seq(0, top, 1)
  ),
  yaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    # reverse axis
    autorange = 'reversed'
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)


# plot 5 (summary table in plot)

# calculate summary statistics for producao
summ.table.producao <-
  cbind(
    sum(table.1, na.rm = FALSE),
    formatC(
      min(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      min(as.numeric(metricas_artigos$SJR), na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    formatC(
      median(as.numeric(metricas_artigos$SJR), na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    formatC(
      max(as.numeric(metricas_artigos$SJR), na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    # sum Estrato different than A or B
    paste0(
      formatC(
        100 - sum(table.2[na.omit(match(c("A1", "A2", "A3", "A4", "B1", "B2", "B3", "B4", "B5"), rownames(table.2))), ], na.rm = FALSE) / sum(table.2, na.rm = FALSE) * 100,
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    ),
    # sum Estrato B
    paste0(
      formatC(
        sum(table.2[na.omit(match(c("B1", "B2", "B3", "B4", "B5"), rownames(table.2))), ], na.rm = FALSE) / sum(table.2, na.rm = FALSE) * 100,
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    ),
    # sum Estrato A
    paste0(
      formatC(
        sum(table.2[na.omit(match(c("A1", "A2", "A3", "A4"), rownames(table.2))), ], na.rm = FALSE) / sum(table.2, na.rm = FALSE) * 100,
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    )
  )

names(summ.table.producao) <-
  c(
    "Artigos publicados",
    "Mínimo",
    "Mediana anual",
    "Máximo",
    "Menor",
    "Mediana SJR",
    "Maior",
    "Outros",
    "Estrato B",
    "Estrato A"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.producao
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-artigos-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira), out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.4
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-artigos-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira), out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-artigos-1
knitr::include_graphics("index_files/figure-html/sintese-artigos-1.png")
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-visibilidade, include = FALSE, eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira)}
# select products
metricas_artigos <- metricas_all[metricas_all$`Subtipo de Produção` == "ARTIGO EM PERIÓDICO", ]

# keep journal titles
metricas_artigos <- metricas_artigos[metricas_artigos$`Item de Detalhamento` == "ISSN / Título do periódico", ]

# remove duplicated ID rows
metricas_artigos <- metricas_artigos[!duplicated(metricas_artigos$`ID da Produção`), ]

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

table.1 <- data.frame(metricas_artigos$"Ano da Produção", metricas_artigos$altmetric_score)

# plot 1 (violin plot of Altmetric por ano)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = 9, name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.1, id.vars = "metricas_artigos..Ano.da.Produção.", value.name = "Altmetric")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
data_long <- data_long[, -2]
colnames(data_long) <- c("Ano", "Altmetric")

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Altmetric,
  color = colors[1],
  type = 'box',
  colors = colors[1],
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Atenção e Visibilidade (Altmetric)",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "Altmetric Score",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    type = "log"
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)

# plot 2 (IS_OA in plot)

# generate cross tables of IS_OA artigos per year
table.2 <-
  t(table(metricas_artigos$"Ano da Produção",
          as.logical(metricas_artigos$is_oa)))
table.2 <- table.2[order(rownames(table.2)), ]
rownames(table.2) <- c("Open access", "Paywall")
# swap lines
table.2 <- table.2[seq_len(nrow(table.2)) + c(1, -1),]

# Define the number of colors you want
nb.cols <- length(rownames(table.2))
mycolors <-
  colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = dim(table.2)[1], name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.2, id.vars = "Linhas de Pesquisa", variable.name = "Acesso", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Acesso", "Ano", "Frequência")

# convert absolute to relative frequency
data_long <- data_long %>%
  dplyr::group_by(Ano) %>%
  dplyr::mutate(Frequência = Frequência / sum(Frequência, na.rm = TRUE))

plot.2 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Acesso,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Acesso",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# plot 3 (CITATIONS in plot)

if (sjmisc::is_empty(metricas_artigos$citations)) {
  table.3 <- as.matrix(rep(0, length(max(anos) - min(anos) + 1)))
} else {
  # generate cross tables of citations per year
  table.3 <-
    t(table(metricas_artigos$"Ano da Produção",
            metricas_artigos$citations))
  table.3 <- table.3[order(rownames(table.3)),]
  table.3 <- colSums(table.3)
}

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
nb.cols <- length(table.3)
mycolors <- colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

# Reshape data for Plotly
data_long <- reshape2::melt(table.3, value.name = "Citações")
data_long$Ano <- as.numeric(names(table.3))
data_long <- data.frame(data_long, stringsAsFactors = FALSE)

colnames(data_long) <- c("Citações", "Ano")

plot.3 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Citações,
  color = colors[1],
  type = 'bar',
  colors = colors[1],
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Citações",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = FALSE
)


# plot 4 (summary table in plot)

# calculate summary statistics for visibilidade
summ.table.visibilidade <-
  cbind(
    sum(as.numeric(table.1[, 2]), na.rm = TRUE),
    formatC(
      min(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    sum(as.numeric(table.3), na.rm = TRUE),
    formatC(
      min(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    )
  )

names(summ.table.visibilidade) <-
  c(
    "Altmetric total",
    "Mínimo",
    "Mediana anual",
    "Máximo",
    "Citações totais",
    "Mínimo",
    "Mediana anual",
    "Máximo"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 3, 4, 5, 5, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.visibilidade
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-visibilidade-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira), out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-visibilidade-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira), out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-visibilidade-1
knitr::include_graphics("index_files/figure-html/sintese-visibilidade-1.png")
cat('\n\n')
source("Scripts/fonte-metricas.R", local = knitr::knit_global())
```

```{r sintese-pessoal-ies, include = FALSE, eval = has.discentes}
discentes.raw <-
  readxl::read_excel(
    "PPG/Discentes.xlsx",
    sheet = "Discentes",
    col_types = c("text")
  )
discentes.raw <- discentes.raw[discentes.raw$País == "Brasil",]
discentes.raw$'Data Matrícula' <-
  as.Date(discentes.raw$'Data Matrícula', format = "%d/%m/%Y")
discentes.raw$'Data Situação' <-
  as.Date(discentes.raw$'Data Situação', format = "%d/%m/%Y")
discentes.raw$'Ano Titulação' <-
  substr(as.Date(discentes.raw$'Data Situação', format = "%d/%m/%Y"), 1, 4)
# tempo de curso
discentes.raw$`Tempo de Curso (meses)` <-
  lubridate::interval(start = lubridate::ymd(gsub("-", "", discentes.raw$'Data Matrícula')), end = lubridate::ymd(gsub("-", "", discentes.raw$'Data Situação'))) %/% months(1)
discentes.raw %>%
  dplyr::mutate(`Tempo de Curso (meses)` = as.numeric(`Tempo de Curso (meses)`)) %>%
  dplyr::mutate(`Ano Titulação` = as.numeric(`Ano Titulação`))
discentes.raw$Curso[grepl("Mestrado", discentes.raw$Curso)] <- "Mestrado"
discentes.raw$Curso[grepl("Doutorado", discentes.raw$Curso)] <-"Doutorado"

discentes <- discentes.raw[is.na(discentes.raw$'Data Situação'), ]
discentes <- discentes[discentes$'Situação' != "Cancelado", ]
discentes <- discentes[discentes$'Situação' != "Desligado", ]
discentes <- discentes[!is.na(discentes$'Nome'), ]

egressos <- discentes.raw[!is.na(discentes.raw$'Data Situação'), ]
mestres <- egressos[grepl("mestrado", tolower(egressos$Curso)), ]
doutores <- egressos[grepl("doutorado", tolower(egressos$Curso)), ]

# identifying available courses
cursos <- levels(as.factor(c(discentes$Curso, egressos$Curso)))

# generate plot of egressos per year
table.1 <- table(egressos$Curso, egressos$`Ano Titulação`)

# generate plot of tempo para titulação per year
table.2.msc <-
  data.frame(mestres$`Ano Titulação`,
             as.numeric(mestres$`Tempo de Curso (meses)`))
table.2.dsc <-
  data.frame(doutores$`Ano Titulação`,
             as.numeric(doutores$`Tempo de Curso (meses)`))

# plot 1 (geospatial plot of candidates)
# reading BR geospatial data from IPEA
states$discentes <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(discentes$UF))
for (i in 1:length(UF$Var1)) {
  states$discentes[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

p1 <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = states, ggplot2::aes(fill = discentes), color = "grey") +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Discentes, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 20,
      color = "white",
      face = "bold"
    )
  ) +
  ggplot2::ggtitle("Distribuição Regional de Discentes")

data <-
  as.data.frame(table(c(discentes$UF[discentes$UF == "RJ"], rep(
    "Outras UF", length(discentes$UF[discentes$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot2::ggplot(data, ggplot2::aes(x = "", y = N, fill = Regiões)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

data <- as.data.frame(table(discentes$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot2::ggplot(data, ggplot2::aes(x = "", y = N, fill = Cursos)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

g <-
  gridExtra::arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g1 <- cowplot::ggdraw(g) +
  ggplot2::theme(plot.background = ggplot2::element_rect(fill = main.color, color = NA))

plot(g1)

# plot 2 (geospatial plot of egressos)
states$egressos <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(egressos$UF))
for (i in 1:length(UF$Var1)) {
  states$egressos[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

p1 <- ggplot2::ggplot() +
  ggplot2::geom_sf(
    data = states,
    ggplot2::aes(fill = egressos),
    color = "grey") +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Egressos, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 20,
      color = "white",
      face = "bold"
    )
  ) +
  ggplot2::ggtitle("Distribuição Regional de Egressos")

data <-
  as.data.frame(table(c(egressos$UF[egressos$UF == "RJ"], rep(
    "Outras UF", length(egressos$UF[egressos$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot2::ggplot(data, ggplot2::aes(x = "", y = N, fill = Regiões)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

data <- as.data.frame(table(egressos$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot2::ggplot(data, ggplot2::aes(x = "", y = N, fill = Cursos)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

g <-
  gridExtra::arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g2 <- cowplot::ggdraw(g) +
  ggplot2::theme(plot.background = ggplot2::element_rect(fill = main.color, color = NA))

plot(g2)
```

```{r sintese-pessoal-ies-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.discentes, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-pessoal-1
knitr::include_graphics("index_files/figure-html/sintese-pessoal-ies-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-pessoal-2
knitr::include_graphics("index_files/figure-html/sintese-pessoal-ies-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-pessoal, include = FALSE, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
periodo <- min(as.numeric(anos)):max(as.numeric(anos))

# discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

names(sucupira.list) <- as.character(anos)

# get number of discentes by year from sucupira.list
discentes <- data.frame(
  Ano = anos,
  Mestrado = rep(0, length(anos)),
  Doutorado = rep(0, length(anos)),
  stringsAsFactors = FALSE
)
for (i in 1:length(anos)){
  sucupira.list[[i]]$`Nível Discente`[grepl("Mestrado", discentes$`Nível Discente`)] <- "Mestrado"
  sucupira.list[[i]]$`Nível Discente`[grepl("Doutorado", discentes$`Nível Discente`)] <- "Doutorado"

  discentes$Mestrado[i] <- sum(sucupira.list[[i]]$`Nível Discente` == "Mestrado")
  discentes$Doutorado[i] <- sum(sucupira.list[[i]]$`Nível Discente` == "Doutorado")
}

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# Reshape data for Plotly
data_long <- reshape2::melt(discentes, id.vars = "Ano", variable.name = "Nível", value.name = "Frequência")

# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(data_long$Nível)), name = "Set3")

data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Ano", "Nível", "Frequência")

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Nível,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Discentes",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# get number of discentes by year from sucupira.list
situacao <- data.frame(
  Ano = anos,
  Matriculado = rep(0, length(anos)),
  Titulado = rep(0, length(anos)),
  Desligado = rep(0, length(anos)),
  Abandonou = rep(0, length(anos)),
  'Mudança com defesa' = rep(0, length(anos)),
  'Mudança sem defesa' = rep(0, length(anos)),
  check.names = FALSE
)
for (i in 1:length(anos)){
  # drop nível Bacharelado
  sucupira.list[[i]] <- sucupira.list[[i]][!grepl("Bacharelado", sucupira.list[[i]]$`Nível Discente`),]

  situacao$Matriculado[i] <- sum(sucupira.list[[i]]$Situação == "MATRICULADO")
  situacao$Titulado[i] <- sum(sucupira.list[[i]]$Situação == "TITULADO")
  situacao$Desligado[i] <- sum(sucupira.list[[i]]$Situação == "DESLIGADO")
  situacao$Abandonou[i] <- sum(sucupira.list[[i]]$Situação == "ABANDONOU")
  situacao$"Mudança com defesa"[i] <- sum(sucupira.list[[i]]$Situação == "MUDANCA DE NÍVEL COM DEFESA")
  situacao$"Mudança sem defesa"[i] <- sum(sucupira.list[[i]]$Situação == "MUDANCA DE NÍVEL SEM DEFESA")
}

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# Reshape data for Plotly
data_long <- reshape2::melt(situacao, id.vars = "Ano", variable.name = "Situação", value.name = "Frequência")

# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = length(unique(data_long$Situação)), name = "Set3")

data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Ano", "Situação", "Frequência")

plot.2 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Situação,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.2 <- plot.2 %>% plotly::layout(
  title = list(
    text = "Discentes",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)

# Discentes - Orientadores
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

names(sucupira.list) <- as.character(anos)

# get egressos for the current period
egressos <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
egressos <- data.frame(do.call(dplyr::bind_rows, egressos))
names(egressos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# dplyr::select former students
egressos <- egressos[egressos$`Situação Discente` == "TITULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
egressos <- egressos[egressos$`Orientador Principal?` == "Sim", ]

# tempo de curso
egressos$`Tempo de Curso (meses)` <-
  lubridate::interval(start = lubridate::dmy(gsub("-", "", egressos$`Data Matrícula`)), end = lubridate::dmy(gsub("-", "", egressos$`Data Situação`))) %/% months(1)
egressos %>%
  dplyr::mutate(`Tempo de Curso (meses)` = as.numeric(`Tempo de Curso (meses)`))
egressos$`Nível Discente`[grepl("Mestrado", egressos$`Nível Discente`)] <- "Mestrado"
egressos$`Nível Discente`[grepl("Doutorado", egressos$`Nível Discente`)] <-"Doutorado"

# get years
egressos$'Ano' <- substr(as.Date(egressos$`Data Situação`, format = "%d/%m/%Y"), 1, 4)

# drop columns
egressos <- egressos %>% dplyr::select("Nível Discente", "Ano", "Nome do Orientador", "Nome Discente", "Tempo de Curso (meses)")

# remove duplicates
egressos <- unique(egressos)
colnames(egressos)[which(names(egressos) == "Nome Discente")] <- "Nome"

# generate table of egressos per year
table.1 <- table(egressos$`Nível Discente`, egressos$`Ano`)

# generate table of mestres per year
mestres <- egressos[egressos$`Nível Discente` == "Mestrado", ]
table.2 <- table(mestres$`Ano`)

# generate table of doutores per year
doutores <- egressos[egressos$`Nível Discente` == "Doutorado", ]
table.3 <- table(doutores$`Ano`)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = dim(table.1)[1], name = "Set3")

# Reshape data for Plotly
data_long <- reshape2::melt(table.1, id.vars = "Nível Discente", variable.name = "Ano", value.name = "Frequência")
data_long <- data.frame(data_long, stringsAsFactors = FALSE)
colnames(data_long) <- c("Nível", "Ano", "Frequência")

plot.3 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~Frequência,
  color = ~Nível,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.3 <- plot.3 %>% plotly::layout(
  title = list(
    text = "Egressos",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white')
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# plot 4 (violin plot of Tempo de Curso por ano)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = dim(table.1)[1], name = "Set3")

# generate table of tempo de curso per year
table.2 <- egressos %>%
  dplyr::group_by(`Nível Discente`, `Ano`)

# Reshape data for Plotly
data_long <- dplyr::select(table.2, `Nível Discente`, `Ano`, `Tempo de Curso (meses)`)

plot.4 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~`Tempo de Curso (meses)`,
  color = ~`Nível Discente`,
  type = 'box',
  colors = colors,
  height = 720
)

plot.4 <- plot.4 %>% plotly::layout(
  title = list(
    text = "Tempo de Curso",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos
  ),
  yaxis = list(
    title = "Meses",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    type = "log"
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE
)

# plot 5(summary table in plot)

# calculate summary statistics for pessoal
summ.table.pessoal <-
  cbind(
    dim(egressos)[1],
    formatC(
      sum(egressos$`Nível Discente` == "Mestrado", na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      sum(egressos$`Nível Discente` == "Doutorado", na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(
        egressos$`Tempo de Curso (meses)`[egressos$`Nível Discente` == "Mestrado"],
        na.rm = TRUE
      ),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(
        egressos$`Tempo de Curso (meses)`[egressos$`Nível Discente` == "Doutorado"],
        na.rm = TRUE
      ),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    sum(discentes$Mestrado[discentes$Ano == max(discentes$Ano)] + discentes$Doutorado[discentes$Ano == max(discentes$Ano)]),
    sum(discentes$Mestrado[discentes$Ano == max(discentes$Ano)]),
    sum(discentes$Doutorado[discentes$Ano == max(discentes$Ano)])
  )

names(summ.table.pessoal) <-
  c(
    "Egressos",
    "Mestres",
    "Doutores",
    "Meses",
    "Meses",
    "Candidatos",
    "Mestrandos",
    "Doutorandos"
  )

# plot area setup
layout.m <- matrix(c(1, 2, 3, 1, 4, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.pessoal
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-pessoal-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.2
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.4
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-pessoal-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-pessoal-1
knitr::include_graphics("index_files/figure-html/sintese-pessoal-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-posdoc, include = FALSE, eval = all(has.sucupira.files, has.posdoc)}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
periodo <- min(as.numeric(anos)):max(as.numeric(anos))

# posdocs
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get table of posdocs per ano in list
posdoc.raw <- sucupira.raw %>%
  plyr::compact()

posdoc.list <- sucupira.list
names(posdoc.list) <- as.character(anos)

# frequency table of posdocs per year (list element)
posdoc <- data.frame(
  Ano = rep(NA, length(posdoc.list)),
  Frequência = rep(NA, length(posdoc.list))
)
posdoc$Ano <- anos
posdoc$Frequência <- lapply(posdoc.list, function(x) {
  dim(x)[1]
})
# repeate Ano based on each Frequência
posdocs.long <- c()
for (i in 1:nrow(posdoc)){
  if(posdoc$Frequência[i] == 0){
    posdocs.long <- rbind(
      posdocs.long,
      data.frame(
        Ano = rep(posdoc$Ano[i], 1),
        Nacionalidade = NA
      )
    )
  }
  posdocs.long <- rbind(
    posdocs.long,
    data.frame(
      Ano = rep(posdoc$Ano[i], posdoc$Frequência[i]),
      Nacionalidade = posdoc.list[[as.character(posdoc$Ano[i])]]$Nacionalidade
    )
  )
}
# drop rows with NA
posdocs.long <- posdocs.long[!is.na(posdocs.long$Nacionalidade), ]

posdocs.atuais <- posdoc.raw[is.na(posdoc.raw$`Vínculo Fim`), ]
posdocs.atuais <- posdocs.atuais[!is.na(posdocs.atuais$`Pós-Doc Nome`), ]
posdocs.atuais <- posdocs.atuais[!duplicated(posdocs.atuais), ]

# generate plot of posdocs per year
table.1 <- posdocs.long %>%
  dplyr::group_by(Ano, Nacionalidade) %>%
  dplyr::summarise(Frequência = n())

# plot 1 (posdocs titulados)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())
# Define colors using RColorBrewer
colors <- RColorBrewer::brewer.pal(n = dim(table.1)[1], name = "Set3")

# summary table
data_long <- table.1

plot.1 <- plotly::plot_ly(
  data = data_long,
  x = ~Ano,
  y = ~`Frequência`,
  color = ~`Nacionalidade`,
  type = 'bar',
  colors = colors,
  height = 720
)

plot.1 <- plot.1 %>% plotly::layout(
  title = list(
    text = "Estágio Pós-Doutoral",
    x = 0.5,
    xanchor = 'center',
    font = list(size = 24, color = 'white')
  ),
  xaxis = list(
    title = "",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = anos,
    range = anos
  ),
  yaxis = list(
    title = "N",
    titlefont = list(color = 'white'),
    tickfont = list(color = 'white'),
    tickvals = seq(0, max(data_long$Frequência), by = 1)
  ),
  legend = list(
    title = 'Legenda',
    titlefont = list(color = 'white'),
    font = list(color = 'white'),
    bgcolor = 'black',
    bordercolor = 'white',
    borderwidth = 1,
    orientation = 'h',
    xanchor = 'center',
    x = 0.5
  ),
  plot_bgcolor = 'black',
  paper_bgcolor = 'black',
  font = list(color = 'white'),
  margin = list(l = 60, r = 60, t = 60, b = 60),
  showlegend = TRUE,
  barmode = 'stack'
)


# frequency table of posdocs per country (list element)
# repeate Ano based on each Frequência
posdocs.pais.long <- c()
for (i in 1:nrow(posdoc)){
  if(posdoc$Frequência[i] == 0){
    posdocs.pais.long <- rbind(
      posdocs.pais.long,
      data.frame(
        Ano = rep(posdoc$Ano[i], 1),
        País = NA
      )
    )
  }
  posdocs.pais.long <- rbind(
    posdocs.pais.long,
    data.frame(
      Ano = rep(posdoc$Ano[i], posdoc$Frequência[i]),
      País = posdoc.list[[as.character(posdoc$Ano[i])]]$País
    )
  )
}
# drop rows with NA
posdocs.pais.long <- posdocs.pais.long[!is.na(posdocs.pais.long$País), ]


# plot 2 (geospatial plot of posdocs)
paises <- as.data.frame(table(posdocs.pais.long$País))
source("Scripts/worldmap.R", local = knitr::knit_global())

ggplot2::ggplot() +
  ggplot2::geom_polygon(data = worldmap, ggplot2::aes(
    x = long,
    y = lat,
    group = group,
    fill = Freq
  )) +
  cowplot::theme_map() +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Pesquisadores, n",
    limits = c(min(0, paises$Freq), max(paises$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white"),
    axis.title.x = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank()
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color, color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color, color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    panel.grid.minor = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 15,
      color = "white",
      face = "bold",
      hjust = 0.5
    )
  ) +
  ggplot2::ggtitle("Distribuição Global de Pós-Docs")

# plot 3 (summary table in plot)

# calculate summary statistics for posdocs
IDs <- unique(posdoc.raw$`Identificador do Pós-Doc`)
total <- length(IDs)

concluidos <- 0
for (i in IDs){
  posdoc.data <- posdoc.raw[posdoc.raw$`Identificador do Pós-Doc` == i, ]
  if(any(!is.na(posdoc.data$`Vínculo Fim`))){
    concluidos <- concluidos + 1
  }
}
brasileiros.concluidos <- 0
for(i in IDs){
  posdoc.data <- posdoc.raw[posdoc.raw$`Identificador do Pós-Doc` == i, ]
  if(any(!is.na(posdoc.data$`Vínculo Fim`) & posdoc.data$País == "Brasil")){
    brasileiros.concluidos <- brasileiros.concluidos + 1
  }
}
estrangeiros.concluidos <- 0
for(i in IDs){
  posdoc.data <- posdoc.raw[posdoc.raw$`Identificador do Pós-Doc` == i, ]
  if(any(!is.na(posdoc.data$`Vínculo Fim`) & posdoc.data$País != "Brasil")){
    estrangeiros.concluidos <- estrangeiros.concluidos + 1
  }
}

em.andamento <- sum(is.na(posdoc.list[[as.character(max(as.numeric(names(posdoc.list))))]]$`Vínculo Fim`))
brasileiros.em.andamento <- sum(
  is.na(posdoc.list[[as.character(max(as.numeric(names(posdoc.list))))]]$`Vínculo Fim`) &
  posdoc.list[[as.character(max(as.numeric(names(posdoc.list))))]]$País == "Brasil"
)
estrangeiros.em.andamento <- sum(
  is.na(posdoc.list[[as.character(max(as.numeric(names(posdoc.list))))]]$`Vínculo Fim`) &
  posdoc.list[[as.character(max(as.numeric(names(posdoc.list))))]]$País != "Brasil"
)

summ.table.posdoc <-
  c(
    total,
    concluidos,
    brasileiros.concluidos,
    estrangeiros.concluidos,
    em.andamento,
    brasileiros.em.andamento,
    estrangeiros.em.andamento
  )

names(summ.table.posdoc) <-
  c("Pós-Docs total",
    "Concluídos",
    "Brasileiro",
    "Estrangeiro",
    "Em andamento",
    "Brasileiro",
    "Estrangeiro"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 3, 4, 5, 6, 7), ncol = 3, byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.posdoc
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-posdoc-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = and(has.sucupira.files, has.posdoc), out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.1
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-posdoc-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = and(has.sucupira.files, has.posdoc), out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-posdoc-1
knitr::include_graphics("index_files/figure-html/sintese-posdoc-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-posdoc-2
knitr::include_graphics("index_files/figure-html/sintese-posdoc-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-rede, include = FALSE, eval = has.sucupira.files}
# projetos
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# create edge matrix
proj.id <-
  as.factor(sucupira.raw$`Identificador do Projeto de Pesquisa`)
n.proj <- nlevels(proj.id)
membros <- sort(unique(sucupira.raw$`Nome do Membro do Projeto`))
n.membros <- length(membros)
categ <- as.factor(sucupira.raw$`Categoria do Membro do Projeto`)
n.categ <- nlevels(categ)
edge.matrix <- matrix(NA, nrow = 0, ncol = 2)
colnames(edge.matrix) <- c("from", "to")

# loop across all projects to populate the edge matrix
for (i in 1:n.proj) {
  # get the members by project id
  membros.proj <-
    unique(sucupira.raw$`Nome do Membro do Projeto`[proj.id == levels(proj.id)[i]])
  # only vote for upper diagonal elements
  for (n in 1:length(membros.proj)) {
    for (m in n:length(membros.proj)) {
      if (n != m) {
        # find members
        row.n <- match(membros.proj[n], membros)
        col.m <- match(membros.proj[m], membros)
        new.edge <- cbind(membros[row.n], membros[col.m])
        # add edges
        edge.matrix <- rbind(edge.matrix, new.edge)
      }
    }
  }
}

# complete cases only
edge.matrix <- edge.matrix[complete.cases(edge.matrix), ]

# build the graph object
network <- igraph::graph_from_edgelist(edge.matrix, directed = FALSE)

# set member category and color
colrs <- RColorBrewer::brewer.pal(n = n.categ, name = "Set3")
for (i in 1:length(igraph::V(network))) {
  categ.id <-
    match(igraph::V(network)[[i]]$name, sucupira.raw$`Nome do Membro do Projeto`)
  igraph::V(network)[[i]]$categ <-
    sucupira.raw$`Categoria do Membro do Projeto`[categ.id]
  col.id <- match(igraph::V(network)[[i]]$categ, levels(categ))
  igraph::V(network)[i]$color <- colrs[col.id]
}

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot 1
plot(
  network,
  directed = FALSE,
  arrow.mode = 0,
  vertex.label = NA,
  vertex.frame.color = "darkgrey",
  vertex.size = log(igraph::degree(network, mode = "all")) * 1.2,
  edge.color = "lightgrey",
  edge.lty = "solid",
  edge.size = igraph::edge.betweenness(network),
  edge.curved = .2
)
legend(
  "bottomleft",
  legend = levels(categ),
  pch = 19,
  col = colrs,
  text.col = "white",
  bty = "n",
  horiz = FALSE,
  cex = 0.8
)
title(main = "Membros de Projetos de Pesquisa",
      outer = TRUE,
      cex.main = 1.7)

# plot 2

# IES participantes externos
sheet <- "Participante Externo"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
sucupira.raw <- sucupira.raw[!duplicated(sucupira.raw),]
IES <- sucupira.raw$`Instituição de Origem`
IES <- IES[!is.na(IES)]
países <- sucupira.raw$`País da Instituição de Origem`
países <- países[!is.na(países)]
mundo <- sucupira.raw$`País da Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` != "Brasil"]
mundo <- mundo[!is.na(mundo)]

part.ext.nac <- sucupira.raw$`Nome do Participante`[sucupira.raw$`País da Instituição de Origem` == "Brasil"]
part.ext.nac <- part.ext.nac[!is.na(part.ext.nac)]
part.ext.inter <- sucupira.raw$`Nome do Participante`[sucupira.raw$`País da Instituição de Origem` != "Brasil"]
part.ext.inter <- part.ext.inter[!is.na(part.ext.inter)]
IES.nac <- sucupira.raw$`Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` == "Brasil"]
IES.nac <- IES.nac[!is.na(IES.nac)]
IES.inter <- sucupira.raw$`Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` != "Brasil"]
IES.inter <- IES.inter[!is.na(IES.inter)]

# get initials
data.to.abbrev <- IES
abbrev <- abbreviate(data.to.abbrev)

ranked.ies <- c()
for (i in 1:length(sort(table(abbrev), decreasing = FALSE))) {
  ranked.ies <-
    c(ranked.ies, rep(names(sort(table(
      abbrev
    ))[i]), match(sort(table(
      abbrev
    ))[i][[1]], unique(sort(
      table(abbrev)
    )))))
}
data.to.cloud <- ranked.ies
cloud.title <- "Instituições"
clean.text <- TRUE
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
# show the wordcloud
plot(wordcloud)

# plot 3

# check if there are IES
if (length(IES.nac) > 0) {
  top <- min(length(IES.nac), 10)
  data.nac <-
    na.omit(data.frame(name = names(sort(
      table(IES.nac), decreasing = TRUE
    )[1:top]), value = as.numeric(sort(
      table(IES.nac), decreasing = TRUE
    )[1:top])))
  
  # break vector names in 2 lines
  text.2.break <- data.nac$name
  source("Scripts/line-2-break.R", local = knitr::knit_global())
  data.nac$name <- broken_text
  
  # plot area setup
  layout.m <- c(1)
  source("Scripts/plot-margins.R", local = knitr::knit_global())
  # Define colors using RColorBrewer
  colors <- RColorBrewer::brewer.pal(n = top, name = "Set3")
  
  # set factor level for sorting
  data.nac$name <- factor(data.nac$name, levels = data.nac$name)

  plot.3 <- plotly::plot_ly(
    data = data.nac,
    x = ~value,
    y = ~name,
    color = colors[1],
    type = 'bar',
    colors = colors[1],
    height = 720
  )
  
  plot.3 <- plot.3 %>% plotly::layout(
    title = list(
      text = paste0("Top-", top, " Nacionais"),
      x = 0.5,
      xanchor = 'center',
      font = list(size = 24, color = 'white')
    ),
    xaxis = list(
      title = "N",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      tickvals = seq(0, max(data.nac$value), by = 1)
    ),
    yaxis = list(
      title = "",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      # reverse axis
      autorange = 'reversed'
    ),
    plot_bgcolor = 'black',
    paper_bgcolor = 'black',
    font = list(color = 'white'),
    margin = list(l = 60, r = 60, t = 60, b = 60),
    showlegend = FALSE
  )
}

# plot 4

# check if there are IES
if (length(IES.inter) > 0) {
  top <- min(length(IES.inter), 10)
  data.inter <-
    na.omit(data.frame(name = names(sort(
      table(IES.inter), decreasing = TRUE
    )[1:top]), value = as.numeric(sort(
      table(IES.inter), decreasing = TRUE
    )[1:top])))
  
  # break vector names in 2 lines
  text.2.break <- data.inter$name
  source("Scripts/line-2-break.R", local = knitr::knit_global())
  data.inter$name <- broken_text
  
  # plot area setup
  layout.m <- c(1)
  source("Scripts/plot-margins.R", local = knitr::knit_global())
  # Define colors using RColorBrewer
  colors <- RColorBrewer::brewer.pal(n = top, name = "Set3")
  
  # set factor level for sorting
  data.inter$name <- factor(data.inter$name, levels = data.inter$name)

  plot.4 <- plotly::plot_ly(
    data = data.inter,
    x = ~value,
    y = ~name,
    color = colors[1],
    type = 'bar',
    colors = colors[1],
    height = 720
  )
  
  plot.4 <- plot.4 %>% plotly::layout(
    title = list(
      text = paste0("Top-", top, " Internacionais"),
      x = 0.5,
      xanchor = 'center',
      font = list(size = 24, color = 'white')
    ),
    xaxis = list(
      title = "N",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      tickvals = seq(0, max(data.inter$value), by = 1)
    ),
    yaxis = list(
      title = "",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      # reverse axis
      autorange = 'reversed'
    ),
    plot_bgcolor = 'black',
    paper_bgcolor = 'black',
    font = list(color = 'white'),
    margin = list(l = 60, r = 60, t = 60, b = 60),
    showlegend = FALSE
  )
}

# plot 5

# check if there are mundo
if (length(mundo) > 0) {
  top <- min(length(mundo), 10)
  data.pais <-
    na.omit(data.frame(name = names(sort(
      table(mundo), decreasing = TRUE
    )[1:top]), value = as.numeric(sort(
      table(mundo), decreasing = TRUE
    )[1:top])))
  
  # break vector names in 2 lines
  text.2.break <- data.pais$name
  source("Scripts/line-2-break.R", local = knitr::knit_global())
  data.pais$name <- broken_text
  
  # set factor level for sorting
  data.pais$name <- factor(data.pais$name, levels = data.pais$name)

  plot.5 <- plotly::plot_ly(
    data = data.pais,
    x = ~value,
    y = ~name,
    color = colors[1],
    type = 'bar',
    colors = colors[1],
    height = 720
  )
  
  plot.5 <- plot.5 %>% plotly::layout(
    title = list(
      text = paste0("Top-", top, " Países"),
      x = 0.5,
      xanchor = 'center',
      font = list(size = 24, color = 'white')
    ),
    xaxis = list(
      title = "N",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      tickvals = seq(0, max(data.pais$value), by = 1)
    ),
    yaxis = list(
      title = "",
      titlefont = list(color = 'white'),
      tickfont = list(color = 'white'),
      # reverse axis
      autorange = 'reversed'
    ),
    plot_bgcolor = 'black',
    paper_bgcolor = 'black',
    font = list(color = 'white'),
    margin = list(l = 60, r = 60, t = 60, b = 60),
    showlegend = FALSE
  )
}
  
# check if there are mundo
if (length(mundo) > 0) {
  # plot 6 (geospatial plot of participantes externos)
  paises <- as.data.frame(table(as.character(mundo)))
  source("Scripts/worldmap.R", local = knitr::knit_global())
  
  ggplot2::ggplot() +
    ggplot2::geom_polygon(data = worldmap, ggplot2::aes(
      x = long,
      y = lat,
      group = group,
      fill = Freq
    )) +
    cowplot::theme_map() +
    ggplot2::scale_fill_distiller(
      palette = "Spectral",
      name = "Pesquisadores, n",
      limits = c(min(0, paises$Freq), max(paises$Freq)),
      na.value = "grey"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      legend.position = 'bottom',
      legend.title = ggplot2::element_text(color = "white"),
      legend.text = ggplot2::element_text(color = "white"),
      axis.title.x = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_blank(),
      axis.ticks.x = ggplot2::element_blank(),
      axis.title.y = ggplot2::element_blank(),
      axis.text.y = ggplot2::element_blank(),
      axis.ticks.y = ggplot2::element_blank()
    ) +
    ggplot2::theme(
      plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
      panel.background = ggplot2::element_rect(fill = main.color, color = main.color),
      plot.background = ggplot2::element_rect(fill = main.color, color = main.color),
      panel.grid.major = ggplot2::element_line(color = "transparent"),
      panel.grid.minor = ggplot2::element_line(color = "transparent"),
      axis.text.x = ggplot2::element_blank(),
      axis.text.y = ggplot2::element_blank(),
      plot.title = ggplot2::element_text(
        size = 15,
        color = "white",
        face = "bold",
        hjust = 0.5
      )
    ) +
    ggplot2::ggtitle("Distribuição Global de Participantes Externos")
} else {
  # plot empty plot
  plot.new()
  title(main = "Distribuição global de Participantes Externos",
        outer = TRUE,
        cex.main = 1.7)
}

# plot 7 (summary table in plot)

# calculate summary statistics for IES
summ.table.ies <-
  c(
    length(unique(IES.nac)) + length(unique(IES.inter)),
    length(unique(IES.nac)),
    length(unique(IES.inter)),
    length(unique(part.ext.nac)) + length(unique(part.ext.inter)),
    length(unique(part.ext.nac)),
    length(unique(part.ext.inter))
  )

names(summ.table.ies) <-
  c(
    "Instituições colaboradoras",
    "Nacionais",
    "Internacionais",
    "Participantes externos",
    "Nacionais",
    "Internacionais"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 2, 3, 4, 4, 5, 6),
                   ncol = 2,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.ies
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-rede-carousel-1, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "100%"}
cat('<br>')
cat('<br>')

cat('<div align="center">')
plot.3
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.4
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

cat('<div align="center">')
plot.5
cat('</div>')
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

```{r sintese-rede-carousel-2, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = 'asis', eval = has.sucupira.files, out.width = "70%"}
cat('<br>')
cat('<br>')

# show sintese-rede-1
knitr::include_graphics("index_files/figure-html/sintese-rede-1.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-rede-2
knitr::include_graphics("index_files/figure-html/sintese-rede-2.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())

# show sintese-rede-3
knitr::include_graphics("index_files/figure-html/sintese-rede-3.png")
cat('\n\n')
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>
