---
title: OBSERVATÓRIO
output:
  html_document:
    toc: false
    css:
      - ./CSS/index.css
      - ./CSS/main-color.css
      - ./CSS/responsive.css
---

<!--install and/or load all R packages-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = "asis",
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = "html",
  webshot = "webshot",
  dev = "png"
)
source("Scripts/all-required-packages.R", local = knitr::knit_global())
```

---
title: "OBSERVATÓRIO `r ifelse(and(has.dados.cadastrais, has.sucupira.files), sigla.PPG, "")`"
---

<br>

<br>

<center>

```{r logo-ies}
if(file.exists("PPG/Images/logo-programa.png")) {
  cat('<img src=\"PPG/Images/logo-programa.png\" align=\"center\"/>')
}
```

<br>

<p style="font-size:1.5em">
```{r intro, results = "asis"}
if(and(has.dados.cadastrais, has.sucupira.files)){
cat(
  'O **Observatório ', toupper(as.character(sigla.PPG)),
  '** é uma iniciativa do **Programa de Pós-graduação em ', as.character(nome.PPG), '** - [', tools::toTitleCase(as.character(nome.IES)), '](', as.character(site.PPG),') ',
  'que envolve o registro, o acompanhamento e a análise agregada e estruturada de dados para divulgação transparente de suas atividades, planejamentos, ações e impactos, tornando-os acessíveis à sociedade',
   sep = "")
} else {
cat(
  'O **Observatório** é uma iniciativa que envolve o registro, o acompanhamento e a análise agregada e estruturada de dados para divulgação transparente de suas atividades, planejamentos, ações e impactos, tornando-os acessíveis à sociedade',
   sep = "")
}
```
</p>

</center>

<br>

<br>

```{r sintese-coerencia, include = FALSE, eval = has.sucupira.files}
# projetos
sheet <- "Linhas de Pesquisa - Projetos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# remove duplicated lines across years
sucupira.raw <- unique(sucupira.raw)

# remove duplicated projects ("EM ANDAMENTO" vs. "CONCLUÍDO" -> keep "CONCLUÍDO")
projetos.id <- unique(sucupira.raw$`Identificador do Projeto`)
sucupira <- c()
for (i in 1:length(projetos.id)) {
  matches <-
    sucupira.raw[sucupira.raw$`Identificador do Projeto` == projetos.id[i], ]
  if (dim(matches)[1] == 1) {
    sucupira <- dplyr::bind_rows(sucupira, matches)
  } else {
    keep <-
      matches[matches$Situação == "CONCLUÍDO" |
                !is.na(matches$`Data de Fim da Linha`), ]
    sucupira <- dplyr::bind_rows(sucupira, keep)
  }
}

# update base data
sucupira.raw <- sucupira

# structure the alluvial plot
alluv.data <-
  data.frame(
    sucupira.raw$`Área de Concentração`,
    sucupira.raw$`Linha de Pesquisa`,
    sucupira.raw$`Nome do Projeto de Pesquisa`,
    sucupira.raw$`Data de Início da Linha`,
    sucupira.raw$`Data de Fim da Linha`
  )

# replace full date by year only
alluv.data$sucupira.raw..Data.de.Início.da.Linha. <-
  format(as.Date(
    alluv.data$sucupira.raw..Data.de.Início.da.Linha.,
    "%d/%m/%Y"
  ),
  format = "%Y")
alluv.data$sucupira.raw..Data.de.Fim.da.Linha. <-
  format(as.Date(alluv.data$sucupira.raw..Data.de.Fim.da.Linha., "%d/%m/%Y"),
         format = "%Y")

# replace NA values by current year
alluv.data$sucupira.raw..Data.de.Fim.da.Linha.[is.na(alluv.data$sucupira.raw..Data.de.Fim.da.Linha.)] <-
  format(Sys.Date(), format = "%Y")

# remove data without AC or LP
alluv.data <-
  alluv.data[!is.na(alluv.data$sucupira.raw..Área.de.Concentração.) &
               !is.na(alluv.data$sucupira.raw..Linha.de.Pesquisa.), ]

# ordering by dates
alluv.data <-
  alluv.data[order(
    alluv.data$sucupira.raw..Data.de.Início.,
    alluv.data$sucupira.raw..Data.de.Fim.da.Linha.,
    alluv.data$sucupira.raw..Nome.do.Projeto.de.Pesquisa.,
    decreasing = FALSE
  ),]

# summary data for plot table
current.AC <-
  unique(alluv.data$sucupira.raw..Área.de.Concentração.[alluv.data$sucupira.raw..Data.de.Fim.da.Linha. == format(Sys.Date(), format = "%Y")])

old.AC <-
  unique(alluv.data$sucupira.raw..Área.de.Concentração.[alluv.data$sucupira.raw..Data.de.Fim.da.Linha. == format(Sys.Date(), format = "%Y")])
old.AC <- old.AC[!old.AC %in% c(current.AC, NA)]

old.LP <-
  unique(alluv.data$sucupira.raw..Linha.de.Pesquisa.[alluv.data$sucupira.raw..Data.de.Fim.da.Linha. != format(Sys.Date(), format = "%Y")])

current.LP <-
  unique(alluv.data$sucupira.raw..Linha.de.Pesquisa.)
current.LP <- current.LP[!current.LP %in% c(old.LP, NA)]

# remove data from inactive LP
if (length(old.LP) != 0) {
  alluv.data <-
    alluv.data[!(alluv.data$sucupira.raw..Linha.de.Pesquisa. == old.LP),]
  # alluv.data <-
  #   alluv.data[!(
  #     alluv.data$sucupira.raw..Data.de.Fim.da.Linha. == format(Sys.Date(), format = "%Y")
  #   ), ]
}

summ.AC.LP <-
  as.data.frame(
    table(
      alluv.data$sucupira.raw..Área.de.Concentração.,
      alluv.data$sucupira.raw..Linha.de.Pesquisa.,
      alluv.data$sucupira.raw..Data.de.Início.da.Linha.,
      alluv.data$sucupira.raw..Data.de.Fim.da.Linha.
    )
  )

# drop freq = 0 values
summ.AC.LP <- summ.AC.LP[summ.AC.LP$Freq != 0, ]

colnames(summ.AC.LP) <- c("AC", "LP", "Inicio", "Fim", "Freq")

# insert data from later LP
extra <- c()
for (i in 1:dim(summ.AC.LP)[1]) {
  if (as.character(summ.AC.LP$Inicio[i]) > min(as.character(summ.AC.LP$Inicio))) {
    extra <-
      rbind(extra,
            c(
              as.character(summ.AC.LP$AC[i]),
              as.character(summ.AC.LP$LP[i]),
              min(as.character(summ.AC.LP$Inicio)),
              as.character(summ.AC.LP$Inicio[i]),
              as.character(summ.AC.LP$Freq[i])
            ))
  }
}
extra <- as.data.frame(extra)
try(colnames(extra) <- c("AC", "LP", "Inicio", "Fim", "Freq"), silent = TRUE)

summ.AC.LP <- rbind(summ.AC.LP, extra)

# code PP names for display
alluv.data$sucupira.raw..Nome.do.Projeto.de.Pesquisa. <-
  as.numeric(as.factor(alluv.data$sucupira.raw..Nome.do.Projeto.de.Pesquisa.))

# drop names columns
summ.AC.LP <- summ.AC.LP[, -(1:2)]

# rename cols
colnames(summ.AC.LP) <- c("source", "target", "value")

summ.LP.PP <-
  as.data.frame(
    table(
      alluv.data$sucupira.raw..Linha.de.Pesquisa.,
      alluv.data$sucupira.raw..Nome.do.Projeto.de.Pesquisa.
    )
  )
colnames(summ.LP.PP) <- c("source", "target", "value")

# count projects only once
summ.LP.PP$value[summ.LP.PP$value != 0] <- 1

# remove zeroed-value data
summ.AC.LP <- summ.AC.LP[summ.AC.LP$value != 0,]

# A connection data frame is a list of flows with intensity for each flow
links <- summ.AC.LP

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name = c(as.character(links$source),
                             as.character(links$target)) %>% unique())

# We need a data frame giving a hierarchical structure. Let's consider the flare dataset
edges1 <-
  aggregate(
    alluv.data$sucupira.raw..Linha.de.Pesquisa.,
    by = list(
      alluv.data$sucupira.raw..Área.de.Concentração.,
      alluv.data$sucupira.raw..Linha.de.Pesquisa.
    ),
    FUN = length
  )

# Usually we associate another dataset that give information about each node of the dataset
vertices <- NULL

# Then we have to make a 'graph' object using the igraph library:
mygraph <- graph_from_data_frame(edges1[, 1:2], vertices = vertices)

# plot 1
par(
  oma = c(0, 0, 0, 0),
  mar = c(0, 0, 0, 0),
  bg = main.color,
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)

# Make the plot
ggraph(mygraph, layout = 'circlepack', weight = c(0, edges1[, 3])) +
  geom_node_circle(aes(fill = as.factor(depth))) +
  scale_colour_brewer(RColorBrewer::brewer.pal(n = 9, name = "Set3")) +
  scale_fill_discrete(labels = c("Áreas de concentração", "Linhas de pesquisa")) +
  theme_void() +
  theme(
    panel.border = element_blank(),
    panel.background = element_rect(fill = main.color, color = main.color),
    plot.background = element_rect(fill = main.color, color = main.color),
    legend.background = element_rect(fill = main.color,  color = main.color),
    legend.box.background = element_rect(fill = main.color,  color = main.color),
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(color = "white", size = 14)
  )

# plot 2

# plot area setup
# layout.m <- matrix(c(1, 2, 3, 4), ncol = 2, byrow = FALSE)
layout.m <- matrix(c(1, 2), ncol = 1, byrow = FALSE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.coerencia.1 <- c(length(unique(current.AC)),
                      length(unique(current.LP)))
names(summ.coerencia.1) <-
  c("Áreas de Concentração",
    "Linhas de Pesquisa")

# names(summ.coerencia.1) <-
#   c("Áreas de Concentração \n (ativas)",
#     "Linhas de Pesquisa \n (ativas)")

# summ.coerencia.2 <- c(length(unique(old.AC)),
#                       length(unique(old.LP)))
# names(summ.coerencia.2) <-
#   c("Áreas de Concentração \n (inativas)",
#     "Linhas de Pesquisa \n (inativas)")
#
# summ.data <- c(summ.coerencia.1, summ.coerencia.2)
summ.data <- c(summ.coerencia.1)
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-coerencia-carousel, eval = has.sucupira.files}
# carousel
bsplus::bs_carousel(id = "coerencia-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-coerencia-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-coerencia-2.png"))

source("Scripts/fonte_sucupira.R", local = knitr::knit_global())
```

<br>

<br>

```{r sintese-temas, include = FALSE, eval = has.sucupira.files}
# file path to save the wordclouds
dir.path <- file.path(getwd(), "index_files", "figure-html")
dir.create(dir.path, recursive = TRUE)

# projetos
sheet <- "Projetos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
data.to.cloud <- sucupira.raw$`Nome do Projeto de Pesquisa`
cloud.title <- "Temas de Projetos"
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())

# dissertações e teses
sheet <- "TCC"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
data.to.cloud <- sucupira.raw$`Nome do Trabalho de Conclusão`
cloud.title <- "Dissertações e Teses"
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())

# artigos
sheet <- "Produções"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
data.to.cloud <- sucupira.raw$`Nome da Produção`
cloud.title <- "Temas de Produção"
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())
```

```{r sintese-temas-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", out.width = "100%", eval = has.sucupira.files}
# carousel of wordclouds
bsplus::bs_carousel(id = "temas-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/Projetos.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/TCC.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/Produções.png"))

cat('\n\n')
source("Scripts/fonte_sucupira.R", local = knitr::knit_global())
```

<br>

<br>

```{r sintese-projetos, include = FALSE, eval = has.sucupira.files}
# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# get all history of 'linha de pesquisa'
linhas <-
  as.character(na.exclude(unique(sucupira.raw$`Linha de Pesquisa`)))

# initialize data structure
andamento.ano <-
  matrix(NA, nrow = length(linhas), ncol = length(anos))
colnames(andamento.ano) <- anos
rownames(andamento.ano) <- linhas
concluido.ano <- andamento.ano

# iterate across all Sucupira list elements to search for active and closed projects
for (i in 1:length(anos)) {
  # active
  projetos <- sucupira.list[[i]]
  projetos <-
    projetos[projetos$`Membro Responsável` == "Sim" &
               projetos$Situação == "EM ANDAMENTO",]
  for (j in 1:length(linhas)) {
    andamento.ano[j, i] <-
      sum(projetos$`Linha de Pesquisa` == linhas[j], na.rm = TRUE)
  }
  # closed
  projetos <- sucupira.list[[i]]
  projetos <-
    projetos[projetos$`Membro Responsável` == "Sim" &
               projetos$Situação == "CONCLUÍDO",]
  for (j in 1:length(linhas)) {
    concluido.ano[j, i] <-
      sum(projetos$`Linha de Pesquisa` == linhas[j], na.rm = TRUE)
  }
}
projetos.ano <- andamento.ano + concluido.ano
projetos.ano <-
  projetos.ano[, order(colnames(projetos.ano), decreasing = FALSE)]

membros <-
  data.frame(sucupira.raw$`Nome do Membro do Projeto`,
             sucupira.raw$`Categoria do Membro do Projeto`)
membros <- membros[!duplicated(membros), ]
categorias <-
  table(membros$sucupira.raw..Categoria.do.Membro.do.Projeto.)

# calculate summary statistics for projetos
summ.table.projetos <-
  c(paste0(
    formatC(
      sum(concluido.ano, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = ".",
      decimal.mark = ","
    )
  ),
  paste0(
    formatC(
      sum(andamento.ano[, dim(andamento.ano)[2]], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = ".",
      decimal.mark = ","
    )
  ),
  categorias,
  sum(categorias))
names(summ.table.projetos) <-
  c("Projetos concluídos",
    "Projetos em andamento",
    names(categorias),
    "Total de membros")

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot 1 (total de projetos por linha, por ano)
barplot(projetos.ano,
        ylab = "N",
        col = RColorBrewer::brewer.pal(n = length(linhas), name = "Set3"))
title(main = "Projetos por Linha de Pesquisa",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topright",
  legend = linhas,
  fill = RColorBrewer::brewer.pal(n = length(linhas), name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 0.70,
)

# plot 2 (percentual de projetos por linha, por ano)
barplot(
  scale(
    as.matrix(projetos.ano),
    center = FALSE,
    scale = colSums(as.matrix(projetos.ano))
  ) * 100,
  ylab = "%",
  col = RColorBrewer::brewer.pal(n = length(linhas), name = "Set3"),
  ylim = c(0, 100)
)
title(main = "Projetos por Linha de Pesquisa",
      outer = TRUE,
      cex.main = 1.7)

# plot 3 (summary table in plot)

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 2, 2, 3, 4, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.projetos
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-projetos-carousel, eval = has.sucupira.files}
# carousel
bsplus::bs_carousel(id = "projetos-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-projetos-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-projetos-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-projetos-3.png"))

cat('\n\n')
source("Scripts/fonte_sucupira.R", local = knitr::knit_global())
```

<br>

<br>

```{r sintese-financiadores, include = FALSE, eval = has.financiadores}
options("scipen" = 100)

financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

# dplyr::select variables to display
financiadores <-
  financiadores.raw %>% dplyr::select("Ano", "Agência", "Programa", "Total", "Proponente")

# drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores), ]

# generate cross-table
N.editais.agencia.ano <-
  table(financiadores$'Agência', financiadores$'Ano')
N.editais.agencia.ano <-
  N.editais.agencia.ano[, order(colnames(N.editais.agencia.ano), decreasing = FALSE)]

# get all 'agencias'
agencias <-
  na.exclude(rownames(N.editais.agencia.ano))

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot 1 (financiadores per agency by year (absolute frequency)
barplot(N.editais.agencia.ano,
        ylab = "N",
        col = RColorBrewer::brewer.pal(n = length(agencias), name = "Set3"))
title(main = "Editais financiados por agência",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = agencias,
  fill = RColorBrewer::brewer.pal(n = length(agencias), name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1,
)

# generate cross-table
T.editais.agencia.ano <-
  with(financiadores, tapply(
    financiadores$Total,
    list(financiadores$'Agência', financiadores$'Ano'),
    FUN = sum
  ))

# add zero to not available values
T.editais.agencia.ano[is.na(T.editais.agencia.ano)] <- 0

T.editais.agencia.ano <-
  T.editais.agencia.ano[, order(colnames(T.editais.agencia.ano), decreasing = FALSE)]

# get all 'agencias'
agencias <-
  na.exclude(rownames(T.editais.agencia.ano))

# plot 2 (financiadores per agency by year (absolute frequency))

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

barplot(T.editais.agencia.ano,
        ylab = "R$",
        col = RColorBrewer::brewer.pal(n = length(agencias), name = "Set3"))
title(main = "Valores financiados por agência",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = agencias,
  fill = RColorBrewer::brewer.pal(n = length(agencias), name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1,
)

# generate cross-table
professores.ano <-
  rowSums(table(financiadores$Ano, financiadores$Proponente) != 0)

# plot 3 (financiadores per docente by year (absolute frequency))

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

barplot(professores.ano,
        ylab = "N",
        col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(professores.ano)))
title(main = "Docentes com financiamento",
      outer = TRUE,
      cex.main = 1.7)

# plot 4 (top-10 editais)

editais <- financiadores$Programa

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min(length(do::unique_no.NA(editais)), 10)
data.editais <-
  na.omit(data.frame(name = names(sort(
    table(editais), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(editais), decreasing = TRUE
  )[1:top])))

# break vector names in 2 lines
text.2.break <- data.editais$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.editais$name <- broken_text

barplot(
  height = rev(data.editais$value),
  names = rev(data.editais$name),
  xlab = "N",
  col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " editais"),
  outer = TRUE,
  cex.main = 1.7
)

# plot 5 (top-10 agencias)

agencias <- financiadores$Agência

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min(length(do::unique_no.NA(agencias)), 10)
data.agencias <-
  na.omit(data.frame(name = names(sort(
    table(agencias), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(agencias), decreasing = TRUE
  )[1:top])))

# break vector names in 2 lines
text.2.break <- data.agencias$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.agencias$name <- broken_text

barplot(
  height = rev(data.agencias$value),
  names = rev(data.agencias$name),
  xlab = "N",
  col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " agências"),
  outer = TRUE,
  cex.main = 1.7
)

# calculate summary statistics for financiamentos
summ.table.financiadores <- matrix(0, nrow = 1, ncol = 5)
summ.table.financiadores <-
  cbind(
    paste0(
      formatC(
        length(na.omit(financiadores$Total)),
        format = "d",
        digits = 0,
        big.mark = ".",
        decimal.mark = ","
      )
    ),
    paste0(
      "R$ ",
      formatC(
        sum(financiadores$Total, na.rm = TRUE),
        format = "f",
        digits = 2,
        big.mark = ".",
        decimal.mark = ","
      )
    ),
    paste0("R$ ", formatC(
      median(financiadores$Total, na.rm = TRUE),
      format = "f",
      digits = 0,
      big.mark = "."
    )),
    paste0("R$ ", formatC(
      min(financiadores$Total, na.rm = TRUE),
      format = "f",
      digits = 0,
      big.mark = "."
    )),
    paste0("R$ ",
           formatC(
             max(financiadores$Total, na.rm = TRUE),
             format = "f",
             digits = 0,
             big.mark = "."
           ))
  )
names(summ.table.financiadores) <-
  c("Editais financiados",
    "Total de financiamentos",
    "Mediana anual",
    "Menor",
    "Maior")

# plot 6 (summary table in plot)

# plot area setup
layout.m <-
  matrix(c(1, 1, 2, 2, 3, 3, 4, 5), ncol = 2, byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.financiadores
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-financiadores-carousel, eval = has.financiadores}
# carousel
bsplus::bs_carousel(id = "financiadores-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-1.png")
  ) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-2.png")
  ) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-3.png")
  ) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-4.png")
  ) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-5.png")
  ) %>%
  bsplus::bs_append(
    id = "financiadores-carousel",
    content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-financiadores-6.png")
  )

cat('\n\n')
cat(
  "*Fontes:* [**CAPES**](https://www.gov.br/capes/pt-br), [**CNPq**](https://www.gov.br/cnpq/pt-br), [**FAPERJ**](http://www.faperj.br), **PPG**"
)
```

<br>

<br>

```{r sintese-producao, include = FALSE, eval = any(has.producao.ppg, has.producao.sucupira)}
# Qualis
qualis.PPG <- c()
for (i in 1:length(estratos)) {
  qualis.PPG[i] <-
    sum(doi_all$WebQualis == estratos[i], na.rm = TRUE) / length(doi_all$WebQualis) * 100
}
names(qualis.PPG) <- estratos

qualis.PPG.up <- names(qualis.PPG[1])
qualis.PPG.lr <- names(qualis.PPG[length(qualis.PPG)])

# generate cross tables of artigos per year
table.1 <- table(doi_all$published_on)

table.2 <-
  matrix(0, ncol = length(unique(doi_all$published_on)), nrow = length(estratos))
colnames(table.2) <- sort(unique(doi_all$published_on))
rownames(table.2) <- estratos

for (i in 1:length(doi_all$WebQualis)) {
    table.2[match(doi_all$WebQualis[i], rownames(table.2)), match(doi_all$published_on[i], colnames(table.2))] <-
      table.2[match(doi_all$WebQualis[i], rownames(table.2)), match(doi_all$published_on[i], colnames(table.2))] + 1
}

table.3 <- data.frame(doi_all$published_on, doi_all$SJR)
table.3.median <-
  aggregate(
    table.3,
    by = list(table.3$doi_all.published_on),
    FUN = median,
    na.rm = TRUE
  )
table.3.median <- t(as.matrix(table.3.median[, -2]))
table.3.median <- as.numeric(table.3.median[-1, ])
names(table.3.median) <- names(table.1)

table.4 <- data.frame(doi_all$published_on, doi_all$CiteScore)
table.4.median <-
  aggregate(
    table.4,
    by = list(table.4$doi_all.published_on),
    FUN = median,
    na.rm = TRUE
  )
table.4.median <- t(as.matrix(table.4.median[, -2]))
table.4.median <- as.numeric(table.4.median[-1, ])
names(table.4.median) <- names(table.1)

table.5 <-
  data.frame(doi_all$journal, doi_all$SJR)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# Define the number of colors you want
nb.cols <- length(rownames(table.2))
mycolors <- colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

# plot 1 (total de produção bilbiográfica, por ano)
barplot(table.1,
        ylab = "N",
        col = rep(mycolors[1], length(table.1)))
title(main = "Produção Bibliográfica",
      outer = TRUE,
      cex.main = 1.7)

# Define the number of colors you want
nb.cols <- length(rownames(table.2))
mycolors <- colorRampPalette(RColorBrewer::brewer.pal(9, "Blues"))(nb.cols)

# plot 2 (total de produção bilbiográfica, por estrato, por ano)
barplot(table.2,
        ylab = "Estrato",
        col = rev(mycolors))
title(main = "Qualidade da produção (Qualis)",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = rownames(table.2),
  fill = rev(mycolors),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1,
)

# # plot 3 (percentual de produção bilbiográfica, por estrato, por ano)
# barplot(
#   scale(
#     as.matrix(table.2),
#     center = FALSE,
#     scale = colSums(as.matrix(table.2))
#   ) * 100,
#   ylab = "%",
#   col = rev(mycolors),
#   ylim = c(0, 100)
# )
# title(main = "Qualidade da produção (Qualis)",
#       outer = TRUE,
#       cex.main = 1.7)

# plot 4 (violin plot of SJR por ano)
vioplot::vioplot(as.numeric(table.3[, 2]) ~ as.numeric(table.3[, 1]),
        xlab = NA,
        ylab = "SJR")
title(main = "Qualidade da produção (SJR)",
      outer = TRUE,
      cex.main = 1.7)

# plot 5 (violin plot of CiteScore por ano)
vioplot::vioplot(as.numeric(table.4[, 2]) ~ as.numeric(table.4[, 1]),
        xlab = NA,
        ylab = "CiteScore")
title(main = "Qualidade da produção (CiteScore)",
      outer = TRUE,
      cex.main = 1.7)

# plot 6 (top-10 journals)
journals.SJR <- unique(table.5)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min((as.numeric(journals.SJR$SJR)), 10)
data.journals <-
  data.frame(
    name = journals.SJR$doi_all.journal[order(as.numeric(journals.SJR$doi_all.SJR), decreasing = TRUE)][1:top],
    value = as.numeric(sort(as.numeric(journals.SJR$doi_all.SJR), decreasing = TRUE
             )[1:top])
    )

# break vector names in 2 lines
text.2.break <- data.journals$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.journals$name <- broken_text

# Define the number of colors you want
nb.cols <- length(rownames(table.2))
mycolors <- colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

options(digits = 10)
barplot(
  height = rev(data.journals$value),
  names = rev(data.journals$name),
  xlab = "SJR",
  col = rep(mycolors[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " periódicos (SJR)"),
  outer = TRUE,
  cex.main = 1.7
)
options(digits = 2)

# plot 7 (barplot of QUALIS e SJR)

# plot area setup
layout.m <- matrix(c(1, 2, 3),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

barplot(
  -rev(qualis.base),
  horiz = TRUE,
  xlab = "%",
  ylab = "Estratos",
  xlim = c(-max(qualis.base, qualis.PPG), max(qualis.base, qualis.PPG)),
  ylim = c(0, length(unique(qualis.base)) + 3),
  col = mycolors[1],
  sub = "Base",
  cex.names = 0.7,
  xaxt = 'n',
  ann = FALSE
)
barplot(
  rev(qualis.PPG),
  horiz = TRUE,
  xlab = "%",
  ylab = "Estratos",
  xlim = c(-max(qualis.base, qualis.PPG), max(qualis.base, qualis.PPG)),
  ylim = c(0, length(unique(qualis.base)) + 3),
  col = mycolors[2],
  sub = "Programa",
  cex.names = 0.7,
  xaxt = 'n',
  ann = FALSE,
  add = TRUE
)
axis(1, at = round(c(
  -max(qualis.base, qualis.PPG), 0, max(qualis.base, qualis.PPG)
)), labels = round(c(
  max(qualis.base, qualis.PPG), 0, max(qualis.base, qualis.PPG)
)))
title(main = "Distribuição Bases vs. Programa (Qualis, SJR, CiteScore)",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = c("Base", "Programa"),
  fill = mycolors[1:2],
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = TRUE,
  cex = 1
)

# hist SJR base e PPG
SJR.base <- scimago$SJR[!is.na(scimago$SJR)]
SJR.PPG <- doi_all$SJR[!is.na(doi_all$SJR)]

vioplot::vioplot(
  as.numeric(SJR.base),
  col = mycolors[1],
  xlab = NA,
  side = "left",
  ylim = c(min(
    as.numeric(SJR.base), as.numeric(SJR.PPG)
  ), max(
    as.numeric(SJR.base), as.numeric(SJR.PPG)
  )),
  ylab = "SJR",
  xaxt = 'n',
  ann = FALSE
)
vioplot::vioplot(
  as.numeric(SJR.PPG),
  col = mycolors[2],
  xlab = NA,
  side = "right",
  ylim = c(min(
    as.numeric(SJR.base), as.numeric(SJR.PPG)
  ), max(
    as.numeric(SJR.base), as.numeric(SJR.PPG)
  )),
  ylab = "SJR",
  xaxt = 'n',
  ann = FALSE,
  add = TRUE
)

# hist CiteScore base e PPG
CITESCORE.base <- citescore$CiteScore[!is.na(citescore$CiteScore)]
CITESCORE.PPG <- doi_all$CiteScore[!is.na(doi_all$CiteScore)]

vioplot::vioplot(
  as.numeric(CITESCORE.base),
  col = mycolors[1],
  xlab = NA,
  side = "left",
  ylim = c(min(
    as.numeric(CITESCORE.base), as.numeric(CITESCORE.PPG)
  ), max(
    as.numeric(CITESCORE.base), as.numeric(CITESCORE.PPG)
  )),
  ylab = "SJR",
  xaxt = 'n',
  ann = FALSE
)
vioplot::vioplot(
  as.numeric(CITESCORE.PPG),
  col = mycolors[2],
  xlab = NA,
  side = "right",
  ylim = c(min(
    as.numeric(CITESCORE.base), as.numeric(CITESCORE.PPG)
  ), max(
    as.numeric(CITESCORE.base), as.numeric(CITESCORE.PPG)
  )),
  ylab = "SJR",
  xaxt = 'n',
  ann = FALSE,
  add = TRUE
)

# plot 8 (summary table in plot)

# calculate summary statistics for producao
summ.table.producao <-
  cbind(
    sum(table.1),
    formatC(
      min(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.1, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      min(doi_all$SJR, na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    formatC(
      median(doi_all$SJR, na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    formatC(
      max(doi_all$SJR, na.rm = TRUE),
      format = "f",
      digits = 3,
      big.mark = "."
    ),
    paste0(
      formatC(
        100 - round((sum(table.2[1:8,]) / sum(table.2) * 100), 0),
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    ),
    paste0(
      formatC(
        sum(table.2[5:8,]) / sum(table.2) * 100,
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    ),
    paste0(
      formatC(
        sum(table.2[1:4,]) / sum(table.2) * 100,
        format = "d",
        digits = 0,
        big.mark = "."
      ),
      "%"
    )
  )

names(summ.table.producao) <-
  c(
    "Artigos publicados",
    "Mínimo",
    "Mediana anual",
    "Máximo",
    "Menor",
    "Mediana SJR",
    "Maior",
    "Outros",
    "B1-B4",
    "A1-A4"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.producao
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-producao-carousel, eval = any(has.producao.ppg, has.producao.sucupira)}
# carousel
bsplus::bs_carousel(id = "producao-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-3.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-4.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-5.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-6.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-producao-7.png"))

cat('\n\n')
cat(
  "*Fontes:* [**WebQualis**](https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/veiculoPublicacaoQualis/listaConsultaGeralPeriodicos.jsf), [**SJR**](https://www.scimagojr.com), [**Scopus**](https://www.scopus.com/home.uri), **PPG**"
)
```

<br>

<br>

```{r sintese-visibilidade, include = FALSE, eval = any(has.producao.ppg, has.producao.sucupira)}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

table.1 <- data.frame(doi_all$published_on, doi_all$altmetric_score)

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot 1 (violin plot of Altmetric por ano)
vioplot::vioplot(as.numeric(table.1[, 2]) ~ as.numeric(table.1[, 1]),
                 xlab = NA,
                 ylab = "Altmetric")
title(main = "Atenção e visibilidade (Altmetric)",
      outer = TRUE,
      cex.main = 1.7)
# add Altmetric logo and summary
par(new = TRUE)
my_image <-
  readPNG("Metrics/Altmetric/cropped-altmetric-symbol.png")
img <- as.raster(my_image)
lm <- par("usr")
r <- (lm[2] - lm[1]) / (lm[4] - lm[3])
h <- (lm[4] - lm[3]) / 5
w <- ((lm[2] - lm[1]) / 5)
x1 <- lm[1]
x2 <- lm[1] + w
y1 <- lm[4] - h
y2 <- lm[4]
rasterImage(
  img,
  xleft = x1,
  xright = x2,
  ybottom = y1,
  ytop = y2
)
text(
  x = (x1 + x2) / 2,
  y = (y1 + y2) / 2,
  labels = as.character(sum(as.numeric(table.1[, 2]), na.rm = TRUE)),
  adj = 0.5
)

# generate cross tables of IS_OA artigos per year
table.2 <-
  t(table(doi_all$published_on,
          as.logical(doi_all$is_oa)))
table.2 <- table.2[order(rownames(table.2)), ]
rownames(table.2) <- c("Open access", "Paywall")
# swap lines
table.2 <- table.2[seq_len(nrow(table.2)) + c(1, -1),]

# Define the number of colors you want
nb.cols <- length(rownames(table.2))
mycolors <-
  colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

# plot 2 (IS_OA in plot)
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

barplot(
  scale(
    as.matrix(table.2),
    center = FALSE,
    scale = colSums(as.matrix(table.2))
  ) * 100,
  ylab = "%",
  col = mycolors,
  ylim = c(0, 100)
)
title(main = "Produção em periódicos de acesso aberto",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = rownames(table.2),
  fill = rev(mycolors),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1,
)

if (sjmisc::is_empty(doi_all$citations)) {
  table.3 <- as.matrix(rep(0, length(max(anos) - min(anos) + 1)))
} else {
  # generate cross tables of citations per year
  table.3 <-
    t(table(doi_all$published_on,
            doi_all$citations))
  table.3 <- table.3[order(rownames(table.3)),]
  table.3 <- colSums(table.3)
}

# Define the number of colors you want
nb.cols <- length(table.3)
mycolors <-
  colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(nb.cols)

# plot 3 (CITATIONS in plot)
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

barplot(table.3,
        ylab = "N",
        col = rep(mycolors[1], length(table.3)))
title(main = "Total de citações",
      outer = TRUE,
      cex.main = 1.7)

# plot 4 (summary table in plot)

# calculate summary statistics for visibilidade
summ.table.visibilidade <-
  cbind(
    sum(as.numeric(table.1[, 2]), na.rm = TRUE),
    formatC(
      min(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.1[, 2], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    sum(as.numeric(table.3), na.rm = TRUE),
    formatC(
      min(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      max(table.3, na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    )
  )

names(summ.table.visibilidade) <-
  c(
    "Altmetric total",
    "Mínimo",
    "Mediana anual",
    "Máximo",
    "Citações totais",
    "Mínimo",
    "Mediana anual",
    "Máximo"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 1, 2, 3, 4, 5, 5, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.visibilidade
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-visibilidade-carousel, eval = any(has.producao.ppg, has.producao.sucupira)}
# carousel
bsplus::bs_carousel(id = "visibilidade-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-visibilidade-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-visibilidade-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-visibilidade-3.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-visibilidade-4.png"))

cat('\n\n')
cat(
  "*Fontes:* [**Altmetric**](https://www.altmetric.com), [**CrossRef**](https://www.crossref.org), **PPG**"
)
```

<br>

<br>

```{r sintese-pessoal, include = FALSE, eval = has.discentes}
discentes.raw <-
  readxl::read_excel(
    "PPG/Discentes.xlsx",
    sheet = "Discentes",
    col_types = c("text")
  )
discentes.raw <- discentes.raw[discentes.raw$País == "Brasil",]
discentes.raw$'Data Matrícula' <-
  as.Date(discentes.raw$'Data Matrícula', format = "%d/%m/%Y")
discentes.raw$'Data Situação' <-
  as.Date(discentes.raw$'Data Situação', format = "%d/%m/%Y")
discentes.raw$'Ano Titulação' <-
  substr(as.Date(discentes.raw$'Data Situação', format = "%d/%m/%Y"), 1, 4)
# tempo de curso
discentes.raw$`Tempo de Curso (meses)` <-
  lubridate::interval(start = ymd(gsub("-", "", discentes.raw$'Data Matrícula')), end = ymd(gsub("-", "", discentes.raw$'Data Situação'))) %/% months(1)
discentes.raw %>%
  mutate(`Tempo de Curso (meses)` = as.numeric(`Tempo de Curso (meses)`)) %>%
  mutate(`Ano Titulação` = as.numeric(`Ano Titulação`))
discentes.raw$Curso[grepl("Mestrado", discentes.raw$Curso)] <- "Mestrado"
discentes.raw$Curso[grepl("Doutorado", discentes.raw$Curso)] <-"Doutorado"

discentes <- discentes.raw[is.na(discentes.raw$'Data Situação'), ]
discentes <- discentes[discentes$'Situação' != "Cancelado", ]
discentes <- discentes[discentes$'Situação' != "Desligado", ]
discentes <- discentes[!is.na(discentes$'Nome'), ]

egressos <- discentes.raw[!is.na(discentes.raw$'Data Situação'), ]
mestres <- egressos[grepl("mestrado", tolower(egressos$Curso)), ]
doutores <- egressos[grepl("doutorado", tolower(egressos$Curso)), ]

# identifying available courses
cursos <- levels(as.factor(c(discentes$Curso, egressos$Curso)))

# reading BR geospatial data from IPEA
datasets <- geobr::list_geobr()$years[3]
last.update <-
  as.numeric(strsplit(datasets, ", ")[[1]][length(strsplit(datasets, ", ")[[1]]) - 1])
states <-
  geobr::read_state(
    code_state = "all",
    year = last.update,
    simplified = TRUE,
    showProgress = FALSE
  )

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# generate plot of egressos per year
table.1 <- table(egressos$Curso, egressos$`Ano Titulação`)

# plot 1 (egressos titulados)
barplot(as.matrix(table.1),
        ylab = "Egressos",
        col = RColorBrewer::brewer.pal(n = 9, name = "Set3"))
title(main = "Formação de pessoal de nível superior",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = cursos,
  fill = RColorBrewer::brewer.pal(n = 9, name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1
)

# generate plot of tempo para titulação per year
table.2.msc <-
  data.frame(mestres$`Ano Titulação`,
             as.numeric(mestres$`Tempo de Curso (meses)`))
table.2.dsc <-
  data.frame(doutores$`Ano Titulação`,
             as.numeric(doutores$`Tempo de Curso (meses)`))

# plot 2 (violin plot of tempo para titulação por ano)
vioplot::vioplot(
  as.numeric(table.2.msc[, 2]) ~ as.numeric(table.2.msc[, 1]),
  col = RColorBrewer::brewer.pal(n = 9, name = "Set3")[2],
  xlab = NA,
  side = "left",
  at = sort(unique(as.numeric(table.2.msc[, 1]))),
  ylim = c(min(
    as.numeric(table.2.msc[, 2]), as.numeric(table.2.dsc[, 2])
  ), max(
    as.numeric(table.2.msc[, 2]), as.numeric(table.2.dsc[, 2])
  )),
  ylab = "Meses"
)
vioplot::vioplot(
  as.numeric(table.2.dsc[, 2]) ~ as.numeric(table.2.dsc[, 1]),
  col = RColorBrewer::brewer.pal(n = 9, name = "Set3")[1],
  xlab = NA,
  side = "right",
  ylab = "Meses",
  at = sort(unique(as.numeric(table.2.dsc[, 1]))),
  ylim = c(min(
    as.numeric(table.2.msc[, 2]), as.numeric(table.2.dsc[, 2])
  ), max(
    as.numeric(table.2.msc[, 2]), as.numeric(table.2.dsc[, 2])
  )),
  add = TRUE
)
title(main = "Tempo para titulação",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = cursos,
  fill = RColorBrewer::brewer.pal(n = 9, name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1
)

# plot 3 (geospatial plot of candidates)
states$discentes <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(discentes$UF))
for (i in 1:length(UF$Var1)) {
  states$discentes[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

p1 <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = states, ggplot2::aes(fill = discentes), color = "grey") +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Discentes, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 20,
      color = "white",
      face = "bold"
    )
  ) +
  ggplot2::ggtitle("Distribuição regional de discentes")

data <-
  as.data.frame(table(c(discentes$UF[discentes$UF == "RJ"], rep(
    "Outras UF", length(discentes$UF[discentes$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot2::ggplot(data, aes(x = "", y = N, fill = Regiões)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

data <- as.data.frame(table(discentes$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot2::ggplot(data, aes(x = "", y = N, fill = Cursos)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

g <-
  gridExtra::arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g2 <- cowplot::ggdraw(g) +
  ggplot2::theme(plot.background = ggplot2::element_rect(fill = main.color, color = NA))

plot(g2)

# plot 4 (geospatial plot of egressos)
states$egressos <- rep(NA, dim(states)[1])
UF <- as.data.frame(table(egressos$UF))
for (i in 1:length(UF$Var1)) {
  states$egressos[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

p1 <- ggplot2::ggplot() +
  ggplot2::geom_sf(
    data = states,
    ggplot2::aes(fill = egressos),
    color = "grey") +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Egressos, n",
    limits = c(min(0, UF$Freq), max(UF$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = element_text(color = "white"),
    legend.text = element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 20,
      color = "white",
      face = "bold"
    )
  ) +
  ggplot2::ggtitle("Distribuição regional de egressos")

data <-
  as.data.frame(table(c(egressos$UF[egressos$UF == "RJ"], rep(
    "Outras UF", length(egressos$UF[egressos$UF != "RJ"])
  ))))
colnames(data) <- c("Regiões", "N")

p2 <- ggplot2::ggplot(data, aes(x = "", y = N, fill = Regiões)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

data <- as.data.frame(table(egressos$Curso))
colnames(data) <- c("Cursos", "N")

p3 <- ggplot2::ggplot(data, aes(x = "", y = N, fill = Cursos)) +
  ggplot2::scale_fill_manual(values = c("darkblue", "lightblue")) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::coord_polar("y", start = 0) +
  ggplot2::theme_void() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(color = "white")
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color)
  )

g <-
  gridExtra::arrangeGrob(p1,
              p2,
              p3,
              layout_matrix = rbind(c(1, 2), c(1, 3)),
              widths = c(7 / 10, 3 / 10))

g2 <- cowplot::ggdraw(g) +
  ggplot2::theme(plot.background = element_rect(fill = main.color, color = NA))

plot(g2)

# plot 5 (summary table in plot)

# calculate summary statistics for pessoal
summ.table.pessoal <-
  cbind(
    sum(table.1),
    formatC(
      sum(table.1[2,], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      sum(table.1[1,], na.rm = TRUE),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(
        table.2.msc$as.numeric.mestres..Tempo.de.Curso..meses...,
        na.rm = TRUE
      ),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    formatC(
      median(
        table.2.dsc$as.numeric.doutores..Tempo.de.Curso..meses...,
        na.rm = TRUE
      ),
      format = "d",
      digits = 0,
      big.mark = "."
    ),
    dim(discentes)[1],
    sum(discentes$Curso == "Mestrado"),
    sum(discentes$Curso == "Doutorado")
  )

names(summ.table.pessoal) <-
  c(
    "Egressos",
    "Mestres",
    "Doutores",
    "Meses",
    "Meses",
    "Candidatos",
    "Mestrandos",
    "Doutorandos"
  )

# plot area setup
layout.m <- matrix(c(1, 2, 3, 1, 4, 5, 6, 7, 8),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.pessoal
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-pessoal-carousel, eval = has.discentes}
# carousel
bsplus::bs_carousel(id = "pessoal-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-pessoal-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-pessoal-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-pessoal-3.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-pessoal-4.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-pessoal-5.png"))

cat('\n\n')
cat(
  "*Fontes:* [**Plataforma Sucupira**](https://sucupira.capes.gov.br/sucupira/), **PPG**"
)
```

<br>

<br>

```{r sintese-posdoc, include = FALSE, eval = has.posdocs}
# posdocs
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

posdoc.raw <- sucupira.raw
posdoc.raw$`Vínculo Início` <-
  as.Date(posdoc.raw$`Vínculo Início`, format = "%d/%m/%Y")
posdoc.raw$`Vínculo Fim` <-
  substr(as.Date(posdoc.raw$`Vínculo Fim`, format = "%d/%m/%Y"), 1, 4)
posdoc.raw$'Ano Matrícula' <-
  substr(as.Date(posdoc.raw$`Vínculo Início`, format = "%d/%m/%Y"), 1, 4)

posdocs <- posdoc.raw[!is.na(posdoc.raw$`Vínculo Fim`), ]
posdocs <- posdocs[!is.na(posdocs$`Pós-Doc Nome`), ]
posdocs <- posdocs[!duplicated(posdocs), ]

posdocs.atuais <- posdoc.raw[is.na(posdoc.raw$`Vínculo Fim`), ]
posdocs.atuais <- posdocs.atuais[!is.na(posdocs.atuais$`Pós-Doc Nome`), ]
posdocs.atuais <- posdocs.atuais[!duplicated(posdocs.atuais), ]

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# generate plot of posdocs per year
table.1 <- table(posdocs$Nacionalidade, posdocs$'Ano Matrícula')
table.2 <- table(posdocs.atuais$Nacionalidade, posdocs.atuais$'Ano Matrícula')

# all posdocs
posdoc.years <- min(posdocs$'Ano Matrícula', posdocs.atuais$'Ano Matrícula'):max(posdocs$'Ano Matrícula', posdocs.atuais$'Ano Matrícula')

table.3 <- matrix(0, nrow = length(unique(posdoc.raw$Nacionalidade)), ncol = length(posdoc.years))
rownames(table.3) <- unique(posdoc.raw$Nacionalidade)
colnames(table.3) <- posdoc.years

table.3a <- table.3
table.3b <- table.3

if(sum(table.1) != 0) {
  for (i in 1:dim(table.1)[1]) {
    for (j in 1:dim(table.1)[2]) {
      table.3a[match(rownames(table.1)[i], rownames(table.3)),
               match(colnames(table.1)[j], colnames(table.3))] <-
        table.1[i, j]
    }
  }
}
if (sum(table.2) != 0) {
  for (i in 1:dim(table.2)[1]) {
    for (j in 1:dim(table.2)[2]) {
      table.3b[match(rownames(table.2)[i], rownames(table.3)),
               match(colnames(table.2)[j], colnames(table.3))] <-
        table.2[i, j]
    }
  }
}
table.3 <- as.matrix(table.3a) + as.matrix(table.3b)

# plot 1 (posdocs titulados)
barplot(as.matrix(table.3),
        ylab = "Pós-docs",
        col = RColorBrewer::brewer.pal(n = 9, name = "Set3"))
title(main = "Estágio Pós-Doutoral",
      outer = TRUE,
      cex.main = 1.7)
legend(
  "topleft",
  legend = unique(posdoc.raw$Nacionalidade),
  fill = RColorBrewer::brewer.pal(n = 9, name = "Set3"),
  text.col = "white",
  box.lwd = 0,
  bty = "n",
  horiz = FALSE,
  cex = 1
)

# plot 2 (geospatial plot of posdocs)
paises <- as.data.frame(table(c(posdocs$País, posdocs.atuais$País)))
source("Scripts/worldmap.R", local = knitr::knit_global())

ggplot2::ggplot() +
  ggplot2::geom_polygon(data = worldmap,
                        ggplot2::aes(
                          x = long,
                          y = lat,
                          group = group,
                          fill = Freq
                        )) +
  cowplot::theme_map() +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Pós-Docs, n",
    limits = c(min(0, paises$Freq), max(paises$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white"),
    axis.title.x = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank()
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    panel.grid.minor = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 18,
      color = "white",
      face = "bold",
      hjust = 0.5
    )
  ) +
  ggplot2::ggtitle("Distribuição global de Pós-Docs")

# plot 3 (summary table in plot)

# calculate summary statistics for posdocs
summ.table.posdoc <-
  c(
    sum(table.3),
    sum(table.1),
    as.numeric(rowSums(table.1)),
    sum(table.2),
    as.numeric(rowSums(table.2))
  )

names(summ.table.posdoc) <-
  c(
    "Pós-Docs total",
    "Concluídos",
    names(rowSums(table.1)),
    "Em andamento",
    names(rowSums(table.2))
  )

# plot area setup
layout.m <- matrix(c(1,1,1,2,3,4,5,6,7),
                   ncol = 3,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.posdoc
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-posdoc-carousel, eval = has.posdocs}
# carousel
bsplus::bs_carousel(id = "posdoc-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-posdoc-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-posdoc-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-posdoc-3.png"))

source("Scripts/fonte_sucupira.R", local = knitr::knit_global())
```

<br>

<br>

```{r sintese-rede, include = FALSE, eval = has.sucupira.files}
# projetos
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# create edge matrix
proj.id <-
  as.factor(sucupira.raw$`Identificador do Projeto de Pesquisa`)
n.proj <- nlevels(proj.id)
membros <- sort(unique(sucupira.raw$`Nome do Membro do Projeto`))
n.membros <- length(membros)
categ <- as.factor(sucupira.raw$`Categoria do Membro do Projeto`)
n.categ <- nlevels(categ)
edge.matrix <- matrix(NA, nrow = 0, ncol = 2)
colnames(edge.matrix) <- c("from", "to")

# loop across all projects to populate the edge matrix
for (i in 1:n.proj) {
  # get the members by project id
  membros.proj <-
    unique(sucupira.raw$`Nome do Membro do Projeto`[proj.id == levels(proj.id)[i]])
  # only vote for upper diagonal elements
  for (n in 1:length(membros.proj)) {
    for (m in n:length(membros.proj)) {
      if (n != m) {
        # find members
        row.n <- match(membros.proj[n], membros)
        col.m <- match(membros.proj[m], membros)
        new.edge <- cbind(membros[row.n], membros[col.m])
        # add edges
        edge.matrix <- rbind(edge.matrix, new.edge)
      }
    }
  }
}

# build the graph object
network <- igraph::graph_from_edgelist(edge.matrix, directed = FALSE)

# set member category and color
colrs <- RColorBrewer::brewer.pal(n = n.categ, name = "Set3")
for (i in 1:length(V(network))) {
  categ.id <-
    match(V(network)[[i]]$name, sucupira.raw$`Nome do Membro do Projeto`)
  V(network)[[i]]$categ <-
    sucupira.raw$`Categoria do Membro do Projeto`[categ.id]
  col.id <- match(V(network)[[i]]$categ, levels(categ))
  V(network)[i]$color <- colrs[col.id]
}

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot 1
plot(
  network,
  directed = FALSE,
  arrow.mode = 0,
  vertex.label = NA,
  vertex.frame.color = "darkgrey",
  vertex.size = log(degree(network, mode = "all")) * 1.2,
  edge.color = "lightgrey",
  edge.lty = "solid",
  edge.size = edge.betweenness(network),
  edge.curved = .2
)
legend(
  "bottomleft",
  legend = levels(categ),
  pch = 19,
  col = colrs,
  text.col = "white",
  bty = "n",
  horiz = FALSE,
  cex = 0.8
)
title(main = "Membros de projetos de pesquisa",
      outer = TRUE,
      cex.main = 1.7)

# file path to save the wordclouds
dir.path <- file.path(getwd(), "index_files", "figure-html")
dir.create(dir.path, recursive = TRUE)

# IES participantes externos
sheet <- "Participante Externo"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
sucupira.raw <- sucupira.raw[!duplicated(sucupira.raw),]
IES <- sucupira.raw$`Instituição de Origem`
IES <- IES[!is.na(IES)]
países <- na.omit(sucupira.raw$`País da Instituição de Origem`)
mundo <-
  na.omit(sucupira.raw$`País da Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` != "Brasil"])

part.ext.nac <-
  na.omit(sucupira.raw$`Nome do Participante`[sucupira.raw$`País da Instituição de Origem` == "Brasil"])
part.ext.inter <-
  na.omit(sucupira.raw$`Nome do Participante`[sucupira.raw$`País da Instituição de Origem` != "Brasil"])

IES.nac <-
  na.omit(sucupira.raw$`Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` == "Brasil"])
IES.inter <-
  na.omit(sucupira.raw$`Instituição de Origem`[sucupira.raw$`País da Instituição de Origem` != "Brasil"])

# get initials
data.to.abbrev <- IES
source("Scripts/get-abbrev.R", local = knitr::knit_global())

ranked.ies <- c()
rank <- 1
for (i in 1:length(sort(table(abbrev), decreasing = FALSE))) {
  ranked.ies <-
    c(ranked.ies,
      rep(names(sort(table(
        abbrev
      ))[i]), match(sort(table(
        abbrev
      ))[i][[1]], unique(sort(
        table(abbrev)
      )))))
}
data.to.cloud <- ranked.ies
cloud.title <- "Instituições"
source("Scripts/docs-to-wordcloud.R", local = knitr::knit_global())

# plot 3

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min(length(IES.nac), 10)
data.nac <-
  na.omit(data.frame(name = names(sort(
    table(IES.nac), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(IES.nac), decreasing = TRUE
  )[1:top])))

# break vector names in 2 lines
text.2.break <- data.nac$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.nac$name <- broken_text

barplot(
  height = rev(data.nac$value),
  names = rev(data.nac$name),
  xlab = "N",
  col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " nacionais"),
  outer = TRUE,
  cex.main = 1.7
)

# plot 4

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min(length(IES.inter), 10)
data.inter <-
  na.omit(data.frame(name = names(sort(
    table(IES.inter), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(IES.inter), decreasing = TRUE
  )[1:top])))

# break vector names in 2 lines
text.2.break <- data.inter$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.inter$name <- broken_text

barplot(
  height = rev(data.inter$value),
  names = rev(data.inter$name),
  xlab = "N",
  col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " internacionais"),
  outer = TRUE,
  cex.main = 1.7
)

# plot 5

# plot area setup
layout.m <- c(1)
source("Scripts/plot-margins.R", local = knitr::knit_global())

# plot area setup
par(mar = c(1.5, 15, 1, 1))

top <- min(length(mundo), 10)
data.pais <-
  na.omit(data.frame(name = names(sort(
    table(mundo), decreasing = TRUE
  )[1:top]),
  value = as.numeric(sort(
    table(mundo), decreasing = TRUE
  )[1:top])))

# break vector names in 2 lines
text.2.break <- data.pais$name
source("Scripts/line-2-break.R", local = knitr::knit_global())
data.pais$name <- broken_text

barplot(
  height = rev(data.pais$value),
  names = rev(data.pais$name),
  xlab = "N",
  col = rep(RColorBrewer::brewer.pal(n = 9, name = "Set3")[1], length(1:top)),
  horiz = T,
  las = 1,
  cex.names = 0.7
)
title(
  main = paste0("Top-", top, " países"),
  outer = TRUE,
  cex.main = 1.7
)

# plot 6 (geospatial plot of participantes externos)
paises <- as.data.frame(table(as.character(mundo)))
source("Scripts/worldmap.R", local = knitr::knit_global())

ggplot2::ggplot() +
  ggplot2::geom_polygon(data = worldmap,
                        aes(
                          x = long,
                          y = lat,
                          group = group,
                          fill = Freq
                        )) +
  cowplot::theme_map() +
  ggplot2::scale_fill_distiller(
    palette = "Spectral",
    name = "Pesquisadores, n",
    limits = c(min(0, paises$Freq), max(paises$Freq)),
    na.value = "grey"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = 'bottom',
    legend.title = ggplot2::element_text(color = "white"),
    legend.text = ggplot2::element_text(color = "white"),
    axis.title.x = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank()
  ) +
  ggplot2::theme(
    plot.margin = ggplot2::unit(c(0, 0, 0, 0), "cm"),
    panel.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    plot.background = ggplot2::element_rect(fill = main.color,  color = main.color),
    panel.grid.major = ggplot2::element_line(color = "transparent"),
    panel.grid.minor = ggplot2::element_line(color = "transparent"),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(
      size = 15,
      color = "white",
      face = "bold",
      hjust = 0.5
    )
  ) +
  ggplot2::ggtitle("Distribuição global de Participantes Externos")

# plot 7 (summary table in plot)

# calculate summary statistics for IES
summ.table.ies <-
  cbind(
    length(unique(na.omit(IES.nac))) + length(unique(na.omit(IES.inter))),
    length(unique(na.omit(IES.nac))),
    length(unique(na.omit(IES.inter))),
    length(unique(na.omit(part.ext.nac))) + length(unique(na.omit(part.ext.inter))),
    length(unique(na.omit(part.ext.nac))),
    length(unique(na.omit(part.ext.inter)))
  )

names(summ.table.ies) <-
  c(
    "Instituições colaboradoras",
    "Nacionais",
    "Internacionais",
    "Participantes externos",
    "Nacionais",
    "Internacionais"
  )

# plot area setup
layout.m <- matrix(c(1, 1, 2, 3, 4, 4, 5, 6),
                   ncol = 2,
                   byrow = TRUE)
source("Scripts/plot-margins.R", local = knitr::knit_global())

summ.data <- summ.table.ies
source("Scripts/plot-summaries.R", local = knitr::knit_global())
```

```{r sintese-rede-carousel, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', results = "asis", out.width = "100%", eval = has.sucupira.files}
# carousel
bsplus::bs_carousel(id = "rede-carousel",
            use_indicators = FALSE,
            use_controls = TRUE) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-1.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/Participante Externo.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-2.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-3.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-4.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-5.png")) %>%
  bsplus::bs_append(content = bsplus::bs_carousel_image(src = "index_files/figure-html/sintese-rede-6.png"))

source("Scripts/fonte_sucupira.R", local = knitr::knit_global())
```

<br>

<br>

<div><center><img width="5%" height="5%" src="https://raw.githubusercontent.com/rstudio/hex-stickers/main/thumbs/RStudio.png"> Esta página foi desenvolvida em [**`r R.version$version.string`**](https://www.rstudio.com) usando [**R markdown**](https://rmarkdown.rstudio.com)
</center></div>

<br>

<br>

<br>

```{r session-info}
sessioninfo::session_info() %>%
  details::details(summary = 'Current session info',
                   open = FALSE)
```

<br>
