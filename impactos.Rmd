---
title: Impactos
output:
  html_document:
    toc: true
    toc_float: true
    css:
      - ./CSS/generic.css
      - ./CSS/logo-above-toc.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
---

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = "asis",
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)
```

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
    knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

<!--script for inserting LOGO ABOVE THE TOC-->
```{js}
$(document).ready(function() {
  $('#TOC').parent().prepend('<div id=\"nav_logo\"><img src="PPG/Images/logo-programa.png"></div>');
  });
```

<!--script for sharing-->
<p align="right">
```{r share}
home <- metadata$repository_url
source("Scripts/social-media-sharing.R", local = knitr::knit_global())
```
</p>

<!--script for generating ALTMETRIC badges-->
<script type='text/javascript' src='https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js'></script>

<!--script for generating multiple DIMENSIONS badges-->
<script async src="https://badge.dimensions.ai/badge.js" charset="utf-8"></script>

<!--script for generating multiple PLUMX badges-->
<script type="text/javascript" src="//cdn.plu.mx/widget-all.js"></script>

<br>

```{r periodo-vigente, eval = has.sucupira.files, results = "hide"}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
periodo.vigente <- anos
```

## **Impacto educacional** {#impacto-educacional .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Turmas**

```{r turmas-nivel, eval = has.sucupira.files}
# turmas
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(periodo.vigente, names(sucupira.list)))]
turmas.raw <- do.call(rbind.data.frame, sucupira.list[periodos])

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "Nome da Disciplina",
                                                  "Nível do curso")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "Período/Ano",
    "Nível do curso"
  ))

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# generate table (total by year)
table.part1 <-
  gtsummary::tbl_summary(
    turmas %>% dplyr::select(
      "Período/Ano",
      "Nível do curso"
    ),
    by = "Período/Ano",
    type = list(
      "Nível do curso" ~ "categorical"
    ),
    statistic = list(
      "Nível do curso" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  tbl_fix_order() %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.part1)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Disciplinas**

```{r turmas-disciplinas, eval = has.sucupira.files}
# turmas
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(periodo.vigente, names(sucupira.list)))]
turmas.raw <- do.call(rbind.data.frame, sucupira.list[periodos])

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "Nome da Disciplina",
                                                  "Nível do curso")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "Período/Ano",
    "Nome da Disciplina"
  ))

# change to title case
turmas$`Nome da Disciplina` <- tools::toTitleCase(tolower(turmas$`Nome da Disciplina`))

# rename
colnames(turmas) <- c(
  "Período/Ano",
  "Disciplina"
)

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# generate table (total by year)
table.part1 <-
  gtsummary::tbl_summary(
    turmas %>% dplyr::select(
      "Período/Ano",
      "Disciplina"
    ),
    by = "Período/Ano",
    type = list(
      "Disciplina" ~ "categorical"
    ),
    statistic = list(
      "Disciplina" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  tbl_fix_order() %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.part1)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Docentes**

```{r turmas-docentes, eval = has.sucupira.files}
# turmas
sheet <- "Turmas"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Load years data
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Bind all sheets for disciplines
periodos <- names(sucupira.list)[na.omit(match(periodo.vigente, names(sucupira.list)))]
turmas.raw <- do.call(rbind.data.frame, sucupira.list[periodos])

turmas.raw$`Período/Ano` <-
  paste(
    sub(".*/", "", turmas.raw$`Período/Ano`),
    sub("/.*", "", turmas.raw$`Período/Ano`),
    sep = "/"
  )

# remove duplicates based on selected columns
turmas.raw <- turmas.raw[!duplicated(turmas.raw[c("Período/Ano",
                                                  "ID da Disciplina",
                                                  "Nome da Disciplina",
                                                  "Nível do curso")]), ]

# select variables
turmas <- turmas.raw %>%
  dplyr::select(c(
    "Período/Ano",
    "Nível do curso",
    "Nome da Disciplina",
    "Categoria do responsável",
    "Nome do responsável",
    "Indicador de responsável principal"
  ))

# change to title case
turmas$`Nome da Disciplina` <- tools::toTitleCase(tolower(turmas$`Nome da Disciplina`))
turmas$`Nome do responsável` <- tools::toTitleCase(tolower(turmas$`Nome do responsável`))

# rename
colnames(turmas) <- c(
  "Período/Ano",
  "Disciplinas por curso",
  "Disciplina",
  "Categoria",
  "Docente responsável",
  "Responsável"
)

# get turmas by responsável and categoria Docente
turmas.doc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Docente", ]
  
table.part2 <- 
gtsummary::tbl_summary(
    turmas.doc %>% dplyr::select(
      "Período/Ano",
      "Docente responsável"
    ),
    by = "Período/Ano",
    type = list(
      "Docente responsável" ~ "categorical"
    ),
    statistic = list(
      "Docente responsável" ~ "{n}"
      ),
    missing = "no",
    digits = list(gtsummary::everything() ~ 0)) %>%
  gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels()

# Print HTML table
if (knitr::is_html_output()) {
  print(table.part2)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())


# get turmas by responsável and categoria Pós-Doc
turmas.posdoc <- turmas[turmas$Responsável == "Sim" & turmas$Categoria == "Pós-Doc", ]

if(!sjmisc::is_empty(turmas.posdoc)){
  table.part3 <- 
    gtsummary::tbl_summary(
      turmas.posdoc %>% dplyr::select(
        "Período/Ano",
        "Docente responsável"
      ),
      by = "Período/Ano",
      type = list(
        "Docente responsável" ~ "categorical"
      ),
      statistic = list(
        "Docente responsável" ~ "{n}"
      ),
      missing = "no",
      digits = list(gtsummary::everything() ~ 0)) %>%
    gtsummary::modify_header(label = "**Período/Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
    gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
    gtsummary::bold_labels()
}

# Print HTML table
if (knitr::is_html_output() && !sjmisc::is_empty(turmas.posdoc)) {
  print(table.part3)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Formação continuada**

```{r formacao-continuada, eval = has.sucupira.files}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
discentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Discente`,
  `Nível Discente`,
  `Situação Discente`,
  `Data Matrícula`,
  `Data Situação`
)
colnames(discentes)[2] <- "Nome"
colnames(discentes)[3] <- "Nível"
colnames(discentes)[4] <- "Situação"

# Egressos
sheet <- "Egressos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
egressos <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa do Egresso`,
  `Nome do Egresso`,
  `Nível Titulação`,
  `Ano Titulação`
)
colnames(egressos)[1] <- "Identificador da Pessoa"
colnames(egressos)[2] <- "Nome"
colnames(egressos)[3] <- "Nível"
try(egressos$Situação <- "EGRESSO", silent = TRUE)

# Pós-Doc
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
posdoc <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Pós-Doc Nome`,
  `Vínculo Início`,
  `Vínculo Fim`
)
colnames(posdoc)[2] <- "Nome"
try(posdoc$Situação <- "PÓS-DOC", silent = TRUE)

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
docentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Docente`,
  `Data de Admissão`,
  `Data de Desligamento`
)
colnames(docentes)[2] <- "Nome"
try(docentes$Situação <- "DOCENTE", silent = TRUE)

# bind all data by "Identificador da Pessoa"
formacao.continuada <- dplyr::bind_rows(
  discentes,
  egressos,
  posdoc,
  docentes
)

# remove duplicates
formacao.continuada <- formacao.continuada %>%
  dplyr::distinct()

# sort by "Identificador da Pessoa"
formacao.continuada <- formacao.continuada %>%
  dplyr::arrange(`Identificador da Pessoa`)

# create table to fill with start-end year for each situation
table <- data.frame(
  "Nome" = NA,
  Bacharelado = NA,
  "Mestrado" = NA,
  "Doutorado" = NA,
  "Pós-Doc" = NA,
  "Docente" = NA,
  check.names = FALSE
)

ID <- unique(formacao.continuada$`Identificador da Pessoa`)
for (i in 1:length(ID)) {
  # select data by ID
  data <- formacao.continuada %>%
    dplyr::filter(`Identificador da Pessoa` == ID[i])
  # get name
  table[i, "Nome"] <- data$Nome[1]
  # get year of start and end for discentes equal to bacharelado
  table[i, "Bacharelado"] <- min(data$`Data Matrícula`[data$Nível == "Bacharelado"], na.rm = TRUE)
  table[i, "Bacharelado"] <- format(as.Date(table[i, "Bacharelado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to mestrado
  table[i, "Mestrado"] <- min(data$`Data Matrícula`[data$Nível == "Mestrado"], na.rm = TRUE)
  table[i, "Mestrado"] <- format(as.Date(table[i, "Mestrado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to doutorado
  table[i, "Doutorado"] <- min(data$`Data Matrícula`[data$Nível == "Doutorado"], na.rm = TRUE)
  table[i, "Doutorado"] <- format(as.Date(table[i, "Doutorado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for pós-doc
  table[i, "Pós-Doc"] <- min(data$`Vínculo Início`, na.rm = TRUE)
  table[i, "Pós-Doc"] <- format(as.Date(table[i, "Pós-Doc"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for docentes
  table[i, "Docente"] <- min(data$`Data de Admissão`, na.rm = TRUE)
  table[i, "Docente"] <- format(as.Date(table[i, "Docente"], format = "%d/%m/%Y"), "%Y")
}

# add last colum with total number of years
table$Atuações <- apply(table, 1, function(x) {
  sum(!is.na(x)) - 1
})

# add last column with the lowest and higher levels of education. Paste levels
table$Formação <- apply(table, 1, function(x) {
  # drop first and last columns
  x <- x[-c(1, length(x))]
  # get lower column with data
  lower <- which(!is.na(x))[1]
  # get higher column with data
  higher <- which(!is.na(x))[length(which(!is.na(x)))]
  if(length(which(!is.na(x))) == 1) {
    return(names(x)[lower])
  } else {
    return(paste(names(x)[lower], names(x)[higher], sep = " - "))
  }
})

# sort by iniciacao científica, mestrado, doutorado, pós-doc, docente e nome
table.continuada <- table %>%
  dplyr::arrange(
    `Bacharelado`,
    `Mestrado`,
    `Doutorado`,
    `Pós-Doc`,
    `Docente`,
    Nome
  )

# add column with first first atuação date available
table.continuada$Ano <- apply(table.continuada, 1, function(x) {
  as.numeric(min(x[2:6], na.rm = TRUE))
})

# select data to print with Ano in periodo.vigente
table.continuada <- table.continuada %>%
  dplyr::filter(
    table.continuada$`Bacharelado` == periodo.vigente |
      table.continuada$`Mestrado` == periodo.vigente |
      table.continuada$`Doutorado` == periodo.vigente |
      table.continuada$`Pós-Doc` == periodo.vigente |
      table.continuada$`Docente` == periodo.vigente
  )

# select columns to print
table.continuada.part <- table.continuada %>%
  dplyr::select(Atuações, Formação, Ano)

# sort by Ano
table.continuada.part <- table.continuada.part %>%
  dplyr::arrange(Ano, Atuações, Formação)

# select Formação with " - " in Formação
try(table.continuada.part <- dplyr::filter(table.continuada.part, grepl(" - ", Formação)), silent = TRUE)

# reload previous table if current is empty
if(nrow(table.continuada.part) == 0) {
  table.continuada.part <- table.continuada %>%
    dplyr::select(Atuações, Formação, Ano)
}

# bug report
# https://stackoverflow.com/questions/78811916/gtsummary-tbl-summary-sorting-of-stratify-variable/78812588
tbl_fix_order <- function(x) {
  nms <- names(x$table_body)
  is_stat_cols <- grepl("^stat_", nms)
  non_stat_cols <- nms[!is_stat_cols]
  stat_cols <- nms[is_stat_cols]
  stat_cols <- stat_cols[
    order(as.integer(gsub("^.*?(\\d+)$", "\\1", stat_cols)))
  ]
  x$table_body <- x$table_body[c(non_stat_cols, stat_cols)]
  
  x  
}

# print tables
table.2.3.1 <-
 gtsummary::tbl_summary(
    table.continuada.part,
    by = "Ano",
    statistic = list(gtsummary::all_categorical() ~ "{n}"),
    missing = "no",
    digits = gtsummary::everything() ~ 0,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  tbl_fix_order() %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::bold_labels() %>%
  tbl_fix_order() %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
 ) %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA)

# Print HTML table
if (knitr::is_html_output()) {
  print(table.2.3.1)
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Impacto científico** {#impacto-cientifico .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Produção**

```{r 3-1-2-data, eval = has.sucupira.files}
# Produções - Detalhes
sheet <- "Produções - Detalhes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
sucupira <- sucupira.list[as.character(periodo.vigente)] %>%
  plyr::compact()
for(i in 1:length(sucupira)){
  sucupira[[i]] <- cbind(
    "Anos" = rep(periodo.vigente[i], times = dim(sucupira[[i]])[1]),
    sucupira[[i]]
  )
}
sucupira.df <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira.df) <-
  names(sucupira[[as.character(max(as.numeric(periodo.vigente)))]])

sucupira.df <-
  sucupira.df %>% dplyr::select(
    "Anos",
    "Nome da Produção",
    "Produção vinculada a TCC concluído",
    "Tipo de Produção",
    "Subtipo de Produção",
    "Área de Concentração",
    "Linha de Pesquisa",
    "Projeto",
    "Categoria do Autor Principal"
  )
sucupira.df$`Área de Concentração` <- tools::toTitleCase(tolower(sucupira.df$`Área de Concentração`))
sucupira.df$`Linha de Pesquisa` <- tools::toTitleCase(tolower(sucupira.df$`Linha de Pesquisa`))
sucupira.df$`Tipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Tipo de Produção`))
sucupira.df$`Subtipo de Produção` <- tools::toTitleCase(tolower(sucupira.df$`Subtipo de Produção`))
```

```{r 3-1-2-ac, eval = has.sucupira.files}
table.ac <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(periodo.vigente)
))

rownames(table.ac) <- NULL
table.ac <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.ac)
colnames(table.ac) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.ac)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == periodo.vigente[j], ]
    table.ac[i, j + 1] <- try(
      data$`Área de Concentração`[match(table.ac$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.ac <- table.ac[rowSums(is.na(table.ac)) < ncol(table.ac), ]

table.ac.long <- tidyr::gather(
  table.ac[, -1],
  "Ano",
  "Área de Concentração",
  colnames(table.ac)[-1],
  factor_key = TRUE
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.ac.long) <- c("Ano", "Área de Concentração")

# change all column types to factors
table.ac.long <- table.ac.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.ac.gt <- gtsummary::tbl_summary(
  table.ac.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Área de Concentração'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-lp, eval = has.sucupira.files}
table.lp <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(periodo.vigente)
))

rownames(table.lp) <- NULL
table.lp <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.lp)
colnames(table.lp) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.lp)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == periodo.vigente[j], ]
    table.lp[i, j + 1] <- try(
      data$`Linha de Pesquisa`[match(table.lp$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.lp <- table.lp[rowSums(is.na(table.lp)) < ncol(table.lp), ]

table.lp.long <- tidyr::gather(
  table.lp[, -1],
  "Ano",
  "Linha de Pesquisa",
  colnames(table.lp)[-1],
  factor_key = TRUE
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.lp.long) <- c("Ano", "Linha de Pesquisa")

# change all column types to factors
table.lp.long <- table.lp.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.lp.gt <- gtsummary::tbl_summary(
  table.lp.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Linha de Pesquisa'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-producao, eval = has.sucupira.files}
table.prd <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(periodo.vigente)
))

rownames(table.prd) <- NULL
table.prd <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.prd)
colnames(table.prd) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.prd)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == periodo.vigente[j], ]
    table.prd[i, j + 1] <- try(
      data$`Tipo de Produção`[match(table.prd$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.prd <- table.prd[rowSums(is.na(table.prd)) < ncol(table.prd), ]

table.prd.long <- tidyr::gather(
  table.prd[, -1],
  "Ano",
  "Tipo de Produção",
  colnames(table.prd)[-1],
  factor_key = TRUE
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.prd.long) <- c("Ano", "Tipo de Produção")

# change all column types to factors
table.prd.long <- table.prd.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.prd.gt <- gtsummary::tbl_summary(
  table.prd.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Tipo de Produção'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-autor, eval = has.sucupira.files}
table.aut <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(periodo.vigente)
))

rownames(table.aut) <- NULL
table.aut <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.aut)
colnames(table.aut) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.aut)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == periodo.vigente[j], ]
    table.aut[i, j + 1] <- try(
      data$`Categoria do Autor Principal`[match(table.aut$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.aut <- table.aut[rowSums(is.na(table.aut)) < ncol(table.aut), ]

table.aut.long <- tidyr::gather(
  table.aut[, -1],
  "Ano",
  "Categoria do Autor Principal",
  colnames(table.aut)[-1],
  factor_key = TRUE
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.aut.long) <- c("Ano", "Categoria do Autor Principal")

# change all column types to factors
table.aut.long <- table.aut.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.aut.gt <- gtsummary::tbl_summary(
  table.aut.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Categoria do Autor Principal'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-tcc, eval = has.sucupira.files}
table.tcc <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)]),
  ncol = length(periodo.vigente)
))

rownames(table.tcc) <- NULL
table.tcc <- cbind(sucupira.df$`Nome da Produção`[!duplicated(sucupira.df)], table.tcc)
colnames(table.tcc) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.tcc)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df[sucupira.df$Anos == periodo.vigente[j], ]
    table.tcc[i, j + 1] <- try(
      data$`Produção vinculada a TCC concluído`[match(table.tcc$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.tcc <- table.tcc[rowSums(is.na(table.tcc)) < ncol(table.tcc), ]

table.tcc.long <- tidyr::gather(
  table.tcc[, -1],
  "Ano",
  "Produção vinculada a TCC concluído",
  colnames(table.tcc)[-1],
  factor_key = TRUE
)

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tcc.long) <- c("Ano", "Produção vinculada a TCC concluído")

# change all column types to factors
table.tcc.long <- table.tcc.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.tcc.gt <- gtsummary::tbl_summary(
  table.tcc.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Produção vinculada a TCC concluído'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-bibliografica, eval = has.sucupira.files}
# filter sucupira.df by "Tipo de Produção" == "Bibliográfica"
sucupira.df.bib <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Bibliográfica", ])

table.bib <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df.bib$`Nome da Produção`[!duplicated(sucupira.df.bib)]),
  ncol = length(periodo.vigente)
))

rownames(table.bib) <- NULL
table.bib <- cbind(sucupira.df.bib$`Nome da Produção`[!duplicated(sucupira.df.bib)], table.bib)
colnames(table.bib) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.bib)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df.bib[sucupira.df.bib$Anos == periodo.vigente[j], ]
    table.bib[i, j + 1] <- try(
      data$`Subtipo de Produção`[match(table.bib$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.bib <- table.bib[rowSums(is.na(table.bib)) < ncol(table.bib), ]

table.bib.long <- tidyr::gather(
  table.bib[, -1],
  "Ano",
  "Nome da Produção",
  colnames(table.bib)[-1],
  factor_key = TRUE
)

# to title case
table.bib$`Nome da Produção` <- tools::toTitleCase(tolower(table.bib$`Nome da Produção`))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.bib.long) <- c("Ano", "Produção bibliográfica")

# change all column types to factors
table.bib.long <- table.bib.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.bib.gt <- gtsummary::tbl_summary(
  table.bib.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Produção bibliográfica'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-tecnica, eval = has.sucupira.files}
# filter sucupira.df by "Tipo de Produção" == "Técnica"
sucupira.df.tec <- unique(sucupira.df[sucupira.df$`Tipo de Produção` == "Técnica", ])

table.tec <- data.frame(matrix(
  NA,
  nrow = length(sucupira.df.tec$`Nome da Produção`[!duplicated(sucupira.df.tec)]),
  ncol = length(periodo.vigente)
))

rownames(table.tec) <- NULL
table.tec <- cbind(sucupira.df.tec$`Nome da Produção`[!duplicated(sucupira.df.tec)], table.tec)
colnames(table.tec) <- c("Nome da Produção", as.character(periodo.vigente))

for (i in 1:dim(table.tec)[1]) {
  for (j in 1:length(periodo.vigente)) {
    data <- sucupira.df.tec[sucupira.df.tec$Anos == periodo.vigente[j], ]
    table.tec[i, j + 1] <- try(
      data$`Subtipo de Produção`[match(table.tec$`Nome da Produção`[i], data$`Nome da Produção`)],
      silent = TRUE
    )
  }
}

# remove rows with NA in all columns
table.tec <- table.tec[rowSums(is.na(table.tec)) < ncol(table.tec), ]

table.tec.long <- tidyr::gather(
  table.tec[, -1],
  "Ano",
  "Subtipo de Produção",
  colnames(table.tec)[-1],
  factor_key = TRUE
)

# to title case
table.tec.long$`Subtipo de Produção` <- tools::toTitleCase(tolower(table.tec.long$`Subtipo de Produção`))

my_N <- function(data, ...) {
  gtsummary::style_number(sum(data == "Produção", na.rm = TRUE), digits = 0)
}

colnames(table.tec.long) <- c("Ano", "Produção técnica")

# change all column types to factors
table.tec.long <- table.tec.long %>%
  dplyr::mutate(dplyr::across(gtsummary::everything(), as.factor))

# Print tables
table.tec.gt <- gtsummary::tbl_summary(
  table.tec.long,
  by = "Ano",
  statistic = list(gtsummary::all_categorical() ~ "{n}"),
  missing = "no",
  digits = gtsummary::everything() ~ 0,
  sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = gtsummary::everything() ~ "{n}"
  ) %>%
  gtsummary::modify_header(label = "**Ano**", gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::all_stat_cols() ~ NA) %>%
  gtsummary::bold_labels() %>%
    gtsummary::remove_row_type(
    variables = c('Produção técnica'),
    type = "level",
    level_value = ("Produção")
  )
```

```{r 3-1-2-list-tables, eval = has.sucupira.files}
# list all tables
table.all <-
  list(table.ac.gt,
       table.lp.gt,
       table.prd.gt,
       table.aut.gt,
       table.tcc.gt,
       table.bib.gt,
       table.tec.gt
  )

# drop empty elements from list
table.all <- table.all[lapply(table.all, length) > 0]

# print all tables stacked
print(gtsummary::tbl_stack(table.all))

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Métricas**

```{r impacto-metricas, eval = any(has.metricas.doi.ppg, has.metricas.doi.sucupira)}
metricas_all_ID <- metricas_all[!duplicated(metricas_all$"ID da Produção"),]

metricas_all_ID$Qualis[is.na(metricas_all_ID$Qualis)] <- "Não classificado"

# get only artigos
metricas_all_ID <- metricas_all_ID[metricas_all_ID$"Subtipo de Produção" == "ARTIGO EM PERIÓDICO",]

# loop to get Qualis values from matched ISSN values
for(i in 1:dim(metricas_all_ID)[1]) {
  # check if ISSN exists in the list
  if(!sjmisc::is_empty(which(metricas_all_ID$ISSN[i] == qualis$ISSN))){
      metricas_all_ID$Qualis[i] <- as.character(unique(qualis[which(metricas_all_ID$ISSN[i] == qualis$ISSN), "Estrato"]))
  }
}

síntese.ano <- dplyr::bind_cols(
      Ano = as.numeric(metricas_all_ID$"Ano da Produção"),
      Qualis = as.factor(metricas_all_ID$Qualis),
      CiteScore = as.numeric(metricas_all_ID$CiteScore),
      SJR = as.numeric(metricas_all_ID$SJR),
      Citações = as.numeric(metricas_all_ID$citations),
      Altmetric = as.numeric(metricas_all_ID$altmetric_score),
      Facebook = as.numeric(metricas_all_ID$cited_by_fbwalls_count),
      Blogs = as.numeric(metricas_all_ID$cited_by_feeds_count),
      'Google+' = as.numeric(metricas_all_ID$cited_by_gplus_count),
      Notícias = as.numeric(metricas_all_ID$cited_by_msm_count),
      Posts = as.numeric(metricas_all_ID$cited_by_posts_count),
      Reddit = as.numeric(metricas_all_ID$cited_by_rdts_count),
      X = as.numeric(metricas_all_ID$cited_by_tweeters_count),
      'YouTube/Vimeo' = as.numeric(metricas_all_ID$cited_by_videos_count),
      Patentes = as.numeric(metricas_all_ID$cited_by_patents_count),
      Mendeley = as.numeric(metricas_all_ID$mendeley),
      'Acesso aberto' = factor(as.logical(metricas_all_ID$is_oa), levels = c(TRUE, FALSE), labels = c("Sim", "Não"))
          )

# Data selection
síntese.ano <- síntese.ano %>%
  dplyr::select(c(
    "Ano",
    "Qualis",
    "CiteScore",
    "SJR",
    "Citações",
    "Altmetric",
    "Facebook",
    "Blogs",
    "Google+",
    "Notícias",
    "Posts",
    "Reddit",
    "X",
    "YouTube/Vimeo",
    "Patentes",
    "Mendeley",
    "Acesso aberto"
    ))

# filter data in quadrineal.vigente
síntese.ano <- síntese.ano %>%
  dplyr::filter(
    Ano >= min(periodo.vigente) &
    Ano <= max(periodo.vigente)
    )

# generate table (total by year)
table.3.2.1 <-
  gtsummary::tbl_summary(
    síntese.ano,
    by = "Ano",
    type = list(
      "CiteScore" ~ "continuous",
      "Qualis" ~ "categorical",
      "SJR" ~ "continuous",
      "Citações" ~ "continuous",
      "Altmetric" ~ "continuous",
      "Facebook" ~ "continuous",
      "Blogs" ~ "continuous",
      "Google+" ~ "continuous",
      "Notícias" ~ "continuous",
      "Posts" ~ "continuous",
      "Reddit" ~ "continuous",
      "X" ~ "continuous",
      "YouTube/Vimeo" ~ "continuous",
      "Patentes" ~ "continuous",
      "Mendeley" ~ "continuous",
      "Acesso aberto" ~ "categorical"
      ),
    statistic = list(
      gtsummary::all_continuous() ~ "{median} ({min}-{max})",
      gtsummary::all_categorical() ~ "{n} ({p}%)"
      ),
    missing = "no",
    digits = list(
      "Qualis" ~ 0,
      "CiteScore" ~ 2,
      "SJR" ~ 2,
      "Citações" ~ 0,
      "Altmetric" ~ 0,
      "Facebook" ~ 0,
      "Blogs" ~ 0,
      "Google+" ~ 0,
      "Notícias" ~ 0,
      "Posts" ~ 0,
      "Reddit" ~ 0,
      "X" ~ 0,
      "YouTube/Vimeo" ~ 0,
      "Patentes" ~ 0,
      "Mendeley" ~ 0
      ),
    ) %>%
  gtsummary::add_overall(
    last = TRUE,
    col_label = "**Subtotal**",
    statistic = list(
      gtsummary::all_continuous() ~ "{median} ({min}-{max})",
      gtsummary::all_categorical() ~ "{n} ({p}%)"
      )
  ) %>%
  gtsummary::modify_header(
    label = "**Ano**",
    gtsummary::all_stat_cols() ~ "**{level}**") %>%
  gtsummary::modify_footnote(gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()


# Print HTML table
if (knitr::is_html_output()) {
  print(table.3.2.1)
}

source("Scripts/fonte-metricas.R", local = knitr::knit_global())

cat('\n\n')
cat('**Nota**: A classificação dos periódicos pelo Qualis refere-se à Avaliação Quadrienal 2017-2020 conforme arquivo disponibilizado na [Plataforma Sucupira](https://sucupira.capes.gov.br/sucupira/public/consultas/coleta/veiculoPublicacaoQualis/listaConsultaGeralPeriodicos.xhtml) e não substitui a classificação da CAPES da Avaliação Quadrienal ', min(periodo.vigente), '-', max(periodo.vigente), '.', sep = "")
cat('\n\n')
```

<br>

### **Velocidade**


<br>

### **Alcance**


<br>

### **Conteúdo**


<br>

### **Periódicos institucionais**

```{r periodicos-ies, cache = TRUE, cache.path = "cache/periodicos-ies/", eval = has.periodicos}
# read separate sheets
periodicos.raw <-
  readxl::read_excel(
    "PPG/Periódicos institucionais.xlsx",
    sheet = "Periódicos",
    col_types = c("text")
  )

Abrir <- matrix(NA, nrow = dim(periodicos.raw)[1])
colnames(Abrir) <- "Abrir"
# add hyperlinks
for (i in 1:dim(periodicos.raw)[1]) {
  if (!is.na(periodicos.raw[i, 3])) {
    Abrir[i] <-
      paste0('<a href="',
             periodicos.raw[i, 3],
             '" target="_blank"',
             '>',
             # fontawesome icon
             fontawesome::fa("up-right-from-square"),
             '</a>')
  }
}

periodicos <- cbind(periodicos.raw[, -3], Abrir)

# add metrics
periodicos$SJR <- rep('-', dim(periodicos)[1])
periodicos$CiteScore <- rep('-', dim(periodicos)[1])

# get SJR and CiteScore from database
for (i in 1:length(periodicos$ISSN)) {
  # get ISSN values
  df_scopus <- data.frame(issn = periodicos$ISSN[i])
  # remove - from ISSN
  df_scopus$issn <- gsub("-", "", df_scopus$issn)
  # get metrics
  source("Scripts/scopus-from-issn.R", local = knitr::knit_global())
  periodicos$SJR[i] <- ifelse(length(doi_with_metrics$SJR) != 0, doi_with_metrics$SJR, "")
  periodicos$CiteScore[i] <- ifelse(length(doi_with_metrics$CiteScore) != 0,
                                    doi_with_metrics$CiteScore,
                                    "")
  # wait to respect API rate limit (polite request)
  Sys.sleep(1)
  # beep to alert
  beepr::beep("coin")
}

periodicos$SJR <- format(round(as.numeric(periodicos$SJR), 3), nsmall = 3)
periodicos$CiteScore <- format(round(as.numeric(periodicos$CiteScore), 1), nsmall = 1)

# print table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(periodicos, title = "Impactos - Períódicos institucionais")

cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

### **Comitê de Ética em Pesquisa** {#cep .tabset}

#### **CEP**

<center>

```{r logo-ies, eval = has.cep}
if(file.exists("PPG/Images/logo-cep.png") & has.cep) {
  # read separate sheets
  link <-
    readxl::read_excel("PPG/Comitê de Ética em Pesquisa.xlsx",
                       sheet = "CEP",
                       col_types = c("text"))[[1]]
  cat('[<img src=\"PPG/Images/logo-cep.png\" align=\"center\"/>](', link, ')')
}
cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

</center>

<br>

#### **Documentos vigentes**

```{r cep-vigentes, eval = has.cep}
# read separate sheets
cep.vigentes.raw <-
  readxl::read_excel("PPG/Comitê de Ética em Pesquisa.xlsx",
                     sheet = "Vigentes",
                     col_types = c("text"))

Abrir <- matrix(NA, nrow = dim(cep.vigentes.raw)[1])
colnames(Abrir) <- "Abrir"
# add hyperlinks
for (i in 1:dim(cep.vigentes.raw)[1]) {
  if (!is.na(cep.vigentes.raw[i, 3])) {
    Abrir[i] <-
      paste0('<a href="',
             cep.vigentes.raw[i, 3],
             '" target="_blank"',
             '>',
             # fontawesome icon
             fontawesome::fa("up-right-from-square"),
             '</a>')
  }
}

cep.vigentes <- cbind(cep.vigentes.raw[, -3], Abrir)

# print table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(cep.vigentes, title = "Impactos - Comitê de Ética em Pesquisa - Documentos vigentes")

cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

#### **Documentos revogados**

```{r cep-revogados, eval = has.cep}
# read separate sheets
cep.revogados.raw <-
  readxl::read_excel("PPG/Comitê de Ética em Pesquisa.xlsx",
                     sheet = "Revogados",
                     col_types = c("text"))

Abrir <- matrix(NA, nrow = dim(cep.revogados.raw)[1])
colnames(Abrir) <- "Abrir"
# add hyperlinks
for (i in 1:dim(cep.revogados.raw)[1]) {
  if (!is.na(cep.revogados.raw[i, 3])) {
    Abrir[i] <-
      paste0('<a href="',
             cep.revogados.raw[i, 3],
             '" target="_blank"',
             '>',
             # fontawesome icon
             fontawesome::fa("up-right-from-square"),
             '</a>')
  }
}

cep.revogados <- cbind(cep.revogados.raw[, -3], Abrir)

# print table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(cep.revogados, title = "Impactos - Comitê de Ética em Pesquisa - Documentos revogados")
  
cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

## **Impacto tecnológico/econômico** {#impacto-tecnologico-economico .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Agência-Edital**

```{r auto-financiadores-agencia-programa, eval = has.financiadores}
financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

options(scipen = 10)

# dplyr::select variables to display, by AGENCIA & PROGRAMA
financiadores <-
  financiadores.raw %>% dplyr::select("Agência", "Programa")

# drop rows with empty cells
financiadores <-
  financiadores[complete.cases(financiadores),]

# generate table (total per edital, per agency)
table.1 <-
  gtsummary::tbl_summary(
    financiadores,
    by = "Agência",
    type = list(gtsummary::all_continuous() ~ "continuous"),
    statistic = gtsummary::all_categorical() ~ c("{n}"),
    missing = "no",
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(last = TRUE,
              col_label = "Total") %>%
  gtsummary::modify_header(label = "**Agência**") %>%
  gtsummary::modify_footnote(update = gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()
# print table
print(table.1)

cat('\n\n')

cat(
  "**Fontes**: [**CAPES**](https://www.gov.br/capes/pt-br), [**CNPq**](https://www.gov.br/cnpq/pt-br), [**FAPERJ**](http://www.faperj.br), **UNISUAM**"
)
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

### **Agência-Ano**

```{r auto-financiadores-agencia-ano, eval = has.financiadores}
financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

options(scipen = 10)

financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

# dplyr::select variables to display, by AGENCIA & ANO
financiadores <-
  financiadores.raw %>% dplyr::select("Ano", "Agência", "Total")

# drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores),]

financiadores <-
  financiadores[order(financiadores$Ano, decreasing = TRUE),]
financiadores$Ano <- as.factor(financiadores$Ano)

# generate table (total per year, per agency)
table.2 <-
  gtsummary::tbl_summary(
    financiadores,
    by = "Agência",
    type = list(gtsummary::all_continuous() ~ "continuous"),
    statistic = list(gtsummary::all_continuous() ~ "R$ {sum}"),
    missing = "no",
    digits = "Total" ~ 2
  ) %>%
  gtsummary::add_overall(last = TRUE,
              col_label = "Total") %>%
  gtsummary::modify_header(label = "**Agência**") %>%
  gtsummary::modify_footnote(update = gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()
# print table
print(table.2)

cat('\n\n')

cat(
  "**Fontes**: [**CAPES**](https://www.gov.br/capes/pt-br), [**CNPq**](https://www.gov.br/cnpq/pt-br), [**FAPERJ**](http://www.faperj.br), **UNISUAM**"
)
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

### **Edital-Ano**

```{r auto-financiadores-docente-programa, eval = has.financiadores}
options(scipen = 10)

financiadores.raw <-
  readxl::read_excel("PPG/Financiadores.xlsx", sheet = "financiadores")

# dplyr::select variables to display, by AGENCIA & ANO
financiadores <-
  financiadores.raw %>% dplyr::select("Ano", "Programa", "Total")

# drop rows with empty cells
financiadores <- financiadores[complete.cases(financiadores),]

financiadores <-
  financiadores[order(financiadores$Programa, decreasing = TRUE),]

# generate table (total per year, per docente)
table.2 <-
  gtsummary::tbl_summary(
    financiadores,
    by = "Programa",
    type = list(gtsummary::all_continuous() ~ "continuous"),
    statistic = list(gtsummary::all_continuous() ~ "R$ {sum}"),
    missing = "no",
    digits = "Total" ~ 2,
    sort = gtsummary::all_categorical() ~ "frequency"
  ) %>%
  gtsummary::add_overall(last = TRUE,
              col_label = "Total") %>%
  gtsummary::modify_header(label = "**Programa**") %>%
  gtsummary::modify_footnote(update = gtsummary::everything() ~ NA) %>%
  gtsummary::bold_labels()
# print table
print(table.2)

cat('\n\n')
cat(
  "**Fontes**: [**CAPES**](https://www.gov.br/capes/pt-br), [**CNPq**](https://www.gov.br/cnpq/pt-br), [**FAPERJ**](http://www.faperj.br), **UNISUAM**"
)
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

## **Impacto sociocultural** {#impacto-sociocultural .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Políticas** {#politicas .tabset}

#### **Tabela**

```{r politicas-citacao, cache = TRUE, cache.path = "cache/politicas-citacao/", eval = has.sage.files}
# list all Sage Profiles
files.to.read <-
  list.files(file.path(getwd(), "Impacto", "Sage Policy Profiles"),
            full.names = TRUE,
            recursive = FALSE)

# column bind all into a single dataframe
sage.profiles.raw <- data.frame()
for (i in 1:length(files.to.read)) {
  sage.profiles.raw <-
    rbind(sage.profiles.raw,
          read.csv2(files.to.read[i],
                    header = TRUE,
                    sep = ",",
                    stringsAsFactors = FALSE))
}

# remove duplicates
sage.profiles.raw  <-
  sage.profiles.raw[!duplicated(sage.profiles.raw$Policy.Document.ID), ]

# select columns
sage.profiles <- dplyr::select(sage.profiles.raw,
                               c("Published.on",
                                 "Title",
                                 "Source.title",
                                 "Source.type",
                                 "Cited.research.titles",
                                 "Cited.research.DOIs",
                                 "Source.country",
                                 "Document.URL"
                                 ))

# format Published.on as year
sage.profiles$Published.on <-
  format(as.Date(sage.profiles$Published.on, "%Y-%m-%d"), "%Y")

# use title case
sage.profiles$Source.title <-
  tools::toTitleCase(sage.profiles$Source.title)
sage.profiles$Source.type <-
  tools::toTitleCase(sage.profiles$Source.type)

# format link of Source.title using Document.URL and drop the latter column
sage.profiles$Source.title <-
  paste0('<a href="',
         sage.profiles$Document.URL,
         '" target="_blank"',
         '>',
         sage.profiles$Source.title,
         '</a>')

# create Fontes
sage.profiles$Fontes <- NA

# loop for all entries to bind Cited.research.titles with respective Cited.research.DOIs
for (i in 1:nrow(sage.profiles)) {
  dois.data <-
    stringr::str_split_1(string = sage.profiles$Cited.research.DOIs[i],
                         pattern = "  ，")
  # try to retrieve data from the cache file
  if (!sjmisc::is_empty(dois.data)) {
      bib.data <- rcrossref::cr_cn(dois = dois.data, format = "text", style = "apa-cv")
      # wait to respect API rate limit (polite request)
      Sys.sleep(1)
      # beep to alert
      beepr::beep("coin")
  }
  # convert bib.data from list to vector
  sage.profiles$Fontes[i] <- paste(bib.data, collapse = "<br><br>")
}

# drop columns
sage.profiles$Document.URL <- NULL
sage.profiles$Cited.research.titles <- NULL
sage.profiles$Cited.research.DOIs <- NULL

# rename columns
colnames(sage.profiles) <- c("Ano",
                             "Título",
                             "Tipo",
                             "Pesquisas citadas (DOI)",
                             "País",
                             "Fonte"
                             )

# keep complete cases only
sage.profiles <-
  sage.profiles[complete.cases(sage.profiles), ]
sage.profiles.raw <-
  sage.profiles.raw[complete.cases(sage.profiles), ]

# sort by year decreasing
sage.profiles <-
  sage.profiles[order(sage.profiles$Ano, decreasing = TRUE), ]
sage.profiles.raw <-
  sage.profiles.raw[order(sage.profiles$Ano, decreasing = TRUE), ]

cat('\n\n<!-- -->\n\n')

# create DT table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(sage.profiles, title = "Impactos - Produção citada em diretrizes e políticas")

cat('\n\n')
cat(
  "**Fontes**: [**SAGE Profile Policies**](https://www.socialsciencespace.com/sagepolicyprofiles/), [**CrossRef**](https://www.crossref.org)"
)
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

```{r politicas-docentes, eval = has.politicas}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Políticas.xlsx")

# display each sheet in a tab
for (i in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('#### **', abas[i], '**'))
  cat('\n\n<!-- -->\n\n')
  agendas <-
    readxl::read_excel("PPG/Políticas.xlsx",
               sheet = abas[i],
               col_types = c("text"))
  
  cat(
    paste0(
      '<iframe src="',
      agendas[1],
      '" style=\"width:100%; height:600px; border:2px solid black;"></iframe>'
    )
  )
  
  cat('\n\n')
  
  cat(
    "**Fontes**: [**SAGE Profile Policies**](https://www.socialsciencespace.com/sagepolicyprofiles/)"
  )
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
}
```

<br>

## **Ações durante a pandemia** {#acoes-pandemia}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !any(has.metricas.doi.ppg, has.metricas.doi.sucupira)}
cat('<br>')
```

```{r pandemia-termos}
pandemia <-
  c(
    "19nCoV",
    "2019 Novel Coronavirus",
    "2019-nCoV",
    "2019 nCoV",
    "coronavirus disease 2019",
    "Coronavirus Disease 2019",
    "Coronavirus Disease 2019",
    "COVID -19",
    "COVID 19",
    "COVID 2019",
    "COVID longa",
    "COVID- 19",
    "COVID-19",
    "COVID-2019",
    "COVID",
    "COVID19",
    "COVID2019",
    "doenca do coronavirus 2019",
    "doença do coronavirus 2019",
    "doenca do novo coronavirus 2019",
    "doença do novo coronavirus 2019",
    "doenca do novo coronavirus",
    "doença do novo coronavirus",
    "long COVID",
    "nCoV",
    "New Coronavirus",
    "Novo Coronavirus",
    "pós - COVID",
    "pós- COVID",
    "pós -COVID",
    "pós COVID",
    "pós-COVID",
    "pós-COVID-19",
    "post - COVID",
    "post- COVID",
    "post -COVID",
    "post COVID",
    "post-COVID",
    "post-COVID-19",
    "postCOVID",
    "SARS coronavirus 2",
    "SARS Coronavirus 2",
    "SARS CoV 2",
    "SARS COV 2",
    "SARS-CoV-2",
    "SARS-COV-2",
    "SARS-CoV2",
    "SARS-COV2",
    "SARSCoV-2",
    "SARSCOV-2",
    "SARSCoV2",
    "SARSCOV2",
    "severe acute respiratory syndrome coronavirus 2",
    "Severe Acute Respiratory Syndrome Coronavirus 2",
    "síndrome respiratória aguda grave",
    "pandemic",
    "pandemics",
    "pandemia"
  )
```

<br>

### **Projetos**

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r pandemia-projetos, eval = has.sucupira.files}
# projetos - membros
sheet <- "Projetos - Membros"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data from all Sucupira years available
projetos.all <-
  do.call(rbind.data.frame, sucupira.list)

projetos.all <-
  unique(projetos.all[projetos.all$`Membro Responsável` == "Sim",])

# dplyr::selecting those with COVID in the title
projetos <-
  projetos.all[grep(paste(tolower(pandemia), collapse = "|"),
                    tolower(projetos.all$`Nome do Projeto de Pesquisa`)),]

table.projetos <- data.frame()
if (!sjmisc::is_empty(projetos)) {
  table.projetos <-
    data.frame(
      projetos$`Área de Concentração`,
      projetos$`Linha de Pesquisa`,
      projetos$`Nome do Projeto de Pesquisa`,
      projetos$`Natureza do Projeto de Pesquisa`,
      projetos$`Nome do Membro do Projeto`,
      projetos$`Data de Início`
    )
  table.projetos <- table.projetos[order(table.projetos[, 1]), ]
  labels <- colnames(table.projetos)
  # print tables
  table.projetos[, 1] <-
    as.vector(unlist(lapply(table.projetos[, 1], FUN =  stringr::str_to_upper)))
  table.projetos[, 2] <-
    as.vector(unlist(lapply(table.projetos[, 2], FUN = stringr::str_to_sentence)))
  table.projetos[, 3] <-
    as.vector(unlist(lapply(table.projetos[, 3], FUN = stringr::str_to_title)))
  table.projetos[, 4] <-
    as.vector(unlist(lapply(table.projetos[, 4], FUN = stringr::str_to_title)))
  
  colnames(table.projetos) <-
    c(
      "Área de Concentração",
      "Linha de Pesquisa",
      "Projeto",
      "Natureza",
      "Responsável",
      "Início"
    )
}

cat('\n\n<!-- -->\n\n')

# create DT table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.projetos, title = "Impactos - Ações durante a Pandemia - Projetos")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Teses**

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r pandemia-tese, eval = has.sucupira.files}
# tcc
sheet <- "TCC - Financiadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

periodos <- names(sucupira.list)
periodo <- as.character(seq(min(periodos), max(periodos), by = 1))
tcc.all <- do.call(rbind.data.frame, sucupira.list[periodos])

# dplyr::selecting those with COVID in the title
tcc.all <-
  tcc.all[grep(paste(tolower(pandemia), collapse = "|"),
           tolower(tcc.all$`Nome do Trabalho de Conclusão`)),]

tcc <-
  tcc.all[tcc.all$`Tipo de Trabalho de Conclusão` == "TESE",]

# make unique ID
id.TCC <- tcc$"Identificador do Trabalho de Conclusão"
id.TCC <- unique(id.TCC)
for (i in 1:length(id.TCC)) {
  # select current ID
  banca <- tcc[tcc$"Identificador do Trabalho de Conclusão" == id.TCC[i], ]
  paises <- paste0(unique(banca$"País da Pessoa da Banca"), collapse = ", ")
  tcc$`País da Pessoa da Banca`[match(id.TCC[i], tcc$"Identificador do Trabalho de Conclusão")] <- paises
}

table.tese <- data.frame(
  "Ano" = rep(NA, length(id.TCC)),
  "Linha de Pesquisa" = rep(NA, length(id.TCC)),
  "Título" = rep(NA, length(id.TCC)),
  "Autor" = rep(NA, length(id.TCC)),
  "Orientadores" = rep(NA, length(id.TCC)),
  "Financiadores" = rep(NA, length(id.TCC)),
  "País" = rep(NA, length(id.TCC)),
  check.names = FALSE
)
  
if (!sjmisc::is_empty(id.TCC)) {
  # select data
  table.tese <-
    data.frame(
      "Ano" = format((as.Date(gsub("/", "-", tcc$'Data da Defesa'), "%d-%m-%Y")), "%Y"),
      "Linha de Pesquisa" = tcc$`Linha de Pesquisa`,
      "Título" = tcc$`Nome do Trabalho de Conclusão`,
      "Autor" = tcc$`Nome do Autor`,
      "Orientadores" = tcc$`Nome do Orientador`,
      "Financiadores" = tcc$`Nome do Financiador`,
      "País" = tcc$`País da Pessoa da Banca`,
      check.names = FALSE
    )
  
  table.tese[, 2] <-
    as.vector(unlist(lapply(table.tese[, 2], FUN = stringr::str_to_title)))
  table.tese[, 3] <-
    as.vector(unlist(lapply(table.tese[, 3], FUN = stringr::str_to_sentence)))
  table.tese[, 4] <-
    as.vector(unlist(lapply(table.tese[, 4], FUN = stringr::str_to_title)))
  table.tese[, 5] <-
    as.vector(unlist(lapply(table.tese[, 5], FUN = stringr::str_to_title)))
  table.tese[, 6] <-
    as.vector(unlist(lapply(table.tese[, 6], FUN = stringr::str_to_title)))

  # drop duplicated entries
  table.tese <- table.tese[!duplicated(table.tese), ]
  
  # sort by Ano and Titulo
  table.tese <- dplyr::arrange(table.tese, dplyr::desc(Ano), Título)
}

# print table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.tese, title = "Repositório - Teses")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Dissertações**

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r pandemia-dissertacao, eval = has.sucupira.files}
# tcc
sheet <- "TCC - Financiadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

periodos <- names(sucupira.list)
periodo <- as.character(seq(min(periodos), max(periodos), by = 1))
tcc.all <- do.call(rbind.data.frame, sucupira.list[periodos])

# dplyr::selecting those with COVID in the title
tcc.all <-
  tcc.all[grep(paste(tolower(pandemia), collapse = "|"),
           tolower(tcc.all$`Nome do Trabalho de Conclusão`)),]

tcc <-
  tcc.all[tcc.all$`Tipo de Trabalho de Conclusão` == "DISSERTAÇÃO",]

# make unique ID
id.TCC <- tcc$"Identificador do Trabalho de Conclusão"
id.TCC <- unique(id.TCC)
for (i in 1:length(id.TCC)) {
  # select current ID
  banca <- tcc[tcc$"Identificador do Trabalho de Conclusão" == id.TCC[i], ]
  paises <- paste0(unique(banca$"País da Pessoa da Banca"), collapse = ", ")
  tcc$`País da Pessoa da Banca`[match(id.TCC[i], tcc$"Identificador do Trabalho de Conclusão")] <- paises
}

table.dissert <- data.frame(
  "Ano" = rep(NA, length(id.TCC)),
  "Linha de Pesquisa" = rep(NA, length(id.TCC)),
  "Título" = rep(NA, length(id.TCC)),
  "Autor" = rep(NA, length(id.TCC)),
  "Orientadores" = rep(NA, length(id.TCC)),
  "Financiadores" = rep(NA, length(id.TCC)),
  "País" = rep(NA, length(id.TCC)),
  check.names = FALSE
)

if (!sjmisc::is_empty(id.TCC)) {
  # select data
  table.dissert <-
    data.frame(
      "Ano" = format((as.Date(gsub("/", "-", tcc$'Data da Defesa'), "%d-%m-%Y")), "%Y"),
      "Linha de Pesquisa" = tcc$`Linha de Pesquisa`,
      "Título" = tcc$`Nome do Trabalho de Conclusão`,
      "Autor" = tcc$`Nome do Autor`,
      "Orientadores" = tcc$`Nome do Orientador`,
      "Financiadores" = tcc$`Nome do Financiador`,
      "País" = tcc$`País da Pessoa da Banca`,
      check.names = FALSE
    )
  
  table.dissert[, 2] <-
    as.vector(unlist(lapply(table.dissert[, 2], FUN = stringr::str_to_title)))
  table.dissert[, 3] <-
    as.vector(unlist(lapply(table.dissert[, 3], FUN = stringr::str_to_sentence)))
  table.dissert[, 4] <-
    as.vector(unlist(lapply(table.dissert[, 4], FUN = stringr::str_to_title)))
  table.dissert[, 5] <-
    as.vector(unlist(lapply(table.dissert[, 5], FUN = stringr::str_to_title)))
  table.dissert[, 6] <-
    as.vector(unlist(lapply(table.dissert[, 6], FUN = stringr::str_to_title)))

  # drop duplicated entries
  table.dissert <- table.dissert[!duplicated(table.dissert), ]
  
  # sort by Ano and Titulo
  table.dissert <- dplyr::arrange(table.dissert, dplyr::desc(Ano), Título)
}

# print table
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.dissert, title = "Repositório - Dissertações")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Produção bibliográfica** {#producao-bibliografica}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r producao-bibliografica-tabela, eval = has.sucupira.files}
# produção
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
produtos <- sucupira.list[as.character(anos)] %>%
  plyr::compact()
produtos <- data.frame(do.call(dplyr::bind_rows, produtos))
names(produtos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# select products
produtos <- produtos[produtos$`Tipo de Produção` == "BIBLIOGRÁFICA", ]

# get years
produtos$'Ano' <- substr(as.Date(produtos$`Ano da Produção`, format = "%Y"), 1, 4)

# dplyr::selecting those with COVID in the title
produtos <-
  produtos[grep(paste(tolower(pandemia), collapse = "|"),
                    tolower(produtos$`Nome da Produção`)),]

# format names
produtos$`Nome da Produção` <- tools::toTitleCase(tolower(produtos$`Nome da Produção`))
produtos$`Nome do Autor` <- tools::toTitleCase(tolower(produtos$`Nome do Autor`))
produtos$`Categoria do Autor` <- tools::toTitleCase(tolower(produtos$`Categoria do Autor`))

# produção detalhes
produtos.detalhes <- metricas_all

# loop
produtos.list <- list()
if (dim(produtos)[1] != 0) {
  for (i in 1:length(unique(produtos$"ID da Produção"))) {
    id <- unique(produtos$"ID da Produção")[i]
    produtos.id <- produtos[produtos$"ID da Produção" == id,]
    for (j in 1:length(produtos.id$"Nome do Autor")) {
      try(if (produtos.id$"Categoria do Autor"[j] == "Discente") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "¹", "</b>")
      }, silent = TRUE)
      try(if (produtos.id$"Categoria do Autor"[j] == "Egresso") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "²", "</b>")
      }, silent = TRUE)
      try(if (produtos.id$"Categoria do Autor"[j] == "Docente") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "³", "</b>")
      }, silent = TRUE)
    }
    # get product metadata
    source("Scripts/get-producao-metadata.R", local = knitr::knit_global())
    metadata <- get_id_metadata(id = id, subtipo = unique(produtos.id$`Subtipo de Produção`), produtos.detalhes = produtos.detalhes)
    produtos.list[[i]] <- data.frame(
      "Ano" = produtos.id$"Ano da Produção"[1],
      "Título" = produtos.id$"Nome da Produção"[1],
      "Autores" = paste0(
        # remove NA values from Nome do Autor
        produtos.id$"Nome do Autor"[!is.na(produtos.id$"Nome do Autor")],
        collapse = "; "
      ),
      "Detalhamento" = metadata$detalhamento[1],
      "Altmetric" = unique(produtos.detalhes$altmetric_score[produtos.detalhes$"ID da Produção" == id]),
      "CiteScore" = unique(produtos.detalhes$SJR[produtos.detalhes$"ID da Produção" == id]),
      "SJR" = unique(produtos.detalhes$CiteScore[produtos.detalhes$"ID da Produção" == id]),
      "Qualis" = unique(produtos.detalhes$Qualis[produtos.detalhes$"ID da Produção" == id]),
      "Citações" = unique(produtos.detalhes$citations[produtos.detalhes$"ID da Produção" == id])
    )
  }
}
produtos.df <- data.frame(do.call(dplyr::bind_rows, produtos.list))

# remove duplicates
produtos.df <- unique(produtos.df)

table <- produtos.df %>% dplyr::arrange(
  dplyr::desc(as.numeric(produtos.df$'Ano')),
  produtos.df$'Título'
)

cat('\n\n<!-- -->\n\n')

source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table, title = "Impacto - Ações durante a pandemia - Produções bibliográficas (¹Discente, ²Egresso, ³Docente)")
cat("**Autoria**: ¹Discente, ²Egresso, ³Docente")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Produção técnica** {#producao-tecnica}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r producao-tecnica-tabela, eval = has.sucupira.files}
# produção
sheet <- "Produções - Autores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get data for the current period
produtos <- sucupira.list[as.character(anos)] %>%
  plyr::compact()
produtos <- data.frame(do.call(dplyr::bind_rows, produtos))
names(produtos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# select products
produtos <- produtos[produtos$`Tipo de Produção` == "TÉCNICA", ]

# get years
produtos$'Ano' <- substr(as.Date(produtos$`Ano da Produção`, format = "%Y"), 1, 4)

# dplyr::selecting those with COVID in the title
produtos <-
  produtos[grep(paste(tolower(pandemia), collapse = "|"),
                    tolower(produtos$`Nome da Produção`)),]

# format names
produtos$`Nome da Produção` <- tools::toTitleCase(tolower(produtos$`Nome da Produção`))
produtos$`Nome do Autor` <- tools::toTitleCase(tolower(produtos$`Nome do Autor`))
produtos$`Categoria do Autor` <- tools::toTitleCase(tolower(produtos$`Categoria do Autor`))

# produção detalhes
produtos.detalhes <- metricas_all

# loop
produtos.list <- list()
if (dim(produtos)[1] != 0) {
  for (i in 1:length(unique(produtos$"ID da Produção"))) {
    id <- unique(produtos$"ID da Produção")[i]
    produtos.id <- produtos[produtos$"ID da Produção" == id,]
    for (j in 1:length(produtos.id$"Nome do Autor")) {
      try(if (produtos.id$"Categoria do Autor"[j] == "Discente") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "¹", "</b>")
      }, silent = TRUE)
      try(if (produtos.id$"Categoria do Autor"[j] == "Egresso") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "²", "</b>")
      }, silent = TRUE)
      try(if (produtos.id$"Categoria do Autor"[j] == "Docente") {
        produtos.id$"Nome do Autor"[j] <-
          paste0("<b>", produtos.id$"Nome do Autor"[j], "³", "</b>")
      }, silent = TRUE)
    }
    # get product metadata
    source("Scripts/get-producao-metadata.R", local = knitr::knit_global())
    metadata <- get_id_metadata(id = id, subtipo = unique(produtos.id$`Subtipo de Produção`), produtos.detalhes = produtos.detalhes)
    produtos.list[[i]] <- data.frame(
      "Ano" = produtos.id$"Ano da Produção"[1],
      "Título" = produtos.id$"Nome da Produção"[1],
      "Autores" = paste0(
        # remove NA values from Nome do Autor
        produtos.id$"Nome do Autor"[!is.na(produtos.id$"Nome do Autor")],
        collapse = "; "
      ),
      "Detalhamento" = metadata$detalhamento[1],
      "Altmetric" = unique(produtos.detalhes$altmetric_score[produtos.detalhes$"ID da Produção" == id]),
      "CiteScore" = unique(produtos.detalhes$SJR[produtos.detalhes$"ID da Produção" == id]),
      "SJR" = unique(produtos.detalhes$CiteScore[produtos.detalhes$"ID da Produção" == id]),
      "Qualis" = unique(produtos.detalhes$Qualis[produtos.detalhes$"ID da Produção" == id]),
      "Citações" = unique(produtos.detalhes$citations[produtos.detalhes$"ID da Produção" == id])
    )
  }
}
produtos.df <- data.frame(do.call(dplyr::bind_rows, produtos.list))

# remove duplicates
produtos.df <- unique(produtos.df)

table <- produtos.df %>% dplyr::arrange(
  dplyr::desc(as.numeric(produtos.df$'Ano')),
  produtos.df$'Título'
)

cat('\n\n<!-- -->\n\n')

source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table, title = "Impacto - Ações durante a pandemia - Produções técnicas (¹Discente, ²Egresso, ³Docente)")
cat("**Autoria**: ¹Discente, ²Egresso, ³Docente")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>
