---
title: Pessoas
output:
  html_document:
    toc: true
    toc_float: true
    css:
      - ./CSS/generic.css
      - ./CSS/logo-above-toc.css
      - ./CSS/main-color.css
      - ./CSS/narrow-margins.css
      - ./CSS/responsive.css
---

<!--set up-->
```{r setup, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', out.width = "100%", results = "hide"}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  results = "asis",
  include = TRUE,
  out.width = "100%",
  knitr.kable.NA = '',
  knitr.table.format = ifelse(knitr::is_html_output(), "html", "latex"),
  webshot = "webshot",
  dev = "png"
)
```

<!--load caches-->
```{r load-caches, echo = FALSE, include = FALSE}
folders <- list.dirs(file.path("cache/"), full.names = FALSE, recursive = FALSE)
for(folder in folders){
    knitr::load_cache(label = folder, path = paste0(file.path("cache", folder), "/"))
}
```

<!--script for inserting LOGO ABOVE THE TOC-->
```{js}
$(document).ready(function() {
  $('#TOC').parent().prepend('<div id=\"nav_logo\"><img src="PPG/Images/logo-programa.png"></div>');
  });
```

<!--script for sharing-->
<p align="right">
```{r share}
home <- metadata$repository_url
source("Scripts/social-media-sharing.R", local = knitr::knit_global())
```
</p>

<br>

## **Secretaria** {#secretaria}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.dados.cadastrais}
cat('<br>')
```

```{r dados-cadastrais-endereco, eval = has.dados.cadastrais}
# Read Excel data
endereco.raw <- readxl::read_excel("PPG/Dados Cadastrais.xlsx", sheet = "Endereço", col_types = c("text"))
colnames(endereco.raw) <- seq(1:dim(endereco.raw)[2])

# Resolve long URLs
for (i in 1:dim(endereco.raw)[1]) {
  if (length(grep('https://', endereco.raw[i, 2])) != 0) {
    endereco.raw[i, 2] <-
      paste0('<a href=\"',
             endereco.raw[i, 2],
             '\" target=\"_blank\"',
             '>',
             # fontawesome icon
             fontawesome::fa("up-right-from-square"),
             '</a>')
  }
}

# Print tables
table <- unname(as.data.frame(endereco.raw))

print(
  knitr::kable(table, align = c("l", rep("c", ncol(table) - 2), "r"), escape = FALSE, format = ifelse(knitr::is_html_output(), "html", "latex")) %>%
    kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = T,
      position = "center"
    )
)

# Print sources
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Coordenação** {#coordenacao}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.coordenacao}
cat('<br>')
```

```{r coordenadores, eval = has.coordenacao}
# Import necessary libraries with `library::function` notation
library(readxl)
library(kableExtra)

# Read Excel data
coordenadores <- readxl::read_excel("PPG/Coordenação.xlsx", sheet = "Coordenação")

# Recode dates
coordenadores$'Credenciamento' <- substr(as.Date(coordenadores$'Credenciamento', format = "%d/%m/%Y"), 1, 4)
coordenadores$'Descredenciamento' <- substr(as.Date(coordenadores$'Descredenciamento', format = "%d/%m/%Y"), 1, 4)
coordenadores$'Descredenciamento'[is.na(coordenadores$'Descredenciamento')] <- "Atual"

# Initialize empty data frame
table.coord <- data.frame(matrix(NA, nrow = 0, ncol = 4))

# Iterate through rows to construct table
for (i in 1:dim(coordenadores)[1]) {
  table <- cbind(
    paste0('<a href=\"mailto:', coordenadores$"E-mail"[i], '\">', coordenadores$'Nome'[i], '</a>'),
    coordenadores$Categoria[i],
    paste0(coordenadores$'Credenciamento'[i], "-", coordenadores$'Descredenciamento'[i])
  )
  table.coord <- rbind(table.coord, table)
}

# Set column and row names
colnames(table.coord) <- c("Nome", "Categoria", "Vigência")
rownames(table.coord) <- NULL

# Print tables
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.coord, title = "Pessoas - Coordenação")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Docentes** {#docentes .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Credenciados** {#credenciados .tabset}

```{r docentes-credenciados, eval = has.sucupira.files, results = "hide"}
# Read Excel data
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Set the names of the Sucupira list
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Determine the most recent Sucupira year
most.recent <- as.character(ifelse(!is.null(sucupira.list[[format(Sys.Date(), "%Y")]]), format(Sys.Date(), "%Y"), max(as.numeric(names(sucupira.list)))))

# Define the periodo
periodo <- most.recent

# Get docentes for the current period
sucupira <- sucupira.list[as.character(periodo)] %>% compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# Recode dates
sucupira$'Data de Admissão' <- substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <- substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <- "Atual"

# Filter duplicated docentes
docentes <- sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Carga Horária PG (Semanal)", colnames(sucupira))]), ]
docentes <- docentes[order(docentes$"Nome Docente"),]
```

```{r docentes-credenciados-tabela, eval = has.sucupira.files}
# Initialize empty data frame
table.doc.cred <- data.frame(matrix(NA, nrow = 0, ncol = 7))

# Iterate through rows to construct table
for (i in 1:dim(docentes)[1]) {
  table <- cbind(
    paste0(
      '<a href=\"mailto:',
      docentes$"E-mail"[i],
      '\">',
      docentes$'Nome Docente'[i],
      '</a>'
    ),
    docentes$Categoria[i],
    paste0(
      docentes$'Data de Admissão'[i],
      "-",
      docentes$'Data de Desligamento'[i]
    ),
    ifelse(
      !is.na(docentes$'Número do currículo Lattes'[i]),
      paste0(
        '<a href=\"http://lattes.cnpq.br/',
        docentes$'Número do currículo Lattes'[i],
        '\">',
        docentes$'Número do currículo Lattes'[i],
        '</a>'
      ),
      docentes$'Número do currículo Lattes'[i]
    ),
    ifelse(
      !is.na(docentes$ORCID[i]),
      paste0(
        '<a href=\"https://orcid.org/',
        paste0(sapply(seq(
          from = 1,
          to = nchar(docentes$ORCID[i]),
          by = 4
        ),
        function(j)
          substr(docentes$ORCID[i], j, j + 3)), collapse = "-"),
        '\">',
        paste0(sapply(seq(
          from = 1,
          to = nchar(docentes$ORCID[i]),
          by = 4
        ),
        function(j)
          substr(docentes$ORCID[i], j, j + 3)), collapse = "-"),
        '</a>'
      ),
      docentes$ORCID[i]
    ),
    docentes$País[i]
  )
  table.doc.cred <- rbind(table.doc.cred, table)
}

# Set column and row names
colnames(table.doc.cred) <-
  c("Nome",
    "Categoria",
    "Credenciamento",
    "Lattes ID",
    "ORCID",
    "País")
rownames(table.doc.cred) <- NULL

# Order table
ids <- order(table.doc.cred$'Nome', decreasing = FALSE)
table.doc.cred <- table.doc.cred[ids,]

# Print tables
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.doc.cred, title = "Pessoas - Docentes - Credenciados")

# Print sources
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Histórico** {#historico .tabset}

```{r docentes-historico, eval = has.sucupira.files, results = "hide"}
# docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# periodo
periodo <- anos

# get docentes for the current period
sucupira <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# recode
sucupira$'Data de Admissão' <-
  substr(as.Date(sucupira$'Data de Admissão', format = "%d/%m/%Y"), 1, 4)
sucupira$'Data de Desligamento' <-
  substr(as.Date(sucupira$'Data de Desligamento', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Data de Desligamento'[is.na(sucupira$'Data de Desligamento')] <-
  "Atual"

# filter duplicated docentes (changes in details will we exhibited)
docentes <-
  sucupira[!duplicated(sucupira[, match("Nome Docente", colnames(sucupira)):match("Carga Horária PG (Semanal)", colnames(sucupira))]),]
docentes <- docentes[order(docentes$"Nome Docente"), ]
```

```{r docentes-historico-tabela, eval = has.sucupira.files}
# Initialize empty data frame
table.doc.hist <- data.frame(matrix(NA, nrow = 0, ncol = 7))

# Iterate through rows to construct table
for (i in 1:dim(docentes)[1]) {
  table <- cbind(
    paste0(
      '<a href=\"mailto:',
      docentes$"E-mail"[i],
      '\">',
      docentes$'Nome Docente'[i],
      '</a>'
    ),
    docentes$Categoria[i],
    paste0(
      docentes$'Data de Admissão'[i],
      "-",
      docentes$'Data de Desligamento'[i]
    ),
    ifelse(
      !is.na(docentes$'Número do currículo Lattes'[i]),
      paste0(
        '<a href=\"http://lattes.cnpq.br/',
        docentes$'Número do currículo Lattes'[i],
        '\">',
        docentes$'Número do currículo Lattes'[i],
        '</a>'
      ),
      docentes$'Número do currículo Lattes'[i]
    ),
    ifelse(
      !is.na(docentes$ORCID[i]),
      paste0(
        '<a href=\"https://orcid.org/',
        paste0(sapply(seq(
          from = 1,
          to = nchar(docentes$ORCID[i]),
          by = 4
        ),
        function(j)
          substr(docentes$ORCID[i], j, j + 3)), collapse = "-"),
        '\">',
        paste0(sapply(seq(
          from = 1,
          to = nchar(docentes$ORCID[i]),
          by = 4
        ),
        function(j)
          substr(docentes$ORCID[i], j, j + 3)), collapse = "-"),
        '</a>'
      ),
      docentes$ORCID[i]
    ),
    docentes$País[i]
  )
  table.doc.hist <- rbind(table.doc.hist, table)
}

# Set column names
colnames(table.doc.hist) <-
  c("Nome",
    "Categoria",
    "Credenciamento",
    "Lattes ID",
    "ORCID",
    "País")
rownames(table.doc.hist) <- NULL

# Order table
ids <- order(table.doc.hist$'Nome', decreasing = FALSE)
table.doc.hist <- table.doc.hist[ids,]

# Print tables
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.doc.hist, title = "Docentes - Histórico")

# Print sources
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Diretório CNPq** {#dgp-cnpq .tabset}

```{r dgp-cnpq, eval = has.sucupira.files}
# Read Excel data
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Set the names of the Sucupira list
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Determine the most recent Sucupira year
most.recent <- as.character(ifelse(!is.null(sucupira.list[[format(Sys.Date(), "%Y")]]), format(Sys.Date(), "%Y"), max(as.numeric(names(sucupira.list)))))

# Read separate sheets
docentes.raw <- sucupira.list[[most.recent]]
docentes <- docentes.raw[is.na(docentes.raw$`Data de Desligamento`),]

# Remove duplicates between docs and postdocs
docentes <- docentes[!duplicated(docentes$`Nome Docente`),]

# Order docentes
docentes <- docentes[order(docentes$`Nome Docente`), ]

# Generate output for each docente
for (i in 1:dim(docentes)[1]) {
  cat('\n\n<!-- -->\n\n')
  cat("#### **", as.character(i), "**", "\n", sep = "")
  cat('<center>\n')
  if (!is.na(docentes$`Número do currículo Lattes`[i])) {
    cat(
      paste0(
        '<iframe src="https://dgp.cnpq.br/dgp/espelhorh/',
        gsub("http://lattes.cnpq.br/", "", docentes$`Número do currículo Lattes`[i]),
        '\" style=\"width:100%; height:600px; border:2px solid black;\"></iframe>'
      )
    )
  } else {
    cat("<br>No data available<br>")
  }
  cat('\n</center>')
  cat('\n\n<!-- -->\n\n')
  cat(paste0('**Fontes**: [**Diretório dos Grupos de Pesquisa no Brasil**](https://dgp.cnpq.br/dgp/espelhorh/', docentes$`Número do currículo Lattes`[i]),')')
  cat('\n\n<!-- -->\n\n')
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
}

# Additional sources
cat('\n\n')
cat('**Fontes**: [**Diretório dos Grupos de Pesquisa**](https://lattes.cnpq.br/web/dgp)')
cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

### **ID Externo** {#id .tabset}

```{r ids-externos-docentes, cache = TRUE, cache.path = "cache/external-ids/", eval = has.sucupira.files}
# Read Excel data
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# Set the names of the Sucupira list
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Determine the most recent Sucupira year
most.recent <- as.character(ifelse(!is.null(sucupira.list[[format(Sys.Date(), "%Y")]]), format(Sys.Date(), "%Y"), max(as.numeric(names(sucupira.list)))))

# Define the periodo
periodo <- most.recent

# Get docentes for the current period
sucupira <- sucupira.list[as.character(periodo)] %>% compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# Keep active professors and remove duplicated data
sucupira <- sucupira[is.na(sucupira.raw$`Data de Desligamento`),]
sucupira.unique <- sucupira[!duplicated(sucupira$`Nome Docente`) & !is.na(sucupira$ORCID),]

# order by name
sucupira.unique <- sucupira.unique[order(sucupira.unique$`Nome Docente`, decreasing = FALSE),]

# Format ORCID
my_orcid <- gsub("(.{14})(.*)$", "\\1-\\2", gsub("(.{9})(.*)$", "\\1-\\2", gsub("(.{4})(.*)$", "\\1-\\2", sucupira.unique$ORCID)))

# Compile external identifiers
source("Scripts/orcid-external-identifiers.R", local = knitr::knit_global())

# Print tables
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(external.ids, title = "Pessoas - IDs externos")

cat('\n\n')
cat('**Fontes**: [**Plataforma Sucupira**](https://sucupira.capes.gov.br/sucupira/), [**ORCID**](https://orcid.org)')
cat('\n\n')
if (knitr::is_html_output()) {
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
}
```

<br>

## **Pós-doutorandos** {#posdocs .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Credenciados** {#posdocs-credenciados .tabset}

```{r pos-doc-credenciados, eval = has.sucupira.files}
# Pós-docs
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# Most recent Sucupira year
most.recent <- as.character(ifelse(!is.null(sucupira.list[[format(Sys.Date(), "%Y")]]), format(Sys.Date(), "%Y"), max(as.numeric(names(sucupira.list)))))

# Period
periodo <- most.recent

# Get pós-docs for the current period
sucupira <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <- names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# Recode
sucupira$'Vínculo Início' <- substr(as.Date(sucupira$'Vínculo Início', format = "%d/%m/%Y"), 1, 4)
sucupira$'Vínculo Fim' <- substr(as.Date(sucupira$'Vínculo Fim', format = "%d/%m/%Y"), 1, 4)
sucupira$'Vínculo Fim'[is.na(sucupira$'Vínculo Fim')] <- "Atual"

# Filter duplicated pós-docs (changes in details will be exhibited)
docentes <- sucupira[
  !duplicated(sucupira[, match("Pós-Doc Nome", colnames(sucupira)):match("Vínculo Fim", colnames(sucupira))]), ]
docentes <- docentes[order(docentes$"Pós-Doc Nome"),]

table.posdoc.cred <- data.frame(matrix(NA, nrow = 0, ncol = 5))
if (!sjmisc::is_empty(docentes)) {
  docentes <- docentes[order(docentes$'Pós-Doc Nome'),]

  for (i in 1:dim(docentes)[1]) {
    table <- cbind(
      paste0(
        '<a href=\"mailto:',
        docentes$"E-mail"[i],
        '\">',
        docentes$'Pós-Doc Nome'[i],
        '</a>'
      ),
      docentes$'Origem IES Nome'[i],
      paste0(
        docentes$'Vínculo Início'[i],
        "-",
        docentes$'Vínculo Fim'[i]
      ),
      ifelse(
        !is.na(docentes$ORCID[i]),
        paste0(
          '<a href=\"https://orcid.org/',
          paste0(sapply(seq(from=1, to=nchar(docentes$ORCID[i]), by=4), function(j) substr(docentes$ORCID[i], j, j+3)), collapse = "-"),
          '\">',
          paste0(sapply(seq(from=1, to=nchar(docentes$ORCID[i]), by=4), function(j) substr(docentes$ORCID[i], j, j+3)), collapse = "-"),
          '</a>'
        ),
        docentes$ORCID[i]
      ),
      docentes$País[i]
    )
    table.posdoc.cred <- rbind(table.posdoc.cred, table)
  }
}

colnames(table.posdoc.cred) <-
  c("Nome", "Instituição de origem", "Vigência", "ORCID", "País")
rownames(table.posdoc.cred) <- NULL

table.posdoc.cred <- table.posdoc.cred[order(table.posdoc.cred$'Nome', decreasing = FALSE), ]

source("Scripts/table-with-buttons.R", local = knitr::knit_global())
cat(knitr::knit_print(create_dt(table.posdoc.cred, title = "Pessoas - Pós-Docs - Credenciados")))

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Histórico** {#posdocs-historico}

```{r pos-doc-historico, eval = has.sucupira.files}
# pós-docs
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# periodo
periodo <- anos

# get docentes for the current period
sucupira <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
sucupira <- data.frame(do.call(dplyr::bind_rows, sucupira))
names(sucupira) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# recode
sucupira$'Vínculo Início' <-
  substr(as.Date(sucupira$'Vínculo Início', format = "%d/%m/%Y"), 1, 4)
sucupira$'Vínculo Fim' <-
  substr(as.Date(sucupira$'Vínculo Fim', format = "%d/%m/%Y"),
         1,
         4)
sucupira$'Vínculo Fim'[is.na(sucupira$'Vínculo Fim')] <-
  "Atual"

# filter duplicated docentes (changes in details will we exhibited)
docentes <-
  sucupira[
    !duplicated(
      sucupira[, 
          match("Pós-Doc Nome", colnames(sucupira)):match("Vínculo Fim", colnames(sucupira))]
      ), ]
docentes <- docentes[order(docentes$"Pós-Doc Nome"),]

table.posdoc.hist <- data.frame(matrix(NA, nrow = 0, ncol = 5))
if (dim(docentes)[1] != 0) {
  docentes <- docentes[order(docentes$'Pós-Doc Nome'),]
  
  for (i in 1:dim(docentes)[1]) {
    table <- cbind(
      paste(
        '<a href=\"mailto:',
        docentes$"E-mail"[i],
        '\">',
        docentes$'Pós-Doc Nome'[i],
        '</a>',
        sep = ""
      ),
      docentes$'Origem IES Nome'[i],
      paste(
        docentes$'Vínculo Início'[i],
        "-",
        docentes$'Vínculo Fim'[i],
        sep = ""
      ),
      ifelse(
        !is.na(docentes$ORCID[i]),
        paste(
          '<a href=\"https://orcid.org/',
          paste0(sapply(seq(from=1, to=nchar(docentes$ORCID[i]), by=4), function(j) substr(docentes$ORCID[i], j, j+3)), collapse = "-"),
          '\">',
          paste0(sapply(seq(from=1, to=nchar(docentes$ORCID[i]), by=4), function(j) substr(docentes$ORCID[i], j, j+3)), collapse = "-"),
          '</a>',
          sep = ""
        ),
        docentes$ORCID[i]
      ),
      docentes$País[i]
    )
    table.posdoc.hist <- rbind(table.posdoc.hist, table)
  }
}
colnames(table.posdoc.hist) <-
  c("Nome", "Instituição de origem", "Vigência", "ORCID", "País")
rownames(table.posdoc.hist) <- NULL

table.posdoc.hist <- table.posdoc.hist[order(table.posdoc.hist$'Nome', decreasing = FALSE), ]

source("Scripts/table-with-buttons.R", local = knitr::knit_global())
cat(knitr::knit_print(create_dt(table.posdoc.hist, title = "Pessoas - Pós-Docs - Histórico")))
  
source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Discentes** {#discentes .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Matriculados** {#matriculados .tabset}

```{r discentes-inscritos, eval = has.sucupira.files}
# discentes
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get only last data available
discentes <- sucupira.list[[length(anos)]]

# dplyr::select active students
discentes <- discentes[discentes$`Situação Discente` == "MATRICULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
discentes <- discentes[discentes$`Orientador Principal?` == "Sim", ]

# calculate deadlines
discentes$'Tempo em curso' <-
  lubridate::interval(start = lubridate::dmy(gsub("/", "", discentes$`Data Matrícula`)), end = lubridate::today()) %/% months(1)
discentes$'Defesa até' <-
  format(as.Date(discentes$`Data Matrícula`, format = "%d/%m/%Y") + 365 *
           ifelse(tolower(discentes$`Nível Discente`) == "doutorado", 4, 2),
         format = "%d/%m/%Y")

# get years
discentes$'Ano de Matrícula' <- substr(as.Date(discentes$`Data Matrícula`, format = "%d/%m/%Y"), 1, 4)

# format names
discentes$`Nível Discente` <- tools::toTitleCase(tolower(discentes$`Nível Discente`))
discentes$`Nome Discente` <- tools::toTitleCase(tolower(discentes$`Nome Discente`))
discentes$`Nome do Orientador` <- tools::toTitleCase(tolower(discentes$`Nome do Orientador`))

# drop columns
discentes <- discentes %>% dplyr::select("Nível Discente", "Ano de Matrícula", "Nome Discente", "Nome do Orientador", "Data Matrícula", "Tempo em curso", "Defesa até", "País")

# remove duplicates and empty rows
discentes <- unique(discentes)
discentes <- discentes[complete.cases(discentes), ]

if (dim(discentes)[1] != 0) {
  ids <- order(discentes$'Ano de Matrícula', discentes$'Tempo em curso', discentes$'Nome Discente', decreasing = TRUE)
  discentes <- discentes[ids,]
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(discentes, title = "Pessoas - Discentes - Matriculados")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Prazos** {#prazos}

```{r discentes-prazos-sintese, eval = has.sucupira.files}
discentes$'Ano de matrícula' <-
  format(as.Date(discentes$'Data Matrícula', format = "%d/%m/%Y"), format = "%Y")

if (dim(discentes)[1] != 0) {
  summ.table <- table(discentes$'Ano de matrícula',
                      discentes$'Tempo em curso')
  summ.table[summ.table == 0] <- ""
  # print table
  print(
    knitr::kable(summ.table, align = c("l", rep(
      "c", ncol(summ.table) - 2
    ), "r"), escape = FALSE, format = ifelse(knitr::is_html_output(), "html", "latex")) %>% kableExtra::kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = T,
      position = "center"
    ) %>%
  kableExtra::add_header_above(c(" ", "Meses de curso" = dim(summ.table)[2]))
  )
} else {
  cat("*Sem dados para exibir*")
}

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Egressos** {#egressos .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Titulados** {#titulados}

```{r titulados, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
periodo <- min(max(as.numeric(format(Sys.Date(), "%Y"))), anos)

# egressos
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# get egressos for the current period
egressos <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
egressos <- data.frame(do.call(dplyr::bind_rows, egressos))
names(egressos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# dplyr::select active students
egressos <- egressos[egressos$`Situação Discente` == "TITULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
egressos <- egressos[egressos$`Orientador Principal?` == "Sim", ]

# get years
egressos$'Data Situação' <- substr(as.Date(egressos$`Data Situação`, format = "%d/%m/%Y"), 1, 4)

# format names
egressos$`Nome Discente` <- tools::toTitleCase(tolower(egressos$`Nome Discente`))
egressos$`Nome do Orientador` <- tools::toTitleCase(tolower(egressos$`Nome do Orientador`))

# drop columns (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
egressos <- egressos %>% dplyr::select("Nível Discente", "Data Situação", "Nome do Orientador", "Nome Discente", "País")

# remove duplicates
egressos <- unique(egressos)
colnames(egressos)[which(names(egressos) == "Nome Discente")] <- "Nome"

if (dim(egressos)[1] != 0) {
  egressos <- egressos %>% dplyr::arrange(
    dplyr::desc(egressos$'Data Situação'),
    egressos$'Nome Discente'
    )
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(egressos, title = "Pessoas - Egressos - Titulados")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **5 anos** {#egressos-5}

```{r historico-egressos-5, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
n.anos <- 5
periodo <- (as.numeric(format(Sys.Date(), "%Y")) - n.anos):(as.numeric(format(Sys.Date(), "%Y")) - 1)

# egressos
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

names(sucupira.list) <- as.character(anos)

# get egressos for the current period
egressos <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
egressos <- data.frame(do.call(dplyr::bind_rows, egressos))
names(egressos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# dplyr::select active students
egressos <- egressos[egressos$`Situação Discente` == "TITULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
egressos <- egressos[egressos$`Orientador Principal?` == "Sim", ]

# get years
egressos$'Data Situação' <- substr(as.Date(egressos$`Data Situação`, format = "%d/%m/%Y"), 1, 4)

# format names
egressos$`Nome Discente` <- tools::toTitleCase(tolower(egressos$`Nome Discente`))
egressos$`Nome do Orientador` <- tools::toTitleCase(tolower(egressos$`Nome do Orientador`))

# drop columns (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
egressos <- egressos %>% dplyr::select("Nível Discente", "Data Situação", "Nome do Orientador", "Nome Discente", "País")

# remove duplicates
egressos <- unique(egressos)
colnames(egressos)[which(names(egressos) == "Nome Discente")] <- "Nome"

if (dim(egressos)[1] != 0) {
  egressos <- egressos %>% dplyr::arrange(
    dplyr::desc(egressos$'Data Situação'),
    egressos$'Nome Discente'
    )
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(egressos, title = "Pessoas - Egressos - 5 anos")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **10 anos** {#egressos-10}

```{r historico-egressos-10, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
n.anos <- 10
periodo <- (as.numeric(format(Sys.Date(), "%Y")) - n.anos):(as.numeric(format(Sys.Date(), "%Y")) - 1)

# egressos
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

names(sucupira.list) <- as.character(anos)

# get egressos for the current period
egressos <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
egressos <- data.frame(do.call(dplyr::bind_rows, egressos))
names(egressos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# dplyr::select active students
egressos <- egressos[egressos$`Situação Discente` == "TITULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
egressos <- egressos[egressos$`Orientador Principal?` == "Sim", ]

# get years
egressos$'Data Situação' <- substr(as.Date(egressos$`Data Situação`, format = "%d/%m/%Y"), 1, 4)

# format names
egressos$`Nome Discente` <- tools::toTitleCase(tolower(egressos$`Nome Discente`))
egressos$`Nome do Orientador` <- tools::toTitleCase(tolower(egressos$`Nome do Orientador`))

# drop columns (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
egressos <- egressos %>% dplyr::select("Nível Discente", "Data Situação", "Nome do Orientador", "Nome Discente", "País")

# remove duplicates
egressos <- unique(egressos)
colnames(egressos)[which(names(egressos) == "Nome Discente")] <- "Nome"

if (dim(egressos)[1] != 0) {
  egressos <- egressos %>% dplyr::arrange(
    dplyr::desc(egressos$'Data Situação'),
    egressos$'Nome Discente'
    )
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(egressos, title = "Pessoas - Egressos - 10 anos")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Histórico** {#egressos-historico}

```{r historico-egressos, eval = has.sucupira.files}
# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())

# periodo
n.anos <- 100
periodo <- (as.numeric(format(Sys.Date(), "%Y")) - n.anos):(as.numeric(format(Sys.Date(), "%Y")))

# egressos
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())

names(sucupira.list) <- as.character(anos)

# get egressos for the current period
egressos <- sucupira.list[as.character(periodo)] %>%
  plyr::compact()
egressos <- data.frame(do.call(dplyr::bind_rows, egressos))
names(egressos) <-
  names(sucupira.list[[as.character(max(as.numeric(names(sucupira.list))))]])

# dplyr::select active students
egressos <- egressos[egressos$`Situação Discente` == "TITULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
egressos <- egressos[egressos$`Orientador Principal?` == "Sim", ]

# get years
egressos$'Data Situação' <- substr(as.Date(egressos$`Data Situação`, format = "%d/%m/%Y"), 1, 4)

# format names
egressos$`Nome Discente` <- tools::toTitleCase(tolower(egressos$`Nome Discente`))
egressos$`Nome do Orientador` <- tools::toTitleCase(tolower(egressos$`Nome do Orientador`))

# drop columns (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
egressos <- egressos %>% dplyr::select("Nível Discente", "Data Situação", "Nome do Orientador", "Nome Discente", "País")

# remove duplicates
egressos <- unique(egressos)
colnames(egressos)[which(names(egressos) == "Nome Discente")] <- "Nome"

if (dim(egressos)[1] != 0) {
  egressos <- egressos %>% dplyr::arrange(
    dplyr::desc(egressos$'Data Situação'),
    egressos$'Nome Discente'
    )
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(egressos, title = "Pessoas - Egressos - Histórico")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Distribuição nacional** {#egressos-nacional}

```{r egressos-periodo, eval = has.discentes}
egressos.raw <-
  readxl::read_excel(
    "PPG/Discentes.xlsx",
    sheet = "Discentes",
    col_types = c("text")
  )
egressos.raw <- egressos.raw[egressos.raw$País == "Brasil",]
egressos.raw$'Ano Titulação' <-
  substr(as.Date(egressos.raw$'Data Situação', format = "%d/%m/%Y"), 1, 4)

egressos.raw <- egressos.raw[!is.na(egressos.raw$'Data Situação'), ]
UF <- as.data.frame(table(egressos$UF))

# identifying available courses
cursos <- levels(as.factor(c(egressos.raw$Curso)))

# reading BR geospatial data from IPEA
states$egressos <- rep(NA, dim(states)[1])
for (i in 1:length(UF$Var1)) {
  states$egressos[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
}

# plot Brazil states per period
periodos <-
  rbind(cbind(2010, 2012), cbind(2013, 2016), cbind(2017, 2020), cbind(2021, 2024))
colnames(periodos) <- c("Início", "Fim")
rownames(periodos) <- c("Trienal", "Quadrienal", "Quadrienal", "Quadrienal")

par(
  oma = c(0, 0, 0, 0),
  mar = c(5.1, 4.1, 4.1, 2.1),
  bg = 'black',
  col.lab = "white",
  col.axis = "white",
  fg = "white",
  col.main = "white"
)
layout(matrix(seq(1:dim(periodos)[1]), ncol = dim(periodos)[1], byrow = TRUE))
maps <- list()
for (j in 1:dim(periodos)[1]) {
  egressos <-
    egressos.raw[egressos.raw$`Ano Titulação` >= periodos[j, 1] &
                egressos.raw$`Ano Titulação` <= periodos[j, 2], ]
  states$egressos <- rep(NA, dim(states)[1])
  UF <- as.data.frame(table(egressos$UF))
  for (i in 1:length(UF$Var1)) {
    states$egressos[states$abbrev_state == UF$Var1[i]] <- UF$Freq[i]
  }
  maps[[j]] <- ggplot2::ggplot() +
    ggplot2::geom_sf(
      data = states,
      ggplot2::aes(fill = egressos),
      color = NA,
      size = .15
    ) +
    ggplot2::scale_fill_distiller(
      palette = "Spectral",
      name = "Egressos, n",
      limits = c(min(0, UF$Freq), max(UF$Freq)),
      na.value = "grey"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.margin = unit(c(0, 0, 0, 0), "cm"),
      panel.background = ggplot2::element_rect(fill = "transparent",  color = "transparent"),
      plot.background = ggplot2::element_rect(fill = "transparent",  color = "transparent"),
      panel.grid.major = ggplot2::element_line(color = "transparent"),
      axis.text.x = ggplot2::element_blank(),
      axis.text.y = ggplot2::element_blank()
  ) +
    ggplot2::labs(subtitle = paste0(periodos[j, 1], "-", periodos[j, 2]),
         size = 12) +
    ggplot2::guides(fill = FALSE)
}
Rmisc::multiplot(plotlist = maps, cols = dim(periodos)[1])

cat('\n\n')
cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
```

<br>

## **Bacharelado** {#graduacao .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r discentes-ic, eval = has.sucupira.files}
# dplyr::select level
course.level <- "Bacharelado"

# discentes
sheet <- "Discentes - Orientadores"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
discentes <- sucupira.raw

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# filter students
discentes <- discentes[stringr::str_detect(discentes$`Nível Discente`, course.level), ]

# dplyr::select active students
discentes <- discentes[discentes$`Situação Discente` == "MATRICULADO", ]

# dplyr::select main supervisors (NO SUPERVISORS FOR UNDERGRAD STUDENTS)
# discentes <- discentes[discentes$`Orientador Principal?` == "Sim", ]

# remove duplicates
discentes <- unique(discentes)

# get years
discentes$'Ano de Matrícula' <- substr(as.Date(discentes$`Data Matrícula`, format = "%d/%m/%Y"), 1, 4)

# rename Ano de Matricula as Ano
discentes <- discentes %>% dplyr::rename("Ano" = "Ano de Matrícula")

# format names (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
discentes$`Nome Discente` <- tools::toTitleCase(tolower(discentes$`Nome Discente`))
# discentes$`Nome do Orientador` <- tools::toTitleCase(tolower(discentes$`Nome do Orientador`))

# drop columns (NO SUPERVISOR FOR UNDERGRAD STUDENTS)
discentes <- discentes %>% dplyr::select("Ano", "Nome Discente", "País")

if (dim(discentes)[1] != 0) {
  ids <- order(discentes$'Ano', discentes$'Nome Discente', decreasing = TRUE)
  discentes <- discentes[ids,]
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(discentes, title = "Pessoas - Discentes - Bacharelado")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Formação de pessoal** {#formacao-pessoal .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r formacao-continuada, eval = has.sucupira.files}
# Discentes
sheet <- "Discentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
discentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Discente`,
  `Nível Discente`,
  `Situação Discente`,
  `Data Matrícula`,
  `Data Situação`
)
colnames(discentes)[2] <- "Nome"
colnames(discentes)[3] <- "Nível"
colnames(discentes)[4] <- "Situação"

# Egressos
sheet <- "Egressos"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
egressos <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa do Egresso`,
  `Nome do Egresso`,
  `Nível Titulação`,
  `Ano Titulação`
)
colnames(egressos)[1] <- "Identificador da Pessoa"
colnames(egressos)[2] <- "Nome"
colnames(egressos)[3] <- "Nível"
try(egressos$Situação <- "EGRESSO", silent = TRUE)

# Pós-Doc
sheet <- "Pós-Doc"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
posdoc <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Pós-Doc Nome`,
  `Vínculo Início`,
  `Vínculo Fim`
)
colnames(posdoc)[2] <- "Nome"
try(posdoc$Situação <- "PÓS-DOC", silent = TRUE)

# Docentes
sheet <- "Docentes"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
# get data
docentes <- dplyr::select(
  sucupira.raw,
  `Identificador da Pessoa`,
  `Nome Docente`,
  `Data de Admissão`,
  `Data de Desligamento`
)
colnames(docentes)[2] <- "Nome"
try(docentes$Situação <- "DOCENTE", silent = TRUE)

# bind all data by "Identificador da Pessoa"
formacao.continuada <- dplyr::bind_rows(
  discentes,
  egressos,
  posdoc,
  docentes
)

# format names
formacao.continuada$Nome <- tools::toTitleCase(tolower(formacao.continuada$Nome))

# remove duplicates
formacao.continuada <- formacao.continuada %>%
  dplyr::distinct()

# sort by "Identificador da Pessoa"
formacao.continuada <- formacao.continuada %>%
  dplyr::arrange(`Identificador da Pessoa`)

# create table to fill with start-end year for each situation
table <- data.frame(
  "Nome" = NA,
  Bacharelado = NA,
  "Mestrado" = NA,
  "Doutorado" = NA,
  "Pós-Doc" = NA,
  "Docente" = NA,
  check.names = FALSE
)

ID <- unique(formacao.continuada$`Identificador da Pessoa`)
for (i in 1:length(ID)) {
  # select data by ID
  data <- formacao.continuada %>%
    dplyr::filter(`Identificador da Pessoa` == ID[i])
  # get name
  table[i, "Nome"] <- data$Nome[1]
  # get year of start and end for discentes equal to bacharelado
  table[i, "Bacharelado"] <- min(data$`Data Matrícula`[data$Nível == "Bacharelado"], na.rm = TRUE)
  table[i, "Bacharelado"] <- format(as.Date(table[i, "Bacharelado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to mestrado
  table[i, "Mestrado"] <- min(data$`Data Matrícula`[data$Nível == "Mestrado"], na.rm = TRUE)
  table[i, "Mestrado"] <- format(as.Date(table[i, "Mestrado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for discentes equal to doutorado
  table[i, "Doutorado"] <- min(data$`Data Matrícula`[data$Nível == "Doutorado"], na.rm = TRUE)
  table[i, "Doutorado"] <- format(as.Date(table[i, "Doutorado"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for pós-doc
  table[i, "Pós-Doc"] <- min(data$`Vínculo Início`, na.rm = TRUE)
  table[i, "Pós-Doc"] <- format(as.Date(table[i, "Pós-Doc"], format = "%d/%m/%Y"), "%Y")
  # get year of start and end for docentes
  table[i, "Docente"] <- min(data$`Data de Admissão`, na.rm = TRUE)
  table[i, "Docente"] <- format(as.Date(table[i, "Docente"], format = "%d/%m/%Y"), "%Y")
}

# add last colum with total number of years
table$Atuações <- apply(table, 1, function(x) {
  sum(!is.na(x)) - 1
})

# add last column with the lowest and higher levels of education. Paste levels
table$Formação <- apply(table, 1, function(x) {
  # drop first and last columns
  x <- x[-c(1, length(x))]
  # get lower column with data
  lower <- which(!is.na(x))[1]
  # get higher column with data
  higher <- which(!is.na(x))[length(which(!is.na(x)))]
  if(length(which(!is.na(x))) == 1) {
    return(names(x)[lower])
  } else {
    return(paste(names(x)[lower], names(x)[higher], sep = " - "))
  }
})

# sort by iniciacao científica, mestrado, doutorado, pós-doc, docente e nome
table.continuada <- table %>%
  dplyr::arrange(
    `Bacharelado`,
    `Mestrado`,
    `Doutorado`,
    `Pós-Doc`,
    `Docente`,
    Nome
  )

source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(table.continuada, title = "Pessoas - Formação de pessoal")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

## **Grupos de pesquisa** {#grupos-pesquisa .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

```{r, eval = !has.sucupira.files}
cat('<br>')
```

```{r grupos-pesquisa, eval = has.grupos.pesquisa}
# initialize all sheets
abas <- readxl::excel_sheets("PPG/Grupos de Pesquisa.xlsx")

# display each sheet in a tab
for (j in 1:length(abas)) {
  cat('\n\n<!-- -->\n\n')
  cat(paste0('### **', abas[j], '**'))
  cat('\n\n<!-- -->\n\n')
  grupos.raw <-
    readxl::read_excel("PPG/Grupos de Pesquisa.xlsx",
                       sheet = abas[j],
                       col_types = c("text"))
  
  # replace the link by a tag
  Abrir <- matrix(NA, nrow = dim(grupos.raw)[1])
  colnames(Abrir) <- "Abrir"
  # add hyperlinks
  for (i in 1:dim(grupos.raw)[1]) {
    if (!is.na(grupos.raw[i, ncol(grupos.raw)])) {
      Abrir[i] <-
        paste0('<a href="',
               grupos.raw[i, ncol(grupos.raw)],
               '" target="_blank"',
               '>',
               # fontawesome icon
               fontawesome::fa("up-right-from-square"),
               '</a>')
    }
  }
  grupos <- cbind(grupos.raw[, -ncol(grupos.raw)], Abrir)
  
  # order
  grupos <- grupos[order(grupos[, 1]), ]
  
  # print table
  source("Scripts/table-with-buttons.R", local = knitr::knit_global())
  cat(knitr::knit_print(create_dt(grupos, title = paste0("Pessoas - Grupos de Pesquisa - ", abas[j]))))

  # print end of tab rows
  cat('\n\n')
  cat('**Fontes**: [**Diretório de Grupos de Pesquisa**](https://lattes.cnpq.br/web/dgp)')
  cat('\n\n')
  cat('<br><a style="float:right" href="#top"><b>Início &nbsp;</b>', fontawesome::fa("circle-arrow-up"), '</a><br>')
  cat('<br>')
  cat('<br>')
}
```

<br>

## **Participantes externos** {#participantes-externos .tabset}

<!--script for generating HORIZONTAL LINE-->
<hr style="height:2px;border-width:0;color:black;background-color:black">

### **Participantes** {#participantes .tabset}

```{r externos-nacionais, eval = has.sucupira.files}
# participantes externos
sheet <- "Participante Externo"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
externos <- sucupira.raw

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# remove duplicates
externos <- unique(externos)

# drop columns
externos <- externos %>% dplyr::select("Nome do Participante", "Tipos de Participação", "Instituição de Origem", "País")

# format names
externos$`Nome do Participante` <- tools::toTitleCase(tolower(externos$`Nome do Participante`))
externos$`Tipos de Participação` <- tools::toTitleCase(tolower(externos$`Tipos de Participação`))
colnames(externos)[which(names(externos) == "Tipos de Participação")] <- "Participação"
externos$`Instituição de Origem` <- toupper(externos$`Instituição de Origem`)

if (dim(externos)[1] != 0) {
  externos <- externos[order(externos$'Nome do Participante', decreasing = FALSE),]
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(externos, title = "Pessoas - Participantes externos - Nacionais")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>

### **Instituições** {#instituicoes .tabset}

```{r externos-ies-paises, eval = has.sucupira.files}
# participantes externos
sheet <- "Participante Externo"
source("Scripts/read-xlsx-sucupira.R", local = knitr::knit_global())
externos <- sucupira.raw

# get years
source("Scripts/years-sucupira.R", local = knitr::knit_global())
names(sucupira.list) <- as.character(anos)

# drop columns and remove duplicated entries
externos <- externos %>% dplyr::select("Instituição de Origem", "País")
externos <- unique(externos)

# format names
externos$`Instituição de Origem` <- toupper(externos$`Instituição de Origem`)

if (dim(externos)[1] != 0) {
  externos <- externos[order(externos$'Instituição de Origem', decreasing = FALSE),]
}
source("Scripts/table-with-buttons.R", local = knitr::knit_global())
create_dt(externos, title = "Pessoas - Participantes externos - Instituições")

source("Scripts/fonte-sucupira.R", local = knitr::knit_global())
```

<br>
